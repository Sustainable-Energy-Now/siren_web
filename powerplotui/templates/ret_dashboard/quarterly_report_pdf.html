{% load humanize %}
{% load math_filters %}
{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SWIS Quarterly Report - Q{{ quarter }} {{ year }}</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .quarterly-report {
            max-width: 100%;
        }

        .report-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 600;
        }

        .report-header .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .report-header img {
            height: 60px;
            width: auto;
        }

        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .section h2 {
            color: #1e3c72;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 8px;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .section h3 {
            color: #2a5298;
            margin-top: 20px;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .summary-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            flex: 1 1 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 6px;
            min-width: 180px;
        }

        .summary-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .summary-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .summary-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .summary-card.price {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
        }

        .summary-card .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-card .change {
            font-size: 13px;
            opacity: 0.95;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 13px;
        }

        .data-table thead {
            background: #f5f5f5;
        }

        .data-table th {
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }

        .data-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }

        .data-table .value {
            text-align: right;
        }

        .total-row {
            font-weight: 600;
            background: #e3f2fd;
            border-top: 2px solid #2196F3;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px 15px;
            margin: 15px 0;
            font-size: 13px;
        }

        .observations {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
        }

        .observations ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .observations li {
            margin: 6px 0;
            line-height: 1.5;
        }
    </style>
</head>
<body>
<div class="quarterly-report">
    <!-- Report Header -->
    <div class="report-header">
        <div>
            <h1>SWIS Quarterly Report</h1>
            <div class="subtitle">Q{{ quarter }} {{ year }} ({{ quarter_start_month }} - {{ quarter_end_month }})</div>
        </div>
        <img src="{% static 'img/SEN_LOGO_HERO.png' %}" alt="SEN Logo">
    </div>

    <!-- Quick Navigation Links -->
    <div style="margin: 0 0 20px 0; padding: 15px; background: #ecf0f1; border-radius: 8px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <strong style="color: #2c3e50;">Other Reports:</strong>
        <a href="{% url 'ret_dashboard' %}"
            style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìä
            Monthly Dashboard</a>
        <a href="{% url 'annual_review' year %}"
            style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìë
            {{ year }} Annual Review</a>
        <a href="{% url 'display_module_help' 'ret_dashboard' %}" target="_blank"
            style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">‚ùì
            Help</a>
    </div>

    <!-- Executive Summary -->
    <div class="section">
        <h2>Executive Summary</h2>

        <div class="summary-cards">
            <div class="summary-card success">
                <div class="label">Q{{ quarter }} RE% (Operational)</div>
                <div class="value">{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</div>
                <div class="change">Grid-sent electricity</div>
            </div>

            <div class="summary-card success">
                <div class="label">Q{{ quarter }} RE% (Underlying)</div>
                <div class="value">{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</div>
                <div class="change">Including rooftop solar</div>
            </div>

            <div class="summary-card info">
                <div class="label">YTD RE% (Operational)</div>
                <div class="value">{{ ytd_summary.re_percentage_operational|floatformat:1 }}%</div>
                <div class="change">
                    {% if prev_ytd_summary %}
                    vs {{ prev_ytd_summary.re_percentage_operational|floatformat:1 }}% in {{ year|add:"-1" }}
                    {% endif %}
                </div>
            </div>

            <div class="summary-card info">
                <div class="label">YTD RE% (Underlying)</div>
                <div class="value">{{ ytd_summary.re_percentage_underlying|floatformat:1 }}%</div>
                <div class="change">
                    {% if prev_ytd_summary %}
                    vs {{ prev_ytd_summary.re_percentage_underlying|floatformat:1 }}% in {{ year|add:"-1" }}
                    {% endif %}
                </div>
            </div>

            {% if target %}
            <div class="summary-card {% if ytd_summary.re_percentage_operational >= target.target_re_percentage %}positive{% else %}warning{% endif %}">
                <div class="label">{{ year }} Target {% if ytd_summary.re_percentage_operational >= target.target_re_percentage %}Exceeded{% else %}Shortfall{% endif %}</div>
                <div class="value">{% with shortfall=target.target_re_percentage|sub:ytd_summary.re_percentage_operational %}{% if shortfall > 0 %}{{ shortfall|floatformat:1 }} pp{% else %}On track{% endif %}{% endwith %}</div>
                <div class="change">
                    ‚ö† RE% (Operational) target is {{ target.target_re_percentage|floatformat:0 }}% by year end.
                </div>
            </div>
            {% endif %}

            <div class="summary-card warning">
                <div class="label">Q{{ quarter }} Emissions</div>
                <div class="value">{{ quarterly_summary.total_emissions|floatformat:0|intcomma }}</div>
                <div class="change">tonnes CO‚ÇÇ-e</div>
            </div>

            <div class="summary-card warning">
                <div class="label">YTD Emissions</div>
                <div class="value">{{ ytd_summary.total_emissions|floatformat:0|intcomma }}</div>
                <div class="change">
                    {% if prev_ytd_summary %}
                    {% with change=ytd_summary.total_emissions|sub:prev_ytd_summary.total_emissions %}
                    {% with pct=change|div:prev_ytd_summary.total_emissions|mul:100 %}
                    {% if pct >= 0 %}+{% endif %}{{ pct|floatformat:1 }}% vs {{ year|add:"-1" }}
                    {% endwith %}
                    {% endwith %}
                    {% else %}
                    tonnes CO‚ÇÇ-e
                    {% endif %}
                </div>
            </div>

            {% if quarterly_summary.wholesale_price_avg %}
            <div class="summary-card price">
                <div class="label">Q{{ quarter }} Avg Price</div>
                <div class="value">${{ quarterly_summary.wholesale_price_avg|floatformat:2 }}</div>
                <div class="change">$/MWh wholesale</div>
            </div>
            {% endif %}
        </div>

        <div class="info-box">
            <strong>Note:</strong>
            <strong>Operational Consumption</strong> = Total consumption from grid sources.
            <strong>Underlying Consumption</strong> = Operational + rooftop solar (DPV).
        </div>

        {% if executive_summary and executive_summary.content %}
        <div style="margin-top: 15px; font-size: 14px; line-height: 1.6;">
            {{ executive_summary.content|linebreaks }}
        </div>
        {% endif %}
    </div>

    <!-- Wholesale Price Statistics -->
    {% if quarterly_summary.wholesale_price_avg %}
    <div class="section">
        <h2>Wholesale Price Statistics</h2>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th class="value">Value</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Average Price</td>
                    <td class="value">${{ quarterly_summary.wholesale_price_avg|floatformat:2 }}/MWh</td>
                </tr>
                {% if quarterly_summary.wholesale_price_max %}
                <tr>
                    <td>Maximum Price</td>
                    <td class="value">${{ quarterly_summary.wholesale_price_max|floatformat:2 }}/MWh</td>
                </tr>
                {% endif %}
                {% if quarterly_summary.wholesale_price_min %}
                <tr>
                    <td>Minimum Price</td>
                    <td class="value">${{ quarterly_summary.wholesale_price_min|floatformat:2 }}/MWh</td>
                </tr>
                {% endif %}
                {% if quarterly_summary.wholesale_negative_count is not None %}
                <tr>
                    <td>Negative Price Intervals</td>
                    <td class="value">{{ quarterly_summary.wholesale_negative_count|intcomma }} intervals</td>
                </tr>
                {% endif %}
                {% if quarterly_summary.wholesale_spike_count is not None %}
                <tr>
                    <td>Price Spikes (&gt;$300/MWh)</td>
                    <td class="value">{{ quarterly_summary.wholesale_spike_count|intcomma }} intervals</td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <h3>Monthly Wholesale Price Breakdown</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Month</th>
                    <th class="value">Avg ($/MWh)</th>
                    <th class="value">Max ($/MWh)</th>
                    <th class="value">Min ($/MWh)</th>
                    <th class="value">Negative</th>
                    <th class="value">Spikes</th>
                </tr>
            </thead>
            <tbody>
                {% for monthly in quarterly_data %}
                <tr>
                    <td><strong>{{ monthly.get_month_name }}</strong></td>
                    <td class="value">
                        {% if monthly.wholesale_price_avg is not None %}
                        ${{ monthly.wholesale_price_avg|floatformat:2 }}
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    <td class="value">
                        {% if monthly.wholesale_price_max is not None %}
                        ${{ monthly.wholesale_price_max|floatformat:2 }}
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    <td class="value">
                        {% if monthly.wholesale_price_min is not None %}
                        ${{ monthly.wholesale_price_min|floatformat:2 }}
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    <td class="value">
                        {% if monthly.wholesale_negative_count is not None %}
                        {{ monthly.wholesale_negative_count|intcomma }}
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    <td class="value">
                        {% if monthly.wholesale_spike_count is not None %}
                        {{ monthly.wholesale_spike_count|intcomma }}
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Monthly Performance Breakdown -->
    <div class="section">
        <h2>Monthly Performance Breakdown</h2>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Month</th>
                    <th class="value">Underlying Consumption (GWh)</th>
                    <th class="value">Renewable Gen (GWh)</th>
                    <th class="value">RE% (Operational)</th>
                    <th class="value">vs Target (pp)</th>
                    <th class="value">RE% (Underlying)</th>
                    <th class="value">Emissions (t CO‚ÇÇ-e)</th>
                </tr>
            </thead>
            <tbody>
                {% for monthly in quarterly_data %}
                <tr>
                    <td><strong>{{ monthly.get_month_name }}</strong></td>
                    <td class="value">{{ monthly.underlying_demand|floatformat:0|intcomma }}</td>
                    <td class="value">{{ monthly.total_renewable_generation|floatformat:0|intcomma }}</td>
                    <td class="value">{{ monthly.re_percentage_operational|floatformat:1 }}%</td>
                    <td class="value">
                        {% if target %}
                            {% if monthly.re_percentage_underlying >= target.target_re_percentage %}
                            <span style="color: #27ae60;">‚úì +{{ monthly.re_percentage_underlying|sub:target.target_re_percentage|floatformat:1 }}</span>
                            {% else %}
                            <span style="color: #e74c3c;">{{ monthly.re_percentage_underlying|sub:target.target_re_percentage|floatformat:1 }}</span>
                            {% endif %}
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    <td class="value">{{ monthly.re_percentage_underlying|floatformat:1 }}%</td>
                    <td class="value">{{ monthly.total_emissions_tonnes|floatformat:0|intcomma }}</td>
                </tr>
                {% endfor %}
                {% if quarterly_summary %}
                <tr class="total-row">
                    <td><strong>Q{{ quarter }} TOTAL</strong></td>
                    <td class="value"><strong>{{ quarterly_summary.underlying_demand|floatformat:0|intcomma }}</strong></td>
                    <td class="value"><strong>{{ quarterly_summary.renewable_generation|floatformat:0|intcomma }}</strong></td>
                    <td class="value"><strong>{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</strong></td>
                    <td class="value"><strong>{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</strong></td>
                    <td class="value"><strong>{{ quarterly_summary.total_emissions|floatformat:0|intcomma }}</strong></td>
                    <td class="value">‚Äî</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Year-to-Date Cumulative -->
    <div class="section">
        <h2>Cumulative Year-to-Date Performance</h2>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th class="value">Q{{ quarter }} {{ year }}</th>
                    <th class="value">YTD {{ year }}</th>
                    {% if prev_ytd_summary %}
                    <th class="value">YTD {{ year|add:"-1" }}</th>
                    <th class="value">Change</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>RE% (Operational)</strong></td>
                    <td class="value">{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</td>
                    <td class="value"><strong>{{ ytd_summary.re_percentage_operational|floatformat:1 }}%</strong></td>
                    {% if prev_ytd_summary %}
                    <td class="value">{{ prev_ytd_summary.re_percentage_operational|floatformat:1 }}%</td>
                    <td class="value">
                        {% with change=ytd_summary.re_percentage_operational|sub:prev_ytd_summary.re_percentage_operational %}
                        {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }} pp
                        {% endwith %}
                    </td>
                    {% endif %}
                </tr>
                <tr>
                    <td><strong>RE% (Underlying)</strong></td>
                    <td class="value">{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</td>
                    <td class="value"><strong>{{ ytd_summary.re_percentage_underlying|floatformat:1 }}%</strong></td>
                    {% if prev_ytd_summary %}
                    <td class="value">{{ prev_ytd_summary.re_percentage_underlying|floatformat:1 }}%</td>
                    <td class="value">
                        {% with change=ytd_summary.re_percentage_underlying|sub:prev_ytd_summary.re_percentage_underlying %}
                        {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }} pp
                        {% endwith %}
                    </td>
                    {% endif %}
                </tr>
                <tr>
                    <td>Total Emissions (tonnes CO‚ÇÇ-e)</td>
                    <td class="value">{{ quarterly_summary.total_emissions|floatformat:0|intcomma }}</td>
                    <td class="value">{{ ytd_summary.total_emissions|floatformat:0|intcomma }}</td>
                    {% if prev_ytd_summary %}
                    <td class="value">{{ prev_ytd_summary.total_emissions|floatformat:0|intcomma }}</td>
                    <td class="value">
                        {% with change=ytd_summary.total_emissions|sub:prev_ytd_summary.total_emissions %}
                        {% with pct_change=change|div:prev_ytd_summary.total_emissions|mul:100 %}
                        {% if pct_change >= 0 %}+{% endif %}{{ pct_change|floatformat:1 }}%
                        {% endwith %}
                        {% endwith %}
                    </td>
                    {% endif %}
                </tr>
                <tr>
                    <td>Emissions Intensity (kg/MWh)</td>
                    <td class="value">{{ quarterly_summary.emissions_intensity|floatformat:0 }}</td>
                    <td class="value">{{ ytd_summary.emissions_intensity|floatformat:0 }}</td>
                    {% if prev_ytd_summary %}
                    <td class="value">{{ prev_ytd_summary.emissions_intensity|floatformat:0 }}</td>
                    <td class="value">
                        {% with change=ytd_summary.emissions_intensity|sub:prev_ytd_summary.emissions_intensity %}
                        {% if change >= 0 %}+{% endif %}{{ change|floatformat:0 }}
                        {% endwith %}
                    </td>
                    {% endif %}
                </tr>
                {% if ytd_summary.wholesale_price_avg %}
                <tr>
                    <td>Avg Wholesale Price ($/MWh)</td>
                    <td class="value">${{ quarterly_summary.wholesale_price_avg|floatformat:2 }}</td>
                    <td class="value">${{ ytd_summary.wholesale_price_avg|floatformat:2 }}</td>
                    {% if prev_ytd_summary.wholesale_price_avg %}
                    <td class="value">${{ prev_ytd_summary.wholesale_price_avg|floatformat:2 }}</td>
                    <td class="value">
                        {% with change=ytd_summary.wholesale_price_avg|sub:prev_ytd_summary.wholesale_price_avg|div:prev_ytd_summary.wholesale_price_avg|mul:100 %}
                        {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }}%
                        {% endwith %}
                    </td>
                    {% else %}
                    <td class="value">‚Äî</td>
                    <td class="value">‚Äî</td>
                    {% endif %}
                </tr>
                {% endif %}
            </tbody>
        </table>

        {% if target %}
        <p style="margin-top: 15px; font-size: 13px;">
            {% if ytd_summary.re_percentage_underlying >= target.target_re_percentage %}
            ‚úì YTD performance is <strong>{{ ytd_summary.re_percentage_underlying|sub:target.target_re_percentage|floatformat:1 }} percentage points ahead</strong> of the {{ year }} annual target.
            {% else %}
            ‚ö† YTD performance is <strong>{{ target.target_re_percentage|sub:ytd_summary.re_percentage_underlying|floatformat:1 }} percentage points behind</strong> the {{ year }} annual target.
            {% endif %}
        </p>
        {% endif %}
    </div>

    <!-- New Capacity -->
    {% if new_capacity %}
    <div class="section">
        <h2>New Capacity Commissioned in Q{{ quarter }} {{ year }}</h2>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Facility</th>
                    <th>Technology</th>
                    <th class="value">Capacity (MW)</th>
                    <th>Commissioned</th>
                </tr>
            </thead>
            <tbody>
                {% for facility in new_capacity %}
                <tr>
                    <td><strong>{{ facility.facility.facility_name }}</strong></td>
                    <td>{{ facility.technology_type }}</td>
                    <td class="value">{{ facility.capacity_mw|floatformat:0 }}</td>
                    <td>{{ facility.commissioned_date|date:"d M Y" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <p style="margin-top: 15px;">
            <strong>Total New Capacity Q{{ quarter }} {{ year }}: {{ new_capacity|sum_attr:"capacity_mw"|floatformat:0 }} MW renewable</strong>
        </p>
    </div>
    {% endif %}

    <!-- Key Observations -->
    <div class="section">
        <h2>Key Observations</h2>

        <div class="observations">
            <h3>Positive Developments</h3>
            <ul>
                {% if prev_quarter_summary and quarterly_summary.re_percentage_underlying > prev_quarter_summary.re_percentage_underlying %}
                <li>RE% (underlying) increased by {{ quarterly_summary.re_percentage_underlying|sub:prev_quarter_summary.re_percentage_underlying|floatformat:1 }} percentage points compared to Q{{ quarter }} {{ year|add:"-1" }}</li>
                {% endif %}
                {% if prev_ytd_summary and ytd_summary.total_emissions < prev_ytd_summary.total_emissions %}
                <li>YTD emissions reduced by {{ prev_ytd_summary.total_emissions|sub:ytd_summary.total_emissions|floatformat:0|intcomma }} tonnes CO‚ÇÇ-e ({{ prev_ytd_summary.total_emissions|sub:ytd_summary.total_emissions|div:prev_ytd_summary.total_emissions|mul:100|floatformat:1 }}%) compared to same period last year</li>
                {% endif %}
                <li>Wind generation contributed {{ quarterly_summary.wind_generation|percent:quarterly_summary.underlying_demand|floatformat:1 }}% of total underlying demand</li>
                <li>Combined solar (utility + rooftop) provided {{ quarterly_summary.solar_generation|add:quarterly_summary.dpv_generation|percent:quarterly_summary.underlying_demand|floatformat:1 }}% of electricity</li>
                {% if quarterly_summary.wholesale_negative_count and quarterly_summary.wholesale_negative_count > 0 %}
                <li>{{ quarterly_summary.wholesale_negative_count|intcomma }} intervals of negative wholesale prices indicate strong renewable energy penetration</li>
                {% endif %}
            </ul>
        </div>

        <div class="observations" style="background: #fce4ec; border-left-color: #e91e63;">
            <h3>Challenges and Risks</h3>
            <ul>
                {% if target and quarterly_summary.re_percentage_underlying < target.target_re_percentage %}
                <li>Quarterly RE% ({{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%) is below annual target ({{ target.target_re_percentage }}%)</li>
                {% endif %}
                {% if quarterly_summary.wholesale_spike_count and quarterly_summary.wholesale_spike_count > 0 %}
                <li>{{ quarterly_summary.wholesale_spike_count|intcomma }} price spike intervals (&gt;$300/MWh) indicate periods of grid stress</li>
                {% endif %}
                <li>Continued monitoring needed to ensure annual target achievement</li>
            </ul>
        </div>
    </div>

    <!-- Quarterly Trends Note -->
    <div class="section">
        <h2>Quarterly Trends</h2>
        <div class="info-box">
            <p style="margin: 0; font-size: 13px;">
                <strong>Note:</strong> Interactive charts showing Monthly Generation Breakdown and Year-over-Year RE% Comparison
                are available in the online version of this report. Please view the report online for detailed trend visualizations.
            </p>
        </div>
    </div>

    <!-- Footer -->
    <div style="margin-top: 30px; padding: 15px; background: #ecf0f1; font-size: 12px;">
        <p style="margin: 0;"><strong>Report Generated:</strong> {{ now|date:"d F Y, g:i A" }}</p>
        <p style="margin: 5px 0 0 0;"><strong>Contact:</strong> <a href="mailto:modelling.lead@sen.asn.au">modelling.lead@sen.asn.au</a></p>
    </div>
</div>
</body>
</html>
