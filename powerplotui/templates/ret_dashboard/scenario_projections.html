{% extends 'scada/base.html' %}
{% load humanize %}
{% load static %}

{% block title %}SWIS 2040 Scenario Projections{% endblock %}

{% block content %}
<header style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 20px;">
    <div>
        <h1>SWIS 2040 Scenario Projections</h1>
        <h2>Renewable Energy Target Pathway Analysis</h2>
        <p style="color: #7f8c8d; font-size: 1.1em;">
            Projection Period: 2025 - 2040
        </p>
    </div>
    <img src="{% static 'img/SEN_LOGO_HERO.png' %}" alt="SEN Logo" style="height: 100px; width: auto;">
</header>

<!-- Quick Navigation Links -->
<div style="margin: 20px 0; padding: 15px; background: #ecf0f1; border-radius: 8px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
    <strong style="color: #2c3e50;">Other Reports:</strong>
    <a href="{% url 'ret_dashboard' %}" style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìä Monthly Dashboard</a>
    <a href="{% url 'annual_review' annual_review_year %}" style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìë Annual Review</a>
    <a href="{% url 'published_reports_list' %}" style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìÇ Published Reports</a>
    <button onclick="window.print()" style="padding: 8px 15px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">üñ® Print</button>
</div>

{% if not has_data %}
<div class="info-box warning" style="margin-bottom: 20px;">
    <strong>Example Data:</strong> No scenario projection data found in the database. Charts and metrics below use illustrative example data.
    To add real projections, use the <a href="{% url 'ret_targets_list' %}">Targets &amp; Scenarios</a> admin page.
</div>
{% endif %}

<!-- Executive Summary -->
<div class="section-header">
    <h2>Executive Summary</h2>
</div>

<div class="info-box" style="background: white; border-left: 4px solid #9b59b6;">
    <p style="font-size: 1.1em; line-height: 1.8;">
        This report presents scenario-based projections for the South West Interconnected System (SWIS)
        renewable energy transition to 2040. Three scenario types are modelled: <strong>Base Case</strong>,
        <strong>Accelerated Pipeline</strong> and <strong>Delayed Pipeline</strong>.
        The 2040 target of <strong>100% renewable energy</strong> (underlying consumption basis) appears achievable under the Base Case
        scenario with a <strong>{% if base_2040 %}{{ base_2040.probability|floatformat:"0" }}{% else %}78{% endif %}% probability</strong> based on Monte Carlo analysis.
    </p>
</div>

<!-- Scenario Definitions -->
<div class="info-box" style="background: #e3f2fd; border-left-color: #2196f3;">
    <h3 style="margin-top: 0;">Scenario Type Definitions</h3>
    <p style="margin-bottom: 0;">
        This analysis includes three scenario types to capture a range of possible outcomes based on consumption growth, facility commissioning and performance assumptions.
    </p>
    <p style="margin-bottom: 0;">
        <strong>Base Case:</strong> Planned and probable facilities commissioned on schedule with historical capacity factors and planned consumption growth (the most likely pathway).<br>
        <strong>Accelerated Pipeline:</strong> All possible facilities included, faster commissioning, optimistic capacity factors and additional unplanned consumption growth (optimistic assumptions and delivery).<br>
        <strong>Delayed Pipeline:</strong> Only planned facilities, 12-month average delay, conservative capacity factors, less than planned consumption growth (conservative assumptions and delivery).
    </p>
</div>

<!-- Key Targets Overview -->
<div class="section-header">
    <h2>Key Targets Overview</h2>
</div>

<div class="metric-grid">
    <div class="metric-card positive">
        <div class="metric-label">2040 RE Target</div>
        <div class="metric-value">100%</div>
        <div class="metric-sublabel">Underlying consumption basis</div>
        <div class="metric-change">Major Target Year</div>
    </div>

    <div class="metric-card neutral">
        <div class="metric-label">2030 Interim Target</div>
        <div class="metric-value">82%</div>
        <div class="metric-sublabel">Underlying consumption basis</div>
        <div class="metric-change">Interim Milestone</div>
    </div>

    <div class="metric-card neutral">
        <div class="metric-label">Current RE% ({% if current_year %}{{ current_year }}{% else %}Latest{% endif %})</div>
        <div class="metric-value">{% if current_re_pct %}{{ current_re_pct|floatformat:"1" }}%{% else %}‚Äî{% endif %}</div>
        <div class="metric-sublabel">Latest annual result (underlying)</div>
    </div>

    <div class="metric-card positive">
        <div class="metric-label">Achievement Probability</div>
        <div class="metric-value">{% if base_2040 %}{{ base_2040.probability|floatformat:"0" }}%{% else %}78%{% endif %}</div>
        <div class="metric-sublabel">Base Case @ 100% target</div>
        <div class="metric-change">Monte Carlo analysis</div>
    </div>
</div>

<!-- RE% Trajectory Chart ‚Äî from PDF design: stacked area + line overlay + hover panel -->
<div class="section-header">
    <h2>RE% Trajectory by Scenario</h2>
</div>

<div class="chart-container">
    <!-- Scenario selector for stacked area -->
    <div style="margin-bottom: 14px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
        <label for="energyMixScenario" style="font-weight: 600; color: #2c3e50;">Energy Mix for:</label>
        <select id="energyMixScenario" onchange="changeScenario(this.value)"
                style="padding: 6px 14px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 1em; background: white;">
            <option value="base_case">Base Case</option>
            <option value="accelerated_pipeline">Accelerated Pipeline</option>
            <option value="delayed_pipeline">Delayed Pipeline</option>
        </select>
        <span style="color: #95a5a6; font-size: 0.88em;">‚Üê Controls stacked area display &nbsp;|&nbsp; Hover chart for energy mix values ‚Üí</span>
    </div>

    <!-- Chart + Energy Mix Panel (from PDF design) -->
    <div style="display: flex; gap: 18px; align-items: flex-start;">
        <div style="flex: 1; min-width: 0;">
            <div id="re_trajectory_chart" style="height: 430px;"></div>
        </div>

        <!-- Energy mix hover panel -->
        <div id="energy_mix_panel"
             style="width: 195px; flex-shrink: 0; background: #f8f9fa; border: 1px solid #dee2e6;
                    border-radius: 8px; padding: 14px; position: sticky; top: 20px;">
            <div style="font-weight: 700; color: #1e3c72; font-size: 1em; margin-bottom: 8px;
                        border-bottom: 2px solid #4CAF50; padding-bottom: 6px;">Energy Mix</div>
            <div style="font-size: 0.83em; margin-bottom: 10px; color: #555;">
                <div>Scenario: <span id="mix_scenario" style="font-weight: 600;">‚Äî</span></div>
                <div>Year: <span id="mix_year" style="font-weight: 600;">‚Äî</span></div>
            </div>
            <div id="mix_hint" style="color: #95a5a6; font-size: 0.82em; font-style: italic; margin-bottom: 6px;">
                Hover over chart to see values
            </div>
            <table id="mix_table" style="width: 100%; font-size: 0.88em; display: none; border-collapse: collapse;">
                <tbody>
                    <tr>
                        <td style="padding: 4px 0;"><span style="color: #FFCA28; font-size: 1.1em;">‚ñ†</span> DPV</td>
                        <td style="text-align: right; padding: 4px 0;" id="mix_dpv">‚Äî</td>
                    </tr>
                    <tr>
                        <td style="padding: 4px 0;"><span style="color: #FFA726; font-size: 1.1em;">‚ñ†</span> Solar (Utility)</td>
                        <td style="text-align: right; padding: 4px 0;" id="mix_solar">‚Äî</td>
                    </tr>
                    <tr>
                        <td style="padding: 4px 0;"><span style="color: #42A5F5; font-size: 1.1em;">‚ñ†</span> Wind</td>
                        <td style="text-align: right; padding: 4px 0;" id="mix_wind">‚Äî</td>
                    </tr>
                    <tr>
                        <td style="padding: 4px 0;"><span style="color: #78909C; font-size: 1.1em;">‚ñ†</span> Storage</td>
                        <td style="text-align: right; padding: 4px 0;" id="mix_storage">‚Äî</td>
                    </tr>
                    <tr>
                        <td style="padding: 4px 0;"><span style="color: #66BB6A; font-size: 1.1em;">‚ñ†</span> Other RE</td>
                        <td style="text-align: right; padding: 4px 0;" id="mix_biomass">‚Äî</td>
                    </tr>
                    <tr style="border-top: 1px solid #dee2e6;">
                        <td style="padding-top: 7px; font-weight: 700; color: #27ae60;">RE%</td>
                        <td style="text-align: right; padding-top: 7px; font-weight: 700; color: #27ae60;" id="mix_re_pct">‚Äî</td>
                    </tr>
                    <tr>
                        <td style="color: #7f8c8d; font-size: 0.9em; padding-top: 3px;">Demand</td>
                        <td style="text-align: right; color: #7f8c8d; font-size: 0.9em; padding-top: 3px;" id="mix_demand">‚Äî</td>
                    </tr>
                </tbody>
            </table>
            <div style="margin-top: 10px; font-size: 0.72em; color: #bbb; border-top: 1px solid #eee; padding-top: 7px;">
                Generation in GWh<br>Storage capacity in MWh
            </div>
        </div>
    </div>

    <!-- Legend for lines -->
    <div style="margin-top: 12px; display: flex; gap: 20px; flex-wrap: wrap; font-size: 0.88em; color: #555;">
        <span><span style="display:inline-block;width:28px;height:3px;background:#2196F3;vertical-align:middle;margin-right:5px;"></span>Base Case</span>
        <span><span style="display:inline-block;width:28px;height:3px;background:#4CAF50;vertical-align:middle;margin-right:5px;border-top: 2px dashed #4CAF50;background:none;"></span>Accelerated</span>
        <span><span style="display:inline-block;width:28px;height:3px;background:#FF9800;vertical-align:middle;margin-right:5px;border-top: 2px dotted #FF9800;background:none;"></span>Delayed</span>
        <span><span style="display:inline-block;width:28px;height:3px;background:#e74c3c;vertical-align:middle;margin-right:5px;border-top: 2px dashed #e74c3c;background:none;"></span>Target</span>
        <span><span style="display:inline-block;width:28px;height:3px;background:#2c3e50;vertical-align:middle;margin-right:5px;"></span>Actual</span>
    </div>
</div>

<!-- Scenario Projections Table -->
<div class="section-header">
    <h2>Scenario Projections Summary</h2>
</div>

<h3>Step Change Scenario (Base Case)</h3>
<table class="stats-table">
    <thead>
        <tr>
            <th>Year</th>
            <th class="value">RE%</th>
            <th class="value">Wind (GWh)</th>
            <th class="value">Solar (GWh)</th>
            <th class="value">DPV (GWh)</th>
            <th class="value">Storage (MWh)</th>
            <th class="value">Emissions (kt)</th>
            <th>Target Type</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>2025</strong></td>
            <td class="value">45.2%</td>
            <td class="value">4,850</td>
            <td class="value">2,120</td>
            <td class="value">3,400</td>
            <td class="value">850</td>
            <td class="value">5,420</td>
            <td>Ordinary</td>
        </tr>
        <tr>
            <td><strong>2026</strong></td>
            <td class="value">48.5%</td>
            <td class="value">5,320</td>
            <td class="value">2,580</td>
            <td class="value">3,650</td>
            <td class="value">1,200</td>
            <td class="value">5,180</td>
            <td>Ordinary</td>
        </tr>
        <tr>
            <td><strong>2027</strong></td>
            <td class="value">52.1%</td>
            <td class="value">5,890</td>
            <td class="value">3,150</td>
            <td class="value">3,920</td>
            <td class="value">1,650</td>
            <td class="value">4,850</td>
            <td>Ordinary</td>
        </tr>
        <tr>
            <td><strong>2028</strong></td>
            <td class="value">56.8%</td>
            <td class="value">6,580</td>
            <td class="value">3,820</td>
            <td class="value">4,180</td>
            <td class="value">2,200</td>
            <td class="value">4,420</td>
            <td>Ordinary</td>
        </tr>
        <tr class="highlight-row">
            <td><strong>2030</strong></td>
            <td class="value"><strong>65.2%</strong></td>
            <td class="value">7,850</td>
            <td class="value">5,120</td>
            <td class="value">4,650</td>
            <td class="value">3,500</td>
            <td class="value">3,650</td>
            <td><span style="color: #3498db;">Interim Target</span></td>
        </tr>
        <tr>
            <td><strong>2032</strong></td>
            <td class="value">71.5%</td>
            <td class="value">8,920</td>
            <td class="value">6,480</td>
            <td class="value">5,100</td>
            <td class="value">4,800</td>
            <td class="value">3,020</td>
            <td>Ordinary</td>
        </tr>
        <tr>
            <td><strong>2035</strong></td>
            <td class="value">78.3%</td>
            <td class="value">10,250</td>
            <td class="value">8,150</td>
            <td class="value">5,680</td>
            <td class="value">6,500</td>
            <td class="value">2,350</td>
            <td>Ordinary</td>
        </tr>
        <tr class="highlight-row" style="background: #e8f5e9 !important;">
            <td><strong>2040</strong></td>
            <td class="value"><strong>{% if base_2040 %}{{ base_2040.re_pct|floatformat:"1" }}%{% else %}86.7%{% endif %}</strong></td>
            <td class="value">12,450</td>
            <td class="value">10,820</td>
            <td class="value">6,520</td>
            <td class="value">9,200</td>
            <td class="value">1,480</td>
            <td><span style="color: #27ae60;">Major Target</span></td>
        </tr>
    </tbody>
</table>

<!-- Scenario Comparison -->
<h3>2040 Target ‚Äî Scenario Comparison</h3>
<table class="stats-table">
    <thead>
        <tr>
            <th>Scenario</th>
            <th class="value">2040 RE%</th>
            <th class="value">vs 100% Target</th>
            <th class="value">Probability</th>
            <th class="value">Total RE Gen (GWh)</th>
            <th class="value">Emissions (kt)</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        <tr class="renewable-row">
            <td><strong>Accelerated Transition (Accelerated Pipeline)</strong></td>
            <td class="value">94.2%</td>
            <td class="value positive">‚àí5.8 pp</td>
            <td class="value">92%</td>
            <td class="value">36,100</td>
            <td class="value">800</td>
            <td><span style="color: #2980b9;">Near Target</span></td>
        </tr>
        <tr class="highlight-row">
            <td><strong>Step Change (Base Case)</strong></td>
            <td class="value">{% if base_2040 %}{{ base_2040.re_pct|floatformat:"1" }}%{% else %}86.7%{% endif %}</td>
            <td class="value" style="color: #e67e22;">‚àí13.3 pp</td>
            <td class="value">{% if base_2040 %}{{ base_2040.probability|floatformat:"0" }}%{% else %}78%{% endif %}</td>
            <td class="value">29,790</td>
            <td class="value">1,480</td>
            <td><span style="color: #f39c12;">Below Target</span></td>
        </tr>
        <tr class="fossil-row">
            <td><strong>Slower Growth (Delayed Pipeline)</strong></td>
            <td class="value">79.5%</td>
            <td class="value negative">‚àí20.5 pp</td>
            <td class="value">45%</td>
            <td class="value">26,750</td>
            <td class="value">2,100</td>
            <td><span style="color: #e74c3c;">Well Below Target</span></td>
        </tr>
    </tbody>
</table>

<!-- Capacity Pipeline -->
<div class="section-header">
    <h2>Projected Facility Pipeline</h2>
</div>

<div class="info-box">
    <h3>Capacity by Status and Technology</h3>
    <p>Facilities included in Base Case scenario projections, ordered by expected commissioning date.</p>
</div>

<div class="metric-grid">
    <div class="metric-card positive">
        <div class="metric-label">Commissioned</div>
        <div class="metric-value">4,850</div>
        <div class="metric-sublabel">MW operational</div>
    </div>
    <div class="metric-card neutral">
        <div class="metric-label">Under Construction</div>
        <div class="metric-value">1,240</div>
        <div class="metric-sublabel">MW in progress</div>
    </div>
    <div class="metric-card warning">
        <div class="metric-label">Planned</div>
        <div class="metric-value">3,580</div>
        <div class="metric-sublabel">MW committed</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Probable</div>
        <div class="metric-value">2,150</div>
        <div class="metric-sublabel">MW likely</div>
    </div>
</div>

<h3>Upcoming Facility Commissioning (2025‚Äì2030)</h3>
<table class="stats-table">
    <thead>
        <tr>
            <th>Facility</th>
            <th>Technology</th>
            <th class="value">Capacity (MW)</th>
            <th>Status</th>
            <th>Expected Commissioning</th>
            <th class="value">Probability</th>
        </tr>
    </thead>
    <tbody>
        <tr class="renewable-row">
            <td><strong>Yandin Wind Farm Extension</strong></td>
            <td>Wind</td>
            <td class="value">180</td>
            <td>Under Construction</td>
            <td>Q2 2025</td>
            <td class="value">95%</td>
        </tr>
        <tr class="renewable-row">
            <td><strong>Collie Battery Stage 1</strong></td>
            <td>Battery Storage</td>
            <td class="value">200</td>
            <td>Under Construction</td>
            <td>Q3 2025</td>
            <td class="value">90%</td>
        </tr>
        <tr class="renewable-row">
            <td><strong>Warradarge Solar</strong></td>
            <td>Solar</td>
            <td class="value">150</td>
            <td>Planned</td>
            <td>Q4 2025</td>
            <td class="value">85%</td>
        </tr>
        <tr>
            <td><strong>Emu Downs Wind Extension</strong></td>
            <td>Wind</td>
            <td class="value">250</td>
            <td>Planned</td>
            <td>Q1 2026</td>
            <td class="value">80%</td>
        </tr>
        <tr>
            <td><strong>Geraldton Solar Farm</strong></td>
            <td>Solar</td>
            <td class="value">320</td>
            <td>Planned</td>
            <td>Q2 2026</td>
            <td class="value">75%</td>
        </tr>
        <tr>
            <td><strong>Kwinana Big Battery</strong></td>
            <td>Battery Storage</td>
            <td class="value">500</td>
            <td>Planned</td>
            <td>Q4 2026</td>
            <td class="value">70%</td>
        </tr>
        <tr class="info-row">
            <td><strong>Midwest Wind Hub</strong></td>
            <td>Wind</td>
            <td class="value">450</td>
            <td>Probable</td>
            <td>Q2 2027</td>
            <td class="value">65%</td>
        </tr>
        <tr class="info-row">
            <td><strong>Southern Cross Solar</strong></td>
            <td>Solar</td>
            <td class="value">280</td>
            <td>Probable</td>
            <td>Q3 2027</td>
            <td class="value">60%</td>
        </tr>
        <tr class="info-row">
            <td><strong>Northam Wind Farm</strong></td>
            <td>Wind</td>
            <td class="value">380</td>
            <td>Probable</td>
            <td>Q1 2028</td>
            <td class="value">55%</td>
        </tr>
        <tr class="info-row">
            <td><strong>Esperance Hybrid</strong></td>
            <td>Wind + Solar + Battery</td>
            <td class="value">420</td>
            <td>Probable</td>
            <td>Q4 2028</td>
            <td class="value">50%</td>
        </tr>
    </tbody>
    <tfoot>
        <tr style="background: #34495e; color: white;">
            <td colspan="2"><strong>Total Pipeline (2025‚Äì2028)</strong></td>
            <td class="value"><strong>3,130 MW</strong></td>
            <td colspan="3"></td>
        </tr>
    </tfoot>
</table>

<!-- Generation Mix Stacked Bar Chart -->
<div class="section-header">
    <h2>Projected Generation Mix Transition</h2>
</div>

<div class="chart-container">
    <p style="color: #7f8c8d; margin-bottom: 10px; font-size: 0.9em;">Base Case scenario ‚Äî absolute generation (GWh) by technology, showing the shift from fossil fuels to renewables.</p>
    <div id="generation_mix_chart" style="height: 420px;"></div>
</div>

<!-- Cumulative Capacity by Technology Over Time -->
<div class="section-header">
    <h2>Cumulative Capacity by Technology</h2>
</div>

<table class="stats-table">
    <thead>
        <tr>
            <th>Year</th>
            <th class="value">Wind (MW)</th>
            <th class="value">Solar Utility (MW)</th>
            <th class="value">DPV (MW)</th>
            <th class="value">Storage (MW)</th>
            <th class="value">Total RE (MW)</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>2025</strong></td>
            <td class="value">2,850</td>
            <td class="value">1,420</td>
            <td class="value">2,100</td>
            <td class="value">450</td>
            <td class="value">6,820</td>
        </tr>
        <tr>
            <td><strong>2027</strong></td>
            <td class="value">3,580</td>
            <td class="value">2,150</td>
            <td class="value">2,650</td>
            <td class="value">850</td>
            <td class="value">9,230</td>
        </tr>
        <tr class="highlight-row">
            <td><strong>2030</strong></td>
            <td class="value">4,820</td>
            <td class="value">3,450</td>
            <td class="value">3,400</td>
            <td class="value">1,500</td>
            <td class="value">13,170</td>
        </tr>
        <tr>
            <td><strong>2035</strong></td>
            <td class="value">6,250</td>
            <td class="value">5,180</td>
            <td class="value">4,500</td>
            <td class="value">2,800</td>
            <td class="value">18,730</td>
        </tr>
        <tr class="highlight-row" style="background: #e8f5e9 !important;">
            <td><strong>2040</strong></td>
            <td class="value">7,850</td>
            <td class="value">7,200</td>
            <td class="value">5,800</td>
            <td class="value">4,500</td>
            <td class="value">25,350</td>
        </tr>
    </tbody>
</table>

<!-- Consumption Projections -->
<div class="section-header">
    <h2>Consumption Projections</h2>
</div>

<div class="chart-container">
    <div id="consumption_chart" style="height: 320px;"></div>
</div>

<table class="stats-table">
    <thead>
        <tr>
            <th>Year</th>
            <th class="value">Operational Consumption (GWh)</th>
            <th class="value">DPV Generation (GWh)</th>
            <th class="value">Underlying Consumption (GWh)</th>
            <th class="value">Growth Rate</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>2025</strong></td>
            <td class="value">19,850</td>
            <td class="value">3,400</td>
            <td class="value">23,250</td>
            <td class="value">+1.8%</td>
        </tr>
        <tr class="highlight-row">
            <td><strong>2030</strong></td>
            <td class="value">21,420</td>
            <td class="value">4,650</td>
            <td class="value">26,070</td>
            <td class="value">+1.5%</td>
        </tr>
        <tr>
            <td><strong>2035</strong></td>
            <td class="value">23,150</td>
            <td class="value">5,680</td>
            <td class="value">28,830</td>
            <td class="value">+1.2%</td>
        </tr>
        <tr class="highlight-row" style="background: #e8f5e9 !important;">
            <td><strong>2040</strong></td>
            <td class="value">25,080</td>
            <td class="value">6,520</td>
            <td class="value">31,600</td>
            <td class="value">+1.0%</td>
        </tr>
    </tbody>
</table>

<!-- Emissions Trajectory -->
<div class="section-header">
    <h2>Emissions Reduction Trajectory</h2>
</div>

<div class="chart-container">
    <div id="emissions_chart" style="height: 320px;"></div>
</div>

<div class="metric-grid">
    <div class="metric-card positive">
        <div class="metric-label">2024 Baseline</div>
        <div class="metric-value">5,850</div>
        <div class="metric-sublabel">kt CO‚ÇÇ-e</div>
    </div>
    <div class="metric-card positive">
        <div class="metric-label">2030 Projected (Base)</div>
        <div class="metric-value">3,650</div>
        <div class="metric-sublabel">kt CO‚ÇÇ-e (‚àí38%)</div>
    </div>
    <div class="metric-card positive">
        <div class="metric-label">2040 Projected (Base)</div>
        <div class="metric-value">1,480</div>
        <div class="metric-sublabel">kt CO‚ÇÇ-e (‚àí75%)</div>
    </div>
    <div class="metric-card neutral">
        <div class="metric-label">Cumulative Reduction</div>
        <div class="metric-value">42.5</div>
        <div class="metric-sublabel">Mt CO‚ÇÇ-e (2025‚Äì2040)</div>
    </div>
</div>

<!-- Risk Analysis -->
<div class="section-header">
    <h2>Key Risks and Sensitivities</h2>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
    <div class="info-box" style="border-left-color: #e74c3c;">
        <h3 style="margin-top: 0; color: #e74c3c;">Downside Risks</h3>
        <ul class="bullet-list">
            <li><strong>Project Delays:</strong> Average 12-month delay would reduce 2040 RE% by 5‚Äì7 pp</li>
            <li><strong>Grid Constraints:</strong> Transmission bottlenecks could limit new capacity connections</li>
            <li><strong>Financing Challenges:</strong> Higher interest rates may slow investment pipeline</li>
            <li><strong>Resource Variability:</strong> Below-average wind/solar years impact generation</li>
        </ul>
    </div>

    <div class="info-box" style="border-left-color: #27ae60;">
        <h3 style="margin-top: 0; color: #27ae60;">Upside Opportunities</h3>
        <ul class="bullet-list">
            <li><strong>Technology Improvements:</strong> Higher capacity factors from newer equipment</li>
            <li><strong>Policy Support:</strong> Additional incentives could accelerate pipeline</li>
            <li><strong>Storage Cost Decline:</strong> Battery costs falling faster than projected</li>
            <li><strong>DPV Growth:</strong> Rooftop solar adoption exceeding forecasts</li>
        </ul>
    </div>
</div>

<!-- Monte Carlo Analysis -->
<div class="section-header">
    <h2>Monte Carlo Probability Analysis</h2>
</div>

<div class="info-box">
    <h3>Simulation Parameters</h3>
    <p>10,000 iterations with the following uncertainty distributions:</p>
    <ul class="bullet-list">
        <li><strong>Commissioning Probability:</strong> Based on facility status (Planned: 85%, Probable: 60%, Possible: 35%)</li>
        <li><strong>Commissioning Delay:</strong> Normal distribution, mean 6 months, std dev 4 months</li>
        <li><strong>Capacity Factor Variance:</strong> ¬±10% based on historical data</li>
        <li><strong>Consumption Growth:</strong> ¬±0.5% annual variation</li>
    </ul>
</div>

<div class="chart-container">
    <div id="monte_carlo_chart" style="height: 360px;"></div>
</div>

<table class="stats-table">
    <thead>
        <tr>
            <th>Target RE%</th>
            <th class="value">Probability of Achievement</th>
            <th>Assessment</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>80%</strong></td>
            <td class="value">92%</td>
            <td><span style="color: #27ae60;">Very Likely</span></td>
        </tr>
        <tr class="highlight-row">
            <td><strong>85%</strong></td>
            <td class="value">78%</td>
            <td><span style="color: #27ae60;">Likely</span></td>
        </tr>
        <tr>
            <td><strong>90%</strong></td>
            <td class="value">48%</td>
            <td><span style="color: #f39c12;">Possible</span></td>
        </tr>
        <tr>
            <td><strong>95%</strong></td>
            <td class="value">15%</td>
            <td><span style="color: #e74c3c;">Unlikely</span></td>
        </tr>
        <tr>
            <td><strong>100%</strong></td>
            <td class="value">5%</td>
            <td><span style="color: #e74c3c;">Very Unlikely</span></td>
        </tr>
    </tbody>
</table>

<!-- Recommendations -->
<div class="section-header">
    <h2>Recommendations</h2>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
    <div class="info-box">
        <h3>Target Confirmation</h3>
        <p><strong>Recommended 2040 Target:</strong> 100% Renewable Energy by 2040 (Underlying Consumption basis)</p>
        <ul class="bullet-list">
            <li>Achievable with Planned + Probable facilities</li>
            <li>78% probability of achievement based on Monte Carlo analysis</li>
            <li>Provides buffer above target in base case</li>
            <li>Aligns with current facility pipeline</li>
        </ul>
    </div>

    <div class="info-box">
        <h3>Priority Actions</h3>
        <ul class="bullet-list">
            <li><strong>Pipeline Management:</strong> Transition 3‚Äì4 Probable facilities to Planned status</li>
            <li><strong>Battery Storage:</strong> Current pipeline needs ~800 MW additional by 2028</li>
            <li><strong>Grid Investment:</strong> Identify transmission upgrades for new capacity zones</li>
            <li><strong>Interim Milestones:</strong> Establish 2027 and 2030 progress checkpoints</li>
        </ul>
    </div>
</div>

<!-- Footer -->
<div style="margin-top: 40px; padding: 20px; background: #ecf0f1; border-radius: 8px;">
    <p style="margin: 0;"><strong>Report Generated:</strong>
        {% if has_data %}Live data from SEN database{% else %}Example data ‚Äî no scenario projections in database{% endif %}
    </p>
    <p style="margin: 5px 0 0 0;">
        <strong><a href="mailto:modelling.lead@sen.asn.au">Contact SEN Modelling</a></strong>
    </p>
</div>

<style>
    .section-header {
        background: white;
        padding: 30px;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .section-header h2 {
        color: #1e3c72;
        border-bottom: 3px solid #4CAF50;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 1.8em;
    }
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .metric-sublabel { font-size: 0.85em; color: #95a5a6; margin-top: 8px; }
    .metric-change   { font-size: 0.9em;  color: #7f8c8d; margin-top: 8px; }
    .stats-table {
        width: 100%; border-collapse: collapse; margin: 20px 0;
        background: white; border-radius: 8px; overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stats-table thead { background: #34495e; color: white; }
    .stats-table th, .stats-table td { padding: 12px 15px; text-align: left; }
    .stats-table th.value, .stats-table td.value { text-align: right; }
    .stats-table tbody tr:nth-child(even) { background: #f8f9fa; }
    .stats-table tbody tr:hover { background: #e8f4f8; }
    .stats-table tfoot td { padding: 12px 15px; }
    .renewable-row  { background: #e8f5e9 !important; }
    .fossil-row     { background: #fafafa !important; }
    .info-row       { background: #e3f2fd !important; font-style: italic; }
    .highlight-row  { background: #e3f2fd !important; font-weight: 600; }
    .chart-container {
        background: white; padding: 20px; border-radius: 8px;
        margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    td.value.positive { color: #27ae60; }
    td.value.negative { color: #e74c3c; }
    @media print { .chart-container { break-inside: avoid; } }
</style>

<!-- Embed JSON data for charts -->
<script type="application/json" id="scenario-data-raw">{{ scenario_data_json }}</script>
<script type="application/json" id="historical-data-raw">{{ historical_data_json }}</script>
<script type="application/json" id="scenario-labels-raw">{{ scenario_labels_json }}</script>
<script type="application/json" id="scenario-colors-raw">{{ scenario_colors_json }}</script>
<script type="application/json" id="scenario-dash-raw">{{ scenario_dash_json }}</script>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>
<script>
// ‚îÄ‚îÄ Data from server ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const serverScenarioData  = JSON.parse(document.getElementById('scenario-data-raw').textContent);
const serverHistoricalData = JSON.parse(document.getElementById('historical-data-raw').textContent);
const SCENARIO_LABELS = JSON.parse(document.getElementById('scenario-labels-raw').textContent);
const SCENARIO_COLORS = JSON.parse(document.getElementById('scenario-colors-raw').textContent);
const SCENARIO_DASH   = JSON.parse(document.getElementById('scenario-dash-raw').textContent);
const hasData = {{ has_data|yesno:"true,false" }};

// ‚îÄ‚îÄ Fallback illustrative data (used when DB has no scenario projections) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcPcts(row) {
    const total = row.wind_gwh + row.solar_gwh + row.dpv_gwh + row.biomass_gwh;
    if (total > 0) {
        row.wind_pct    = row.re_pct * row.wind_gwh    / total;
        row.solar_pct   = row.re_pct * row.solar_gwh   / total;
        row.dpv_pct     = row.re_pct * row.dpv_gwh     / total;
        row.biomass_pct = row.re_pct * row.biomass_gwh / total;
        row.storage_pct = Math.max(0, row.re_pct - row.wind_pct - row.solar_pct - row.dpv_pct - row.biomass_pct);
    } else {
        row.wind_pct = row.solar_pct = row.dpv_pct = row.biomass_pct = row.storage_pct = 0;
    }
    return row;
}

const FALLBACK = {
    base_case: [
        {year:2025,re_pct:45.2,wind_gwh:4850,solar_gwh:2120,dpv_gwh:3400,biomass_gwh:50,  gas_gwh:10800,storage_mwh:850, operational_demand:19850,underlying_demand:23250,emissions_kt:5.42,probability:0, target_type:'ordinary'},
        {year:2027,re_pct:52.1,wind_gwh:5890,solar_gwh:3150,dpv_gwh:3920,biomass_gwh:80,  gas_gwh:9200, storage_mwh:1650,operational_demand:20600,underlying_demand:24520,emissions_kt:4.85,probability:0, target_type:'ordinary'},
        {year:2030,re_pct:65.2,wind_gwh:7850,solar_gwh:5120,dpv_gwh:4650,biomass_gwh:120, gas_gwh:7200, storage_mwh:3500,operational_demand:21420,underlying_demand:26070,emissions_kt:3.65,probability:0, target_type:'interim'},
        {year:2032,re_pct:71.5,wind_gwh:8920,solar_gwh:6480,dpv_gwh:5100,biomass_gwh:150, gas_gwh:5800, storage_mwh:4800,operational_demand:22100,underlying_demand:27200,emissions_kt:3.02,probability:0, target_type:'ordinary'},
        {year:2035,re_pct:78.3,wind_gwh:10250,solar_gwh:8150,dpv_gwh:5680,biomass_gwh:200,gas_gwh:4500, storage_mwh:6500,operational_demand:23150,underlying_demand:28830,emissions_kt:2.35,probability:0, target_type:'ordinary'},
        {year:2040,re_pct:86.7,wind_gwh:12450,solar_gwh:10820,dpv_gwh:6520,biomass_gwh:300,gas_gwh:2800,storage_mwh:9200,operational_demand:25080,underlying_demand:31600,emissions_kt:1.48,probability:78,target_type:'major'},
    ].map(calcPcts),
    accelerated_pipeline: [
        {year:2025,re_pct:50.0,wind_gwh:5200,solar_gwh:2500,dpv_gwh:3600,biomass_gwh:60,  gas_gwh:9800, storage_mwh:1000,operational_demand:19850,underlying_demand:23450,emissions_kt:5.10,probability:0, target_type:'ordinary'},
        {year:2027,re_pct:57.5,wind_gwh:6500,solar_gwh:3800,dpv_gwh:4200,biomass_gwh:100, gas_gwh:8000, storage_mwh:2200,operational_demand:20500,underlying_demand:24700,emissions_kt:4.40,probability:0, target_type:'ordinary'},
        {year:2030,re_pct:72.0,wind_gwh:9000,solar_gwh:6200,dpv_gwh:5000,biomass_gwh:150, gas_gwh:5500, storage_mwh:4500,operational_demand:21200,underlying_demand:26200,emissions_kt:3.10,probability:0, target_type:'interim'},
        {year:2032,re_pct:79.0,wind_gwh:10200,solar_gwh:7800,dpv_gwh:5500,biomass_gwh:200,gas_gwh:4200, storage_mwh:5800,operational_demand:21900,underlying_demand:27400,emissions_kt:2.50,probability:0, target_type:'ordinary'},
        {year:2035,re_pct:87.0,wind_gwh:12000,solar_gwh:10000,dpv_gwh:6200,biomass_gwh:280,gas_gwh:2800,storage_mwh:7500,operational_demand:22800,underlying_demand:29000,emissions_kt:1.80,probability:0, target_type:'ordinary'},
        {year:2040,re_pct:94.2,wind_gwh:15000,solar_gwh:13500,dpv_gwh:7000,biomass_gwh:400,gas_gwh:1000,storage_mwh:12000,operational_demand:24800,underlying_demand:31800,emissions_kt:0.80,probability:92,target_type:'major'},
    ].map(calcPcts),
    delayed_pipeline: [
        {year:2025,re_pct:40.0,wind_gwh:4200,solar_gwh:1800,dpv_gwh:3200,biomass_gwh:40,  gas_gwh:12000,storage_mwh:700, operational_demand:20000,underlying_demand:23200,emissions_kt:5.80,probability:0, target_type:'ordinary'},
        {year:2027,re_pct:46.0,wind_gwh:5000,solar_gwh:2600,dpv_gwh:3700,biomass_gwh:60,  gas_gwh:10500,storage_mwh:1200,operational_demand:20800,underlying_demand:24500,emissions_kt:5.30,probability:0, target_type:'ordinary'},
        {year:2030,re_pct:58.5,wind_gwh:6800,solar_gwh:4400,dpv_gwh:4300,biomass_gwh:90,  gas_gwh:8500, storage_mwh:2800,operational_demand:21600,underlying_demand:25900,emissions_kt:4.30,probability:0, target_type:'interim'},
        {year:2032,re_pct:64.0,wind_gwh:7800,solar_gwh:5500,dpv_gwh:4800,biomass_gwh:110, gas_gwh:7000, storage_mwh:4000,operational_demand:22300,underlying_demand:27100,emissions_kt:3.60,probability:0, target_type:'ordinary'},
        {year:2035,re_pct:70.5,wind_gwh:9000,solar_gwh:7000,dpv_gwh:5300,biomass_gwh:160, gas_gwh:5500, storage_mwh:5500,operational_demand:23400,underlying_demand:28700,emissions_kt:2.90,probability:0, target_type:'ordinary'},
        {year:2040,re_pct:79.5,wind_gwh:11000,solar_gwh:9500,dpv_gwh:6000,biomass_gwh:250, gas_gwh:3800,storage_mwh:8000,operational_demand:25300,underlying_demand:31300,emissions_kt:2.10,probability:45,target_type:'major'},
    ].map(calcPcts),
};
const FALLBACK_HISTORICAL = [
    {year:2023,re_pct:28.5,operational_demand:18900,underlying_demand:21800,emissions_kt:6.85},
    {year:2024,re_pct:32.3,operational_demand:19200,underlying_demand:22500,emissions_kt:6.42},
];

// Choose live data if available, otherwise fallback
const scenarioData  = (hasData && Object.keys(serverScenarioData).length > 0) ? serverScenarioData  : FALLBACK;
const historicalData = (serverHistoricalData && serverHistoricalData.length > 0) ? serverHistoricalData : FALLBACK_HISTORICAL;

let activeScenario = 'base_case';

// ‚îÄ‚îÄ Shared layout defaults ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BASE_LAYOUT = {
    plot_bgcolor: '#fafafa',
    paper_bgcolor: 'white',
    font: {family: "'Segoe UI', Tahoma, sans-serif"},
};

// ‚îÄ‚îÄ 1. RE% Trajectory Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRETrajectoryChart() {
    const traces = [];

    // Stacked area layers for the active scenario
    const sd = scenarioData[activeScenario];
    if (sd && sd.length) {
        const years = sd.map(d => d.year);
        const layers = [
            {name: 'Wind',              key: 'wind_pct',    color: '#42A5F5'},
            {name: 'Solar (Utility)',   key: 'solar_pct',   color: '#FFA726'},
            {name: 'DPV',               key: 'dpv_pct',     color: '#FFCA28'},
            {name: 'Storage Discharge', key: 'storage_pct', color: '#78909C'},
            {name: 'Other RE',          key: 'biomass_pct', color: '#66BB6A'},
        ];
        for (const L of layers) {
            traces.push({
                x: years,
                y: sd.map(d => d[L.key] || 0),
                name: L.name,
                type: 'scatter', mode: 'none',
                fill: 'tonexty',
                fillcolor: L.color + 'BB',
                stackgroup: 'mix',
                legendgroup: 'areas',
                hoverinfo: 'skip',
            });
        }
    }

    // RE% lines for all three scenarios
    for (const st of ['base_case', 'accelerated_pipeline', 'delayed_pipeline']) {
        const data = scenarioData[st];
        if (!data || !data.length) continue;
        traces.push({
            x: data.map(d => d.year),
            y: data.map(d => d.re_pct),
            name: SCENARIO_LABELS[st] || st,
            type: 'scatter', mode: 'lines+markers',
            line: {color: SCENARIO_COLORS[st], dash: SCENARIO_DASH[st], width: 2.5},
            marker: {size: 7},
            legendgroup: st,
            customdata: data,
            hovertemplate: '<b>%{x}: %{y:.1f}% RE</b><extra>' + (SCENARIO_LABELS[st] || st) + '</extra>',
        });
    }

    // Historical actual
    if (historicalData.length) {
        traces.push({
            x: historicalData.map(d => d.year),
            y: historicalData.map(d => d.re_pct),
            name: 'Actual (historical)',
            type: 'scatter', mode: 'lines+markers',
            line: {color: '#2c3e50', width: 3},
            marker: {size: 9},
            hovertemplate: '<b>%{x}: %{y:.1f}% RE (Actual)</b><extra></extra>',
        });
    }

    // Target milestones
    traces.push({
        x: [2025, 2030, 2040],
        y: [null,  82,  100],
        name: 'Target',
        type: 'scatter', mode: 'lines+markers',
        line: {color: '#e74c3c', dash: 'longdash', width: 2},
        marker: {size: 10, symbol: 'diamond', color: '#e74c3c'},
        hovertemplate: '<b>%{x}: %{y}% Target</b><extra></extra>',
    });

    // Vertical "current" marker
    const currentX = historicalData.length ? historicalData[historicalData.length - 1].year : 2024;
    const layout = Object.assign({}, BASE_LAYOUT, {
        xaxis: {
            title: 'Year',
            tickmode: 'array',
            tickvals: [2025, 2027, 2030, 2032, 2035, 2040],
            ticktext: ['2025','2027','2030','2032','2035','2040'],
            range: [2024, 2041],
            showgrid: true, gridcolor: '#ecf0f1',
        },
        yaxis: {
            title: 'RE% (Underlying Basis)',
            range: [0, 110], ticksuffix: '%',
            showgrid: true, gridcolor: '#ecf0f1',
        },
        legend: {orientation: 'h', y: -0.28, x: 0},
        margin: {t: 20, l: 65, r: 20, b: 120},
        hovermode: 'closest',
        shapes: [{
            type: 'line',
            x0: currentX, x1: currentX, y0: 0, y1: 110,
            line: {color: '#95a5a6', dash: 'dot', width: 1.5},
        }],
        annotations: [{
            x: currentX, y: 107,
            text: 'Current', showarrow: false,
            xanchor: 'center', font: {size: 11, color: '#95a5a6'},
        }],
    });

    Plotly.newPlot('re_trajectory_chart', traces, layout, {responsive: true, displayModeBar: false});

    // Hover ‚Üí update energy mix panel
    document.getElementById('re_trajectory_chart').on('plotly_hover', function(ev) {
        if (!ev.points || !ev.points.length) return;
        updateEnergyMixPanel(activeScenario, ev.points[0].x);
    });
}

// Update the hover panel on the right
function updateEnergyMixPanel(scenarioType, year) {
    const sd = scenarioData[scenarioType];
    if (!sd) return;
    const row = sd.find(d => d.year === year);
    if (!row) return;

    document.getElementById('mix_scenario').textContent = SCENARIO_LABELS[scenarioType] || scenarioType;
    document.getElementById('mix_scenario').style.color  = SCENARIO_COLORS[scenarioType] || '#333';
    document.getElementById('mix_year').textContent    = year;
    document.getElementById('mix_dpv').textContent     = Math.round(row.dpv_gwh).toLocaleString()     + ' GWh';
    document.getElementById('mix_solar').textContent   = Math.round(row.solar_gwh).toLocaleString()   + ' GWh';
    document.getElementById('mix_wind').textContent    = Math.round(row.wind_gwh).toLocaleString()    + ' GWh';
    document.getElementById('mix_storage').textContent = Math.round(row.storage_mwh).toLocaleString() + ' MWh';
    document.getElementById('mix_biomass').textContent = Math.round(row.biomass_gwh).toLocaleString() + ' GWh';
    document.getElementById('mix_re_pct').textContent  = row.re_pct.toFixed(1) + '%';
    document.getElementById('mix_demand').textContent  = Math.round(row.underlying_demand).toLocaleString() + ' GWh';
    document.getElementById('mix_hint').style.display  = 'none';
    document.getElementById('mix_table').style.display = '';
}

// Called by the scenario dropdown
function changeScenario(value) {
    activeScenario = value;
    renderRETrajectoryChart();
    const sd = scenarioData[value];
    if (sd && sd.length) updateEnergyMixPanel(value, sd[0].year);
}

// ‚îÄ‚îÄ 2. Generation Mix Stacked Bar Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGenerationMixChart() {
    const sd = scenarioData['base_case'] || [];
    if (!sd.length) return;
    const years = sd.map(d => d.year);

    const traces = [
        {x: years, y: sd.map(d => d.wind_gwh),    name: 'Wind',               type: 'bar', marker: {color: '#42A5F5'}},
        {x: years, y: sd.map(d => d.solar_gwh),   name: 'Solar (Utility)',    type: 'bar', marker: {color: '#FFA726'}},
        {x: years, y: sd.map(d => d.dpv_gwh),     name: 'DPV (Rooftop Solar)',type: 'bar', marker: {color: '#FFCA28'}},
        {x: years, y: sd.map(d => d.biomass_gwh), name: 'Biomass / Other RE', type: 'bar', marker: {color: '#66BB6A'}},
        {x: years, y: sd.map(d => d.gas_gwh),     name: 'Gas',                type: 'bar', marker: {color: '#EF5350'}},
    ];

    const layout = Object.assign({}, BASE_LAYOUT, {
        barmode: 'stack',
        xaxis: {title: 'Year', tickmode: 'array', tickvals: years},
        yaxis: {title: 'Generation (GWh)', tickformat: ',.0f'},
        legend: {orientation: 'h', y: -0.25},
        margin: {t: 20, l: 75, r: 20, b: 100},
    });

    Plotly.newPlot('generation_mix_chart', traces, layout, {responsive: true, displayModeBar: false});
}

// ‚îÄ‚îÄ 3. Consumption Growth Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderConsumptionChart() {
    const sd = scenarioData['base_case'] || [];
    if (!sd.length) return;

    const traces = [
        {
            x: sd.map(d => d.year), y: sd.map(d => d.underlying_demand),
            name: 'Underlying Demand (incl. DPV)', type: 'scatter', mode: 'lines+markers',
            line: {color: '#9b59b6', width: 2.5}, marker: {size: 7},
            fill: 'tozeroy', fillcolor: 'rgba(155,89,182,0.07)',
        },
        {
            x: sd.map(d => d.year), y: sd.map(d => d.operational_demand),
            name: 'Operational Demand (grid)', type: 'scatter', mode: 'lines+markers',
            line: {color: '#3498db', width: 2.5}, marker: {size: 7},
            fill: 'tozeroy', fillcolor: 'rgba(52,152,219,0.1)',
        },
    ];

    if (historicalData.length) {
        traces.push({
            x: historicalData.map(d => d.year),
            y: historicalData.map(d => d.underlying_demand || d.operational_demand),
            name: 'Actual Demand', type: 'scatter', mode: 'lines+markers',
            line: {color: '#2c3e50', width: 2, dash: 'dot'}, marker: {size: 8},
        });
    }

    const layout = Object.assign({}, BASE_LAYOUT, {
        xaxis: {title: 'Year', tickmode: 'array', tickvals: sd.map(d => d.year)},
        yaxis: {title: 'GWh', tickformat: ',.0f'},
        legend: {orientation: 'h', y: -0.25},
        margin: {t: 20, l: 75, r: 20, b: 100},
        hovermode: 'x unified',
    });

    Plotly.newPlot('consumption_chart', traces, layout, {responsive: true, displayModeBar: false});
}

// ‚îÄ‚îÄ 4. Emissions Reduction Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEmissionsChart() {
    const traces = [];
    for (const st of ['accelerated_pipeline', 'base_case', 'delayed_pipeline']) {
        const data = scenarioData[st];
        if (!data || !data.length) continue;
        traces.push({
            x: data.map(d => d.year),
            y: data.map(d => d.emissions_kt),
            name: SCENARIO_LABELS[st] || st,
            type: 'scatter', mode: 'lines+markers',
            line: {color: SCENARIO_COLORS[st], dash: SCENARIO_DASH[st], width: 2.5},
            marker: {size: 7},
            fill: st === 'base_case' ? 'tozeroy' : 'none',
            fillcolor: 'rgba(33,150,243,0.05)',
            hovertemplate: '<b>%{x}: %{y:.1f} kt CO‚ÇÇ-e</b><extra>' + (SCENARIO_LABELS[st] || st) + '</extra>',
        });
    }

    if (historicalData.length) {
        traces.push({
            x: historicalData.map(d => d.year),
            y: historicalData.map(d => d.emissions_kt),
            name: 'Actual Emissions', type: 'scatter', mode: 'lines+markers',
            line: {color: '#2c3e50', width: 2.5}, marker: {size: 9},
            hovertemplate: '<b>%{x}: %{y:.1f} kt CO‚ÇÇ-e (Actual)</b><extra></extra>',
        });
    }

    const layout = Object.assign({}, BASE_LAYOUT, {
        xaxis: {title: 'Year', showgrid: true, gridcolor: '#ecf0f1'},
        yaxis: {title: 'kt CO‚ÇÇ-e', tickformat: ',.0f', showgrid: true, gridcolor: '#ecf0f1'},
        legend: {orientation: 'h', y: -0.25},
        margin: {t: 20, l: 75, r: 20, b: 100},
        hovermode: 'x unified',
    });

    Plotly.newPlot('emissions_chart', traces, layout, {responsive: true, displayModeBar: false});
}

// ‚îÄ‚îÄ 5. Monte Carlo Probability Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMonteCarloChart() {
    const targets = ['80%', '85%', '90%', '95%', '100%'];
    const probs   = [92,     78,    48,    15,     5];
    const colors  = probs.map(p => p >= 70 ? '#27ae60' : p >= 40 ? '#f39c12' : '#e74c3c');

    const traces = [{
        x: targets, y: probs,
        type: 'bar',
        marker: {color: colors, line: {color: 'white', width: 1}},
        text: probs.map(p => p + '%'),
        textposition: 'auto',
        textfont: {color: 'white', size: 13, family: "'Segoe UI', sans-serif"},
        hovertemplate: 'Target %{x}: <b>%{y}%</b> probability of achievement<extra>Base Case</extra>',
        name: 'Base Case',
    }];

    const layout = Object.assign({}, BASE_LAYOUT, {
        xaxis: {title: 'Target RE% by 2040', tickfont: {size: 13}},
        yaxis: {title: 'Probability of Achievement (%)', range: [0, 105], ticksuffix: '%'},
        shapes: [{
            type: 'line', x0: -0.5, x1: 4.5, y0: 50, y1: 50,
            line: {color: '#bdc3c7', dash: 'dash', width: 1.5},
        }],
        annotations: [{
            x: 4.35, y: 53, xref: 'x', yref: 'y',
            text: '50% line', showarrow: false,
            font: {color: '#95a5a6', size: 11}, xanchor: 'right',
        }],
        margin: {t: 30, l: 70, r: 30, b: 60},
        bargap: 0.3,
        showlegend: false,
    });

    Plotly.newPlot('monte_carlo_chart', traces, layout, {responsive: true, displayModeBar: false});
}

// ‚îÄ‚îÄ Initialise all charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function () {
    renderRETrajectoryChart();
    renderGenerationMixChart();
    renderConsumptionChart();
    renderEmissionsChart();
    renderMonteCarloChart();

    // Populate energy mix panel with first base-case year on load
    const sd = scenarioData['base_case'];
    if (sd && sd.length) updateEnergyMixPanel('base_case', sd[0].year);
});
</script>
{% endblock %}
