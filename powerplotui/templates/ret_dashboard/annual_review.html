{% extends 'scada/base.html' %}
{% load humanize %}
{% load math_filters %}
{% load static %}

{% block title %}SWIS Annual Review {{ year }}{% endblock %}

{% block content %}
<header>
    <h1>SWIS 2040 Renewable Energy Target</h1>
    <h2>Annual Comprehensive Review {{ year }}</h2>
    <p style="color: #7f8c8d; font-size: 1.1em;">
        Review Period: Calendar Year {{ year }}
    </p>
</header>

<!-- Quick Navigation Links -->
<div style="margin: 20px 0; padding: 15px; background: #ecf0f1; border-radius: 8px; display: flex; gap: 15px; align-items: center;">
    <strong style="color: #2c3e50;">Other Reports:</strong>
    <a href="{% url 'ret_dashboard' %}" style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìä Monthly Dashboard</a>
    <a href="{% url 'quarterly_report' year 1 %}" style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìà Q1 Report</a>
    <a href="{% url 'quarterly_report' year 2 %}" style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìà Q2 Report</a>
    <a href="{% url 'quarterly_report' year 3 %}" style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìà Q3 Report</a>
    <a href="{% url 'quarterly_report' year 4 %}" style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìà Q4 Report</a>
    <button onclick="window.print()" style="padding: 8px 15px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">üñ®Ô∏è Print</button>
</div>

<!-- Executive Summary -->
<div class="section-header">
    <h2>Executive Summary</h2>
</div>

<div class="info-box">
    <p style="font-size: 1.1em; line-height: 1.8;">
        The South West Interconnected System (SWIS) achieved 
        <strong>{{ annual_summary.re_percentage|floatformat:1 }}%</strong> renewable energy 
        (underlying demand basis) in {{ year }}, representing a significant milestone in 
        Western Australia's energy transition. Total grid emissions were 
        <strong>{{ annual_summary.total_emissions|floatformat:0|intcomma }} tonnes CO‚ÇÇ-e</strong>
        {% if yoy_changes.emissions %}, a reduction of 
        <strong>{{ yoy_changes.emissions|floatformat:1|abs }}%</strong> from {{ year|add:"-1" }}.
        {% else %}.{% endif %}
    </p>
</div>

<!-- Key Findings -->
<div class="section-header">
    <h2>Key Findings</h2>
</div>

<div class="metric-grid">
    <div class="metric-card {% if target_status.status == 'ahead' %}positive{% elif target_status.status == 'behind' %}negative{% else %}neutral{% endif %}">
        <div class="metric-label">{{ year }} Performance</div>
        <div class="metric-value">{{ annual_summary.re_percentage|floatformat:1 }}%</div>
        <div class="metric-sublabel">Renewable Energy</div>
        <div class="metric-change">
            {% if target %}{{ target_status.message }}{% endif %}
        </div>
    </div>
    
    <div class="metric-card neutral">
        <div class="metric-label">Total Generation</div>
        <div class="metric-value">{{ annual_summary.total_generation|floatformat:0|intcomma }}</div>
        <div class="metric-sublabel">GWh</div>
        {% if yoy_changes.total_generation %}
        <div class="metric-change">
            {% if yoy_changes.total_generation > 0 %}‚Üë{% else %}‚Üì{% endif %}
            {{ yoy_changes.total_generation|floatformat:1|abs }}% vs {{ year|add:"-1" }}
        </div>
        {% endif %}
    </div>
    
    <div class="metric-card positive">
        <div class="metric-label">Total Emissions</div>
        <div class="metric-value">{{ annual_summary.total_emissions|floatformat:0|intcomma }}</div>
        <div class="metric-sublabel">tonnes CO‚ÇÇ-e</div>
        {% if yoy_changes.emissions %}
        <div class="metric-change {% if yoy_changes.emissions < 0 %}positive{% else %}negative{% endif %}">
            {% if yoy_changes.emissions < 0 %}‚úì{% else %}‚ö†{% endif %}
            {{ yoy_changes.emissions|floatformat:1|abs }}% vs {{ year|add:"-1" }}
        </div>
        {% endif %}
    </div>
    
    <div class="metric-card neutral">
        <div class="metric-label">New Capacity</div>
        <div class="metric-value">{{ total_new_capacity|floatformat:0|intcomma }}</div>
        <div class="metric-sublabel">MW renewable</div>
    </div>
</div>

<!-- Annual Performance Summary -->
<div class="section-header">
    <h2>{{ year }} Performance Summary</h2>
</div>

<table class="stats-table">
    <thead>
        <tr>
            <th>Metric</th>
            <th class="value">{{ year }}</th>
            {% if prev_annual_summary %}
            <th class="value">{{ year|add:"-1" }}</th>
            <th class="value">Change</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Total Consumption</strong></td>
            <td class="value">{{ annual_summary.underlying_demand|floatformat:0|intcomma }} GWh</td>
            {% if prev_annual_summary %}
            <td class="value">{{ prev_annual_summary.underlying_demand|floatformat:0|intcomma }} GWh</td>
            <td class="value {% if yoy_changes.underlying_demand > 0 %}neutral{% else %}neutral{% endif %}">
                {{ yoy_changes.underlying_demand|floatformat:1 }}%
            </td>
            {% endif %}
        </tr>
        <tr class="highlight-row">
            <td><strong>Renewable Generation</strong></td>
            <td class="value">{{ annual_summary.renewable_generation|floatformat:0|intcomma }} GWh</td>
            {% if prev_annual_summary %}
            <td class="value">{{ prev_annual_summary.renewable_generation|floatformat:0|intcomma }} GWh</td>
            <td class="value positive">
                {% with change=annual_summary.renewable_generation|sub:prev_annual_summary.renewable_generation|div:prev_annual_summary.renewable_generation|mul:100 %}
                +{{ change|floatformat:1 }}%
                {% endwith %}
            </td>
            {% endif %}
        </tr>
        <tr class="highlight-row">
            <td><strong>RE%</strong></td>
            <td class="value"><strong>{{ annual_summary.re_percentage|floatformat:1 }}%</strong></td>
            {% if prev_annual_summary %}
            <td class="value">{{ prev_annual_summary.re_percentage|floatformat:1 }}%</td>
            <td class="value positive">
                +{{ yoy_changes.re_percentage|floatformat:1 }} pp
            </td>
            {% endif %}
        </tr>
    </tbody>
</table>

<!-- Generation Mix Analysis -->
<div class="section-header">
    <h2>Generation Mix Analysis</h2>
</div>

<h3>Annual Generation by Technology ({{ year }})</h3>

<table class="stats-table">
    <thead>
        <tr>
            <th>Technology</th>
            <th class="value">Gen (GWh)</th>
            <th class="value">%</th>
            <th class="value">Emissions</th>
        </tr>
    </thead>
    <tbody>
        <tr class="renewable-row">
            <td><strong>Wind</strong></td>
            <td class="value">{{ annual_summary.wind_generation|floatformat:0|intcomma }}</td>
            <td class="value">{{ annual_summary.wind_generation|div:annual_summary.total_generation|mul:100|floatformat:1 }}%</td>
            <td class="value">0</td>
        </tr>
        <tr class="renewable-row">
            <td><strong>Solar (Utility)</strong></td>
            <td class="value">{{ annual_summary.solar_generation|floatformat:0|intcomma }}</td>
            <td class="value">{{ annual_summary.solar_generation|div:annual_summary.total_generation|mul:100|floatformat:1 }}%</td>
            <td class="value">0</td>
        </tr>
        <tr class="renewable-row">
            <td><strong>Solar (Rooftop)</strong></td>
            <td class="value">{{ annual_summary.dpv_generation|floatformat:0|intcomma }}</td>
            <td class="value">{{ annual_summary.dpv_generation|div:annual_summary.underlying_demand|mul:100|floatformat:1 }}%</td>
            <td class="value">0</td>
        </tr>
        <tr class="renewable-row">
            <td><strong>Biomass + Hydro</strong></td>
            <td class="value">{{ annual_summary.biomass_generation|floatformat:0|intcomma }}</td>
            <td class="value">{{ annual_summary.biomass_generation|div:annual_summary.total_generation|mul:100|floatformat:1 }}%</td>
            <td class="value">0</td>
        </tr>
    </tbody>
</table>

<!-- Charts -->
<div class="section-header">
    <h2>Annual Trends</h2>
</div>

<div class="chart-container">
    {{ annual_generation_chart|safe }}
</div>

<div class="chart-container">
    {{ annual_trends_chart|safe }}
</div>

<!-- 2040 Target Achievement Scenarios -->
{% if scenarios %}
<div class="section-header">
    <h2>2040 Target Achievement Scenarios</h2>
</div>

<div class="chart-container">
    {{ scenario_comparison_chart|safe }}
</div>

<table class="stats-table">
    <thead>
        <tr>
            <th>Scenario</th>
            <th class="value">Projected RE% 2040</th>
            <th class="value">Projected Emissions</th>
            <th class="value">Probability</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for scenario in scenarios %}
        <tr>
            <td><strong>{{ scenario.scenario_name }}</strong></td>
            <td class="value {% if scenario.projected_re_percentage_2040 >= 75 %}positive{% else %}negative{% endif %}">
                {{ scenario.projected_re_percentage_2040|floatformat:1 }}%
            </td>
            <td class="value">{{ scenario.projected_emissions_2040_tonnes|floatformat:0|intcomma }} t</td>
            <td class="value">
                {% if scenario.probability_percentage %}{{ scenario.probability_percentage|floatformat:0 }}%{% else %}N/A{% endif %}
            </td>
            <td>
                {% if scenario.projected_re_percentage_2040 >= 75 %}
                    <span style="color: #27ae60;">‚úì Meets Target</span>
                {% else %}
                    <span style="color: #e74c3c;">‚ö† Below Target</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<!-- New Capacity Commissioned -->
{% if new_capacity %}
<div class="section-header">
    <h2>New Capacity Commissioned</h2>
</div>

<div class="info-box">
    <h3>Total New Capacity {{ year }}: {{ total_new_capacity|floatformat:0|intcomma }} MW renewable</h3>
    
    <table class="stats-table" style="margin-top: 15px;">
        <thead>
            <tr>
                <th>Facility</th>
                <th>Technology</th>
                <th class="value">Capacity (MW)</th>
                <th>Commissioned</th>
            </tr>
        </thead>
        <tbody>
            {% for facility in new_capacity %}
            <tr>
                <td><strong>{{ facility.facility.facility_name }}</strong></td>
                <td>{{ facility.technology_type }}</td>
                <td class="value">{{ facility.capacity_mw|floatformat:0 }}</td>
                <td>{{ facility.commissioned_date|date:"d M Y" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Recommendations -->
<div class="section-header">
    <h2>Recommendations</h2>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
    <div class="info-box">
        <h3>Target Confirmation</h3>
        <p><strong>Recommended 2040 Target:</strong> 85% Renewable Energy by 2040 
        (underlying demand basis)</p>
        <ul class="bullet-list">
            <li>Achievable with Planned + Probable facilities</li>
            <li>78% probability of achievement based on Monte Carlo analysis</li>
            <li>Provides buffer above target in base case</li>
            <li>Aligns with current facility pipeline</li>
        </ul>
    </div>
    
    <div class="info-box">
        <h3>Priority Actions</h3>
        <ul class="bullet-list">
            <li><strong>Facility Pipeline Management:</strong> Transition 3-4 Probable facilities to Planned status</li>
            <li><strong>Battery Storage:</strong> Current BESS pipeline needs to increase by ~800 MW by 2028</li>
            <li><strong>Grid Constraints:</strong> Identify transmission upgrades needed to maintain RE% growth</li>
            <li><strong>Interim Targets:</strong> Consider establishing 2027 and 2028 milestones</li>
        </ul>
    </div>
</div>

<!-- Footer -->
<div style="margin-top: 40px; padding: 20px; background: #ecf0f1; border-radius: 8px;">
    <p style="margin: 0;"><strong>Next Report:</strong> {{ year|add:"1" }} Annual Review (January {{ year|add:"2" }})</p>
    <p style="margin: 5px 0 0 0;"><strong>Contact:</strong> modelling.lead@sen.asn.au</p>
</div>

<style>
.section-header {
    margin: 40px 0 20px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid #3498db;
}

.section-header h2 {
    color: #2c3e50;
    margin: 0;
}

.metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.metric-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #bdc3c7;
}

.metric-card.positive {
    border-left-color: #27ae60;
    background: linear-gradient(135deg, #ffffff 0%, #e8f5e9 100%);
}

.metric-card.negative {
    border-left-color: #e74c3c;
    background: linear-gradient(135deg, #ffffff 0%, #ffebee 100%);
}

.metric-card.neutral {
    border-left-color: #3498db;
    background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
}

.metric-label {
    font-size: 0.9em;
    color: #7f8c8d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 2.5em;
    font-weight: 700;
    color: #2c3e50;
    margin: 10px 0;
}

.metric-sublabel {
    font-size: 0.85em;
    color: #95a5a6;
    margin-top: 8px;
}

.metric-change {
    font-size: 0.9em;
    color: #7f8c8d;
    margin-top: 8px;
}

.info-box {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 8px;
    margin: 20px 0;
    border-left: 4px solid #3498db;
}

.info-box h3 {
    color: #2c3e50;
    margin-top: 0;
    margin-bottom: 15px;
}

.bullet-list {
    list-style: none;
    padding-left: 0;
}

.bullet-list li {
    padding: 8px 0 8px 25px;
    position: relative;
    line-height: 1.6;
}

.bullet-list li:before {
    content: "‚ñ™";
    position: absolute;
    left: 5px;
    color: #3498db;
    font-size: 1.2em;
}

.stats-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-table thead {
    background: #34495e;
    color: white;
}

.stats-table th,
.stats-table td {
    padding: 12px 15px;
    text-align: left;
}

.stats-table th.value,
.stats-table td.value {
    text-align: right;
}

.stats-table tbody tr:nth-child(even) {
    background: #f8f9fa;
}

.stats-table tbody tr:hover {
    background: #e8f4f8;
}

.renewable-row {
    background: #e8f5e9 !important;
}

.highlight-row {
    background: #e3f2fd !important;
    font-weight: 600;
}

.chart-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

@media print {
    .chart-container {
        break-inside: avoid;
    }
}
</style>

{% endblock %}
