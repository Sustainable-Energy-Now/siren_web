<!-- templates/ret_dashboard/targets.html -->
{% extends 'scada/base.html' %}
{% load humanize %}

{% block title %}Renewable Energy Targets - SWIS{% endblock %}

{% block content %}
<header>
    <h1>Renewable Energy Targets</h1>
    <p style="color: #7f8c8d; font-size: 1.1em;">
        Manage RE% targets and 2040 demand projections
    </p>
</header>

<!-- Navigation Links -->
<div style="margin: 20px 0; padding: 15px; background: #ecf0f1; border-radius: 8px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
    <strong style="color: #2c3e50;">Navigation:</strong>
    <a href="{% url 'ret_dashboard' %}" style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìä Dashboard</a>
    <a href="#targets-section" style="color: #27ae60; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üéØ Targets</a>
    <a href="#scenarios-section" style="color: #9b59b6; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìà Scenarios</a>
</div>

<!-- Scenario Type Selector -->
<div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
    <strong style="color: #2c3e50;">View Scenario Type:</strong>
    <select id="scenario-type-selector" onchange="window.location.href='?scenario_type=' + this.value"
            style="padding: 8px 15px; margin-left: 10px; border-radius: 4px; border: 1px solid #ced4da; font-size: 1em; cursor: pointer;">
        {% for type_value, type_label in scenario_type_choices %}
        <option value="{{ type_value }}" {% if type_value == selected_scenario_type %}selected{% endif %}>
            {{ type_label }}
        </option>
        {% endfor %}
    </select>
    <span style="margin-left: 15px; color: #6c757d; font-style: italic;">
        Currently showing: <strong style="color: #2c3e50;">{{ selected_scenario_type_display }}</strong>
    </span>
</div>

<!-- Messages -->
{% if messages %}
<div style="margin: 20px 0;">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}" style="padding: 15px; border-radius: 8px; margin-bottom: 10px; 
        {% if message.tags == 'success' %}background: #d4edda; border-left: 4px solid #27ae60; color: #155724;
        {% elif message.tags == 'error' %}background: #f8d7da; border-left: 4px solid #e74c3c; color: #721c24;
        {% else %}background: #d1ecf1; border-left: 4px solid #3498db; color: #0c5460;{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Key Milestones Summary -->
<div class="section-header">
    <h2>Key Milestones</h2>
</div>

<div class="metric-grid">
    {% for milestone in milestones %}
    <div class="metric-card {% if milestone.target_type == 'interim' %}neutral{% else %}positive{% endif %}">
        <div class="metric-label">{{ milestone.year }} Target</div>
        <div class="metric-value">{{ milestone.target_re_percentage|floatformat:0 }}%</div>
        <div class="metric-sublabel">
            {{ milestone.get_target_type_display }}
        </div>
        {% if milestone.target_emissions_tonnes %}
        <div class="metric-change">{{ milestone.target_emissions_tonnes|floatformat:0|intcomma }} t CO‚ÇÇ-e</div>
        {% endif %}
    </div>
    {% empty %}
    <div class="info-box">
        <p>No milestone targets defined. Add targets for 2030, 2035, and 2040 below.</p>
    </div>
    {% endfor %}
</div>

<!-- =================================================================== -->
<!-- Renewable Energy Targets Section -->
<!-- =================================================================== -->

<div class="section-header" id="targets-section">
    <h2>RE Percentage Targets by Year</h2>
</div>

<!-- Add New Target/Scenario Button -->
<div style="margin-bottom: 20px;">
    <button onclick="toggleModal('add-scenario-modal')" class="btn btn-primary">
        + Add New Target/Scenario
    </button>
</div>

<!-- Targets Table -->
<div class="info-box">
    <table class="stats-table">
        <thead>
            <tr>
                <th>Year</th>
                <th>Scenario</th>
                <th class="value">Operational<br>(GWh)</th>
                <th class="value">Underlying<br>(GWh)</th>
                <th class="value">RE Target<br>(%)</th>
                <th class="value">Emissions<br>(t CO‚ÇÇ-e)</th>
                <th>Description</th>
                <th class="value">Type</th>
                <th class="value">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for target in targets %}
            <tr class="{% if target.year == 2030 or target.year == 2040 %}renewable-row{% endif %}">
                <td><strong>{{ target.year }}</strong></td>
                <td>{{ target.scenario_name }}</td>
                <td class="value">
                    {% if target.operational_demand %}
                        {{ target.operational_demand|floatformat:0|intcomma }}
                    {% else %}
                        <span style="color: #adb5bd;">‚Äî</span>
                    {% endif %}
                </td>
                <td class="value">
                    {% if target.underlying_demand %}
                        {{ target.underlying_demand|floatformat:0|intcomma }}
                    {% else %}
                        <span style="color: #adb5bd;">‚Äî</span>
                    {% endif %}
                </td>
                <td class="value"><strong>{{ target.target_re_percentage|floatformat:1 }}%</strong></td>
                <td class="value">
                    {% if target.target_emissions_tonnes %}
                        {{ target.target_emissions_tonnes|floatformat:0|intcomma }}
                    {% else %}
                        <span style="color: #adb5bd;">‚Äî</span>
                    {% endif %}
                </td>
                <td style="max-width: 200px;">{{ target.description|default:"‚Äî"|truncatewords:10 }}</td>
                <td class="value">
                    {% if target.target_type == 'major' %}
                        <span class="badge badge-success">Major</span>
                    {% elif target.target_type == 'interim' %}
                        <span class="badge badge-info">Interim</span>
                    {% else %}
                        <span class="badge badge-secondary">Ordinary</span>
                    {% endif %}
                </td>
                <td class="value" style="white-space: nowrap;">
                    <button onclick="viewScenarioDetail({{ target.id }})"
                            class="btn btn-small btn-view" title="View Details"
                            style="background: #17a2b8; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-right: 3px;">üëÅÔ∏è</button>
                    <button onclick="editScenario({{ target.id }})"
                            class="btn btn-small btn-edit" title="Edit">‚úèÔ∏è</button>
                    {% if target.scenario_type != 'base_case' %}
                    <button onclick="confirmDeleteScenario({{ target.id }}, '{{ target.scenario_name|escapejs }}')"
                            class="btn btn-small btn-delete" title="Delete">üóëÔ∏è</button>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" style="text-align: center; padding: 30px; color: #7f8c8d;">
                    No targets defined yet. Click "Add New Target/Scenario" to create one.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- =================================================================== -->
<!-- Modals -->
<!-- =================================================================== -->

<!-- Add/Edit Scenario Modal -->
<div id="add-scenario-modal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Add New Scenario</h3>
            <button onclick="toggleModal('add-scenario-modal')" class="modal-close">&times;</button>
        </div>
        <form action="{% url 'scenario_create' %}" method="post">
            {% csrf_token %}
            <div class="form-row">
                <div class="form-group">
                    <label for="scenario_name">Scenario Name *</label>
                    <input type="text" name="scenario_name" id="scenario_name" required
                           placeholder="e.g., Base Case 2024">
                </div>
                <div class="form-group">
                    <label for="scenario_type">Scenario Type *</label>
                    <select name="scenario_type" id="scenario_type" required>
                        {% for value, label in scenario_type_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="year">Target Year *</label>
                    <input type="number" name="year" id="year" required
                           min="2020" max="2100" value="2040" placeholder="e.g., 2040">
                </div>
                <div class="form-group">
                    <label for="target_type">Target Type *</label>
                    <select name="target_type" id="target_type" required>
                        {% for value, label in target_type_choices %}
                        <option value="{{ value }}" {% if value == 'ordinary' %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="scenario">SIREN Scenario</label>
                    <select name="scenario" id="scenario">
                        <option value="">-- Not linked --</option>
                        {% for s in siren_scenarios %}
                        <option value="{{ s.idscenarios }}">{{ s.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="scenario_description">Description</label>
                    <textarea name="description" id="scenario_description" rows="2"
                              placeholder="Describe the assumptions for this scenario"></textarea>
                </div>
            </div>
            
            <h4 style="margin: 20px 0 15px; color: #2c3e50; border-bottom: 1px solid #ecf0f1; padding-bottom: 10px;">
                Demand & Storage
            </h4>

            <div class="form-row form-row-3">
                <div class="form-group">
                    <label for="operational_demand">Operational Demand (GWh)</label>
                    <input type="number" name="operational_demand" id="operational_demand"
                           min="0" step="0.1" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="underlying_demand">Underlying Demand (GWh)</label>
                    <input type="number" name="underlying_demand" id="underlying_demand"
                           min="0" step="0.1" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="storage">Storage (MWh)</label>
                    <input type="number" name="storage" id="storage"
                           min="0" step="0.1" placeholder="Optional">
                </div>
            </div>

            <h4 style="margin: 20px 0 15px; color: #2c3e50; border-bottom: 1px solid #ecf0f1; padding-bottom: 10px;">
                RE Target & Emissions
            </h4>

            <div class="form-row">
                <div class="form-group">
                    <label for="target_re_percentage">Target/Projected RE% *</label>
                    <input type="number" name="target_re_percentage" id="target_re_percentage"
                           required min="0" max="100" step="0.1" placeholder="e.g., 85">
                </div>
                <div class="form-group">
                    <label for="target_emissions_tonnes">Target/Projected Emissions (t)</label>
                    <input type="number" name="target_emissions_tonnes" id="target_emissions_tonnes"
                           min="0" step="1" placeholder="Optional">
                </div>
            </div>
            
            <h4 style="margin: 20px 0 15px; color: #2c3e50; border-bottom: 1px solid #ecf0f1; padding-bottom: 10px;">
                Generation Mix (GWh)
            </h4>
            
            <div class="form-row form-row-3">
                <div class="form-group">
                    <label for="wind_generation">Wind</label>
                    <input type="number" name="wind_generation" id="wind_generation" 
                           min="0" step="1" value="0">
                </div>
                <div class="form-group">
                    <label for="solar_generation">Solar (Utility)</label>
                    <input type="number" name="solar_generation" id="solar_generation" 
                           min="0" step="1" value="0">
                </div>
                <div class="form-group">
                    <label for="dpv_generation">Solar (Rooftop)</label>
                    <input type="number" name="dpv_generation" id="dpv_generation" 
                           min="0" step="1" value="0">
                </div>
            </div>
            <div class="form-row form-row-3">
                <div class="form-group">
                    <label for="biomass_generation">Biomass</label>
                    <input type="number" name="biomass_generation" id="biomass_generation" 
                           min="0" step="1" value="0">
                </div>
                <div class="form-group">
                    <label for="gas_generation">Gas</label>
                    <input type="number" name="gas_generation" id="gas_generation" 
                           min="0" step="1" value="0">
                </div>
                <div class="form-group">
                    <label for="probability_percentage">Probability (%)</label>
                    <input type="number" name="probability_percentage" id="probability_percentage" 
                           min="0" max="100" step="1" placeholder="Optional">
                </div>
            </div>
            
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="is_active" checked>
                    Scenario is active
                </label>
            </div>
            
            <div class="modal-actions">
                <button type="button" onclick="toggleModal('add-scenario-modal')" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Scenario</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Scenario Modal -->
<div id="edit-scenario-modal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Edit Scenario</h3>
            <button onclick="toggleModal('edit-scenario-modal')" class="modal-close">&times;</button>
        </div>
        <form id="edit-scenario-form" method="post">
            {% csrf_token %}
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_scenario_name">Scenario Name *</label>
                    <input type="text" name="scenario_name" id="edit_scenario_name" required>
                </div>
                <div class="form-group">
                    <label for="edit_scenario_type">Scenario Type *</label>
                    <select name="scenario_type" id="edit_scenario_type" required>
                        {% for value, label in scenario_type_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="edit_year">Target Year *</label>
                    <input type="number" name="year" id="edit_year" required
                           min="2020" max="2100" placeholder="e.g., 2040">
                </div>
                <div class="form-group">
                    <label for="edit_target_type">Target Type *</label>
                    <select name="target_type" id="edit_target_type" required>
                        {% for value, label in target_type_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="edit_scenario">SIREN Scenario</label>
                    <select name="scenario" id="edit_scenario">
                        <option value="">-- Not linked --</option>
                        {% for s in siren_scenarios %}
                        <option value="{{ s.idscenarios }}">{{ s.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_scenario_description">Description</label>
                    <textarea name="description" id="edit_scenario_description" rows="2"></textarea>
                </div>
            </div>

            <h4 style="margin: 20px 0 15px; color: #2c3e50; border-bottom: 1px solid #ecf0f1; padding-bottom: 10px;">
                Demand & Storage
            </h4>

            <div class="form-row form-row-3">
                <div class="form-group">
                    <label for="edit_operational_demand">Operational Demand (GWh)</label>
                    <input type="number" name="operational_demand" id="edit_operational_demand"
                           min="0" step="0.1">
                </div>
                <div class="form-group">
                    <label for="edit_underlying_demand">Underlying Demand (GWh)</label>
                    <input type="number" name="underlying_demand" id="edit_underlying_demand"
                           min="0" step="0.1">
                </div>
                <div class="form-group">
                    <label for="edit_storage">Storage (MWh)</label>
                    <input type="number" name="storage" id="edit_storage"
                           min="0" step="0.1">
                </div>
            </div>


            <h4 style="margin: 20px 0 15px; color: #2c3e50; border-bottom: 1px solid #ecf0f1; padding-bottom: 10px;">
                RE Target & Emissions
            </h4>

            <div class="form-row">
                <div class="form-group">
                    <label for="edit_target_re_percentage">Target/Projected RE% *</label>
                    <input type="number" name="target_re_percentage" id="edit_target_re_percentage"
                           required min="0" max="100" step="0.1">
                </div>
                <div class="form-group">
                    <label for="edit_target_emissions_tonnes">Target/Projected Emissions (t)</label>
                    <input type="number" name="target_emissions_tonnes" id="edit_target_emissions_tonnes"
                           min="0" step="1">
                </div>
            </div>
            
            <h4 style="margin: 20px 0 15px; color: #2c3e50; border-bottom: 1px solid #ecf0f1; padding-bottom: 10px;">
                Generation Mix (GWh)
            </h4>
            
            <div class="form-row form-row-3">
                <div class="form-group">
                    <label for="edit_wind_generation">Wind</label>
                    <input type="number" name="wind_generation" id="edit_wind_generation" min="0" step="1">
                </div>
                <div class="form-group">
                    <label for="edit_solar_generation">Solar (Utility)</label>
                    <input type="number" name="solar_generation" id="edit_solar_generation" min="0" step="1">
                </div>
                <div class="form-group">
                    <label for="edit_dpv_generation">Solar (Rooftop)</label>
                    <input type="number" name="dpv_generation" id="edit_dpv_generation" min="0" step="1">
                </div>
            </div>
            <div class="form-row form-row-3">
                <div class="form-group">
                    <label for="edit_biomass_generation">Biomass</label>
                    <input type="number" name="biomass_generation" id="edit_biomass_generation" min="0" step="1">
                </div>
                <div class="form-group">
                    <label for="edit_gas_generation">Gas</label>
                    <input type="number" name="gas_generation" id="edit_gas_generation" min="0" step="1">
                </div>
                <div class="form-group">
                    <label for="edit_probability_percentage">Probability (%)</label>
                    <input type="number" name="probability_percentage" id="edit_probability_percentage" 
                           min="0" max="100" step="1">
                </div>
            </div>
            
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="is_active" id="edit_is_active">
                    Scenario is active
                </label>
            </div>
            
            <div class="modal-actions">
                <button type="button" onclick="toggleModal('edit-scenario-modal')" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Scenario Confirmation Modal -->
<div id="delete-scenario-modal" class="modal" style="display: none;">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h3>Confirm Delete</h3>
            <button onclick="toggleModal('delete-scenario-modal')" class="modal-close">&times;</button>
        </div>
        <p>Are you sure you want to delete the scenario "<strong id="delete-scenario-name"></strong>"?</p>
        <p style="color: #e74c3c; font-size: 0.9em;">This action cannot be undone.</p>
        <form id="delete-scenario-form" method="post">
            {% csrf_token %}
            <div class="modal-actions">
                <button type="button" onclick="toggleModal('delete-scenario-modal')" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete Scenario</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Base styles matching dashboard.html */
.section-header {
    margin: 40px 0 20px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid #3498db;
}

.section-header h2 {
    color: #2c3e50;
    margin: 0;
}

.metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.metric-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #bdc3c7;
}

.metric-card.positive {
    border-left-color: #27ae60;
    background: linear-gradient(135deg, #ffffff 0%, #e8f5e9 100%);
}

.metric-card.neutral {
    border-left-color: #3498db;
    background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
}

.metric-label {
    font-size: 0.9em;
    color: #7f8c8d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 2.5em;
    font-weight: 700;
    color: #2c3e50;
    margin: 10px 0;
}

.metric-sublabel {
    font-size: 0.85em;
    color: #95a5a6;
    margin-top: 8px;
}

.metric-change {
    font-size: 0.9em;
    color: #7f8c8d;
    margin-top: 8px;
}

.info-box {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 8px;
    margin: 20px 0;
    border-left: 4px solid #3498db;
}

.stats-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-table thead {
    background: #34495e;
    color: white;
}

.stats-table th,
.stats-table td {
    padding: 12px 15px;
    text-align: left;
}

.stats-table th.value,
.stats-table td.value {
    text-align: right;
}

.stats-table tbody tr:nth-child(even) {
    background: #f8f9fa;
}

.stats-table tbody tr:hover {
    background: #e8f4f8;
}

.renewable-row {
    background: #e8f5e9 !important;
}

/* Buttons */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 1em;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-success {
    background: #27ae60;
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-warning {
    background: #f39c12;
    color: white;
}

.btn-warning:hover {
    background: #d68910;
}

.btn-small {
    padding: 5px 10px;
    font-size: 0.85em;
}

.btn-edit {
    background: #3498db;
    color: white;
}

.btn-delete {
    background: #e74c3c;
    color: white;
}

/* Badges */
.badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 600;
}

.badge-success {
    background: #27ae60;
    color: white;
}

.badge-info {
    background: #3498db;
    color: white;
}

/* Scenario Cards */
.scenario-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
    margin: 20px 0;
}

.scenario-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
}

.scenario-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.scenario-card.inactive {
    opacity: 0.7;
    background: #f5f5f5;
}

.scenario-card.meets-target {
    border-top: 4px solid #27ae60;
}

.scenario-card.below-target {
    border-top: 4px solid #e74c3c;
}

.scenario-header {
    padding: 20px;
    background: #34495e;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.scenario-header h3 {
    margin: 0;
    font-size: 1.2em;
    color: white;
}

.scenario-type-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75em;
    font-weight: 600;
    text-transform: uppercase;
}

.scenario-type-badge.base_case {
    background: #3498db;
}

.scenario-type-badge.high_electrification {
    background: #9b59b6;
}

.scenario-type-badge.delayed_pipeline {
    background: #e67e22;
}

.scenario-type-badge.accelerated_pipeline {
    background: #27ae60;
}

.scenario-main-stat {
    padding: 25px;
    text-align: center;
    background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
}

.scenario-main-stat .stat-value {
    font-size: 3em;
    font-weight: 700;
    color: #2c3e50;
    display: block;
}

.scenario-main-stat .stat-label {
    font-size: 0.9em;
    color: #7f8c8d;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.scenario-status {
    padding: 12px 20px;
    text-align: center;
    font-weight: 600;
    font-size: 0.95em;
}

.scenario-card.meets-target .scenario-status {
    background: #e8f5e9;
    color: #27ae60;
}

.scenario-card.below-target .scenario-status {
    background: #ffebee;
    color: #e74c3c;
}

.scenario-details {
    padding: 20px;
    border-top: 1px solid #ecf0f1;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f5f5f5;
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-row.total {
    font-weight: 600;
    background: #f8f9fa;
    margin: 10px -20px;
    padding: 10px 20px;
}

.detail-label {
    color: #7f8c8d;
}

.detail-value {
    color: #2c3e50;
    font-weight: 500;
}

.scenario-description {
    padding: 15px 20px;
    background: #f8f9fa;
    color: #7f8c8d;
    font-size: 0.9em;
    border-top: 1px solid #ecf0f1;
}

.scenario-actions {
    padding: 15px 20px;
    background: #ecf0f1;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.scenario-meta {
    padding: 10px 20px;
    background: #f8f9fa;
    color: #95a5a6;
    font-size: 0.8em;
    text-align: right;
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.modal-content.modal-large {
    max-width: 700px;
}

.modal-content.modal-small {
    max-width: 400px;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #ecf0f1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #34495e;
    color: white;
    border-radius: 12px 12px 0 0;
}

.modal-header h3 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5em;
    color: white;
    cursor: pointer;
    padding: 0;
    line-height: 1;
}

.modal-close:hover {
    color: #ecf0f1;
}

.modal-content form {
    padding: 25px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c3e50;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #bdc3c7;
    border-radius: 6px;
    font-size: 1em;
    transition: border-color 0.3s;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    border-color: #3498db;
    outline: none;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.form-row-3 {
    grid-template-columns: 1fr 1fr 1fr;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-weight: normal;
}

.checkbox-group input[type="checkbox"] {
    width: auto;
}

.modal-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    padding-top: 15px;
    border-top: 1px solid #ecf0f1;
    margin-top: 20px;
}

/* Responsive */
@media (max-width: 768px) {
    .form-row,
    .form-row-3 {
        grid-template-columns: 1fr;
    }
    
    .scenario-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        margin: 10px;
        max-height: 85vh;
    }
}
</style>

<script>
// Modal toggle function
function toggleModal(modalId) {
    var modal = document.getElementById(modalId);
    if (modal.style.display === 'none' || modal.style.display === '') {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    } else {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
});

// Edit Scenario function
function editScenario(id) {
    // Fetch scenario data via API
    fetch('/api/ret_dashboard/scenarios/' + id + '/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit_scenario_name').value = data.scenario_name;
            document.getElementById('edit_scenario_type').value = data.scenario_type;
            document.getElementById('edit_year').value = data.year || 2040;
            document.getElementById('edit_target_type').value = data.target_type || 'ordinary';
            document.getElementById('edit_scenario').value = data.scenario_id || '';
            document.getElementById('edit_scenario_description').value = data.description || '';
            document.getElementById('edit_operational_demand').value = data.operational_demand || '';
            document.getElementById('edit_underlying_demand').value = data.underlying_demand || '';
            document.getElementById('edit_storage').value = data.storage || '';
            document.getElementById('edit_target_re_percentage').value = data.target_re_percentage;
            document.getElementById('edit_target_emissions_tonnes').value = data.target_emissions_tonnes || '';
            document.getElementById('edit_wind_generation').value = data.wind_generation;
            document.getElementById('edit_solar_generation').value = data.solar_generation;
            document.getElementById('edit_dpv_generation').value = data.dpv_generation;
            document.getElementById('edit_biomass_generation').value = data.biomass_generation;
            document.getElementById('edit_gas_generation').value = data.gas_generation;
            document.getElementById('edit_probability_percentage').value = data.probability_percentage || '';
            document.getElementById('edit_is_active').checked = data.is_active;
            document.getElementById('edit-scenario-form').action = '/ret_dashboard/scenarios/' + id + '/update/';
            toggleModal('edit-scenario-modal');
        })
        .catch(error => {
            console.error('Error fetching scenario:', error);
            alert('Error loading scenario data. Please try again.');
        });
}

// Delete Scenario confirmation
function confirmDeleteScenario(id, name) {
    document.getElementById('delete-scenario-name').textContent = name;
    document.getElementById('delete-scenario-form').action = '/ret_dashboard/scenarios/' + id + '/delete/';
    toggleModal('delete-scenario-modal');
}

// View Scenario Detail
function viewScenarioDetail(scenarioId) {
    toggleModal('scenario-detail-modal');
    document.getElementById('detail-modal-body').innerHTML = '<div class="loading">Loading scenario details...</div>';

    fetch('/api/ret_dashboard/scenarios/' + scenarioId + '/')
        .then(response => response.json())
        .then(data => {
            const html = `
                <div class="detail-grid">
                    <div class="detail-section">
                        <h3>Basic Information</h3>
                        <table class="detail-table">
                            <tr><th>Scenario Name:</th><td>${data.scenario_name || '‚Äî'}</td></tr>
                            <tr><th>Scenario Type:</th><td>${data.scenario_type_display}</td></tr>
                            <tr><th>SIREN Scenario:</th><td>${data.scenario_title || 'None'}</td></tr>
                            <tr><th>Year:</th><td><strong>${data.year}</strong></td></tr>
                            <tr><th>Target Type:</th><td>${data.target_type_display}</td></tr>
                            <tr><th>Description:</th><td>${data.description || '‚Äî'}</td></tr>
                            <tr><th>Active:</th><td><span class="${data.is_active ? 'badge badge-success' : 'badge badge-secondary'}">${data.is_active ? 'Yes' : 'No'}</span></td></tr>
                        </table>
                    </div>

                    <div class="detail-section">
                        <h3>Demand & Targets</h3>
                        <table class="detail-table">
                            <tr><th>Operational Demand:</th><td>${data.operational_demand ? data.operational_demand.toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' GWh' : '‚Äî'}</td></tr>
                            <tr><th>Underlying Demand:</th><td>${data.underlying_demand ? data.underlying_demand.toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' GWh' : '‚Äî'}</td></tr>
                            <tr class="highlight-row"><th>Target RE %:</th><td><strong style="font-size: 1.2em; color: #27ae60;">${data.target_re_percentage.toFixed(1)}%</strong></td></tr>
                            <tr><th>Target Emissions:</th><td>${data.target_emissions_tonnes ? data.target_emissions_tonnes.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' t CO‚ÇÇ-e' : '‚Äî'}</td></tr>
                            <tr><th>Storage:</th><td>${data.storage ? data.storage.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' MWh' : '‚Äî'}</td></tr>
                            <tr><th>Probability:</th><td>${data.probability_percentage ? data.probability_percentage.toFixed(1) + '%' : '‚Äî'}</td></tr>
                        </table>
                    </div>

                    <div class="detail-section">
                        <h3>Generation Mix (GWh)</h3>
                        <table class="detail-table">
                            <tr><th>Wind:</th><td>${data.wind_generation.toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td></tr>
                            <tr><th>Solar (Utility):</th><td>${data.solar_generation.toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td></tr>
                            <tr><th>Solar (Rooftop/DPV):</th><td>${data.dpv_generation.toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td></tr>
                            <tr><th>Biomass:</th><td>${data.biomass_generation.toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td></tr>
                            <tr><th>Gas:</th><td>${data.gas_generation.toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td></tr>
                            <tr class="total-row"><th>Total Generation:</th><td><strong>${data.total_generation.toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} GWh</strong></td></tr>
                        </table>
                    </div>

                    <div class="detail-section">
                        <h3>Metadata</h3>
                        <table class="detail-table">
                            <tr><th>Created:</th><td>${data.created_at ? new Date(data.created_at).toLocaleString() : '‚Äî'}</td></tr>
                            <tr><th>Updated:</th><td>${data.updated_at ? new Date(data.updated_at).toLocaleString() : '‚Äî'}</td></tr>
                            <tr><th>Record ID:</th><td>${data.id}</td></tr>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('detail-modal-body').innerHTML = html;
            document.getElementById('detail-modal-title').textContent = data.scenario_name + ' - ' + data.year;
        })
        .catch(error => {
            document.getElementById('detail-modal-body').innerHTML = `
                <div class="error-box" style="padding: 20px; background: #f8d7da; border-left: 4px solid #e74c3c; border-radius: 4px; color: #721c24;">
                    <strong>Error loading scenario details:</strong> ${error.message}
                </div>
            `;
        });
}
</script>

<!-- Scenario Detail Modal -->
<div id="scenario-detail-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h2 id="detail-modal-title">Scenario Details</h2>
            <button onclick="toggleModal('scenario-detail-modal')" class="close-btn" style="background: none; border: none; font-size: 2em; cursor: pointer; color: #999;">&times;</button>
        </div>
        <div class="modal-body" id="detail-modal-body">
            <div class="loading">Loading...</div>
        </div>
    </div>
</div>

<style>
.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    padding: 20px;
}
.detail-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}
.detail-section h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
    padding-bottom: 8px;
    font-size: 1.1em;
}
.detail-table {
    width: 100%;
    margin-top: 10px;
    border-collapse: collapse;
}
.detail-table tr {
    border-bottom: 1px solid #dee2e6;
}
.detail-table tr:last-child {
    border-bottom: none;
}
.detail-table th {
    text-align: left;
    padding: 10px 12px;
    width: 50%;
    color: #6c757d;
    font-weight: 600;
    font-size: 0.95em;
}
.detail-table td {
    padding: 10px 12px;
    font-weight: 500;
    color: #2c3e50;
}
.total-row {
    background: #e8f4f8;
    font-weight: bold;
}
.total-row th, .total-row td {
    padding-top: 12px;
    padding-bottom: 12px;
    font-size: 1.05em;
}
.highlight-row {
    background: #d4edda;
}
.loading {
    text-align: center;
    padding: 40px;
    color: #7f8c8d;
    font-style: italic;
}
#scenario-detail-modal .modal-content {
    animation: slideDown 0.3s ease-out;
}
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

{% endblock %}
