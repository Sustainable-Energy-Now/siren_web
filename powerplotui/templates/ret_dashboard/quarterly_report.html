{% extends 'scada/base.html' %}
{% load humanize %}
{% load math_filters %}

{% block title %}SWIS Quarterly Report - Q{{ quarter }} {{ year }}{% endblock %}

{% block extra_css %}
<style>
    .quarterly-report {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .report-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 40px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .report-header h1 {
        margin: 0 0 10px 0;
        font-size: 2.5em;
        font-weight: 600;
    }

    .report-header .subtitle {
        font-size: 1.2em;
        opacity: 0.9;
    }

    .section {
        background: white;
        padding: 30px;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section h2 {
        color: #1e3c72;
        border-bottom: 3px solid #4CAF50;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 1.8em;
    }

    .section h3 {
        color: #2a5298;
        margin-top: 25px;
        margin-bottom: 15px;
        font-size: 1.4em;
    }

    /* Executive Summary Cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .summary-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .summary-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .summary-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .summary-card .label {
        font-size: 0.85em;
        opacity: 0.9;
        margin-bottom: 10px;
    }

    .summary-card .value {
        font-size: 2.2em;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .summary-card .change {
        font-size: 0.9em;
        opacity: 0.95;
    }

    /* Tables */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    .data-table thead {
        background: #f5f5f5;
    }

    .data-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #ddd;
    }

    .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
    }

    .data-table tr:hover {
        background: #f9f9f9;
    }

    .data-table .value {
        text-align: right;
    }

    .renewable-row {
        background: #e8f5e9;
    }

    .fossil-row {
        background: #fafafa;
    }

    .total-row {
        font-weight: 600;
        background: #e3f2fd;
        border-top: 2px solid #2196F3;
    }

    /* Status Indicators */
    .status-indicator {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9em;
    }

    .status-indicator.on-track {
        background: #c8e6c9;
        color: #2e7d32;
    }

    .status-indicator.at-risk {
        background: #ffe0b2;
        color: #e65100;
    }

    .status-indicator.behind {
        background: #ffcdd2;
        color: #c62828;
    }

    /* Charts */
    .chart-container {
        margin: 30px 0;
        padding: 20px;
        background: #fafafa;
        border-radius: 8px;
    }

    /* Comparison Grid */
    .comparison-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }

    .comparison-item {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #2196F3;
    }

    .comparison-item .metric {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
    }

    .comparison-item .value {
        font-size: 1.5em;
        font-weight: 600;
        color: #333;
    }

    /* Observations */
    .observations {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
        padding: 20px;
        margin: 20px 0;
        border-radius: 4px;
    }

    .observations ul {
        margin: 10px 0;
        padding-left: 20px;
    }

    .observations li {
        margin: 8px 0;
        line-height: 1.6;
    }
    
    .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px 20px;
        margin: 20px 0;
        border-radius: 4px;
    }

    /* Print Styles */
    @media print {
        .report-header {
            background: #1e3c72 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .section {
            break-inside: avoid;
            page-break-inside: avoid;
        }
        
        .summary-card {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="quarterly-report">
    <!-- Report Header -->
    <div class="report-header">
        <h1>SWIS Quarterly Report</h1>
        <div class="subtitle">Q{{ quarter }} {{ year }} ({{ quarter_start_month }} - {{ quarter_end_month }})</div>
    </div>

    <!-- Executive Summary -->
    <div class="section">
        <h2>Executive Summary</h2>
        
        <div class="summary-cards">
            <div class="summary-card success">
                <div class="label">Q{{ quarter }} RE% (Operational)</div>
                <div class="value">{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</div>
                <div class="change">Grid-sent electricity</div>
            </div>
            
            <div class="summary-card success">
                <div class="label">Q{{ quarter }} RE% (Underlying)</div>
                <div class="value">{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</div>
                <div class="change">Including rooftop solar</div>
            </div>
            
            <div class="summary-card info">
                <div class="label">YTD RE% (Underlying)</div>
                <div class="value">{{ ytd_summary.re_percentage_underlying|floatformat:1 }}%</div>
                <div class="change">
                    {% if prev_ytd_summary %}
                        vs {{ prev_ytd_summary.re_percentage_underlying|floatformat:1 }}% in {{ year|add:"-1" }}
                    {% endif %}
                </div>
            </div>
            
            <div class="summary-card">
                <div class="label">{{ year }} Target</div>
                <div class="value">{{ target.target_percentage|floatformat:1 }}%</div>
                <div class="change">
                    {% if ytd_summary.re_percentage_underlying >= target.target_percentage %}
                        ✓ On track
                    {% else %}
                        ⚠ {{ target.target_percentage|sub:ytd_summary.re_percentage_underlying|floatformat:1 }} pp behind
                    {% endif %}
                </div>
            </div>
            
            <div class="summary-card warning">
                <div class="label">Q{{ quarter }} Emissions</div>
                <div class="value">{{ quarterly_summary.total_emissions|floatformat:0|intcomma }}</div>
                <div class="change">tonnes CO₂-e</div>
            </div>
        </div>
        
        <!-- Demand Definitions Info Box -->
        <div class="info-box">
            <strong>Note:</strong> 
            <strong>Operational Demand</strong> = Grid-sent generation minus storage charging (BESS + Hydro). 
            <strong>Underlying Demand</strong> = Operational + rooftop solar (DPV). 
            Storage is excluded from both demand calculations and RE% numerators.
        </div>
    </div>

    <!-- Monthly Breakdown -->
    <div class="section">
        <h2>Monthly Performance Breakdown</h2>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Month</th>
                    <th class="value">Underlying Demand (GWh)</th>
                    <th class="value">Renewable Gen (GWh)</th>
                    <th class="value">RE% (Operational)</th>
                    <th class="value">RE% (Underlying)</th>
                    <th class="value">Emissions (t CO₂-e)</th>
                    <th class="value">vs Target</th>
                </tr>
            </thead>
            <tbody>
                {% for monthly in monthly_performances %}
                <tr>
                    <td><strong>{{ monthly.month_name }}</strong></td>
                    <td class="value">{{ monthly.underlying_demand|floatformat:0|intcomma }}</td>
                    <td class="value">{{ monthly.total_renewable_generation|floatformat:0|intcomma }}</td>
                    <td class="value">{{ monthly.re_percentage_operational|floatformat:1 }}%</td>
                    <td class="value">{{ monthly.re_percentage_underlying|floatformat:1 }}%</td>
                    <td class="value">{{ monthly.total_emissions_tonnes|floatformat:0|intcomma }}</td>
                    <td class="value">
                        {% if monthly.re_percentage_underlying >= target.target_percentage %}
                            <span style="color: #27ae60;">✓ +{{ monthly.re_percentage_underlying|sub:target.target_percentage|floatformat:1 }}</span>
                        {% else %}
                            <span style="color: #e74c3c;">{{ monthly.re_percentage_underlying|sub:target.target_percentage|floatformat:1 }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                <tr class="total-row">
                    <td><strong>Q{{ quarter }} TOTAL</strong></td>
                    <td class="value"><strong>{{ quarterly_summary.underlying_demand|floatformat:0|intcomma }}</strong></td>
                    <td class="value"><strong>{{ quarterly_summary.renewable_generation|floatformat:0|intcomma }}</strong></td>
                    <td class="value"><strong>{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</strong></td>
                    <td class="value"><strong>{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</strong></td>
                    <td class="value"><strong>{{ quarterly_summary.total_emissions|floatformat:0|intcomma }}</strong></td>
                    <td class="value">—</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Year-to-Date Cumulative -->
    <div class="section">
        <h2>Cumulative Year-to-Date Performance</h2>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th class="value">Q{{ quarter }} {{ year }}</th>
                    <th class="value">YTD {{ year }}</th>
                    {% if prev_ytd_summary %}
                    <th class="value">YTD {{ year|add:"-1" }}</th>
                    <th class="value">Change</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>RE% (Operational)</strong></td>
                    <td class="value">{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</td>
                    <td class="value"><strong>{{ ytd_summary.re_percentage_operational|floatformat:1 }}%</strong></td>
                    {% if prev_ytd_summary %}
                    <td class="value">{{ prev_ytd_summary.re_percentage_operational|floatformat:1 }}%</td>
                    <td class="value">
                        {% with change=ytd_summary.re_percentage_operational|sub:prev_ytd_summary.re_percentage_operational %}
                            {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }} pp
                        {% endwith %}
                    </td>
                    {% endif %}
                </tr>
                <tr>
                    <td><strong>RE% (Underlying)</strong></td>
                    <td class="value">{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</td>
                    <td class="value"><strong>{{ ytd_summary.re_percentage_underlying|floatformat:1 }}%</strong></td>
                    {% if prev_ytd_summary %}
                    <td class="value">{{ prev_ytd_summary.re_percentage_underlying|floatformat:1 }}%</td>
                    <td class="value">
                        {% with change=ytd_summary.re_percentage_underlying|sub:prev_ytd_summary.re_percentage_underlying %}
                            {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }} pp
                        {% endwith %}
                    </td>
                    {% endif %}
                </tr>
                <tr>
                    <td>Total Emissions (tonnes CO₂-e)</td>
                    <td class="value">{{ quarterly_summary.total_emissions|floatformat:0|intcomma }}</td>
                    <td class="value">{{ ytd_summary.total_emissions|floatformat:0|intcomma }}</td>
                    {% if prev_ytd_summary %}
                    <td class="value">{{ prev_ytd_summary.total_emissions|floatformat:0|intcomma }}</td>
                    <td class="value">
                        {% with change=ytd_summary.total_emissions|sub:prev_ytd_summary.total_emissions %}
                            {% with pct_change=change|div:prev_ytd_summary.total_emissions|mul:100 %}
                                {% if pct_change >= 0 %}+{% endif %}{{ pct_change|floatformat:1 }}%
                            {% endwith %}
                        {% endwith %}
                    </td>
                    {% endif %}
                </tr>
                <tr>
                    <td>Emissions Intensity (kg/MWh)</td>
                    <td class="value">{{ quarterly_summary.emissions_intensity|floatformat:0 }}</td>
                    <td class="value">{{ ytd_summary.emissions_intensity|floatformat:0 }}</td>
                    {% if prev_ytd_summary %}
                    <td class="value">{{ prev_ytd_summary.emissions_intensity|floatformat:0 }}</td>
                    <td class="value">
                        {% with change=ytd_summary.emissions_intensity|sub:prev_ytd_summary.emissions_intensity %}
                            {% if change >= 0 %}+{% endif %}{{ change|floatformat:0 }}
                        {% endwith %}
                    </td>
                    {% endif %}
                </tr>
            </tbody>
        </table>

        <p style="margin-top: 20px;">
            {% if ytd_summary.re_percentage_underlying >= target.target_percentage %}
                ✓ YTD performance is <strong>{{ ytd_summary.re_percentage_underlying|sub:target.target_percentage|floatformat:1 }} percentage points ahead</strong> of the {{ year }} annual target.
            {% else %}
                ⚠ YTD performance is <strong>{{ target.target_percentage|sub:ytd_summary.re_percentage_underlying|floatformat:1 }} percentage points behind</strong> the {{ year }} annual target. Acceleration needed in remaining quarters.
            {% endif %}
        </p>
    </div>

    <!-- Charts -->
    <div class="section">
        <h2>Quarterly Trends</h2>
        
        <div class="chart-container">
            <h3>Monthly Generation Breakdown (Q{{ quarter }} {{ year }})</h3>
            <div id="monthly-generation-chart"></div>
        </div>

        <div class="chart-container">
            <h3>Year-over-Year RE% Comparison (Q{{ quarter }})</h3>
            <div id="yoy-comparison-chart"></div>
        </div>
    </div>

    <!-- New Capacity -->
    {% if new_capacity %}
    <div class="section">
        <h2>New Capacity Commissioned in Q{{ quarter }} {{ year }}</h2>
        
        <ul>
            {% for facility in new_capacity %}
            <li style="margin: 10px 0;">
                <strong>{{ facility.facility.facility_name }}</strong> - 
                {{ facility.capacity_mw|floatformat:0 }} MW 
                ({{ facility.technology_type }})
                <br>
                <small style="color: #666;">Commissioned: {{ facility.commissioned_date|date:"d F Y" }}</small>
            </li>
            {% endfor %}
        </ul>

        <p style="margin-top: 20px;">
            <strong>Total New Capacity Q{{ quarter }} {{ year }}: {{ new_capacity|sum_attr:"capacity_mw"|floatformat:0 }} MW renewable</strong>
        </p>
    </div>
    {% endif %}

    <!-- Observations and Key Findings -->
    <div class="section">
        <h2>Key Observations</h2>
        
        <div class="observations">
            <h3>Positive Developments</h3>
            <ul>
                {% if prev_quarter_summary and quarterly_summary.re_percentage_underlying > prev_quarter_summary.re_percentage_underlying %}
                <li>RE% (underlying) increased by {{ quarterly_summary.re_percentage_underlying|sub:prev_quarter_summary.re_percentage_underlying|floatformat:1 }} percentage points compared to Q{{ quarter }} {{ year|add:"-1" }}</li>
                {% endif %}
                
                {% if prev_ytd_summary and ytd_summary.total_emissions < prev_ytd_summary.total_emissions %}
                <li>YTD emissions reduced by {{ prev_ytd_summary.total_emissions|sub:ytd_summary.total_emissions|floatformat:0|intcomma }} tonnes CO₂-e ({{ prev_ytd_summary.total_emissions|sub:ytd_summary.total_emissions|div:prev_ytd_summary.total_emissions|mul:100|floatformat:1 }}%) compared to same period last year</li>
                {% endif %}

                <li>Wind generation contributed {{ quarterly_summary.wind_generation|percent:quarterly_summary.underlying_demand|floatformat:1 }}% of total underlying demand</li>
                
                <li>Combined solar (utility + rooftop) provided {{ quarterly_summary.solar_generation|add:quarterly_summary.dpv_generation|percent:quarterly_summary.underlying_demand|floatformat:1 }}% of electricity</li>
            </ul>
        </div>

        <div class="observations" style="background: #fce4ec; border-left-color: #e91e63;">
            <h3>Challenges and Risks</h3>
            <ul>
                {% if quarterly_summary.re_percentage_underlying < target.target_percentage %}
                <li>Quarterly RE% ({{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%) is below annual target ({{ target.target_percentage }}%)</li>
                {% endif %}
                <li>Continued monitoring needed to ensure annual target achievement</li>
            </ul>
        </div>
    </div>

</div>

<!-- Plotly Charts -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // Monthly Generation Breakdown Chart
    var monthlyGenData = [
        {
            x: [{% for monthly in monthly_performances %}'{{ monthly.month_name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            y: [{% for monthly in monthly_performances %}{{ monthly.wind_generation|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            name: 'Wind',
            type: 'bar',
            marker: {color: '#4CAF50'}
        },
        {
            x: [{% for monthly in monthly_performances %}'{{ monthly.month_name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            y: [{% for monthly in monthly_performances %}{{ monthly.solar_generation|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            name: 'Solar (Utility)',
            type: 'bar',
            marker: {color: '#FFC107'}
        },
        {
            x: [{% for monthly in monthly_performances %}'{{ monthly.month_name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            y: [{% for monthly in monthly_performances %}{{ monthly.dpv_generation|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            name: 'Solar (Rooftop)',
            type: 'bar',
            marker: {color: '#FFE082'}
        },
        {
            x: [{% for monthly in monthly_performances %}'{{ monthly.month_name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            y: [{% for monthly in monthly_performances %}{{ monthly.gas_generation|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            name: 'Gas',
            type: 'bar',
            marker: {color: '#9E9E9E'}
        }
    ];

    var monthlyLayout = {
        barmode: 'stack',
        title: 'Monthly Generation by Technology (Storage excluded)',
        xaxis: {title: 'Month'},
        yaxis: {title: 'Generation (GWh)'},
        legend: {x: 0, y: 1.2, orientation: 'h'}
    };

    Plotly.newPlot('monthly-generation-chart', monthlyGenData, monthlyLayout, {responsive: true});

    // Year-over-Year Comparison - now showing both RE% measures
    var yoyData = [
        {*************Here
            x: ['Q{{ quarter }} {{ year|add:"-1" }} (Op)', 'Q{{ quarter }} {{ year }} (Op)', 'Q{{ quarter }} {{ year|add:"-1" }} (Und)', 'Q{{ quarter }} {{ year }} (Und)'],
            y: [{{ prev_quarter_summary.re_percentage_operational|default:0 }}, {{ quarterly_summary.re_percentage_operational }}, {{ prev_quarter_summary.re_percentage_underlying|default:0 }}, {{ quarterly_summary.re_percentage_underlying }}],
            name: 'RE%',
            type: 'bar',
            marker: {color: ['#90CAF9', '#2196F3', '#A5D6A7', '#4CAF50']}
        }
    ];

    var yoyLayout = {
        title: 'Renewable Energy % Comparison (Operational vs Underlying)',
        yaxis: {title: 'RE%', range: [0, 100]},
        showlegend: false
    };

    Plotly.newPlot('yoy-comparison-chart', yoyData, yoyLayout, {responsive: true});
</script>
{% endblock %}
