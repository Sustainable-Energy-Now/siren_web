{% extends 'scada/base.html' %}
{% load humanize %}
{% load math_filters %}
{% load static %}

{% block title %}SWIS Quarterly Report - Q{{ quarter }} {{ year }}{% endblock %}

{% block extra_css %}
<style>
    .quarterly-report {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .report-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 40px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .report-header h1 {
        margin: 0 0 10px 0;
        font-size: 2.5em;
        font-weight: 600;
        color: #ffffff;
    }

    .report-header .subtitle {
        font-size: 1.2em;
        opacity: 0.9;
        color: #ffffff;
    }

    .section-header {
        background: white;
        padding: 30px;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section-header h2 {
        color: #1e3c72;
        border-bottom: 3px solid #4CAF50;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 1.8em;
    }

    .section-header h3 {
        color: #2a5298;
        margin-top: 25px;
        margin-bottom: 15px;
        font-size: 1.4em;
    }

    /* Executive Summary Cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .summary-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .summary-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .summary-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .summary-card.price {
        background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
    }

    .summary-card .label {
        font-size: 0.85em;
        opacity: 0.9;
        margin-bottom: 10px;
    }

    .summary-card .value {
        font-size: 2.2em;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .summary-card .change {
        font-size: 0.9em;
        opacity: 0.95;
    }

    /* Tables */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    .data-table thead {
        background: #f5f5f5;
    }

    .data-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #ddd;
    }

    .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
    }

    .data-table tr:hover {
        background: #f9f9f9;
    }

    .data-table .value {
        text-align: right;
    }

    .renewable-row {
        background: #e8f5e9;
    }

    .fossil-row {
        background: #fafafa;
    }

    .total-row {
        font-weight: 600;
        background: #e3f2fd;
        border-top: 2px solid #2196F3;
    }

    .info-row {
        background: #e3f2fd !important;
        font-style: italic;
    }

    /* Status Indicators */
    .status-indicator {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9em;
    }

    .status-indicator.on-track {
        background: #c8e6c9;
        color: #2e7d32;
    }

    .status-indicator.at-risk {
        background: #ffe0b2;
        color: #e65100;
    }

    .status-indicator.behind {
        background: #ffcdd2;
        color: #c62828;
    }

    /* Charts */
    .chart-container {
        margin: 30px 0;
        padding: 20px;
        background: #fafafa;
        border-radius: 8px;
    }

    /* Comparison Grid */
    .comparison-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }

    .comparison-item {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #2196F3;
    }

    .comparison-item .metric {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
    }

    .comparison-item .value {
        font-size: 1.5em;
        font-weight: 600;
        color: #333;
    }

    /* Observations */
    .observations {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
        padding: 20px;
        margin: 20px 0;
        border-radius: 4px;
    }

    .observations ul {
        margin: 10px 0;
        padding-left: 20px;
    }

    .observations li {
        margin: 8px 0;
        line-height: 1.6;
    }

    .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px 20px;
        margin: 20px 0;
        border-radius: 4px;
    }

    .price-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .price-stat-card {
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #ff9800;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .price-stat-card .stat-label {
        font-size: 0.8em;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .price-stat-card .stat-value {
        font-size: 1.5em;
        font-weight: 700;
        color: #333;
    }

    .price-stat-card .stat-detail {
        font-size: 0.85em;
        color: #888;
        margin-top: 5px;
    }

    .price-stat-card.negative {
        border-left-color: #4caf50;
    }

    .price-stat-card.spike {
        border-left-color: #f44336;
    }

    /* Metric Grid and Cards (for Key Findings section) */
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .metric-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #bdc3c7;
    }

    .metric-card.positive {
        border-left-color: #27ae60;
        background: linear-gradient(135deg, #ffffff 0%, #e8f5e9 100%);
    }

    .metric-card.negative {
        border-left-color: #e74c3c;
        background: linear-gradient(135deg, #ffffff 0%, #ffebee 100%);
    }

    .metric-card.warning {
        border-left-color: #f39c12;
        background: linear-gradient(135deg, #ffffff 0%, #fff8e1 100%);
    }

    .metric-card.neutral {
        border-left-color: #3498db;
        background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
    }

    .metric-label {
        font-size: 0.9em;
        color: #7f8c8d;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .metric-value {
        font-size: 2.5em;
        font-weight: 700;
        color: #2c3e50;
        margin: 10px 0;
    }

    .metric-sublabel {
        font-size: 0.85em;
        color: #95a5a6;
        margin-top: 8px;
    }

    .metric-change {
        font-size: 0.9em;
        color: #7f8c8d;
        margin-top: 8px;
    }

    /* Print Styles */
    @media print {
        .report-header {
            background: #1e3c72 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .section-header {
            break-inside: avoid;
            page-break-inside: avoid;
        }

        .summary-card {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .metric-card {
            break-inside: avoid;
            page-break-inside: avoid;
        }
    }
</style>
{% endblock %}

{% block content %}
<header style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 20px;">
    <div>
        <h1>SWIS Quarterly Report</h1>
        <div class="subtitle">Q{{ quarter }} {{ year }} ({{ quarter_start_month }} - {{ quarter_end_month }})</div>
    </div>
    <img src="{% static 'img/SEN_LOGO_HERO.png' %}" alt="SEN Logo" style="height: 100px; width: auto;">
</header>

{% if not is_published_version %}
<!-- Quick Navigation Links -->
<div
    style="margin: 20px 0; padding: 15px; background: #ecf0f1; border-radius: 8px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
    <strong style="color: #2c3e50;">Other Reports:</strong>
    <a href="{% url 'ret_dashboard' %}"
        style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìä
        Monthly Dashboard</a>
    {% if 1 in completed_quarters %}
    <a href="{% url 'quarterly_report' year 1 %}"
        style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìà
        Q1 Report</a>
    {% endif %}
    {% if 2 in completed_quarters %}
    <a href="{% url 'quarterly_report' year 2 %}"
        style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìà
        Q2 Report</a>
    {% endif %}
    {% if 3 in completed_quarters %}
    <a href="{% url 'quarterly_report' year 3 %}"
        style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìà
        Q3 Report</a>
    {% endif %}
    {% if 4 in completed_quarters %}
    <a href="{% url 'quarterly_report' year 4 %}"
        style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìà
        Q4 Report</a>
    {% endif %}
    <a href="{% url 'annual_review' year %}"
        style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìë
        {{ year }} Annual Review</a>
    <a href="{% url 'published_reports_list' %}"
        style="color: #3498db; text-decoration: none; padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500;">üìö
        Published Reports</a>
    <button onclick="window.print()"
        style="padding: 8px 15px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">üñ®Ô∏è
        Print</button>
    {% if user.is_authenticated %}
    <form method="POST" action="{% url 'publish_quarterly_report' year quarter %}" style="margin: 0;">
        {% csrf_token %}
        <button type="submit"
            style="padding: 8px 15px; background: #27ae60; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;"
            onclick="return confirm('This will generate and publish HTML and PDF versions of this report. Continue?');">üìÑ
            Publish</button>
    </form>
    {% endif %}
</div>
{% endif %}
<!-- Executive Summary -->
<div class="section-header">
    <h2>Executive Summary</h2>

    <div class="info-box" id="exec-summary-container" style="background: white; border-left: 4px solid #9b59b6;">
        <div id="exec-summary-display">
            <!-- Default dynamic text -->
            <p style="font-size: 1.1em; line-height: 1.8;">
                The South West Interconnected System (SWIS) achieved
                <strong>{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</strong> renewable energy
                (operational demand basis) and <strong>{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</strong>
                (underlying demand basis, including rooftop solar) in Q{{ quarter }} {{ year }}.
                Year-to-date renewable energy performance stands at
                <strong>{{ ytd_summary.re_percentage_operational|floatformat:1 }}%</strong> (operational) and
                <strong>{{ ytd_summary.re_percentage_underlying|floatformat:1 }}%</strong> (underlying).
                Total quarterly emissions were
                <strong>{{ quarterly_summary.total_emissions|floatformat:0|intcomma }} tonnes CO‚ÇÇ-e</strong>{% if prev_quarter_summary %},
                {% with change=quarterly_summary.total_emissions|sub:prev_quarter_summary.total_emissions|div:prev_quarter_summary.total_emissions|mul:100 %}
                {% if change < 0 %}a reduction of <strong>{{ change|mul:-1|floatformat:1 }}%</strong>{% else %}an increase of <strong>{{ change|floatformat:1 }}%</strong>{% endif %} from Q{{ quarter }} {{ year|add:"-1" }}.
                {% endwith %}
                {% else %}.{% endif %}
                {% if quarterly_summary.wholesale_price_avg %}
                The average wholesale electricity price was <strong>${{ quarterly_summary.wholesale_price_avg|floatformat:2 }}/MWh</strong>.
                {% endif %}
            </p>
            {% if executive_summary and executive_summary.content %}
            <div style="font-size: 1.1em; line-height: 1.6; color: #2c3e50; margin-top: 15px;">
                {{ executive_summary.content|linebreaks }}
            </div>
            {% endif %}
            {% if user.is_authenticated and not is_published_version %}
            <div style="margin-top: 15px;">
                <button onclick="toggleExecSummaryEdit()" class="action-btn primary-btn">Add to Summary</button>
                {% if executive_summary and executive_summary.updated_at %}
                <small style="color: #7f8c8d; margin-left: 10px;">
                    Last updated: {{ executive_summary.updated_at|date:"d M Y" }} by {{ executive_summary.updated_by.get_full_name|default:executive_summary.updated_by.username }}
                </small>
                {% endif %}
            </div>
            {% endif %}
        </div>

        {% if user.is_authenticated and not is_published_version %}
        <div id="exec-summary-edit" style="display: none;">
            {% csrf_token %}
            <p style="margin-top: 0; color: #7f8c8d; font-size: 0.9em;">Enter additional commentary for this quarterly report.
            You can include key highlights, trends, and insights for the quarter.
            </p>
            <textarea id="exec-summary-content"
                style="width: 100%; min-height: 200px; padding: 15px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #bdc3c7; font-family: inherit; font-size: 1em; line-height: 1.5; resize: vertical;">{% if executive_summary and executive_summary.content %}{{ executive_summary.content }}{% endif %}</textarea>
            <div style="display: flex; gap: 10px;">
                <button onclick="saveExecSummary()" class="action-btn primary-btn">Save Summary</button>
                <button onclick="toggleExecSummaryEdit()" class="action-btn">Cancel</button>
            </div>
        </div>

        <script>
            function toggleExecSummaryEdit() {
                var displayDiv = document.getElementById('exec-summary-display');
                var editDiv = document.getElementById('exec-summary-edit');

                if (editDiv.style.display === 'none') {
                    editDiv.style.display = 'block';
                    displayDiv.style.display = 'none';
                } else {
                    editDiv.style.display = 'none';
                    displayDiv.style.display = 'block';
                }
            }

            function saveExecSummary() {
                var content = document.getElementById('exec-summary-content').value;
                var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                var btn = document.querySelector('#exec-summary-edit button.primary-btn');
                var originalText = btn.textContent;

                btn.textContent = 'Saving...';
                btn.disabled = true;

                fetch("{% url 'ret_executive_summary_update' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        report_type: 'quarterly',
                        year: {{ year }},
                        quarter: {{ quarter }},
                        content: content
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error saving summary: ' + (data.error || 'Unknown error'));
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving summary');
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
            }
        </script>
        <style>
            .action-btn {
                padding: 8px 15px;
                border: 1px solid #bdc3c7;
                border-radius: 4px;
                background: white;
                cursor: pointer;
                font-size: 0.9em;
                color: #2c3e50;
                transition: all 0.2s;
            }

            .action-btn:hover {
                background: #ecf0f1;
            }

            .primary-btn {
                background: #3498db;
                border-color: #3498db;
                color: white;
            }

            .primary-btn:hover {
                background: #2980b9;
            }
        </style>
        {% endif %}
    </div>
</div>
    <!-- Demand Definitions Info Box -->
<div class="info-box" style="background: #e3f2fd; border-left-color: #2196f3;">
    <p style="margin-bottom: 0;">
        <strong>Operational Demand:</strong> Total grid-sent generation. This
        represents electricity delivered through the grid.<br>
        <strong>Underlying Demand:</strong> Operational demand plus rooftop solar (DPV). This represents total
        electricity consumed including behind-the-meter generation.<br>
    </p>
</div>
<!-- Key Findings -->
<div class="section-header">
    <h2>Key Findings</h2>

    <div class="metric-grid">
        <div class="metric-card positive">
            <div class="metric-label">Q{{ quarter }} RE% (Operational)</div>
            <div class="metric-value">{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</div>
            <div class="metric-sublabel">Grid-sent electricity</div>
        </div>

        <div class="metric-card positive">
            <div class="metric-label">Q{{ quarter }} RE% (Underlying)</div>
            <div class="metric-value">{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</div>
            <div class="metric-sublabel">Including rooftop solar</div>
        </div>

        <div class="metric-card {% if target and ytd_summary.re_percentage_operational >= target.target_re_percentage %}positive{% else %}warning{% endif %}">
            <div class="metric-label">YTD RE% (Operational)</div>
            <div class="metric-value">{{ ytd_summary.re_percentage_operational|floatformat:1 }}%</div>
            <div class="metric-change">
                {% if prev_ytd_summary %}
                vs {{ prev_ytd_summary.re_percentage_operational|floatformat:1 }}% in {{ year|add:"-1" }}
                {% endif %}
            </div>
        </div>

        <div class="metric-card {% if target and ytd_summary.re_percentage_underlying >= target.target_re_percentage %}positive{% else %}warning{% endif %}">
            <div class="metric-label">YTD RE% (Underlying)</div>
            <div class="metric-value">{{ ytd_summary.re_percentage_underlying|floatformat:1 }}%</div>
            <div class="metric-change">
                {% if prev_ytd_summary %}
                vs {{ prev_ytd_summary.re_percentage_underlying|floatformat:1 }}% in {{ year|add:"-1" }}
                {% endif %}
            </div>
        </div>

        {% if target %}
        <div class="metric-card {% if ytd_summary.re_percentage_underlying >= target.target_re_percentage %}positive{% elif ytd_summary.re_percentage_underlying >= target.target_re_percentage|mul:0.95 %}warning{% else %}negative{% endif %}">
            <div class="metric-label">{{ year }} Target</div>
            <div class="metric-value">{{ target.target_re_percentage|floatformat:1 }}%</div>
            <div class="metric-change">
                {% if ytd_summary.re_percentage_underlying >= target.target_re_percentage %}
                ‚úì On track
                {% else %}
                ‚ö† {{ target.target_re_percentage|sub:ytd_summary.re_percentage_underlying|floatformat:1 }} pp behind
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="metric-card neutral">
            <div class="metric-label">Q{{ quarter }} Emissions</div>
            <div class="metric-value">{{ quarterly_summary.total_emissions|floatformat:0|intcomma }}</div>
            <div class="metric-sublabel">tonnes CO‚ÇÇ-e</div>
            {% if prev_quarter_summary %}
            <div class="metric-change">
                {% with change=quarterly_summary.total_emissions|sub:prev_quarter_summary.total_emissions|div:prev_quarter_summary.total_emissions|mul:100 %}
                {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }}% vs {{ year|add:"-1" }}
                {% endwith %}
            </div>
            {% endif %}
        </div>

        <div class="metric-card neutral">
            <div class="metric-label">YTD Emissions</div>
            <div class="metric-value">{{ ytd_summary.total_emissions|floatformat:0|intcomma }}</div>
            <div class="metric-sublabel">tonnes CO‚ÇÇ-e</div>
            {% if prev_ytd_summary %}
            <div class="metric-change">
                {% with change=ytd_summary.total_emissions|sub:prev_ytd_summary.total_emissions|div:prev_ytd_summary.total_emissions|mul:100 %}
                {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }}% vs {{ year|add:"-1" }}
                {% endwith %}
            </div>
            {% endif %}
        </div>

        {% if quarterly_summary.wholesale_price_avg %}
        <div class="metric-card neutral">
            <div class="metric-label">Q{{ quarter }} Avg Price</div>
            <div class="metric-value">${{ quarterly_summary.wholesale_price_avg|floatformat:2 }}</div>
            <div class="metric-sublabel">$/MWh wholesale</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Wholesale Price Statistics -->
{% if quarterly_summary.wholesale_price_avg %}
<div class="section-header">
    <h2>Wholesale Price Summary</h2>

    <div class="price-stats-grid">
        <div class="price-stat-card">
            <div class="stat-label">Average Price</div>
            <div class="stat-value">${{ quarterly_summary.wholesale_price_avg|floatformat:2 }}</div>
            <div class="stat-detail">$/MWh</div>
        </div>

        {% if quarterly_summary.wholesale_price_max %}
        <div class="price-stat-card">
            <div class="stat-label">Maximum Price</div>
            <div class="stat-value">${{ quarterly_summary.wholesale_price_max|floatformat:2 }}</div>
            <div class="stat-detail">
                {% if quarterly_summary.wholesale_price_max_datetime %}
                {{ quarterly_summary.wholesale_price_max_datetime|date:"d M, g:i A" }}
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if quarterly_summary.wholesale_price_min %}
        <div class="price-stat-card">
            <div class="stat-label">Minimum Price</div>
            <div class="stat-value">${{ quarterly_summary.wholesale_price_min|floatformat:2 }}</div>
            <div class="stat-detail">
                {% if quarterly_summary.wholesale_price_min_datetime %}
                {{ quarterly_summary.wholesale_price_min_datetime|date:"d M, g:i A" }}
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if quarterly_summary.wholesale_negative_count is not None %}
        <div class="price-stat-card negative">
            <div class="stat-label">Negative Price Intervals</div>
            <div class="stat-value">{{ quarterly_summary.wholesale_negative_count|intcomma }}</div>
            <div class="stat-detail">intervals &lt; $0/MWh</div>
        </div>
        {% endif %}

        {% if quarterly_summary.wholesale_spike_count is not None %}
        <div class="price-stat-card spike">
            <div class="stat-label">Price Spikes</div>
            <div class="stat-value">{{ quarterly_summary.wholesale_spike_count|intcomma }}</div>
            <div class="stat-detail">intervals &gt; $300/MWh</div>
        </div>
        {% endif %}
    </div>

    <h3>Monthly Wholesale Price Breakdown</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Month</th>
                <th class="value">Avg Price ($/MWh)</th>
                <th class="value">Max Price ($/MWh)</th>
                <th class="value">Min Price ($/MWh)</th>
                <th class="value">Negative Intervals</th>
                <th class="value">Spike Intervals</th>
            </tr>
        </thead>
        <tbody>
            {% for monthly in quarterly_data %}
            <tr>
                <td><strong>{{ monthly.get_month_name }}</strong></td>
                <td class="value">
                    {% if monthly.wholesale_price_avg is not None %}
                    ${{ monthly.wholesale_price_avg|floatformat:2 }}
                    {% else %}
                    ‚Äî
                    {% endif %}
                </td>
                <td class="value">
                    {% if monthly.wholesale_price_max is not None %}
                    ${{ monthly.wholesale_price_max|floatformat:2 }}
                    {% else %}
                    ‚Äî
                    {% endif %}
                </td>
                <td class="value">
                    {% if monthly.wholesale_price_min is not None %}
                    ${{ monthly.wholesale_price_min|floatformat:2 }}
                    {% else %}
                    ‚Äî
                    {% endif %}
                </td>
                <td class="value">
                    {% if monthly.wholesale_negative_count is not None %}
                    {{ monthly.wholesale_negative_count|intcomma }}
                    {% else %}
                    ‚Äî
                    {% endif %}
                </td>
                <td class="value">
                    {% if monthly.wholesale_spike_count is not None %}
                    {{ monthly.wholesale_spike_count|intcomma }}
                    {% else %}
                    ‚Äî
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if prev_quarter_summary.wholesale_price_avg %}
    <div class="info-box" style="margin-top: 20px;">
        <strong>Year-over-Year Comparison:</strong>
        Q{{ quarter }} {{ year|add:"-1" }} average wholesale price was
        ${{ prev_quarter_summary.wholesale_price_avg|floatformat:2 }}/MWh
        {% with change=quarterly_summary.wholesale_price_avg|sub:prev_quarter_summary.wholesale_price_avg|div:prev_quarter_summary.wholesale_price_avg|mul:100 %}
        ({% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }}% change)
        {% endwith %}
    </div>
    {% endif %}
</div>
{% endif %}

<div class="section-header">
    <h2>Monthly Performance Breakdown</h2>

    <table class="data-table">
        <thead>
            <tr>
                <th>Month</th>
                <th class="value">Underlying Demand (GWh)</th>
                <th class="value">Renewable Gen (GWh)</th>
                <th class="value">RE% (Operational)</th>
                <th class="value">RE% (Underlying)</th>
                <th class="value">Emissions (t CO‚ÇÇ-e)</th>
                <th class="value">vs Target</th>
            </tr>
        </thead>
        <tbody>
            {% for monthly in quarterly_data %}
            <tr>
                <td><strong>{{ monthly.get_month_name }}</strong></td>
                <td class="value">{{ monthly.underlying_demand|floatformat:0|intcomma }}</td>
                <td class="value">{{ monthly.total_renewable_generation|floatformat:0|intcomma }}</td>
                <td class="value">{{ monthly.re_percentage_operational|floatformat:1 }}%</td>
                <td class="value">{{ monthly.re_percentage_underlying|floatformat:1 }}%</td>
                <td class="value">{{ monthly.total_emissions_tonnes|floatformat:0|intcomma }}</td>
                <td class="value">
                    {% if target %}
                        {% if monthly.re_percentage_underlying >= target.target_re_percentage %}
                        <span style="color: #27ae60;">‚úì +{{ monthly.re_percentage_underlying|sub:target.target_re_percentage|floatformat:1 }}</span>
                        {% else %}
                        <span style="color: #e74c3c;">{{ monthly.re_percentage_underlying|sub:target.target_re_percentage|floatformat:1 }}</span>
                        {% endif %}
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px;">No monthly data available for this
                    quarter.</td>
            </tr>
            {% endfor %}
            {% if quarterly_summary %}
            <tr class="total-row">
                <td><strong>Q{{ quarter }} TOTAL</strong></td>
                <td class="value"><strong>{{ quarterly_summary.underlying_demand|floatformat:0|intcomma }}</strong>
                </td>
                <td class="value"><strong>{{ quarterly_summary.renewable_generation|floatformat:0|intcomma }}</strong></td>
                <td class="value"><strong>{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</strong>
                </td>
                <td class="value"><strong>{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</strong>
                </td>
                <td class="value"><strong>{{ quarterly_summary.total_emissions|floatformat:0|intcomma }}</strong>
                </td>
                <td class="value">‚Äî</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Year-to-Date Cumulative -->
<div class="section-header">
    <h2>Cumulative Year-to-Date Performance</h2>

    <table class="data-table">
        <thead>
            <tr>
                <th>Metric</th>
                <th class="value">Q{{ quarter }} {{ year }}</th>
                <th class="value">YTD {{ year }}</th>
                {% if prev_ytd_summary %}
                <th class="value">YTD {{ year|add:"-1" }}</th>
                <th class="value">Change</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>RE% (Operational)</strong></td>
                <td class="value">{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</td>
                <td class="value"><strong>{{ ytd_summary.re_percentage_operational|floatformat:1 }}%</strong></td>
                {% if prev_ytd_summary %}
                <td class="value">{{ prev_ytd_summary.re_percentage_operational|floatformat:1 }}%</td>
                <td class="value">
                    {% with change=ytd_summary.re_percentage_operational|sub:prev_ytd_summary.re_percentage_operational %}
                    {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }} pp
                    {% endwith %}
                </td>
                {% endif %}
            </tr>
            <tr>
                <td><strong>RE% (Underlying)</strong></td>
                <td class="value">{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</td>
                <td class="value"><strong>{{ ytd_summary.re_percentage_underlying|floatformat:1 }}%</strong></td>
                {% if prev_ytd_summary %}
                <td class="value">{{ prev_ytd_summary.re_percentage_underlying|floatformat:1 }}%</td>
                <td class="value">
                    {% with change=ytd_summary.re_percentage_underlying|sub:prev_ytd_summary.re_percentage_underlying %}
                    {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }} pp
                    {% endwith %}
                </td>
                {% endif %}
            </tr>
            <tr>
                <td>Total Emissions (tonnes CO‚ÇÇ-e)</td>
                <td class="value">{{ quarterly_summary.total_emissions|floatformat:0|intcomma }}</td>
                <td class="value">{{ ytd_summary.total_emissions|floatformat:0|intcomma }}</td>
                {% if prev_ytd_summary %}
                <td class="value">{{ prev_ytd_summary.total_emissions|floatformat:0|intcomma }}</td>
                <td class="value">
                    {% with change=ytd_summary.total_emissions|sub:prev_ytd_summary.total_emissions %}
                    {% with pct_change=change|div:prev_ytd_summary.total_emissions|mul:100 %}
                    {% if pct_change >= 0 %}+{% endif %}{{ pct_change|floatformat:1 }}%
                    {% endwith %}
                    {% endwith %}
                </td>
                {% endif %}
            </tr>
            <tr>
                <td>Emissions Intensity (kg/MWh)</td>
                <td class="value">{{ quarterly_summary.emissions_intensity|floatformat:0 }}</td>
                <td class="value">{{ ytd_summary.emissions_intensity|floatformat:0 }}</td>
                {% if prev_ytd_summary %}
                <td class="value">{{ prev_ytd_summary.emissions_intensity|floatformat:0 }}</td>
                <td class="value">
                    {% with change=ytd_summary.emissions_intensity|sub:prev_ytd_summary.emissions_intensity %}
                    {% if change >= 0 %}+{% endif %}{{ change|floatformat:0 }}
                    {% endwith %}
                </td>
                {% endif %}
            </tr>
            {% if ytd_summary.wholesale_price_avg %}
            <tr>
                <td>Avg Wholesale Price ($/MWh)</td>
                <td class="value">${{ quarterly_summary.wholesale_price_avg|floatformat:2 }}</td>
                <td class="value">${{ ytd_summary.wholesale_price_avg|floatformat:2 }}</td>
                {% if prev_ytd_summary.wholesale_price_avg %}
                <td class="value">${{ prev_ytd_summary.wholesale_price_avg|floatformat:2 }}</td>
                <td class="value">
                    {% with change=ytd_summary.wholesale_price_avg|sub:prev_ytd_summary.wholesale_price_avg|div:prev_ytd_summary.wholesale_price_avg|mul:100 %}
                    {% if change >= 0 %}+{% endif %}{{ change|floatformat:1 }}%
                    {% endwith %}
                </td>
                {% else %}
                <td class="value">‚Äî</td>
                <td class="value">‚Äî</td>
                {% endif %}
            </tr>
            {% endif %}
        </tbody>
    </table>

    {% if target %}
    <p style="margin-top: 20px;">
        {% if ytd_summary.re_percentage_underlying >= target.target_re_percentage %}
        {% with diff=ytd_summary.re_percentage_underlying|sub:target.target_re_percentage %}
        ‚úì YTD performance is <strong>{{ diff|floatformat:1 }} percentage points
            ahead</strong> of the {{ year }} annual target.
        {% endwith %}
        {% else %}
        {% with diff=target.target_re_percentage|sub:ytd_summary.re_percentage_underlying %}
        ‚ö† YTD performance is <strong>{{ diff|floatformat:1 }} percentage points
            behind</strong> the {{ year }} annual target. Acceleration needed in remaining quarters.
        {% endwith %}
        {% endif %}
    </p>
    {% endif %}
</div>

<!-- Generation Mix Analysis -->
<div class="section-header">
    <h2>Generation Mix Analysis</h2>

    <h3>Quarterly Generation by Technology (Q{{ quarter }})</h3>

    <table class="data-table">
        <thead>
            <tr>
                <th>Technology</th>
                <th class="value">Gen (GWh)</th>
                <th class="value">% of Operational</th>
                <th class="value">% of Underlying</th>
                <th class="value">Emissions</th>
            </tr>
        </thead>
        <tbody>
            <tr class="renewable-row">
                <td><strong>Wind</strong></td>
                <td class="value">{{ quarterly_summary.wind_generation|floatformat:0|intcomma }}</td>
                <td class="value">{{ quarterly_summary.wind_generation|div:quarterly_summary.operational_demand|mul:100|floatformat:1 }}%</td>
                <td class="value">{{ quarterly_summary.wind_generation|div:quarterly_summary.underlying_demand|mul:100|floatformat:1 }}%</td>
                <td class="value">0</td>
            </tr>
            <tr class="renewable-row">
                <td><strong>Solar (Utility)</strong></td>
                <td class="value">{{ quarterly_summary.solar_generation|floatformat:0|intcomma }}</td>
                <td class="value">{{ quarterly_summary.solar_generation|div:quarterly_summary.operational_demand|mul:100|floatformat:1 }}%</td>
                <td class="value">{{ quarterly_summary.solar_generation|div:quarterly_summary.underlying_demand|mul:100|floatformat:1 }}%</td>
                <td class="value">0</td>
            </tr>
            <tr class="renewable-row">
                <td><strong>Solar (Rooftop)</strong></td>
                <td class="value">{{ quarterly_summary.dpv_generation|floatformat:0|intcomma }}</td>
                <td class="value">‚Äî</td>
                <td class="value">{{ quarterly_summary.dpv_generation|div:quarterly_summary.underlying_demand|mul:100|floatformat:1 }}%</td>
                <td class="value">0</td>
            </tr>
            <tr class="renewable-row">
                <td><strong>Biomass</strong></td>
                <td class="value">{{ quarterly_summary.biomass_generation|floatformat:0|intcomma }}</td>
                <td class="value">{{ quarterly_summary.biomass_generation|div:quarterly_summary.operational_demand|mul:100|floatformat:1 }}%
                </td>
                <td class="value">{{ quarterly_summary.biomass_generation|div:quarterly_summary.underlying_demand|mul:100|floatformat:1 }}%
                </td>
                <td class="value">0</td>
            </tr>
            <tr class="fossil-row">
                <td>Gas</td>
                <td class="value">{{ quarterly_summary.gas_generation|floatformat:0|intcomma }}</td>
                <td class="value">{{ quarterly_summary.gas_generation|div:quarterly_summary.operational_demand|mul:100|floatformat:1 }}%</td>
                <td class="value">{{ quarterly_summary.gas_generation|div:quarterly_summary.underlying_demand|mul:100|floatformat:1 }}%</td>
                <td class="value">{{ quarterly_summary.gas_generation|mul:380|floatformat:0|intcomma }} t</td>
            </tr>
            <tr class="fossil-row">
                <td>Coal</td>
                <td class="value">{{ quarterly_summary.coal_generation|floatformat:1 }}</td>
                <td class="value">{{ quarterly_summary.coal_generation|div:quarterly_summary.operational_demand|mul:100|floatformat:1 }}%</td>
                <td class="value">{{ quarterly_summary.coal_generation|div:quarterly_summary.underlying_demand|mul:100|floatformat:1 }}%</td>
            </tr>
            {% if quarterly_summary.storage_charge > 0 %}
            <tr class="info-row">
                <td><em>Storage Charge</em></td>
                <td class="value"><em>{{ quarterly_summary.storage_charge|floatformat:1 }}</em></td>
                <td class="value" colspan="2"></td>
            </tr>
            {% endif %}
            {% if quarterly_summary.storage_discharge > 0 %}
            <tr class="info-row">
                <td><em>Storage Discharge</em></td>
                <td class="value"><em>{{ quarterly_summary.storage_discharge|floatformat:0|intcomma }}</em></td>
                <td class="value"><em>0</em></td>
            </tr>
            {% endif %}
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td><strong>Total RE%</strong></td>
                <td class="value">‚Äî</td>
                <td class="value"><strong>{{ quarterly_summary.re_percentage_operational|floatformat:1 }}%</strong></td>
                <td class="value"><strong>{{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%</strong></td>
                <td class="value">‚Äî</td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Charts -->
<div class="section-header">
    <h2>Quarterly Trends</h2>

    <div class="chart-container">
        <h3>Monthly Generation Breakdown (Q{{ quarter }} {{ year }})</h3>
        <div id="monthly-generation-chart"></div>
    </div>

    <div class="chart-container">
        <h3>Year-over-Year RE% Comparison (Q{{ quarter }})</h3>
        <div id="yoy-comparison-chart"></div>
    </div>
</div>

<!-- New Capacity -->
{% if new_capacity %}
<div class="section-header">
    <h2>New Capacity Commissioned in Q{{ quarter }} {{ year }}</h2>

    <ul>
        {% for facility in new_capacity %}
        <li style="margin: 10px 0;">
            <strong>{{ facility.facility.facility_name }}</strong> -
            {{ facility.capacity_mw|floatformat:0 }} MW
            ({{ facility.technology_type }})
            <br>
            <small style="color: #666;">Commissioned: {{ facility.commissioned_date|date:"d F Y" }}</small>
        </li>
        {% endfor %}
    </ul>

    <p style="margin-top: 20px;">
        <strong>Total New Capacity Q{{ quarter }} {{ year }}: {{ new_capacity|sum_attr:"capacity_mw"|floatformat:0
            }} MW renewable</strong>
    </p>
</div>
{% endif %}

<!-- Observations and Key Findings -->
<div class="section-header">
    <h2>Key Observations</h2>

    <div class="observations">
        <h3>Positive Developments</h3>
        <ul>
            {% if prev_quarter_summary and quarterly_summary.re_percentage_underlying > prev_quarter_summary.re_percentage_underlying %}
            <li>RE% (underlying) increased by {{ quarterly_summary.re_percentage_underlying|sub:prev_quarter_summary.re_percentage_underlying|floatformat:1 }} percentage points compared to Q{{ quarter }} {{ year|add:"-1" }}</li>
            {% endif %}
            {% if prev_ytd_summary and ytd_summary.total_emissions < prev_ytd_summary.total_emissions %} <li>YTD
                emissions reduced by {{ prev_ytd_summary.total_emissions|sub:ytd_summary.total_emissions|floatformat:0|intcomma }} tonnes
                CO‚ÇÇ-e ({{ prev_ytd_summary.total_emissions|sub:ytd_summary.total_emissions|div:prev_ytd_summary.total_emissions|mul:100|floatformat:1 }}%) compared to same period last year</li>
                {% endif %}
                <li>Wind generation contributed {{ quarterly_summary.wind_generation|percent:quarterly_summary.underlying_demand|floatformat:1 }}%
                    of total underlying demand</li>
                <li>Combined solar (utility + rooftop) provided {{ quarterly_summary.solar_generation|add:quarterly_summary.dpv_generation|percent:quarterly_summary.underlying_demand|floatformat:1 }}% of electricity</li>
                {% if quarterly_summary.wholesale_negative_count and quarterly_summary.wholesale_negative_count > 0 %}
                <li>{{ quarterly_summary.wholesale_negative_count|intcomma }} intervals of negative wholesale prices
                    indicate strong renewable energy penetration</li>
                {% endif %}
        </ul>
    </div>

    <div class="observations" style="background: #fce4ec; border-left-color: #e91e63;">
        <h3>Challenges and Risks</h3>
        <ul>
            {% if target and quarterly_summary.re_percentage_underlying < target.target_re_percentage %} <li>Quarterly RE% ({{ quarterly_summary.re_percentage_underlying|floatformat:1 }}%) is below annual target ({{ target.target_re_percentage }}%)</li>
                {% endif %}
                {% if quarterly_summary.wholesale_spike_count and quarterly_summary.wholesale_spike_count > 0 %}
                <li>{{ quarterly_summary.wholesale_spike_count|intcomma }} price spike intervals (&gt;$300/MWh)
                    indicate periods of grid stress</li>
                {% endif %}
                <li>Continued monitoring needed to ensure annual target achievement</li>
        </ul>
    </div>
</div>
<div class="section-header">
    {% if not is_published_version %}
    {% include "ret_dashboard/partials/comments_section.html" with report_type="quarterly" year=year quarter=quarter comments=comments %}
    {% endif %}
</div>
<!-- Footer -->
<div style="margin-top: 40px; padding: 20px; background: #ecf0f1; border-radius: 8px;">
    {% if not is_published_version %}
    <p style="margin: 0;"><strong>Next Report:</strong> {{ next_report }}</p>
    {% endif %}
    <p style="margin: {% if is_published_version %}0{% else %}5px 0 0 0{% endif %};">
    <strong></strong><a href="mailto:modelling.lead@sen.asn.au">Contact SEN Modelling</a></strong>
    </p>
</div>


<!-- Plotly Charts -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // Monthly Generation Breakdown Chart
    var monthlyGenData = [
        {
            x: [{% for monthly in quarterly_data %}'{{ monthly.get_month_name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    y: [{% for monthly in quarterly_data %}{{ monthly.wind_generation|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
    name: 'Wind',
        type: 'bar',
            marker: { color: '#4CAF50' }
        },
    {
        x: [{% for monthly in quarterly_data %} '{{ monthly.get_month_name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    y: [{% for monthly in quarterly_data %}{{ monthly.solar_generation|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
    name: 'Solar (Utility)',
        type: 'bar',
            marker: { color: '#FFC107' }
        },
    {
        x: [{% for monthly in quarterly_data %} '{{ monthly.get_month_name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    y: [{% for monthly in quarterly_data %}{{ monthly.dpv_generation|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
    name: 'Solar (Rooftop)',
        type: 'bar',
            marker: { color: '#FFE082' }
        },
    {
        x: [{% for monthly in quarterly_data %} '{{ monthly.get_month_name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    y: [{% for monthly in quarterly_data %}{{ monthly.gas_generation|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
    
    name: 'Gas',
        type: 'bar',
            marker: { color: '#9E9E9E' }
        }
    ];

    var monthlyLayout = {
        barmode: 'stack',
        title: 'Monthly Generation by Technology',
        xaxis: { title: 'Month' },
        yaxis: { title: 'Generation (GWh)' },
        legend: { x: 0, y: 1.2, orientation: 'h' }
    };

    Plotly.newPlot('monthly-generation-chart', monthlyGenData, monthlyLayout, { responsive: true });

    // Year-over-Year Comparison - now showing both RE% measures
    var yoyData = [
        {
            x: ['Q{{ quarter }} {{ year|add:"-1" }} (Op)', 'Q{{ quarter }} {{ year }} (Op)', 'Q{{ quarter }} {{ year|add:"-1" }} (Und)', 'Q{{ quarter }} {{ year }} (Und)'],
            y: [{{ prev_quarter_summary.re_percentage_operational|default:0 }}, {{ quarterly_summary.re_percentage_operational }}, {{ prev_quarter_summary.re_percentage_underlying|default:0 }}, {{ quarterly_summary.re_percentage_underlying }}],
    name: 'RE%',
        type: 'bar',
            marker: { color: ['#90CAF9', '#2196F3', '#A5D6A7', '#4CAF50'] }
        }
    ];

    var yoyLayout = {
        title: 'Renewable Energy % Comparison (Operational vs Underlying)',
        yaxis: { title: 'RE%', range: [0, 100] },
        showlegend: false
    };

    Plotly.newPlot('yoy-comparison-chart', yoyData, yoyLayout, { responsive: true });
</script>
{% endblock %}