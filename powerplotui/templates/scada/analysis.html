<!-- templates/scada/analysis.html -->
{% extends 'scada/base.html' %}

{% block title %}SWIS Load Analysis - {{ month_name }} {{ year }}{% endblock %}

{% block content %}
<header>
    <h1>Average SWIS Load by Period</h1>
    <p style="color: #7f8c8d; font-size: 1.1em;">
        South West Interconnected System - {{ month_name }} {{ year }}
    </p>
</header>

<!-- Tab Navigation -->
<div class="tab-navigation">
    <button class="tab-button active" onclick="switchTab('load-analysis')">Load Analysis</button>
    <button class="tab-button" onclick="switchTab('historical-data')">Historical Data</button>
    <button class="tab-button" onclick="switchTab('facility-overview')">Facility Overview</button>
</div>

<!-- Tab: Load Analysis -->
<div id="load-analysis" class="tab-content active">
    <!-- Month Selector -->
    <div class="month-selector">
        <label for="month-select"><strong>Select Period:</strong></label>
        <select id="month-select" name="month">
            {% for m in available_months %}
            <option value="{{ m.value }}" {% if m.value == month %}selected{% endif %}>
                {{ m.label }}
            </option>
            {% endfor %}
        </select>
        <select id="year-select" name="year">
            {% for y in available_years %}
            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
        <button onclick="loadPeriod()">View</button>
        <button onclick="window.print()" style="background: #95a5a6;">Print Report</button>
    </div>

    <!-- Key Metrics Overview -->
    <h2>{{ month_name }} {{ year }} - Key Metrics</h2>

    <div class="metric-grid">
        <div class="metric-card neutral">
            <div class="metric-label">Operational Demand</div>
            <div class="metric-value">{{ summary.operational_demand|floatformat:1 }} GWh</div>
            <div class="metric-change">
                {% if changes.operational_demand %}
                    {% if changes.operational_demand > 0 %}↑{% else %}↓{% endif %}
                    {{ changes.operational_demand|floatformat:1 }}% vs {{ year|add:"-1" }}
                {% endif %}
            </div>
        </div>
        
        <div class="metric-card positive">
            <div class="metric-label">RE % of Operational Demand</div>
            <div class="metric-value">{{ summary.re_percentage_operational|floatformat:1 }}%</div>
            <div class="metric-change">
                {% if prev_summary %}
                    {{ prev_summary.re_percentage_operational|floatformat:1 }}% in {{ year|add:"-1" }}
                {% endif %}
            </div>
        </div>
        
        <div class="metric-card positive">
            <div class="metric-label">RE % of Underlying Demand</div>
            <div class="metric-value">{{ summary.re_percentage_underlying|floatformat:1 }}%</div>
            <div class="metric-change">
                {% if prev_summary %}
                    {{ prev_summary.re_percentage_underlying|floatformat:1 }}% in {{ year|add:"-1" }}
                {% endif %}
            </div>
        </div>
        
        <div class="metric-card neutral">
            <div class="metric-label">DPV Generation</div>
            <div class="metric-value">{{ summary.dpv_generation|floatformat:1 }} GWh</div>
            <div class="metric-change">
                {{ summary.dpv_percentage_underlying|floatformat:1 }}% of underlying demand
            </div>
        </div>
    </div>

    <!-- Generation Breakdown Charts -->
    <h2>Energy Mix Breakdown</h2>

    <div class="chart-container">
        <div class="chart-title">How Operational and Underlying Demand Was Met</div>
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
            Technology breakdown for {{ month_name }} {{ year }} and Year-to-Date {{ year }}
        </p>
        {{ pie_chart|safe }}
    </div>

<!-- Generation Breakdown Charts -->
<h2>Demand Breakdowns</h2>

<div class="chart-container">
    <div class="chart-title">How Operational and Underlying Demand Was Met</div>
    <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
        Four pie charts showing {{ month_name }} {{ year }} followed by YTD {{ year }}
    </p>
    {{ pie_chart|safe }}
</div>

<!-- Diurnal Profiles -->
<h2>Average Diurnal Profiles</h2>

<div class="info-box">
    <h4>About Diurnal Profiles</h4>
    <p>These charts show average underlying demand patterns throughout the day. 
    The <span style="color: #49C2A9; font-weight: 600;">green line</span> shows average prices.</p>
</div>

<div class="chart-container">
    <div class="chart-title">{{ month_name }} {{ year }} - Average Daily Pattern</div>
    {{ diurnal_chart_month|safe }}
</div>

<div class="chart-container">
    <div class="chart-title">YTD {{ year }} - Average Daily Pattern</div>
    {{ diurnal_chart_ytd|safe }}
</div>

<!-- Daily RE Variation -->
{% if daily_re_chart %}
<h2>Daily Renewable Energy Variation</h2>

<div class="chart-container">
    <div class="chart-title">Daily Underlying RE Percentages - {{ month_name }} {{ year }}</div>
    <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
        Range: {{ re_range.min|floatformat:1 }}% ({{ re_range.min_date|date:"jS" }}) 
        to {{ re_range.max|floatformat:1 }}% ({{ re_range.max_date|date:"jS" }})
    </p>
    {{ daily_re_chart|safe }}
</div>
{% endif %}

<!-- Detailed Statistics -->
<h2>Detailed Breakdown - {{ month_name }}</h2>

<table class="stats-table">
    <thead>
        <tr>
            <th>Metric</th>
            <th class="value">{{ month_name }} {{ year }}</th>
            <th class="value">{{ month_name }} {{ year|add:"-1" }}</th>
            <th class="value">Change</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Overall Operational Demand</strong></td>
            <td class="value">{{ summary.operational_demand|floatformat:1 }} GWh</td>
            <td class="value">
                {% if prev_summary %}{{ prev_summary.operational_demand|floatformat:1 }} GWh{% else %}N/A{% endif %}
            </td>
            <td class="value {% if changes.operational_demand > 0 %}positive{% else %}negative{% endif %}">
                {% if changes.operational_demand %}
                    {{ changes.operational_demand|floatformat:1 }}%
                {% else %}N/A{% endif %}
            </td>
        </tr>
        <tr>
            <td>Weekday Demand</td>
            <td class="value">{{ weekday_demand|floatformat:1 }} GWh</td>
            <td class="value">
                {% if prev_weekday_demand %}{{ prev_weekday_demand|floatformat:1 }} GWh{% else %}N/A{% endif %}
            </td>
            <td class="value">
                {% if weekday_change %}{{ weekday_change|floatformat:1 }}%{% else %}N/A{% endif %}
            </td>
        </tr>
        <tr>
            <td>Weekend Demand</td>
            <td class="value">{{ weekend_demand|floatformat:1 }} GWh</td>
            <td class="value">
                {% if prev_weekend_demand %}{{ prev_weekend_demand|floatformat:1 }} GWh{% else %}N/A{% endif %}
            </td>
            <td class="value">
                {% if weekend_change %}{{ weekend_change|floatformat:1 }}%{% else %}N/A{% endif %}
            </td>
        </tr>
    </tbody>
</table>

<!-- RE Percentage Details -->
<h3>Renewable Energy Performance</h3>

<div class="info-box">
    <h4>{{ month_name }} Highlights</h4>
    <ul class="bullet-list">
        <li>RE met <span class="highlight">{{ summary.re_percentage_operational|floatformat:1 }}%</span> 
            of Operational demand, compared to 
            <span class="highlight">{{ prev_summary.re_percentage_operational|floatformat:1 }}%</span> 
            in {{ year|add:"-1" }}</li>
        <li><strong>RE met <span class="highlight">{{ summary.re_percentage_underlying|floatformat:1 }}%</span> 
            of underlying demand</strong>, 
            <span class="highlight">{{ prev_summary.re_percentage_underlying|floatformat:1 }}%</span> 
            in {{ year|add:"-1" }}</li>
        <li>Operational demand increased by 
            <span class="highlight">{{ changes.operational_demand|floatformat:1 }}%</span> 
            over {{ month_name }} {{ year|add:"-1" }}</li>
        <li>DPV met <span class="highlight">{{ summary.dpv_percentage_underlying|floatformat:1 }}%</span> 
            of underlying demand</li>
        <li>BESS represented <span class="highlight">{{ bess_percentage|floatformat:1 }}%</span> 
            of Operational demand</li>
    </ul>
</div>

    <!-- YTD Summary -->
    <h2>Year to Date - {{ month_name }} {{ year }}</h2>

    <table class="stats-table">
        <thead>
            <tr>
                <th>Metric</th>
                <th class="value">YTD {{ year }}</th>
                <th class="value">YTD {{ year|add:"-1" }}</th>
                <th class="value">Change</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Overall Operational Demand</strong></td>
                <td class="value">{{ ytd_summary.operational_demand|floatformat:1 }} GWh</td>
                <td class="value">{{ ytd_prev_summary.operational_demand|floatformat:1 }} GWh</td>
                <td class="value positive">{{ ytd_changes.operational_demand|floatformat:1 }}%</td>
            </tr>
            <tr>
                <td>Underlying Demand</td>
                <td class="value">{{ ytd_summary.underlying_demand|floatformat:1 }} GWh</td>
                <td class="value">{{ ytd_prev_summary.underlying_demand|floatformat:1 }} GWh</td>
                <td class="value">N/A</td>
            </tr>
            <tr>
                <td>DPV Generation</td>
                <td class="value">{{ ytd_summary.dpv_generation|floatformat:1 }} GWh</td>
                <td class="value">{{ ytd_prev_summary.dpv_generation|floatformat:1 }} GWh</td>
                <td class="value">N/A</td>
            </tr>
            <tr>
                <td>Wind Generation</td>
                <td class="value">{{ ytd_summary.wind_generation|floatformat:1 }} GWh</td>
                <td class="value">{{ ytd_prev_summary.wind_generation|floatformat:1 }} GWh</td>
                <td class="value">N/A</td>
            </tr>
            <tr>
                <td>Solar Generation</td>
                <td class="value">{{ ytd_summary.solar_generation|floatformat:1 }} GWh</td>
                <td class="value">{{ ytd_prev_summary.solar_generation|floatformat:1 }} GWh</td>
                <td class="value">N/A</td>
            </tr>
            <tr>
                <td>Battery Discharge</td>
                <td class="value">{{ ytd_summary.battery_discharge|floatformat:1 }} GWh</td>
                <td class="value">{{ ytd_prev_summary.battery_discharge|floatformat:1 }} GWh</td>
                <td class="value">N/A</td>
            </tr>
            <tr>
                <td>Fossil Generation</td>
                <td class="value">{{ ytd_summary.fossil_generation|floatformat:1 }} GWh</td>
                <td class="value">{{ ytd_prev_summary.fossil_generation|floatformat:1 }} GWh</td>
                <td class="value">N/A</td>
            </tr>
            <tr class="total-row">
                <td><strong>RE % of Operational</strong></td>
                <td class="value">{{ ytd_summary.re_percentage_operational|floatformat:1 }}%</td>
                <td class="value">{{ ytd_prev_summary.re_percentage_operational|floatformat:1 }}%</td>
                <td class="value">
                    {% if ytd_summary.re_percentage_operational > ytd_prev_summary.re_percentage_operational %}
                        +{{ ytd_summary.re_percentage_operational|floatformat:1|add:"-"|add:ytd_prev_summary.re_percentage_operational|floatformat:1 }}pp
                    {% else %}
                        {{ ytd_summary.re_percentage_operational|floatformat:1|add:"-"|add:ytd_prev_summary.re_percentage_operational|floatformat:1 }}pp
                    {% endif %}
                </td>
            </tr>
            <tr class="total-row">
                <td><strong>RE % of Underlying</strong></td>
                <td class="value">{{ ytd_summary.re_percentage_underlying|floatformat:1 }}%</td>
                <td class="value">{{ ytd_prev_summary.re_percentage_underlying|floatformat:1 }}%</td>
                <td class="value">N/A</td>
            </tr>
        </tbody>
    </table>

    <div class="info-box" style="margin-top: 30px;">
        <h4>YTD {{ year }} BESS Metrics</h4>
        <ul class="bullet-list">
            <li>BESS represented <span class="highlight">{{ ytd_bess_percentage|floatformat:1 }}%</span> 
                of Operational demand (vs <span class="highlight">{{ ytd_prev_bess_percentage|floatformat:1 }}%</span> in {{ year|add:"-1" }})</li>
            <li>Round-trip efficiency: <span class="highlight">{{ ytd_bess_efficiency|floatformat:1 }}%</span></li>
        </ul>
    </div>
</div>

<!-- Tab: Historical Data -->
<div id="historical-data" class="tab-content">
    <h2>Historical Trends & Analysis</h2>
    <p style="color: #7f8c8d; margin-bottom: 30px;">
        View long-term trends in demand, renewable energy penetration, and generation mix.
    </p>

    <!-- Time Range Selector -->
    <div class="historical-controls">
        <label for="hist-view-select"><strong>View:</strong></label>
        <select id="hist-view-select" onchange="updateHistoricalView()">
            <option value="monthly">Monthly Data</option>
            <option value="yearly">Annual Comparison</option>
        </select>
        
        <label for="hist-year-start"><strong>From:</strong></label>
        <select id="hist-year-start">
            {% for y in available_years %}
            <option value="{{ y }}" {% if y == year|add:"-2" %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
        
        <label for="hist-year-end"><strong>To:</strong></label>
        <select id="hist-year-end">
            {% for y in available_years %}
            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
        
        <button onclick="loadHistoricalData()">Update View</button>
        <button onclick="exportHistoricalData()" style="background: #27ae60;">Export CSV</button>
    </div>

    <!-- Trend Charts -->
    <h3>Demand Trends</h3>
    <div class="chart-container">
        <div class="chart-title">Operational and Underlying Demand Over Time</div>
        {{ historical_demand_chart|safe }}
    </div>

    <h3>Renewable Energy Penetration</h3>
    <div class="chart-container">
        <div class="chart-title">RE Percentage of Operational and Underlying Demand</div>
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
            Track renewable energy penetration progress over time
        </p>
        {{ historical_re_chart|safe }}
    </div>

    <h3>Generation Mix Evolution</h3>
    <div class="chart-container">
        <div class="chart-title">Energy Sources Over Time</div>
        {{ historical_mix_chart|safe }}
    </div>

    <!-- Comparison Table -->
    <h3>Period Comparison Table</h3>
    
    <div class="info-box">
        <p><strong>Tip:</strong> Click on column headers to sort. All values are in GWh unless otherwise specified.</p>
    </div>

    <div class="table-wrapper">
        <table class="stats-table historical-table" id="historical-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Period <span class="sort-icon">⇅</span></th>
                    <th onclick="sortTable(1)" class="value">Operational<br>Demand (GWh) <span class="sort-icon">⇅</span></th>
                    <th onclick="sortTable(2)" class="value">Underlying<br>Demand (GWh) <span class="sort-icon">⇅</span></th>
                    <th onclick="sortTable(3)" class="value">Wind<br>(GWh) <span class="sort-icon">⇅</span></th>
                    <th onclick="sortTable(4)" class="value">Solar<br>(GWh) <span class="sort-icon">⇅</span></th>
                    <th onclick="sortTable(5)" class="value">DPV<br>(GWh) <span class="sort-icon">⇅</span></th>
                    <th onclick="sortTable(6)" class="value">Fossil<br>(GWh) <span class="sort-icon">⇅</span></th>
                    <th onclick="sortTable(7)" class="value">RE %<br>Operational <span class="sort-icon">⇅</span></th>
                    <th onclick="sortTable(8)" class="value">RE %<br>Underlying <span class="sort-icon">⇅</span></th>
                </tr>
            </thead>
            <tbody>
                {% for record in historical_data %}
                <tr class="{% cycle 'odd' 'even' %}">
                    <td><strong>{{ record.period_label }}</strong></td>
                    <td class="value">{{ record.operational_demand|floatformat:1 }}</td>
                    <td class="value">{{ record.underlying_demand|floatformat:1 }}</td>
                    <td class="value">{{ record.wind_generation|floatformat:1 }}</td>
                    <td class="value">{{ record.solar_generation|floatformat:1 }}</td>
                    <td class="value">{{ record.dpv_generation|floatformat:1 }}</td>
                    <td class="value">{{ record.fossil_generation|floatformat:1 }}</td>
                    <td class="value re-percent">{{ record.re_percentage_operational|floatformat:1 }}%</td>
                    <td class="value re-percent">{{ record.re_percentage_underlying|floatformat:1 }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Key Statistics Summary -->
    <h3>Historical Summary Statistics</h3>
    
    <div class="metric-grid">
        <div class="metric-card neutral">
            <div class="metric-label">Average Monthly Demand</div>
            <div class="metric-value">{{ historical_stats.avg_operational_demand|floatformat:1 }} GWh</div>
            <div class="metric-change">Range: {{ historical_stats.min_operational_demand|floatformat:1 }} - {{ historical_stats.max_operational_demand|floatformat:1 }} GWh</div>
        </div>
        
        <div class="metric-card positive">
            <div class="metric-label">RE Penetration Growth</div>
            <div class="metric-value">{{ historical_stats.re_growth|floatformat:1 }}pp</div>
            <div class="metric-change">From {{ historical_stats.first_re_percent|floatformat:1 }}% to {{ historical_stats.last_re_percent|floatformat:1 }}%</div>
        </div>
        
        <div class="metric-card positive">
            <div class="metric-label">Total Renewable Energy</div>
            <div class="metric-value">{{ historical_stats.total_re_generation|floatformat:0 }} GWh</div>
            <div class="metric-change">Across all periods displayed</div>
        </div>
        
        <div class="metric-card neutral">
            <div class="metric-label">Peak RE Month</div>
            <div class="metric-value">{{ historical_stats.peak_re_month }}</div>
            <div class="metric-change">{{ historical_stats.peak_re_value|floatformat:1 }}% of operational demand</div>
        </div>
    </div>

    <!-- Year-over-Year Comparison -->
    {% if yearly_comparison %}
    <h3>Annual Performance Comparison</h3>
    
    <table class="stats-table">
        <thead>
            <tr>
                <th>Year</th>
                <th class="value">Total Operational<br>Demand (GWh)</th>
                <th class="value">Average RE %<br>Operational</th>
                <th class="value">Total Wind<br>(GWh)</th>
                <th class="value">Total Solar<br>(GWh)</th>
                <th class="value">YoY Demand<br>Change</th>
                <th class="value">YoY RE<br>Change (pp)</th>
            </tr>
        </thead>
        <tbody>
            {% for year_data in yearly_comparison %}
            <tr>
                <td><strong>{{ year_data.year }}</strong></td>
                <td class="value">{{ year_data.total_operational_demand|floatformat:0 }}</td>
                <td class="value re-percent">{{ year_data.avg_re_percentage|floatformat:1 }}%</td>
                <td class="value">{{ year_data.total_wind|floatformat:0 }}</td>
                <td class="value">{{ year_data.total_solar|floatformat:0 }}</td>
                <td class="value {% if year_data.yoy_demand_change > 0 %}positive{% elif year_data.yoy_demand_change < 0 %}negative{% endif %}">
                    {% if year_data.yoy_demand_change %}
                        {{ year_data.yoy_demand_change|floatformat:1 }}%
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td class="value {% if year_data.yoy_re_change > 0 %}positive{% elif year_data.yoy_re_change < 0 %}negative{% endif %}">
                    {% if year_data.yoy_re_change %}
                        {{ year_data.yoy_re_change|floatformat:1 }}pp
                    {% else %}
                        N/A
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- Insights Box -->
    <div class="info-box" style="margin-top: 30px;">
        <h4>📊 Key Insights from Historical Data</h4>
        <ul class="bullet-list">
            <li>Renewable energy penetration has grown by <span class="highlight">{{ historical_stats.re_growth|floatformat:1 }} percentage points</span> over the displayed period</li>
            <li>The highest RE percentage was <span class="highlight">{{ historical_stats.peak_re_value|floatformat:1 }}%</span> in {{ historical_stats.peak_re_month }}</li>
            <li>Average operational demand: <span class="highlight">{{ historical_stats.avg_operational_demand|floatformat:1 }} GWh/month</span></li>
            <li>Total renewable generation across all periods: <span class="highlight">{{ historical_stats.total_re_generation|floatformat:0 }} GWh</span></li>
        </ul>
    </div>
</div>

<!-- Tab: Facility Overview -->
<div id="facility-overview" class="tab-content">
    <h2>Facility Overview</h2>
    <p style="color: #7f8c8d; margin-bottom: 30px;">
        Comprehensive view of all generation facilities in the SWIS network.
    </p>

    <!-- Facility Statistics -->
    <div class="facility-stats-grid">
        <div class="facility-stat-card">
            <div class="stat-icon">⚡</div>
            <div class="stat-value">{{ facility_stats.total_capacity|floatformat:0 }}</div>
            <div class="stat-label">Total Capacity (MW)</div>
        </div>
        <div class="facility-stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <div class="stat-icon">🌱</div>
            <div class="stat-value">{{ facility_stats.renewable_capacity|floatformat:0 }}</div>
            <div class="stat-label">Renewable Capacity (MW)</div>
        </div>
        <div class="facility-stat-card" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);">
            <div class="stat-icon">🏭</div>
            <div class="stat-value">{{ facility_stats.total_facilities }}</div>
            <div class="stat-label">Total Facilities</div>
        </div>
        <div class="facility-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="stat-icon">📊</div>
            <div class="stat-value">{{ facility_stats.renewable_percentage|floatformat:1 }}%</div>
            <div class="stat-label">RE Capacity Share</div>
        </div>
    </div>

    {% if capacity_chart %}
    <h3 style="margin-top: 40px;">Installed Capacity by Fuel Type</h3>
    <div class="chart-container">
        {{ capacity_chart|safe }}
    </div>
    {% endif %}

    <!-- Top Performers -->
    {% if top_performers %}
    <h3 style="margin-top: 40px;">Top Performers - {{ month_name }} {{ year }}</h3>
    <table class="stats-table">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Facility</th>
                <th>Fuel Type</th>
                <th>Generation (GWh)</th>
                <th>Capacity Factor (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for performer in top_performers %}
            <tr>
                <td class="value">{{ forloop.counter }}</td>
                <td>{{ performer.name }}</td>
                <td><span class="facility-badge {{ performer.fuel_type }}">{{ performer.fuel_type|upper }}</span></td>
                <td class="value">{{ performer.monthly_generation|floatformat:1 }}</td>
                <td class="value">{{ performer.capacity_factor|floatformat:1 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<!-- Tab: Export Data -->
<div id="export-data" class="tab-content">
    <h2>Export Data</h2>
    <p style="color: #7f8c8d;">Download analysis data in various formats.</p>
    <div class="info-box">
        <p>Export options:</p>
        <ul style="margin-top: 10px;">
            <li>CSV format for spreadsheet analysis</li>
            <li>JSON format for API integration</li>
            <li>PDF report generation</li>
        </ul>
        <button style="margin-top: 15px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Export Current Period
        </button>
    </div>
</div>

<style>
.tab-navigation {
    display: flex;
    gap: 5px;
    margin: 20px 0;
    border-bottom: 2px solid #e0e0e0;
}

.tab-button {
    padding: 12px 24px;
    background: #f5f5f5;
    border: none;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    font-size: 1em;
    transition: all 0.3s ease;
    color: #555;
}

.tab-button:hover {
    background: #e0e0e0;
}

.tab-button.active {
    background: #3498db;
    color: white;
    font-weight: 600;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Historical Data Styles */
.historical-controls {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.historical-controls label {
    color: #2c3e50;
    font-weight: 500;
}

.historical-controls select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95em;
}

.historical-controls button {
    padding: 8px 16px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.3s ease;
}

.historical-controls button:hover {
    background: #2980b9;
}

.table-wrapper {
    overflow-x: auto;
    margin: 20px 0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.historical-table {
    min-width: 1000px;
}

.historical-table th {
    cursor: pointer;
    user-select: none;
    position: relative;
}

.sort-icon {
    font-size: 0.8em;
    color: #95a5a6;
    margin-left: 5px;
}

.historical-table tr.odd {
    background-color: #f9f9f9;
}

.historical-table tr.even {
    background-color: #ffffff;
}

.historical-table tr:hover {
    background-color: #e8f4f8;
}

.re-percent {
    color: #27ae60;
    font-weight: 600;
}

/* Facility Overview Styles */
.facility-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.facility-stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stat-icon {
    font-size: 2.5em;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 2em;
    font-weight: 700;
    margin: 10px 0;
}

.stat-label {
    font-size: 0.9em;
    opacity: 0.9;
}

.facility-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .historical-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .historical-controls select,
    .historical-controls button {
        width: 100%;
    }
    
    .metric-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function loadPeriod() {
    const month = document.getElementById('month-select').value;
    const year = document.getElementById('year-select').value;
    window.location.href = `/scada_analysis/${year}/${month}/`;
}

function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

// Historical Data Functions
function loadHistoricalData() {
    const viewType = document.getElementById('hist-view-select').value;
    const yearStart = document.getElementById('hist-year-start').value;
    const yearEnd = document.getElementById('hist-year-end').value;
    
    window.location.href = `/scada_analysis/historical/?view=${viewType}&start=${yearStart}&end=${yearEnd}`;
}

function updateHistoricalView() {
    // This could be enhanced to update the view without full page reload
    loadHistoricalData();
}

function exportHistoricalData() {
    const yearStart = document.getElementById('hist-year-start').value;
    const yearEnd = document.getElementById('hist-year-end').value;
    
    window.location.href = `/scada_analysis/export/?start=${yearStart}&end=${yearEnd}&format=csv`;
}

// Table sorting function
let sortDirections = {};

function sortTable(columnIndex) {
    const table = document.getElementById('historical-table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort direction
    if (!sortDirections[columnIndex]) {
        sortDirections[columnIndex] = 'asc';
    } else {
        sortDirections[columnIndex] = sortDirections[columnIndex] === 'asc' ? 'desc' : 'asc';
    }
    
    const direction = sortDirections[columnIndex];
    
    rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent.trim();
        let bValue = b.cells[columnIndex].textContent.trim();
        
        // Remove % and GWh for numeric comparisons
        aValue = parseFloat(aValue.replace(/[^\d.-]/g, '')) || aValue;
        bValue = parseFloat(bValue.replace(/[^\d.-]/g, '')) || bValue;
        
        if (typeof aValue === 'number' && typeof bValue === 'number') {
            return direction === 'asc' ? aValue - bValue : bValue - aValue;
        }
        
        return direction === 'asc' 
            ? aValue.toString().localeCompare(bValue.toString())
            : bValue.toString().localeCompare(aValue.toString());
    });
    
    // Reappend rows in sorted order
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort icons
    const headers = table.querySelectorAll('th');
    headers.forEach((header, index) => {
        const icon = header.querySelector('.sort-icon');
        if (icon) {
            if (index === columnIndex) {
                icon.textContent = direction === 'asc' ? '↑' : '↓';
                icon.style.color = '#3498db';
            } else {
                icon.textContent = '⇅';
                icon.style.color = '#95a5a6';
            }
        }
    });
}

// Facility Overview Functions
function filterFacilities() {
    const fuelType = document.getElementById('fuel-type-filter').value;
    const minCapacity = parseFloat(document.getElementById('capacity-filter').value) || 0;
    const searchTerm = document.getElementById('search-filter').value.toLowerCase();
    
    const facilities = document.querySelectorAll('.facility-card');
    let visibleCount = 0;
    
    facilities.forEach(facility => {
        const facilityFuelType = facility.dataset.fuelType;
        const facilityCapacity = parseFloat(facility.dataset.capacity);
        const facilityName = facility.dataset.name;
        
        const matchesFuelType = fuelType === 'all' || facilityFuelType === fuelType;
        const matchesCapacity = facilityCapacity >= minCapacity;
        const matchesSearch = searchTerm === '' || facilityName.includes(searchTerm);
        
        if (matchesFuelType && matchesCapacity && matchesSearch) {
            facility.style.display = 'block';
            visibleCount++;
        } else {
            facility.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    const noResults = document.getElementById('no-results');
    if (visibleCount === 0) {
        noResults.style.display = 'block';
    } else {
        noResults.style.display = 'none';
    }
}

</script>

{% endblock %}

{% block extra_js %}
<script>
// Enable keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        navigateMonth(-1);
    } else if (e.key === 'ArrowRight') {
        navigateMonth(1);
    }
});

function navigateMonth(direction) {
    let month = parseInt(document.getElementById('month-select').value);
    let year = parseInt(document.getElementById('year-select').value);
    
    month += direction;
    if (month > 12) {
        month = 1;
        year++;
    } else if (month < 1) {
        month = 12;
        year--;
    }
    
    window.location.href = `/scada_analysis/${year}/${month}/`;
}
</script>
{% endblock %}