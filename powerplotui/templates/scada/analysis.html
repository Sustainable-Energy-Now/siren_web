<!-- templates/scada/analysis.html -->
{% extends 'scada/base.html' %}

{% block title %}SWIS Load Analysis - {{ month_name }} {{ year }}{% endblock %}

{% block content %}
<header>
    <h1>Average SWIS Load by Period</h1>
    <p style="color: #7f8c8d; font-size: 1.1em;">
        South West Interconnected System - {{ month_name }} {{ year }}
    </p>
</header>

<!-- Tab Navigation -->
<div class="tab-navigation">
    <button class="tab-button active" onclick="switchTab('load-analysis')">Load Analysis</button>
    <button class="tab-button" onclick="switchTab('historical-data')">Historical Data</button>
    <button class="tab-button" onclick="switchTab('facility-overview')">Facility Overview</button>
</div>

<!-- Tab: Load Analysis -->
<div id="load-analysis" class="tab-content active">
    <!-- Month Selector -->
    <div class="month-selector">
        <label for="month-select"><strong>Select Period:</strong></label>
        <select id="month-select" name="month">
            {% for m in available_months %}
            <option value="{{ m.value }}" {% if m.value == month %}selected{% endif %}>
                {{ m.label }}
            </option>
            {% endfor %}
        </select>
        <select id="year-select" name="year">
            {% for y in available_years %}
            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
        <button onclick="loadPeriod()">View</button>
        <button onclick="window.print()" style="background: #95a5a6;">Print Report</button>
    </div>

    <div class="info-box warning">
        <h4>‚ö† Important Note</h4>
        <p><em>Effective 1 October 2023, the WEM moved to 5-minute trading intervals. Relationships between 
        figures from October 1, 2023 onwards (post-reform) and prior to (pre-reform) are somewhat suspect.</em></p>
    </div>

    <!-- Key Metrics Overview -->
    <h2>{{ month_name }} {{ year }} - Key Metrics</h2>

    <div class="metric-grid">
        <div class="metric-card neutral">
            <div class="metric-label">Operational Demand</div>
            <div class="metric-value">{{ summary.operational_demand|floatformat:1 }} GWh</div>
            <div class="metric-change">
                {% if changes.operational_demand %}
                    {% if changes.operational_demand > 0 %}‚Üë{% else %}‚Üì{% endif %}
                    {{ changes.operational_demand|floatformat:1 }}% vs {{ year|add:"-1" }}
                {% endif %}
            </div>
        </div>
        
        <div class="metric-card positive">
            <div class="metric-label">RE % of Operational Demand</div>
            <div class="metric-value">{{ summary.re_percentage_operational|floatformat:1 }}%</div>
            <div class="metric-change">
                {% if prev_summary %}
                    {{ prev_summary.re_percentage_operational|floatformat:1 }}% in {{ year|add:"-1" }}
                {% endif %}
            </div>
        </div>
        
        <div class="metric-card positive">
            <div class="metric-label">RE % of Underlying Demand</div>
            <div class="metric-value">{{ summary.re_percentage_underlying|floatformat:1 }}%</div>
            <div class="metric-change">
                {% if prev_summary %}
                    {{ prev_summary.re_percentage_underlying|floatformat:1 }}% in {{ year|add:"-1" }}
                {% endif %}
            </div>
        </div>
        
        <div class="metric-card neutral">
            <div class="metric-label">DPV Generation</div>
            <div class="metric-value">{{ summary.dpv_generation|floatformat:1 }} GWh</div>
            <div class="metric-change">
                {{ summary.dpv_percentage_underlying|floatformat:1 }}% of underlying demand
            </div>
        </div>
    </div>

    <!-- Generation Breakdown Charts -->
    <h2>Energy Mix Breakdown</h2>

    <div class="chart-container">
        <div class="chart-title">How Operational and Underlying Demand Was Met</div>
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
            Technology breakdown for {{ month_name }} {{ year }} and Year-to-Date {{ year }}
        </p>
        {{ pie_chart|safe }}
    </div>

<!-- Generation Breakdown Charts -->
<h2>Demand Breakdowns</h2>

<div class="chart-container">
    <div class="chart-title">How Operational and Underlying Demand Was Met</div>
    <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
        Four pie charts showing {{ month_name }} {{ year }} followed by YTD {{ year }}
    </p>
    {{ pie_chart|safe }}
</div>

<!-- Diurnal Profiles -->
<h2>Average Diurnal Profiles</h2>

<div class="info-box">
    <h4>About Diurnal Profiles</h4>
    <p>These charts show average underlying demand patterns throughout the day. 
    The <span style="color: #49C2A9; font-weight: 600;">green line</span> shows average prices.</p>
</div>

<div class="chart-container">
    <div class="chart-title">{{ month_name }} {{ year }} - Average Daily Pattern</div>
    {{ diurnal_chart_month|safe }}
</div>

<div class="chart-container">
    <div class="chart-title">YTD {{ year }} - Average Daily Pattern</div>
    {{ diurnal_chart_ytd|safe }}
</div>

<!-- Daily RE Variation -->
{% if daily_re_chart %}
<h2>Daily Renewable Energy Variation</h2>

<div class="chart-container">
    <div class="chart-title">Daily Underlying RE Percentages - {{ month_name }} {{ year }}</div>
    <p style="text-align: center; color: #7f8c8d; margin-bottom: 20px;">
        Range: {{ re_range.min|floatformat:1 }}% ({{ re_range.min_date|date:"jS" }}) 
        to {{ re_range.max|floatformat:1 }}% ({{ re_range.max_date|date:"jS" }})
    </p>
    {{ daily_re_chart|safe }}
</div>
{% endif %}

<!-- Detailed Statistics -->
<h2>Detailed Breakdown - {{ month_name }}</h2>

<table class="stats-table">
    <thead>
        <tr>
            <th>Metric</th>
            <th class="value">{{ month_name }} {{ year }}</th>
            <th class="value">{{ month_name }} {{ year|add:"-1" }}</th>
            <th class="value">Change</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Overall Operational Demand</strong></td>
            <td class="value">{{ summary.operational_demand|floatformat:1 }} GWh</td>
            <td class="value">
                {% if prev_summary %}{{ prev_summary.operational_demand|floatformat:1 }} GWh{% else %}N/A{% endif %}
            </td>
            <td class="value {% if changes.operational_demand > 0 %}positive{% else %}negative{% endif %}">
                {% if changes.operational_demand %}
                    {{ changes.operational_demand|floatformat:1 }}%
                {% else %}N/A{% endif %}
            </td>
        </tr>
        <tr>
            <td>Weekday Demand</td>
            <td class="value">{{ weekday_demand|floatformat:1 }} GWh</td>
            <td class="value">
                {% if prev_weekday_demand %}{{ prev_weekday_demand|floatformat:1 }} GWh{% else %}N/A{% endif %}
            </td>
            <td class="value">
                {% if weekday_change %}{{ weekday_change|floatformat:1 }}%{% else %}N/A{% endif %}
            </td>
        </tr>
        <tr>
            <td>Weekend Demand</td>
            <td class="value">{{ weekend_demand|floatformat:1 }} GWh</td>
            <td class="value">
                {% if prev_weekend_demand %}{{ prev_weekend_demand|floatformat:1 }} GWh{% else %}N/A{% endif %}
            </td>
            <td class="value">
                {% if weekend_change %}{{ weekend_change|floatformat:1 }}%{% else %}N/A{% endif %}
            </td>
        </tr>
    </tbody>
</table>

<!-- RE Percentage Details -->
<h3>Renewable Energy Performance</h3>

<div class="info-box">
    <h4>{{ month_name }} Highlights</h4>
    <ul class="bullet-list">
        <li>RE met <span class="highlight">{{ summary.re_percentage_operational|floatformat:1 }}%</span> 
            of Operational demand, compared to 
            <span class="highlight">{{ prev_summary.re_percentage_operational|floatformat:1 }}%</span> 
            in {{ year|add:"-1" }}</li>
        <li><strong>RE met <span class="highlight">{{ summary.re_percentage_underlying|floatformat:1 }}%</span> 
            of underlying demand</strong>, 
            <span class="highlight">{{ prev_summary.re_percentage_underlying|floatformat:1 }}%</span> 
            in {{ year|add:"-1" }}</li>
        <li>Operational demand increased by 
            <span class="highlight">{{ changes.operational_demand|floatformat:1 }}%</span> 
            over {{ month_name }} {{ year|add:"-1" }}</li>
        <li>DPV met <span class="highlight">{{ summary.dpv_percentage_underlying|floatformat:1 }}%</span> 
            of underlying demand</li>
        <li>BESS represented <span class="highlight">{{ bess_percentage|floatformat:1 }}%</span> 
            of Operational demand</li>
    </ul>
</div>

    <!-- YTD Summary -->
    <h2>Year to Date - {{ month_name }} {{ year }}</h2>

    <table class="stats-table">
        <thead>
            <tr>
                <th>Metric</th>
                <th class="value">YTD {{ year }}</th>
                <th class="value">YTD {{ year|add:"-1" }}</th>
                <th class="value">Change</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Overall Operational Demand</strong></td>
                <td class="value">{{ ytd_summary.operational_demand|floatformat:1 }} GWh</td>
                <td class="value">{{ ytd_prev_summary.operational_demand|floatformat:1 }} GWh</td>
                <td class="value positive">{{ ytd_changes.operational_demand|floatformat:1 }}%</td>
            </tr>
            <tr>
                <td>RE % of Operational Demand</td>
                <td class="value">{{ ytd_summary.re_percentage_operational|floatformat:1 }}%</td>
                <td class="value">{{ ytd_prev_summary.re_percentage_operational|floatformat:1 }}%</td>
                <td class="value">-</td>
            </tr>
            <tr>
                <td><strong>RE % of Underlying Demand</strong></td>
                <td class="value"><strong>{{ ytd_summary.re_percentage_underlying|floatformat:1 }}%</strong></td>
                <td class="value">{{ ytd_prev_summary.re_percentage_underlying|floatformat:1 }}%</td>
                <td class="value">-</td>
            </tr>
            <tr>
                <td>DPV % of Underlying Demand</td>
                <td class="value">{{ ytd_summary.dpv_percentage_underlying|floatformat:1 }}%</td>
                <td class="value">{{ ytd_prev_summary.dpv_percentage_underlying|floatformat:1 }}%</td>
                <td class="value">-</td>
            </tr>
            <tr>
                <td>BESS % of Operational Demand</td>
                <td class="value">{{ ytd_bess_percentage|floatformat:1 }}%</td>
                <td class="value">{{ ytd_prev_bess_percentage|floatformat:1 }}%</td>
                <td class="value">-</td>
            </tr>
        </tbody>
    </table>

    <!-- BESS Note -->
    <h2>Notes on Battery Storage (BESS)</h2>

    <div class="info-box warning">
        <h4>BESS and RE Percentage Calculation</h4>
        <p>In calculating RE percentage, the assumption is made that BESS are only recharged by RE generation. 
        This is not entirely correct and may inflate the RE percentage by approximately 2.1%.</p>
    </div>

    <table class="stats-table" style="margin-top: 20px;">
        <thead>
            <tr>
                <th>BESS Metrics</th>
                <th class="value">{{ month_name }}</th>
                <th class="value">YTD</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Total Discharge</td>
                <td class="value">{{ summary.battery_discharge|floatformat:1 }} GWh</td>
                <td class="value">{{ ytd_summary.battery_discharge|floatformat:1 }} GWh</td>
            </tr>
            <tr>
                <td>Total Charge</td>
                <td class="value">{{ summary.battery_charge|floatformat:1 }} GWh</td>
                <td class="value">{{ ytd_summary.battery_charge|floatformat:1 }} GWh</td>
            </tr>
            <tr>
                <td>Round-trip Efficiency</td>
                <td class="value">{{ bess_efficiency|floatformat:1 }}%</td>
                <td class="value">{{ ytd_bess_efficiency|floatformat:1 }}%</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Tab: Historical Data -->
<div id="historical-data" class="tab-content">
    <h2>Historical Trends</h2>
    <p style="color: #7f8c8d;">View long-term trends in demand and renewable energy penetration.</p>
    <div class="info-box">
        <p>This feature will display historical data trends across multiple years. Coming soon.</p>
    </div>
</div>

<!-- Tab: Facility Overview -->
<div id="facility-overview" class="tab-content">
    <h2>Generation Facility Overview</h2>
    <p style="color: #7f8c8d;">Detailed information about generation facilities in the South West Interconnected System</p>
    
    <!-- Summary Statistics -->
    <div class="facility-stats-grid">
        <div class="facility-stat-card">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-value">{{ facility_stats.total_capacity|floatformat:0 }} MW</div>
            <div class="stat-label">Total Installed Capacity</div>
        </div>
        <div class="facility-stat-card">
            <div class="stat-icon">üè≠</div>
            <div class="stat-value">{{ facility_stats.total_facilities }}</div>
            <div class="stat-label">Active Facilities</div>
        </div>
        <div class="facility-stat-card">
            <div class="stat-icon">üå±</div>
            <div class="stat-value">{{ facility_stats.renewable_capacity|floatformat:0 }} MW</div>
            <div class="stat-label">Renewable Capacity</div>
        </div>
        <div class="facility-stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-value">{{ facility_stats.renewable_percentage|floatformat:1 }}%</div>
            <div class="stat-label">Renewable Share</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="facility-filters">
        <h3>Filter Facilities</h3>
        <div class="filter-row">
            <div class="filter-group">
                <label for="fuel-type-filter">Fuel Type:</label>
                <select id="fuel-type-filter" onchange="filterFacilities()">
                    <option value="all">All Types</option>
                    <option value="wind">Wind</option>
                    <option value="solar">Solar</option>
                    <option value="battery">Battery Storage</option>
                    <option value="gas">Gas</option>
                    <option value="coal">Coal</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="status-filter">Status:</label>
                <select id="status-filter" onchange="filterFacilities()">
                    <option value="all">All Status</option>
                    <option value="operational">Operational</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="offline">Offline</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="capacity-filter">Min Capacity (MW):</label>
                <input type="number" id="capacity-filter" placeholder="0" min="0" onchange="filterFacilities()">
            </div>
            <div class="filter-group">
                <label for="search-filter">Search:</label>
                <input type="text" id="search-filter" placeholder="Facility name..." onkeyup="filterFacilities()">
            </div>
        </div>
    </div>

    <!-- Facilities Grid -->
    <div class="facilities-container">
        {% for facility in facilities %}
        <div class="facility-card" 
             data-fuel-type="{{ facility.fuel_type }}" 
             data-status="{{ facility.status }}"
             data-capacity="{{ facility.capacity }}"
             data-name="{{ facility.name|lower }}">
            
            <div class="facility-header" style="border-left: 4px solid {{ facility.color }};">
                <div class="facility-title-row">
                    <h4 class="facility-name">{{ facility.name }}</h4>
                    <span class="facility-badge {{ facility.fuel_type }}">{{ facility.fuel_type|upper }}</span>
                </div>
                <div class="facility-code">{{ facility.facility_code }}</div>
            </div>
            
            <div class="facility-body">
                <div class="facility-metric-row">
                    <div class="facility-metric">
                        <span class="metric-label">Capacity</span>
                        <span class="metric-value">{{ facility.capacity|floatformat:1 }} MW</span>
                    </div>
                    <div class="facility-metric">
                        <span class="metric-label">Status</span>
                        <span class="status-indicator {{ facility.status }}">{{ facility.status|title }}</span>
                    </div>
                </div>
                
                {% if facility.monthly_generation %}
                <div class="facility-metric-row">
                    <div class="facility-metric">
                        <span class="metric-label">{{ month_name }} Generation</span>
                        <span class="metric-value">{{ facility.monthly_generation|floatformat:1 }} GWh</span>
                    </div>
                    <div class="facility-metric">
                        <span class="metric-label">Capacity Factor</span>
                        <span class="metric-value">{{ facility.capacity_factor|floatformat:1 }}%</span>
                    </div>
                </div>
                {% endif %}
                
                <div class="facility-info">
                    <div class="info-item">
                        <strong>Owner:</strong> {{ facility.owner|default:"N/A" }}
                    </div>
                    <div class="info-item">
                        <strong>Location:</strong> {{ facility.location|default:"N/A" }}
                    </div>
                    {% if facility.commissioned_date %}
                    <div class="info-item">
                        <strong>Commissioned:</strong> {{ facility.commissioned_date|date:"Y" }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="info-box">
            <p>No facility data available. Please ensure facility data has been imported.</p>
        </div>
        {% endfor %}
    </div>
    
    <div id="no-results" class="info-box" style="display: none; margin-top: 20px;">
        <p>No facilities match your filter criteria. Try adjusting your filters.</p>
    </div>

    <!-- Capacity by Fuel Type Chart -->
    {% if capacity_chart %}
    <h3 style="margin-top: 40px;">Installed Capacity by Fuel Type</h3>
    <div class="chart-container">
        {{ capacity_chart|safe }}
    </div>
    {% endif %}

    <!-- Top Performers -->
    {% if top_performers %}
    <h3 style="margin-top: 40px;">Top Performers - {{ month_name }} {{ year }}</h3>
    <table class="stats-table">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Facility</th>
                <th>Fuel Type</th>
                <th>Generation (GWh)</th>
                <th>Capacity Factor (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for performer in top_performers %}
            <tr>
                <td class="value">{{ forloop.counter }}</td>
                <td>{{ performer.name }}</td>
                <td><span class="facility-badge {{ performer.fuel_type }}">{{ performer.fuel_type|upper }}</span></td>
                <td class="value">{{ performer.generation|floatformat:1 }}</td>
                <td class="value">{{ performer.capacity_factor|floatformat:1 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<!-- Tab: Export Data -->
<div id="export-data" class="tab-content">
    <h2>Export Data</h2>
    <p style="color: #7f8c8d;">Download analysis data in various formats.</p>
    <div class="info-box">
        <p>Export options:</p>
        <ul style="margin-top: 10px;">
            <li>CSV format for spreadsheet analysis</li>
            <li>JSON format for API integration</li>
            <li>PDF report generation</li>
        </ul>
        <button style="margin-top: 15px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Export Current Period
        </button>
    </div>
</div>

<style>
.tab-navigation {
    display: flex;
    gap: 5px;
    margin: 20px 0;
    border-bottom: 2px solid #e0e0e0;
}

.tab-button {
    padding: 12px 24px;
    background: #f5f5f5;
    border: none;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    font-size: 1em;
    transition: all 0.3s ease;
    color: #555;
}

.tab-button:hover {
    background: #e0e0e0;
}

.tab-button.active {
    background: #3498db;
    color: white;
    font-weight: 600;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Facility Overview Styles */
.facility-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.facility-stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stat-icon {
    font-size: 2.5em;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 2em;
    font-weight: 700;
    margin: 10px 0;
}

.stat-label {
    font-size: 0.9em;
    opacity: 0.9;
}

.facility-filters {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}

.facility-filters h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #2c3e50;
}

.filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    font-weight: 600;
    margin-bottom: 5px;
    color: #555;
    font-size: 0.9em;
}

.filter-group select,
.filter-group input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95em;
}

.facilities-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.facility-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.facility-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.facility-header {
    background: #f8f9fa;
    padding: 15px;
}

.facility-title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.facility-name {
    margin: 0;
    color: #2c3e50;
    font-size: 1.1em;
}

.facility-code {
    color: #7f8c8d;
    font-size: 0.85em;
    font-family: monospace;
}

.facility-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.facility-badge.wind {
    background: #e3f2fd;
    color: #1976d2;
}

.facility-badge.solar {
    background: #fff3e0;
    color: #f57c00;
}

.facility-badge.battery {
    background: #e8eaf6;
    color: #3f51b5;
}

.facility-badge.gas {
    background: #fce4ec;
    color: #c2185b;
}

.facility-badge.coal {
    background: #efebe9;
    color: #5d4037;
}

.facility-badge.other {
    background: #f5f5f5;
    color: #616161;
}

.facility-body {
    padding: 15px;
}

.facility-metric-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.facility-metric {
    display: flex;
    flex-direction: column;
}

.facility-metric .metric-label {
    font-size: 0.8em;
    color: #7f8c8d;
    margin-bottom: 3px;
}

.facility-metric .metric-value {
    font-size: 1.1em;
    font-weight: 600;
    color: #2c3e50;
}

.status-indicator {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 600;
}

.status-indicator.operational {
    background: #d4edda;
    color: #155724;
}

.status-indicator.maintenance {
    background: #fff3cd;
    color: #856404;
}

.status-indicator.offline {
    background: #f8d7da;
    color: #721c24;
}

.facility-info {
    border-top: 1px solid #e0e0e0;
    padding-top: 10px;
    margin-top: 10px;
}

.info-item {
    font-size: 0.85em;
    color: #555;
    margin: 5px 0;
}

.facility-footer {
    padding: 12px 15px;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
}

.btn-detail {
    width: 100%;
    padding: 8px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
}

.btn-detail:hover {
    background: #2980b9;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    overflow: auto;
}

.modal-content {
    background: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 8px;
    width: 90%;
    max-width: 800px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    position: relative;
}

.modal-close {
    position: absolute;
    right: 20px;
    top: 15px;
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
}

.modal-close:hover {
    color: #000;
}
</style>

<script>
function loadPeriod() {
    const month = document.getElementById('month-select').value;
    const year = document.getElementById('year-select').value;
    window.location.href = `/scada_analysis/${year}/${month}/`;
}

function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

// Facility Overview Functions
function filterFacilities() {
    const fuelType = document.getElementById('fuel-type-filter').value;
    const status = document.getElementById('status-filter').value;
    const minCapacity = parseFloat(document.getElementById('capacity-filter').value) || 0;
    const searchTerm = document.getElementById('search-filter').value.toLowerCase();
    
    const facilities = document.querySelectorAll('.facility-card');
    let visibleCount = 0;
    
    facilities.forEach(facility => {
        const facilityFuelType = facility.dataset.fuelType;
        const facilityStatus = facility.dataset.status;
        const facilityCapacity = parseFloat(facility.dataset.capacity);
        const facilityName = facility.dataset.name;
        
        const matchesFuelType = fuelType === 'all' || facilityFuelType === fuelType;
        const matchesStatus = status === 'all' || facilityStatus === status;
        const matchesCapacity = facilityCapacity >= minCapacity;
        const matchesSearch = searchTerm === '' || facilityName.includes(searchTerm);
        
        if (matchesFuelType && matchesStatus && matchesCapacity && matchesSearch) {
            facility.style.display = 'block';
            visibleCount++;
        } else {
            facility.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    const noResults = document.getElementById('no-results');
    if (visibleCount === 0) {
        noResults.style.display = 'block';
    } else {
        noResults.style.display = 'none';
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('facility-modal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}
</script>

{% endblock %}

{% block extra_js %}
<script>
// Enable keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        navigateMonth(-1);
    } else if (e.key === 'ArrowRight') {
        navigateMonth(1);
    }
});

function navigateMonth(direction) {
    let month = parseInt(document.getElementById('month-select').value);
    let year = parseInt(document.getElementById('year-select').value);
    
    month += direction;
    if (month > 12) {
        month = 1;
        year++;
    } else if (month < 1) {
        month = 12;
        year--;
    }
    
    window.location.href = `/scada_analysis/${year}/${month}/`;
}
</script>
{% endblock %}