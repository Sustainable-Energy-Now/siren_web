<!-- powerplotui/templates/plot_landing.html -->
{% extends 'powerplotui_base.html' %}
{% load static %}
{% block powerplotui_content %}
    <p>Here you can generate various plots and charts to visualize your data.  You can also export a selected Scenario/ Variant to an excel
        spreadsheet for further processing.
    </p>
    <div style="height: 300px; overflow-y: scroll;">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    {% for field in analysis_data.0.keys %}
                    <th class="px-3 py-2">{{ field }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in analysis_data %}
                <tr>
                    {% for value in row.values %}
                    <td class="px-3 py-2">{{ value }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% csrf_token %}
    {% load crispy_forms_tags %}
    {% crispy plotform %}
    {% if download_ready %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', function() {
                        // Create download link with the file data
                        const link = document.createElement('a');
                        link.href = 'data:{{ content_type }};base64,{{ file_data }}';
                        link.download = '{{ filename }}';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    });
                }
            });
        </script>
    {% endif %}

    <script>
        const GET_VALID_CHOICES_URL = '{% url "get_valid_choices" %}';
        $(document).ready(function() {
            // Function to update variant choices when scenario changes
            function updateVariants() {
                var scenarioId = $('#id_scenario').val();
                
                if (!scenarioId) {
                    $('#id_variant').empty().append('<option value="">Select a Variant</option>');
                    clearSeriesChoices();
                    return;
                }
                var ajaxData = {
                    'scenario': scenarioId,
                    'update_type': 'updateVariants'
                };
                $.ajax({
                    url: GET_VALID_CHOICES_URL,
                    data: ajaxData,
                    success: function(data) {
                        if (data.chartback) {
                            return; // Skip updating variants if coming back from chart
                        }
                        // Clear the variant dropdown
                        $('#id_variant').empty();
                        // Handle different variant scenarios
                        if (data.variants.length === 0) {
                            // No variants available
                            $('#id_variant').append($('<option></option>')
                                .attr('value', '')
                                .attr('disabled', true)
                                .css({'font-style': 'italic', 'color': '#6c757d'})
                                .text('No variants available for this scenario'));
                        } else if (data.variants.length === 1 && data.variants[0].selected) {
                            // Single variant - auto-select it
                            var variant = data.variants[0];
                            $('#id_variant').append($('<option></option>')
                                .attr('value', variant.id)
                                .attr('selected', true)
                                .text(variant.name));
                            
                            // Trigger change event to update dependent dropdowns
                            $('#id_variant').trigger('change');
                        } else {
                            // Multiple variants or single variant without auto-selection
                            // Check if first item is a placeholder
                            if (data.variants[0].id === '') {
                                // First item is "Select a Variant" placeholder
                                $('#id_variant').append($('<option></option>')
                                    .attr('value', '')
                                    .attr('disabled', true)
                                    .attr('selected', true)
                                    .css({'font-style': 'italic', 'color': '#6c757d'})
                                    .text(data.variants[0].name));
                                
                                // Add the actual variants
                                $.each(data.variants.slice(1), function(index, variant) {
                                    $('#id_variant').append($('<option></option>')
                                        .attr('value', variant.id)
                                        .text(variant.name));
                                });
                            } else {
                                // All items are actual variants
                                $('#id_variant').append('<option value="" disabled selected>Select a Variant</option>');
                                $.each(data.variants, function(index, variant) {
                                    $('#id_variant').append($('<option></option>')
                                        .attr('value', variant.id)
                                        .text(variant.name));
                                });
                            }
                        }
                        
                        // Clear series choices until variant is selected
                        clearSeriesChoices();
                    },
                    error: function() {
                        console.log('Error loading variants');
                        $('#id_variant').empty().append($('<option></option>')
                            .attr('value', '')
                            .attr('disabled', true)
                            .css({'font-style': 'italic', 'color': '#dc3545'})
                            .text('Error loading variants'));
                    }
                });
            }

            // Function to update series choices when variant changes
            function updateSeriesForVariant() {
                var scenarioId = $('#id_scenario').val();
                var variantId = $('#id_variant').val();
                
                if (!scenarioId || !variantId) {
                    clearSeriesChoices();
                    clearSeries2Choices(); // Add this line
                    return;
                }
                
                $.ajax({
                    url: GET_VALID_CHOICES_URL,
                    data: {
                        'scenario': scenarioId,
                        'variant': variantId
                    },
                    success: function(data) {
                        updateSeriesChoices(data);
                    },
                    error: function() {
                        console.log('Error loading series choices');
                        clearSeriesChoices();
                        clearSeries2Choices(); // Add this line
                    }
                });
            }            

            // Function to update heading and component dropdowns with separate series data
            function updateSeriesChoices(data) {
                // Update Series 1 heading choices
                $('#id_series_1').empty();
                if (data.series_1_headings && data.series_1_headings.length > 0) {
                    $('#id_series_1').append('<option value="">Select statistic for series 1</option>');
                    $.each(data.series_1_headings, function(index, heading) {
                        $('#id_series_1').append($('<option></option>')
                            .attr('value', heading)
                            .text(heading));
                    });
                } else {
                    $('#id_series_1').append('<option value="" disabled>No statistics available</option>');
                }
                
                // Update Series 2 heading choices
                $('#id_series_2').empty();
                if (data.series_2_headings && data.series_2_headings.length > 0) {
                    $('#id_series_2').append('<option value="">Select statistic for series 2</option>');
                    $.each(data.series_2_headings, function(index, heading) {
                        $('#id_series_2').append($('<option></option>')
                            .attr('value', heading)
                            .text(heading));
                    });
                } else {
                    $('#id_series_2').append('<option value="" disabled>No statistics available</option>');
                }
                
                // Update Series 1 component choices
                $('#id_series_1_component').empty();
                if (data.series_1_components && data.series_1_components.length > 0) {
                    if (data.series_1_components.length === 1) {
                        // Auto-select if only one option
                        $('#id_series_1_component').append($('<option></option>')
                            .attr('value', data.series_1_components[0])
                            .attr('selected', true)
                            .text(data.series_1_components[0]));
                    } else {
                        $('#id_series_1_component').append('<option value="">Select component for series 1</option>');
                        $.each(data.series_1_components, function(index, component) {
                            $('#id_series_1_component').append($('<option></option>')
                                .attr('value', component)
                                .text(component));
                        });
                    }
                } else {
                    $('#id_series_1_component').append('<option value="" disabled>No components available</option>');
                }
                
                // Update Series 2 component choices
                $('#id_series_2_component').empty();
                if (data.series_2_components && data.series_2_components.length > 0) {
                    $('#id_series_2_component').append('<option value="">Select component for series 2</option>');
                    $.each(data.series_2_components, function(index, component) {
                        $('#id_series_2_component').append($('<option></option>')
                            .attr('value', component)
                            .text(component));
                    });
                } else {
                    $('#id_series_2_component').append('<option value="" disabled>No components available</option>');
                }
            }
            
            // Function to update components for a specific series based on selected heading
            function updateSeriesComponents(seriesNumber) {
                var scenarioId = $('#id_scenario').val();
                var variantId = $('#id_variant').val();
                var headingId = $('#id_series_' + seriesNumber).val();
                
                if (!scenarioId || !variantId || !headingId) {
                    return;
                }
                
                var ajaxData = {
                    'scenario': scenarioId,
                    'variant': variantId,
                    'update_type': 'series_' + seriesNumber + '_components_for_heading'
                };
                ajaxData['series_' + seriesNumber + '_heading'] = headingId;
                
                $.ajax({
                    url: GET_VALID_CHOICES_URL,
                    data: ajaxData,
                    success: function(data) {
                        var componentField = '#id_series_' + seriesNumber + '_component';
                        $(componentField).empty();
                        
                        var componentsKey = 'series_' + seriesNumber + '_components';
                        var components = data[componentsKey];
                        
                        if (components && components.length > 0) {
                            if (components.length === 1) {
                                // Auto-select if only one option
                                $(componentField).append($('<option></option>')
                                    .attr('value', components[0])
                                    .attr('selected', true)
                                    .text(components[0]));
                            } else {
                                $(componentField).append('<option value="">Select component for series ' + seriesNumber + '</option>');
                                $.each(components, function(index, component) {
                                    $(componentField).append($('<option></option>')
                                        .attr('value', component)
                                        .text(component));
                                });
                            }
                        } else {
                            $(componentField).append('<option value="" disabled>No components available</option>');
                        }
                    },
                    error: function() {
                        console.log('Error loading components for series ' + seriesNumber);
                    }
                });
            }

            // Combined function to update series 2 headings or components
            function updateSeries2Dependencies(triggerField) {
                var scenarioId = $('#id_scenario').val();
                var variantId = $('#id_variant').val();
                var componentId = $('#id_series_2_component').val();
                var headingId = $('#id_series_2').val();
                if (!scenarioId || !variantId) return;
                // Determine what needs to be updated based on what's selected
                var updateType, ajaxData;
                var targetField, dataKey, placeholderText, noDataText;
                
                if (triggerField === 'component') {
                    // Component changed - update headings for this component
                    updateType = 'series_2_headings_for_component';
                    targetField = '#id_series_2';
                    dataKey = 'series_2_headings';
                    placeholderText = 'Select statistic for series 2';
                    noDataText = 'No statistics available';
                    ajaxData = {
                        'scenario': scenarioId,
                        'variant': variantId,
                        'update_type': updateType
                    };
                    if (componentId) {
                        ajaxData['series_2_component'] = componentId;
                    }
                } else if (triggerField === 'heading' && !componentId) {
                    // Heading changed - update components for this heading
                    updateType = 'series_2_components_for_heading';
                    targetField = '#id_series_2_component';
                    dataKey = 'series_2_components';
                    placeholderText = 'Select component for series 2';
                    noDataText = 'No components available';
                    ajaxData = {
                        'scenario': scenarioId,
                        'variant': variantId,
                        'update_type': updateType
                    };
                    if (headingId) {
                        ajaxData['series_2_heading'] = headingId;
                    }
                } else {
                    // Both selected or neither selected - nothing to update
                    return;
                }
                
                $.ajax({
                    url: GET_VALID_CHOICES_URL,
                    data: ajaxData,
                    success: function(data) {
                        var targetElement = $(targetField);
                        targetElement.empty();
                        
                        var items = data[dataKey];
                        if (items && items.length > 0) {
                            if (items.length === 1 && updateType === 'series_2_components_for_heading') {
                                // Auto-select if only one component option
                                targetElement.append($('<option></option>')
                                    .attr('value', items[0])
                                    .attr('selected', true)
                                    .text(items[0]));
                            } else {
                                targetElement.append(`<option value="">${placeholderText}</option>`);
                                $.each(items, function(index, item) {
                                    targetElement.append($('<option></option>')
                                        .attr('value', item)
                                        .text(item));
                                });
                            }
                        } else {
                            targetElement.append(`<option value="" disabled>${noDataText}</option>`);
                        }
                    },
                    error: function() {
                        console.log(`Error loading ${dataKey.replace('_', ' ')}`);
                        $(targetField).empty().append('<option value="" disabled>Error loading data</option>');
                    }
                });
            }

            // Function to clear series choices
            function clearSeriesChoices() {
                $('#id_series_1, #id_series_2').empty().append('<option value="" disabled>Select a variant first</option>');
                $('#id_series_1_component, #id_series_2_component').empty().append('<option value="" disabled>Select a variant first</option>');
            }

            // Function to clear series 2 choices
            function clearSeries2Choices() {
                $('#id_series_2').empty().append('<option value="" disabled>Select a variant first</option>');
                $('#id_series_2_component').empty().append('<option value="" disabled>Select a variant first</option>');
            }

            // Event handlers
            $('#id_scenario').change(updateVariants);
            $('#id_variant').change(updateSeriesForVariant);
            
            // Event handlers for series heading selections
            $('#id_series_1').change(function() {
                updateSeriesComponents(1);
            });
            
            // Event handler for series 2 fields
            $('#id_series_2_component').change(function() {
                updateSeries2Dependencies('component');
            });

            $('#id_series_2').change(function() {
                updateSeries2Dependencies('heading');
            });
            
            // Initialize on page load if a scenario is already selected
            if ($('#id_scenario').val()) {
                updateVariants();
            }
        });
    </script>
{% endblock %}
