{% extends 'risk_analysis/base.html' %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Risk Dashboard</li>
{% endblock %}

{% block risk_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>SWIS Risk Analysis Dashboard</h3>
    <div>
        <a href="{% url 'risk_scenario_list' %}" class="btn btn-primary">
            <i class="bi bi-list-ul"></i> View Scenarios
        </a>
        <a href="{% url 'risk_comparison' %}" class="btn btn-outline-secondary">
            <i class="bi bi-bar-chart"></i> Compare Scenarios
        </a>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Scenarios with Risks</h5>
                <h2 class="mb-0">{{ total_scenarios }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Risk Events</h5>
                <h2 class="mb-0">{{ total_events }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Severe Risks</h5>
                <h2 class="mb-0 text-danger">{{ severe_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">High Risks</h5>
                <h2 class="mb-0 text-warning">{{ high_count }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Scenarios Overview -->
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Scenario Risk Comparison</h5>
            </div>
            <div class="card-body">
                <div id="scenario-comparison-chart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Risk Distribution</h5>
            </div>
            <div class="card-body">
                <div id="risk-distribution-chart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Scenario Cards -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Scenarios with Risk Events</h4>
    <a href="{% url 'powermapui:display_scenarios' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-gear"></i> Manage Scenarios
    </a>
</div>
<div class="row" id="scenarios-container">
    {% for scenario in scenarios %}
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">{{ scenario.title }}</h5>
            </div>
            <div class="card-body">
                <p class="card-text text-muted small">{{ scenario.description|default:"No description"|truncatewords:30 }}</p>

                <!-- Risk Summary -->
                <div class="d-flex justify-content-between mb-2">
                    <span>Risk Events:</span>
                    <strong>{{ scenario.risk_events.count }}</strong>
                </div>
            </div>
            <div class="card-footer">
                <a href="{% url 'risk_scenario_detail' scenario.idscenarios %}" class="btn btn-sm btn-outline-primary">View Details</a>
                <a href="{% url 'risk_event_create' scenario.idscenarios %}" class="btn btn-sm btn-outline-success">Add Risk</a>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info">
            No scenarios have risk events yet.
            <a href="{% url 'risk_scenario_list' %}">Select a scenario</a> to start adding risk events.
        </div>
    </div>
    {% endfor %}
</div>

<!-- Risk Level Legend -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Risk Level Legend (6x6 Matrix)</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <span class="badge" style="background-color: #27ae60; color: white;">Low (1-6)</span>
                <small class="text-muted d-block">Acceptable risk, routine monitoring</small>
            </div>
            <div class="col-md-3">
                <span class="badge" style="background-color: #f1c40f; color: black;">Medium (7-12)</span>
                <small class="text-muted d-block">Management attention required</small>
            </div>
            <div class="col-md-3">
                <span class="badge" style="background-color: #e67e22; color: white;">High (13-24)</span>
                <small class="text-muted d-block">Senior management attention required</small>
            </div>
            <div class="col-md-3">
                <span class="badge" style="background-color: #e74c3c; color: white;">Severe (25-36)</span>
                <small class="text-muted d-block">Immediate action required</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block risk_scripts %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fetch summary data
    fetch('{% url "api_risk_summary" %}')
        .then(response => response.json())
        .then(data => {
            // Render risk distribution pie chart
            let lowCount = 0, mediumCount = 0, highCount = 0, severeCount = 0;

            if (data.scenarios) {
                data.scenarios.forEach(s => {
                    if (s.risk_counts) {
                        lowCount += s.risk_counts.low || 0;
                        mediumCount += s.risk_counts.medium || 0;
                        highCount += s.risk_counts.high || 0;
                        severeCount += s.risk_counts.severe || 0;
                    }
                });
            }

            if (lowCount + mediumCount + highCount + severeCount > 0) {
                const distData = [{
                    values: [lowCount, mediumCount, highCount, severeCount],
                    labels: ['Low', 'Medium', 'High', 'Severe'],
                    type: 'pie',
                    marker: {
                        colors: ['#27ae60', '#f1c40f', '#e67e22', '#e74c3c']
                    },
                    hole: 0.4
                }];
                const distLayout = {
                    showlegend: true,
                    legend: { orientation: 'h', y: -0.1 },
                    margin: { t: 20, b: 50, l: 20, r: 20 }
                };
                Plotly.newPlot('risk-distribution-chart', distData, distLayout, {responsive: true});
            } else {
                document.getElementById('risk-distribution-chart').innerHTML = '<p class="text-muted text-center mt-5">No risk data available</p>';
            }

            // Render scenario comparison chart
            if (data.scenarios && data.scenarios.length > 0) {
                const scenarioNames = data.scenarios.map(s => s.name);
                const inherentScores = data.scenarios.map(s => s.avg_inherent_score || 0);
                const residualScores = data.scenarios.map(s => s.avg_residual_score || 0);

                const compData = [
                    {
                        x: scenarioNames,
                        y: inherentScores,
                        name: 'Inherent Risk',
                        type: 'bar',
                        marker: { color: '#e74c3c' }
                    },
                    {
                        x: scenarioNames,
                        y: residualScores,
                        name: 'Residual Risk',
                        type: 'bar',
                        marker: { color: '#27ae60' }
                    }
                ];
                const compLayout = {
                    barmode: 'group',
                    xaxis: { title: 'Scenario' },
                    yaxis: { title: 'Average Risk Score' },
                    legend: { orientation: 'h', y: 1.1 },
                    margin: { t: 40, b: 80, l: 60, r: 20 }
                };
                Plotly.newPlot('scenario-comparison-chart', compData, compLayout, {responsive: true});
            } else {
                document.getElementById('scenario-comparison-chart').innerHTML = '<p class="text-muted text-center mt-5">No scenario data available</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching summary:', error);
            document.getElementById('risk-distribution-chart').innerHTML = '<p class="text-muted text-center mt-5">Error loading data</p>';
            document.getElementById('scenario-comparison-chart').innerHTML = '<p class="text-muted text-center mt-5">Error loading data</p>';
        });
});
</script>
{% endblock %}
