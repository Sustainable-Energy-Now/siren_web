{% extends 'powerplotui_base.html' %}

{% block powerplotui_content %}
{% load static %}

<!-- Tom Select for collapsible multi-select dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<style>
    /* Compact Tom Select styling */
    .ts-wrapper.multi .ts-control {
        min-height: 38px;
        max-height: 120px;
        overflow-y: auto;
    }
    .ts-wrapper .ts-control {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
    .ts-wrapper.focus .ts-control {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .ts-dropdown {
        max-height: 300px;
    }
</style>

<div class="container-fluid mt-4">
    <h2>Facility SCADA Data Visualization</h2>
    
    <!-- Mode selector -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="viewMode" id="singleMode" value="single" checked>
                <label class="btn btn-outline-primary" for="singleMode">Single Facility</label>
                
                <input type="radio" class="btn-check" name="viewMode" id="compareMode" value="compare">
                <label class="btn btn-outline-primary" for="compareMode">Compare Two Facilities</label>
                
                <input type="radio" class="btn-check" name="viewMode" id="technologyMode" value="technology">
                <label class="btn btn-outline-primary" for="technologyMode">Technology Aggregated</label>
                
                <input type="radio" class="btn-check" name="viewMode" id="techCompareMode" value="techcompare">
                <label class="btn btn-outline-primary" for="techCompareMode">Compare Technologies</label>
            </div>
        </div>
    </div>
    
    <!-- Single facility form -->
    <div class="row mt-4" id="singleFacilityForm">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form id="scadaPlotForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="facilitySelect" class="form-label">Select Facility(ies):</label>
                            <select class="form-select tom-select-multi" id="facilitySelect" name="facility" multiple required>
                                {% for facility in facilities %}
                                <option value="{{ facility.idfacilities }}"
                                        data-technology="{{ facility.idtechnologies.technology_name }}">
                                    {{ facility.facility_name }}
                                    {% if facility.facility_code %}({{ facility.facility_code }}){% endif %}
                                    - {{ facility.idtechnologies.technology_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="yearSelect" class="form-label">Select Year:</label>
                            <select class="form-select" id="yearSelect" name="year" required>
                                <option value="">Choose a year...</option>
                                {% for year in years %}
                                <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="aggregationSelect" class="form-label">Time Period:</label>
                            <select class="form-select" id="aggregationSelect" name="aggregation">
                                <option value="hour">Hourly</option>
                                <option value="week">Weekly</option>
                                <option value="month">Monthly</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="chartTypeSelect" class="form-label">Chart Type:</label>
                            <select class="form-select" id="chartTypeSelect" name="chartType">
                                <option value="line">Line Chart</option>
                                <option value="scatter">Scatter Plot</option>
                                <option value="bar">Bar Chart</option>
                                <option value="area">Area Chart</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-graph-up"></i> Plot Facilities
                            </button>
                        </div>
                    </form>
                    
                    <!-- Date Range Selection -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="accordion" id="dateRangeAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dateRangeCollapse">
                                            Optional: Select Date Range
                                        </button>
                                    </h2>
                                    <div id="dateRangeCollapse" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label class="form-label">Quick Select:</label>
                                                    <select class="form-select" id="quickSelectSingle">
                                                        <option value="">Full Year</option>
                                                        <option value="summer">Summer (Dec-Feb)</option>
                                                        <option value="autumn">Autumn (Mar-May)</option>
                                                        <option value="winter">Winter (Jun-Aug)</option>
                                                        <option value="spring">Spring (Sep-Nov)</option>
                                                        <option value="q1">Q1 (Jan-Mar)</option>
                                                        <option value="q2">Q2 (Apr-Jun)</option>
                                                        <option value="q3">Q3 (Jul-Sep)</option>
                                                        <option value="q4">Q4 (Oct-Dec)</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Start Month:</label>
                                                    <select class="form-select" id="startMonthSingle">
                                                        <option value="">Select...</option>
                                                        <option value="1">January</option>
                                                        <option value="2">February</option>
                                                        <option value="3">March</option>
                                                        <option value="4">April</option>
                                                        <option value="5">May</option>
                                                        <option value="6">June</option>
                                                        <option value="7">July</option>
                                                        <option value="8">August</option>
                                                        <option value="9">September</option>
                                                        <option value="10">October</option>
                                                        <option value="11">November</option>
                                                        <option value="12">December</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">End Month:</label>
                                                    <select class="form-select" id="endMonthSingle">
                                                        <option value="">Select...</option>
                                                        <option value="1">January</option>
                                                        <option value="2">February</option>
                                                        <option value="3">March</option>
                                                        <option value="4">April</option>
                                                        <option value="5">May</option>
                                                        <option value="6">June</option>
                                                        <option value="7">July</option>
                                                        <option value="8">August</option>
                                                        <option value="9">September</option>
                                                        <option value="10">October</option>
                                                        <option value="11">November</option>
                                                        <option value="12">December</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">&nbsp;</label>
                                                    <button type="button" class="btn btn-secondary w-100" id="clearDateRangeSingle">
                                                        Clear Range
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-md-12">
                                                    <small class="text-muted">
                                                        <strong>Note:</strong> Months are for Southern Hemisphere seasons. Leave blank for full year.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comparison form -->
    <div class="row mt-4" id="comparisonForm" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form id="scadaComparisonPlotForm" class="row g-3">
                        <div class="col-md-3">
                            <label for="facility1Select" class="form-label">Facility Group 1:</label>
                            <select class="form-select tom-select-multi" id="facility1Select" name="facility1" multiple required>
                                {% for facility in facilities %}
                                <option value="{{ facility.idfacilities }}"
                                        data-technology="{{ facility.idtechnologies.technology_name }}">
                                    {{ facility.facility_name }} - {{ facility.idtechnologies.technology_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="facility2Select" class="form-label">Facility Group 2:</label>
                            <select class="form-select tom-select-multi" id="facility2Select" name="facility2" multiple required>
                                {% for facility in facilities %}
                                <option value="{{ facility.idfacilities }}"
                                        data-technology="{{ facility.idtechnologies.technology_name }}">
                                    {{ facility.facility_name }} - {{ facility.idtechnologies.technology_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="yearSelectCompare" class="form-label">Year:</label>
                            <select class="form-select" id="yearSelectCompare" name="year" required>
                                <option value="">Choose a year...</option>
                                {% for year in years %}
                                <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="aggregationSelectCompare" class="form-label">Time Period:</label>
                            <select class="form-select" id="aggregationSelectCompare" name="aggregation">
                                <option value="hour">Hourly</option>
                                <option value="week">Weekly</option>
                                <option value="month">Monthly</option>
                            </select>
                        </div>
                        
                        <div class="col-md-1">
                            <label for="chartTypeSelectCompare" class="form-label">Chart:</label>
                            <select class="form-select" id="chartTypeSelectCompare" name="chartType">
                                <option value="line">Line</option>
                                <option value="scatter">Scatter</option>
                                <option value="bar">Bar</option>
                                <option value="area">Area</option>
                            </select>
                        </div>
                        
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-graph-up"></i> Compare
                            </button>
                        </div>
                    </form>
                    
                    <!-- Date Range Selection for Comparison -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="accordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dateRangeCollapseCompare">
                                            Optional: Select Date Range
                                        </button>
                                    </h2>
                                    <div id="dateRangeCollapseCompare" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label class="form-label">Quick Select:</label>
                                                    <select class="form-select" id="quickSelectCompare">
                                                        <option value="">Full Year</option>
                                                        <option value="summer">Summer (Dec-Feb)</option>
                                                        <option value="autumn">Autumn (Mar-May)</option>
                                                        <option value="winter">Winter (Jun-Aug)</option>
                                                        <option value="spring">Spring (Sep-Nov)</option>
                                                        <option value="q1">Q1 (Jan-Mar)</option>
                                                        <option value="q2">Q2 (Apr-Jun)</option>
                                                        <option value="q3">Q3 (Jul-Sep)</option>
                                                        <option value="q4">Q4 (Oct-Dec)</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Start Month:</label>
                                                    <select class="form-select" id="startMonthCompare">
                                                        <option value="">Select...</option>
                                                        <option value="1">January</option>
                                                        <option value="2">February</option>
                                                        <option value="3">March</option>
                                                        <option value="4">April</option>
                                                        <option value="5">May</option>
                                                        <option value="6">June</option>
                                                        <option value="7">July</option>
                                                        <option value="8">August</option>
                                                        <option value="9">September</option>
                                                        <option value="10">October</option>
                                                        <option value="11">November</option>
                                                        <option value="12">December</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">End Month:</label>
                                                    <select class="form-select" id="endMonthCompare">
                                                        <option value="">Select...</option>
                                                        <option value="1">January</option>
                                                        <option value="2">February</option>
                                                        <option value="3">March</option>
                                                        <option value="4">April</option>
                                                        <option value="5">May</option>
                                                        <option value="6">June</option>
                                                        <option value="7">July</option>
                                                        <option value="8">August</option>
                                                        <option value="9">September</option>
                                                        <option value="10">October</option>
                                                        <option value="11">November</option>
                                                        <option value="12">December</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">&nbsp;</label>
                                                    <button type="button" class="btn btn-secondary w-100" id="clearDateRangeCompare">
                                                        Clear Range
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-md-12">
                                                    <small class="text-muted">
                                                        <strong>Note:</strong> Months are for Southern Hemisphere seasons. Leave blank for full year.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Technology aggregated form -->
    <div class="row mt-4" id="technologyForm" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form id="scadaTechnologyPlotForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="technologySelect" class="form-label">Select Technologies:</label>
                            <select class="form-select tom-select-multi" id="technologySelect" name="technology" multiple required>
                                {% for technology in technologies %}
                                <option value="{{ technology.idtechnologies }}">
                                    {{ technology.technology_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="yearSelectTech" class="form-label">Year:</label>
                            <select class="form-select" id="yearSelectTech" name="year" required>
                                <option value="">Choose a year...</option>
                                {% for year in years %}
                                <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="aggregationSelectTech" class="form-label">Time Period:</label>
                            <select class="form-select" id="aggregationSelectTech" name="aggregation">
                                <option value="hour">Hourly</option>
                                <option value="week">Weekly</option>
                                <option value="month">Monthly</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="chartTypeSelectTech" class="form-label">Chart Type:</label>
                            <select class="form-select" id="chartTypeSelectTech" name="chartType">
                                <option value="line">Line Chart</option>
                                <option value="scatter">Scatter Plot</option>
                                <option value="bar">Bar Chart</option>
                                <option value="area">Area Chart</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-graph-up"></i> Plot Technology
                            </button>
                            <button type="button" class="btn btn-secondary w-100 mt-2" id="clearTechSelection">
                                Clear Selection
                            </button>
                        </div>
                    </form>
                    
                    <!-- Date Range Selection for Technology -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="accordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dateRangeCollapseTech">
                                            Optional: Select Date Range
                                        </button>
                                    </h2>
                                    <div id="dateRangeCollapseTech" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label class="form-label">Quick Select:</label>
                                                    <select class="form-select" id="quickSelectTech">
                                                        <option value="">Full Year</option>
                                                        <option value="summer">Summer (Dec-Feb)</option>
                                                        <option value="autumn">Autumn (Mar-May)</option>
                                                        <option value="winter">Winter (Jun-Aug)</option>
                                                        <option value="spring">Spring (Sep-Nov)</option>
                                                        <option value="q1">Q1 (Jan-Mar)</option>
                                                        <option value="q2">Q2 (Apr-Jun)</option>
                                                        <option value="q3">Q3 (Jul-Sep)</option>
                                                        <option value="q4">Q4 (Oct-Dec)</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Start Month:</label>
                                                    <select class="form-select" id="startMonthTech">
                                                        <option value="">Select...</option>
                                                        <option value="1">January</option>
                                                        <option value="2">February</option>
                                                        <option value="3">March</option>
                                                        <option value="4">April</option>
                                                        <option value="5">May</option>
                                                        <option value="6">June</option>
                                                        <option value="7">July</option>
                                                        <option value="8">August</option>
                                                        <option value="9">September</option>
                                                        <option value="10">October</option>
                                                        <option value="11">November</option>
                                                        <option value="12">December</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">End Month:</label>
                                                    <select class="form-select" id="endMonthTech">
                                                        <option value="">Select...</option>
                                                        <option value="1">January</option>
                                                        <option value="2">February</option>
                                                        <option value="3">March</option>
                                                        <option value="4">April</option>
                                                        <option value="5">May</option>
                                                        <option value="6">June</option>
                                                        <option value="7">July</option>
                                                        <option value="8">August</option>
                                                        <option value="9">September</option>
                                                        <option value="10">October</option>
                                                        <option value="11">November</option>
                                                        <option value="12">December</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">&nbsp;</label>
                                                    <button type="button" class="btn btn-secondary w-100" id="clearDateRangeTech">
                                                        Clear Range
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-md-12">
                                                    <small class="text-muted">
                                                        <strong>Note:</strong> Months are for Southern Hemisphere seasons. Leave blank for full year.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Technology comparison form -->
    <div class="row mt-4" id="techComparisonForm" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form id="scadaTechComparisonPlotForm" class="row g-3">
                        <div class="col-md-3">
                            <label for="technology1Select" class="form-label">Technology Group 1:</label>
                            <select class="form-select tom-select-multi" id="technology1Select" name="technology1" multiple required>
                                {% for technology in technologies %}
                                <option value="{{ technology.idtechnologies }}">
                                    {{ technology.technology_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="technology2Select" class="form-label">Technology Group 2:</label>
                            <select class="form-select tom-select-multi" id="technology2Select" name="technology2" multiple required>
                                {% for technology in technologies %}
                                <option value="{{ technology.idtechnologies }}">
                                    {{ technology.technology_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="yearSelectTechComp" class="form-label">Year:</label>
                            <select class="form-select" id="yearSelectTechComp" name="year" required>
                                <option value="">Choose a year...</option>
                                {% for year in years %}
                                <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="aggregationSelectTechComp" class="form-label">Time Period:</label>
                            <select class="form-select" id="aggregationSelectTechComp" name="aggregation">
                                <option value="hour">Hourly</option>
                                <option value="week">Weekly</option>
                                <option value="month">Monthly</option>
                            </select>
                        </div>
                        
                        <div class="col-md-1">
                            <label for="chartTypeSelectTechComp" class="form-label">Chart:</label>
                            <select class="form-select" id="chartTypeSelectTechComp" name="chartType">
                                <option value="line">Line</option>
                                <option value="scatter">Scatter</option>
                                <option value="bar">Bar</option>
                                <option value="area">Area</option>
                            </select>
                        </div>
                        
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-graph-up"></i> Compare
                            </button>
                            <button type="button" class="btn btn-secondary w-100 mt-2" id="clearTechCompSelection">
                                Clear
                            </button>
                        </div>
                    </form>
                    
                    <!-- Date Range Selection for Technology Comparison -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="accordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dateRangeCollapseTechComp">
                                            Optional: Select Date Range
                                        </button>
                                    </h2>
                                    <div id="dateRangeCollapseTechComp" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label class="form-label">Quick Select:</label>
                                                    <select class="form-select" id="quickSelectTechComp">
                                                        <option value="">Full Year</option>
                                                        <option value="summer">Summer (Dec-Feb)</option>
                                                        <option value="autumn">Autumn (Mar-May)</option>
                                                        <option value="winter">Winter (Jun-Aug)</option>
                                                        <option value="spring">Spring (Sep-Nov)</option>
                                                        <option value="q1">Q1 (Jan-Mar)</option>
                                                        <option value="q2">Q2 (Apr-Jun)</option>
                                                        <option value="q3">Q3 (Jul-Sep)</option>
                                                        <option value="q4">Q4 (Oct-Dec)</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Start Month:</label>
                                                    <select class="form-select" id="startMonthTechComp">
                                                        <option value="">Select...</option>
                                                        <option value="1">January</option>
                                                        <option value="2">February</option>
                                                        <option value="3">March</option>
                                                        <option value="4">April</option>
                                                        <option value="5">May</option>
                                                        <option value="6">June</option>
                                                        <option value="7">July</option>
                                                        <option value="8">August</option>
                                                        <option value="9">September</option>
                                                        <option value="10">October</option>
                                                        <option value="11">November</option>
                                                        <option value="12">December</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">End Month:</label>
                                                    <select class="form-select" id="endMonthTechComp">
                                                        <option value="">Select...</option>
                                                        <option value="1">January</option>
                                                        <option value="2">February</option>
                                                        <option value="3">March</option>
                                                        <option value="4">April</option>
                                                        <option value="5">May</option>
                                                        <option value="6">June</option>
                                                        <option value="7">July</option>
                                                        <option value="8">August</option>
                                                        <option value="9">September</option>
                                                        <option value="10">October</option>
                                                        <option value="11">November</option>
                                                        <option value="12">December</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">&nbsp;</label>
                                                    <button type="button" class="btn btn-secondary w-100" id="clearDateRangeTechComp">
                                                        Clear Range
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-md-12">
                                                    <small class="text-muted">
                                                        <strong>Note:</strong> Months are for Southern Hemisphere seasons. Leave blank for full year.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
   
    <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading quantity data...</p>
    </div>
    
    <div id="errorMessage" class="alert alert-danger mt-4" style="display: none;"></div>
    
    <!-- Single facility info -->
    <div id="plotInfo" class="mt-4" style="display: none;">
        <div class="alert alert-info">
            <strong>Facility:</strong> <span id="infoFacilityName"></span> |
            <strong>Technology:</strong> <span id="infoTechnology"></span> |
            <strong>Year:</strong> <span id="infoYear"></span> |
            <strong>Aggregation:</strong> <span id="infoAggregation"></span> |
            <strong>Data Points:</strong> <span id="infoTotalPeriods"></span>
        </div>
    </div>
    
    <!-- Comparison metrics -->
    <div id="comparisonMetrics" class="mt-4" style="display: none;">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Correlation & Complementarity Analysis</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Comparing:</h6>
                        <p><strong>Facility 1:</strong> <span id="compFacility1"></span> (<span id="compTech1"></span>)</p>
                        <p><strong>Facility 2:</strong> <span id="compFacility2"></span> (<span id="compTech2"></span>)</p>
                        <p><strong>Year:</strong> <span id="compYear"></span> | <strong>Aggregation:</strong> <span id="compAggregation"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Key Metrics:</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Correlation Coefficient:</strong></td>
                                <td><span id="metricCorrelation" class="badge"></span></td>
                            </tr>
                            <tr>
                                <td><strong>Complementarity Score:</strong></td>
                                <td><span id="metricComplementarity" class="badge"></span></td>
                            </tr>
                            <tr>
                                <td><strong>Variability Reduction:</strong></td>
                                <td><span id="metricVariability"></span>%</td>
                            </tr>
                            <tr>
                                <td><strong>Complementary Periods:</strong></td>
                                <td><span id="metricComplementaryPct"></span>%</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="alert alert-secondary">
                            <strong>Interpretation:</strong> <span id="metricInterpretation"></span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <small class="text-muted">
                            <strong>Note:</strong> 
                            Correlation ranges from -1 (perfect negative) to +1 (perfect positive). 
                            Complementarity score ranges from 0 (perfectly correlated) to 1 (perfectly uncorrelated/anti-correlated). 
                            Higher complementarity indicates better portfolio diversification potential.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Chart</span>
                    <button type="button" class="btn btn-success btn-sm" id="exportExcelBtn" style="display: none;">
                        <i class="bi bi-file-earmark-excel"></i> Export to Excel
                    </button>
                </div>
                <div class="card-body">
                    <div id="quantityChart" style="width: 100%; height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-3.1.1.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Tom Select on all multi-select dropdowns
    const tomSelectConfig = {
        plugins: ['remove_button', 'clear_button'],
        placeholder: 'Click to select...',
        maxItems: null,
        closeAfterSelect: false,
        hidePlaceholder: true
    };

    // Store Tom Select instances for later access
    const tomSelectInstances = {};

    document.querySelectorAll('.tom-select-multi').forEach(function(select) {
        tomSelectInstances[select.id] = new TomSelect(select, tomSelectConfig);
    });

    // Form elements
    const singleForm = document.getElementById('scadaPlotForm');
    const comparisonForm = document.getElementById('scadaComparisonPlotForm');
    const technologyForm = document.getElementById('scadaTechnologyPlotForm');
    const techComparisonForm = document.getElementById('scadaTechComparisonPlotForm');
    const facilitySelect = document.getElementById('facilitySelect');
    const yearSelect = document.getElementById('yearSelect');
    const aggregationSelect = document.getElementById('aggregationSelect');
    const chartTypeSelect = document.getElementById('chartTypeSelect');
    const facility1Select = document.getElementById('facility1Select');
    const facility2Select = document.getElementById('facility2Select');
    const yearSelectCompare = document.getElementById('yearSelectCompare');
    const aggregationSelectCompare = document.getElementById('aggregationSelectCompare');
    const chartTypeSelectCompare = document.getElementById('chartTypeSelectCompare');
    const yearSelectTech = document.getElementById('yearSelectTech');
    const aggregationSelectTech = document.getElementById('aggregationSelectTech');
    const chartTypeSelectTech = document.getElementById('chartTypeSelectTech');
    const yearSelectTechComp = document.getElementById('yearSelectTechComp');
    const aggregationSelectTechComp = document.getElementById('aggregationSelectTechComp');
    const chartTypeSelectTechComp = document.getElementById('chartTypeSelectTechComp');
    // Technology comparison elements
    const technology1Select = document.getElementById('technology1Select');
    const technology2Select = document.getElementById('technology2Select');
    const clearTechCompSelection = document.getElementById('clearTechCompSelection');
    
    // UI elements
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const plotInfo = document.getElementById('plotInfo');
    const comparisonMetrics = document.getElementById('comparisonMetrics');
    const chartDiv = document.getElementById('quantityChart');
    const singleFacilityFormDiv = document.getElementById('singleFacilityForm');
    const comparisonFormDiv = document.getElementById('comparisonForm');
    const technologyFormDiv = document.getElementById('technologyForm');
    const techComparisonFormDiv = document.getElementById('techComparisonForm');

    // Technology selection elements
    const technologySelect = document.getElementById('technologySelect');
    const clearTechSelection = document.getElementById('clearTechSelection');

    // Clear button for technology selection - works with Tom Select
    if (clearTechSelection) {
        clearTechSelection.addEventListener('click', function() {
            if (tomSelectInstances['technologySelect']) {
                tomSelectInstances['technologySelect'].clear();
            }
        });
    }

    // Clear button for technology comparison
    if (clearTechCompSelection) {
        clearTechCompSelection.addEventListener('click', function() {
            if (tomSelectInstances['technology1Select']) {
                tomSelectInstances['technology1Select'].clear();
            }
            if (tomSelectInstances['technology2Select']) {
                tomSelectInstances['technology2Select'].clear();
            }
        });
    }
    // Mode switching
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // Hide all forms
            singleFacilityFormDiv.style.display = 'none';
            comparisonFormDiv.style.display = 'none';
            technologyFormDiv.style.display = 'none';
            techComparisonFormDiv.style.display = 'none';
            plotInfo.style.display = 'none';
            comparisonMetrics.style.display = 'none';
            
            // Show selected form
            if (this.value === 'single') {
                singleFacilityFormDiv.style.display = 'block';
            } else if (this.value === 'compare') {
                comparisonFormDiv.style.display = 'block';
            } else if (this.value === 'technology') {
                technologyFormDiv.style.display = 'block';
            } else if (this.value === 'techcompare') {
                techComparisonFormDiv.style.display = 'block';
            }
            
            Plotly.purge(chartDiv);
            hideError();
        });
    });
    
    // Update years when facility changes
    facilitySelect.addEventListener('change', function() {
        const selectedOptions = Array.from(this.selectedOptions);
        if (selectedOptions.length > 0) {
            // Use first selected facility for year lookup
            updateAvailableYears(selectedOptions[0].value, yearSelect);
        }
    });
    
    // Date range handlers for single facility
    const quickSelectSingle = document.getElementById('quickSelectSingle');
    const startMonthSingle = document.getElementById('startMonthSingle');
    const endMonthSingle = document.getElementById('endMonthSingle');
    const clearDateRangeSingle = document.getElementById('clearDateRangeSingle');
    
    quickSelectSingle.addEventListener('change', function() {
        const seasonMap = {
            'summer': {start: 12, end: 2},
            'autumn': {start: 3, end: 5},
            'winter': {start: 6, end: 8},
            'spring': {start: 9, end: 11},
            'q1': {start: 1, end: 3},
            'q2': {start: 4, end: 6},
            'q3': {start: 7, end: 9},
            'q4': {start: 10, end: 12}
        };
        
        if (this.value && seasonMap[this.value]) {
            startMonthSingle.value = seasonMap[this.value].start;
            endMonthSingle.value = seasonMap[this.value].end;
        } else {
            startMonthSingle.value = '';
            endMonthSingle.value = '';
        }
    });
    
    clearDateRangeSingle.addEventListener('click', function() {
        quickSelectSingle.value = '';
        startMonthSingle.value = '';
        endMonthSingle.value = '';
    });
    
    // Date range handlers for facility comparison
    const quickSelectCompare = document.getElementById('quickSelectCompare');
    const startMonthCompare = document.getElementById('startMonthCompare');
    const endMonthCompare = document.getElementById('endMonthCompare');
    const clearDateRangeCompare = document.getElementById('clearDateRangeCompare');
    
    quickSelectCompare.addEventListener('change', function() {
        const seasonMap = {
            'summer': {start: 12, end: 2}, 'autumn': {start: 3, end: 5},
            'winter': {start: 6, end: 8}, 'spring': {start: 9, end: 11},
            'q1': {start: 1, end: 3}, 'q2': {start: 4, end: 6},
            'q3': {start: 7, end: 9}, 'q4': {start: 10, end: 12}
        };
        
        if (this.value && seasonMap[this.value]) {
            startMonthCompare.value = seasonMap[this.value].start;
            endMonthCompare.value = seasonMap[this.value].end;
        } else {
            startMonthCompare.value = '';
            endMonthCompare.value = '';
        }
    });
    
    clearDateRangeCompare.addEventListener('click', function() {
        quickSelectCompare.value = '';
        startMonthCompare.value = '';
        endMonthCompare.value = '';
    });
    
    // Date range handlers for technology
    const quickSelectTech = document.getElementById('quickSelectTech');
    const startMonthTech = document.getElementById('startMonthTech');
    const endMonthTech = document.getElementById('endMonthTech');
    const clearDateRangeTech = document.getElementById('clearDateRangeTech');
    
    quickSelectTech.addEventListener('change', function() {
        const seasonMap = {
            'summer': {start: 12, end: 2}, 'autumn': {start: 3, end: 5},
            'winter': {start: 6, end: 8}, 'spring': {start: 9, end: 11},
            'q1': {start: 1, end: 3}, 'q2': {start: 4, end: 6},
            'q3': {start: 7, end: 9}, 'q4': {start: 10, end: 12}
        };
        
        if (this.value && seasonMap[this.value]) {
            startMonthTech.value = seasonMap[this.value].start;
            endMonthTech.value = seasonMap[this.value].end;
        } else {
            startMonthTech.value = '';
            endMonthTech.value = '';
        }
    });
    
    clearDateRangeTech.addEventListener('click', function() {
        quickSelectTech.value = '';
        startMonthTech.value = '';
        endMonthTech.value = '';
    });
    
    // Date range handlers for technology comparison
    const quickSelectTechComp = document.getElementById('quickSelectTechComp');
    const startMonthTechComp = document.getElementById('startMonthTechComp');
    const endMonthTechComp = document.getElementById('endMonthTechComp');
    const clearDateRangeTechComp = document.getElementById('clearDateRangeTechComp');
    
    quickSelectTechComp.addEventListener('change', function() {
        const seasonMap = {
            'summer': {start: 12, end: 2}, 'autumn': {start: 3, end: 5},
            'winter': {start: 6, end: 8}, 'spring': {start: 9, end: 11},
            'q1': {start: 1, end: 3}, 'q2': {start: 4, end: 6},
            'q3': {start: 7, end: 9}, 'q4': {start: 10, end: 12}
        };
        
        if (this.value && seasonMap[this.value]) {
            startMonthTechComp.value = seasonMap[this.value].start;
            endMonthTechComp.value = seasonMap[this.value].end;
        } else {
            startMonthTechComp.value = '';
            endMonthTechComp.value = '';
        }
    });
    
    clearDateRangeTechComp.addEventListener('click', function() {
        quickSelectTechComp.value = '';
        startMonthTechComp.value = '';
        endMonthTechComp.value = '';
    });
    
    // Single facility form submission
    singleForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const selectedOptions = Array.from(facilitySelect.selectedOptions);
        const facilityIds = selectedOptions.map(opt => opt.value);
        
        if (facilityIds.length === 0) {
            showError('Please select at least one facility');
            return;
        }
        
        const year = yearSelect.value;
        const aggregation = aggregationSelect.value;
        const chartType = chartTypeSelect.value;
        
        if (!year) {
            showError('Please select a year');
            return;
        }
        
        comparisonMetrics.style.display = 'none';
        fetchAndPlotData(facilityIds, year, aggregation, chartType);
    });
    
    // Comparison form submission
    comparisonForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const selectedOptions1 = Array.from(facility1Select.selectedOptions);
        const facility1Ids = selectedOptions1.map(opt => opt.value);
        
        const selectedOptions2 = Array.from(facility2Select.selectedOptions);
        const facility2Ids = selectedOptions2.map(opt => opt.value);
        
        if (facility1Ids.length === 0) {
            showError('Please select at least one facility for Group 1');
            return;
        }
        
        if (facility2Ids.length === 0) {
            showError('Please select at least one facility for Group 2');
            return;
        }
        
        const year = yearSelectCompare.value;
        const aggregation = aggregationSelectCompare.value;
        const chartType = chartTypeSelectCompare.value;
        
        if (!year) {
            showError('Please select a year');
            return;
        }
        
        plotInfo.style.display = 'none';
        fetchAndPlotComparison(facility1Ids, facility2Ids, year, aggregation, chartType);
    });
    
    // Technology form submission
    technologyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const selectedOptions = Array.from(technologySelect.selectedOptions);
        const technologyIds = selectedOptions.map(opt => opt.value);
        const year = yearSelectTech.value;
        const aggregation = aggregationSelectTech.value;
        const chartType = chartTypeSelectTech.value;
        
        if (technologyIds.length === 0 || !year) {
            showError('Please select at least one technology and a year');
            return;
        }
        
        comparisonMetrics.style.display = 'none';
        fetchAndPlotTechnology(technologyIds, year, aggregation, chartType);
    });
    
    // Technology comparison form submission
    techComparisonForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const technology1Ids = Array.from(technology1Select.selectedOptions).map(opt => opt.value);
        const technology2Ids = Array.from(technology2Select.selectedOptions).map(opt => opt.value);
        const year = yearSelectTechComp.value;
        const aggregation = aggregationSelectTechComp.value;
        const chartType = chartTypeSelectTechComp.value;
        
        if (technology1Ids.length === 0 || technology2Ids.length === 0 || !year) {
            showError('Please select at least one technology for each group and a year');
            return;
        }
        
        // Check if any technologies are duplicated between groups
        const duplicates = technology1Ids.filter(id => technology2Ids.includes(id));
        if (duplicates.length > 0) {
            showError('Please ensure technologies are not selected in both groups');
            return;
        }
        
        plotInfo.style.display = 'none';
        fetchAndPlotTechnologyComparison(technology1Ids, technology2Ids, year, aggregation, chartType);
    });

    function updateAvailableYears(facilityId, targetSelect) {
        fetch(`/get_facility_years/?facility_id=${facilityId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                targetSelect.innerHTML = '<option value="">Choose a year...</option>';
                data.years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    targetSelect.appendChild(option);
                });
                
                hideError();
            })
            .catch(error => {
                showError('Error fetching years: ' + error.message);
            });
    }
    
    function getHourRangeFromMonths(startMonth, endMonth) {
        const daysPerMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        
        // Calculate start hour
        let startHour = 1;
        for (let i = 0; i < startMonth - 1; i++) {
            startHour += daysPerMonth[i] * 24;
        }
        
        // Calculate end hour
        let endHour = 0;
        for (let i = 0; i < endMonth; i++) {
            endHour += daysPerMonth[i] * 24;
        }
        
        return { start: startHour, end: endHour };
    }
    
    function fetchAndPlotData(facilityIds, year, aggregation, chartType) {
        loadingSpinner.style.display = 'block';
        hideError();
        plotInfo.style.display = 'none';
        
        // Get date range if specified
        let url = `/get_scada_data/?year=${year}&aggregation=${aggregation}`;
        
        // Add facility IDs as array parameters
        facilityIds.forEach(id => {
            url += `&facility_id[]=${id}`;
        });
        const startMonth = startMonthSingle.value;
        const endMonth = endMonthSingle.value;
        
        if (startMonth && endMonth) {
            const hourRange = getHourRangeFromMonths(parseInt(startMonth), parseInt(endMonth));
            url += `&start_hour=${hourRange.start}&end_hour=${hourRange.end}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // Display info based on facility count
                if (data.facility_count === 1) {
                    const facility = data.facilities[0];
                    document.getElementById('infoFacilityName').textContent = facility.facility_name;
                    document.getElementById('infoTechnology').textContent = facility.technology;
                } else {
                    document.getElementById('infoFacilityName').textContent = `${data.facility_count} facilities`;
                    const technologies = [...new Set(data.facilities.map(f => f.technology))].join(', ');
                    document.getElementById('infoTechnology').textContent = technologies;
                }
                document.getElementById('infoYear').textContent = data.year;
                document.getElementById('infoAggregation').textContent = data.aggregation.charAt(0).toUpperCase() + data.aggregation.slice(1);
                document.getElementById('infoTotalPeriods').textContent = data.total_periods;
                plotInfo.style.display = 'block';
                
                plotSupplyData(data, chartType);
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                showError('Error fetching data: ' + error.message);
            });
    }
    
    function fetchAndPlotComparison(facility1Ids, facility2Ids, year, aggregation, chartType) {
        loadingSpinner.style.display = 'block';
        hideError();
        comparisonMetrics.style.display = 'none';
        
        // Build URL with array parameters
        let url = `/get_scada_comparison/?year=${year}&aggregation=${aggregation}`;
        
        // Add facility IDs as array parameters
        facility1Ids.forEach(id => {
            url += `&facility1_id[]=${id}`;
        });
        facility2Ids.forEach(id => {
            url += `&facility2_id[]=${id}`;
        });
        
        const startMonth = startMonthCompare.value;
        const endMonth = endMonthCompare.value;
        
        if (startMonth && endMonth) {
            const hourRange = getHourRangeFromMonths(parseInt(startMonth), parseInt(endMonth));
            url += `&start_hour=${hourRange.start}&end_hour=${hourRange.end}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                displayComparisonMetrics(data);
                plotComparisonData(data, chartType);
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                showError('Error fetching comparison data: ' + error.message);
            });
    }
    
    function fetchAndPlotTechnology(technologyIds, year, aggregation, chartType) {
        loadingSpinner.style.display = 'block';
        hideError();
        plotInfo.style.display = 'none';
        comparisonMetrics.style.display = 'none';
        
        // Build URL with multiple technology IDs
        let url = `/get_scada_technology/?year=${year}&aggregation=${aggregation}`;
        technologyIds.forEach(id => {
            url += `&technology_id[]=${id}`;
        });
        
        // Get date range if specified
        const startMonth = startMonthTech.value;
        const endMonth = endMonthTech.value;
        
        if (startMonth && endMonth) {
            const hourRange = getHourRangeFromMonths(parseInt(startMonth), parseInt(endMonth));
            url += `&start_hour=${hourRange.start}&end_hour=${hourRange.end}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // Display technology names
                const techNamesDisplay = data.technology_names.join(', ');
                document.getElementById('infoFacilityName').textContent = `${techNamesDisplay} (${data.facility_count} facilities)`;
                document.getElementById('infoTechnology').textContent = 'Aggregated Technologies';
                document.getElementById('infoYear').textContent = data.year;
                document.getElementById('infoAggregation').textContent = data.aggregation.charAt(0).toUpperCase() + data.aggregation.slice(1);
                document.getElementById('infoTotalPeriods').textContent = data.total_periods;
                plotInfo.style.display = 'block';
                
                plotTechnologyData(data, chartType);
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                showError('Error fetching technology data: ' + error.message);
            });
    }

    function fetchAndPlotTechnologyComparison(technology1Ids, technology2Ids, year, aggregation, chartType) {
        loadingSpinner.style.display = 'block';
        hideError();
        comparisonMetrics.style.display = 'none';
        plotInfo.style.display = 'none';
        
        // Build URL with multiple technology IDs for both groups
        let url = `/get_scada_technology_comparison/?year=${year}&aggregation=${aggregation}`;
        technology1Ids.forEach(id => {
            url += `&technology1_id[]=${id}`;
        });
        technology2Ids.forEach(id => {
            url += `&technology2_id[]=${id}`;
        });
        
        // Get date range if specified
        const startMonth = startMonthTechComp.value;
        const endMonth = endMonthTechComp.value;
        
        if (startMonth && endMonth) {
            const hourRange = getHourRangeFromMonths(parseInt(startMonth), parseInt(endMonth));
            url += `&start_hour=${hourRange.start}&end_hour=${hourRange.end}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                displayTechnologyComparisonMetrics(data);
                plotTechnologyComparisonData(data, chartType);
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                showError('Error fetching technology comparison data: ' + error.message);
                console.error('Fetch error:', error);
            });
    }

    function displayComparisonMetrics(data) {
        const metrics = data.correlation_metrics;
        
        const group1Display = data.facility_group1.facility_count > 1 
            ? `${data.facility_group1.names.slice(0, 3).join(', ')}${data.facility_group1.names.length > 3 ? '...' : ''} (${data.facility_group1.facility_count} facilities)` 
            : data.facility_group1.names[0];
        const group2Display = data.facility_group2.facility_count > 1 
            ? `${data.facility_group2.names.slice(0, 3).join(', ')}${data.facility_group2.names.length > 3 ? '...' : ''} (${data.facility_group2.facility_count} facilities)` 
            : data.facility_group2.names[0];
        
        const tech1Display = data.facility_group1.breakdown.map(b => b.name).join(', ');
        const tech2Display = data.facility_group2.breakdown.map(b => b.name).join(', ');
        
        document.getElementById('compFacility1').textContent = group1Display;
        document.getElementById('compTech1').textContent = tech1Display;
        document.getElementById('compFacility2').textContent = group2Display;
        document.getElementById('compTech2').textContent = tech2Display;
        document.getElementById('compYear').textContent = data.year;
        document.getElementById('compAggregation').textContent = data.aggregation.charAt(0).toUpperCase() + data.aggregation.slice(1);
        
        // Correlation badge with color
        const corrBadge = document.getElementById('metricCorrelation');
        corrBadge.textContent = metrics.correlation;
        if (Math.abs(metrics.correlation) < 0.3) {
            corrBadge.className = 'badge bg-success';
        } else if (Math.abs(metrics.correlation) < 0.7) {
            corrBadge.className = 'badge bg-warning';
        } else {
            corrBadge.className = 'badge bg-danger';
        }
        
        // Complementarity badge with color
        const compBadge = document.getElementById('metricComplementarity');
        compBadge.textContent = metrics.complementarity_score;
        if (metrics.complementarity_score > 0.7) {
            compBadge.className = 'badge bg-success';
        } else if (metrics.complementarity_score > 0.4) {
            compBadge.className = 'badge bg-warning';
        } else {
            compBadge.className = 'badge bg-danger';
        }
        
        document.getElementById('metricVariability').textContent = metrics.variability_reduction;
        document.getElementById('metricComplementaryPct').textContent = metrics.complementary_periods_pct;
        document.getElementById('metricInterpretation').textContent = metrics.interpretation;
        
        comparisonMetrics.style.display = 'block';
    }
    
    function plotSupplyData(data, chartType) {
        const chartDiv = document.getElementById('quantityChart');
        
        // Create traces for each facility
        const colors = [
            'rgb(31, 119, 180)', 'rgb(255, 127, 14)', 'rgb(44, 160, 44)',
            'rgb(214, 39, 40)', 'rgb(148, 103, 189)', 'rgb(140, 86, 75)',
            'rgb(227, 119, 194)', 'rgb(127, 127, 127)', 'rgb(188, 189, 34)',
            'rgb(23, 190, 207)'
        ];
        
        const traces = data.facilities.map((facility, idx) => {
            const color = colors[idx % colors.length];
            const trace = {
                x: facility.periods,
                y: facility.quantity,
                name: `${facility.facility_name} (${facility.technology})`,
                type: chartType === 'bar' ? 'bar' : 'scatter'
            };
            
            if (chartType === 'line' || chartType === 'area') {
                trace.mode = 'lines';
                trace.line = { width: 2, color: color };
            } else if (chartType === 'scatter') {
                trace.mode = 'markers';
                trace.marker = { size: 6, color: color };
            } else if (chartType === 'bar') {
                trace.marker = { color: color };
            }
            
            if (chartType === 'area') {
                trace.fill = 'tozeroy';
                trace.fillcolor = color.replace('rgb', 'rgba').replace(')', ', 0.3)');
            }
            
            return trace;
        });
        
        const layout = {
            title: {
                text: `SCADA Data (${data.year}) - ${data.facility_count} Facilit${data.facility_count > 1 ? 'ies' : 'y'}`,
                font: { size: 16 }
            },
            xaxis: { 
                title: {
                    text: data.x_label || getTimeScaleLabel(data.aggregation),
                    font: { size: 14 }
                },
                showgrid: true, 
                zeroline: false 
            },
            yaxis: { 
                title: {
                    text: 'Generation (MW)',
                    font: { size: 14 }
                },
                showgrid: true, 
                zeroline: false 
            },
            hovermode: 'closest',
            showlegend: true,
            legend: { x: 1, xanchor: 'right', y: 1 },
            barmode: chartType === 'bar' ? 'group' : undefined
        };
        
        Plotly.newPlot(chartDiv, traces, layout, getPlotConfig());
    }

    function plotComparisonData(data, chartType) {
        const chartDiv = document.getElementById('quantityChart');
        
        const group1Name = data.facility_group1.facility_count > 1 
            ? `Group 1 (${data.facility_group1.facility_count} facilities)` 
            : data.facility_group1.names[0];
        const group2Name = data.facility_group2.facility_count > 1 
            ? `Group 2 (${data.facility_group2.facility_count} facilities)` 
            : data.facility_group2.names[0];
        
        const traces = createTraces(
            [data.periods, data.periods, data.periods],
            [data.group1_quantity, data.group2_quantity, data.group1_quantity.map((v, i) => v + data.group2_quantity[i])],
            [group1Name, group2Name, 'Combined Total'],
            ['rgb(31, 119, 180)', 'rgb(255, 127, 14)', 'rgb(44, 160, 44)'],
            chartType,
            [false, false, true]
        );
        
        const layout = {
            title: {
                text: `Facility Comparison (${data.year})`,
                font: { size: 16 }
            },
            xaxis: { 
                title: {
                    text: data.x_label || getTimeScaleLabel(data.aggregation),
                    font: { size: 14 }
                },
                showgrid: true, 
                zeroline: false 
            },
            yaxis: { 
                title: {
                    text: 'Generation (MW)',
                    font: { size: 14 }
                },
                showgrid: true, 
                zeroline: false 
            },
            hovermode: 'x unified',
            showlegend: true,
            legend: { x: 0, xanchor: 'left', y: 1 },
            barmode: chartType === 'bar' ? 'group' : undefined
        };
        
        // Add breakdown annotations if multiple facilities in a group
        const annotations = [];
        
        if (data.facility_group1.breakdown && data.facility_group1.breakdown.length > 1) {
            const breakdown1Text = 'Group 1:<br>' + data.facility_group1.breakdown
                .map(tech => `${tech.name}: ${tech.facility_count}`)
                .join('<br>');
            
            annotations.push({
                text: breakdown1Text,
                xref: 'paper',
                yref: 'paper',
                x: 0.02,
                y: 0.98,
                xanchor: 'left',
                yanchor: 'top',
                showarrow: false,
                bgcolor: 'rgba(255, 255, 255, 0.9)',
                bordercolor: 'rgb(31, 119, 180)',
                borderwidth: 2,
                borderpad: 6,
                font: { size: 10, color: 'rgb(31, 119, 180)' }
            });
        }
        
        if (data.facility_group2.breakdown && data.facility_group2.breakdown.length > 1) {
            const breakdown2Text = 'Group 2:<br>' + data.facility_group2.breakdown
                .map(tech => `${tech.name}: ${tech.facility_count}`)
                .join('<br>');
            
            annotations.push({
                text: breakdown2Text,
                xref: 'paper',
                yref: 'paper',
                x: 0.98,
                y: 0.98,
                xanchor: 'right',
                yanchor: 'top',
                showarrow: false,
                bgcolor: 'rgba(255, 255, 255, 0.9)',
                bordercolor: 'rgb(255, 127, 14)',
                borderwidth: 2,
                borderpad: 6,
                font: { size: 10, color: 'rgb(255, 127, 14)' }
            });
        }
        
        if (annotations.length > 0) {
            layout.annotations = annotations;
        }
        
        Plotly.newPlot(chartDiv, traces, layout, getPlotConfig());
    }

    function plotTechnologyData(data, chartType) {
        const chartDiv = document.getElementById('quantityChart');
        
        const trace = {
            x: data.periods,
            y: data.quantity,
            name: 'Aggregated Generation',
            type: chartType === 'bar' ? 'bar' : 'scatter'
        };
        
        if (chartType === 'line' || chartType === 'area') {
            trace.mode = 'lines';
            trace.line = { width: 2, color: 'rgb(31, 119, 180)' };
        } else if (chartType === 'scatter') {
            trace.mode = 'markers';
            trace.marker = { size: 6, color: 'rgb(31, 119, 180)' };
        } else if (chartType === 'bar') {
            trace.marker = { color: 'rgb(31, 119, 180)' };
        }
        
        if (chartType === 'area') {
            trace.fill = 'tozeroy';
            trace.fillcolor = 'rgba(31, 119, 180, 0.3)';
        }
        
        // Build title with technology names
        const techNamesDisplay = data.technology_names.join(' + ');
        const titleText = `${techNamesDisplay} - Aggregated Generation from ${data.facility_count} Facilities (${data.year})`;
        
        const layout = {
            title: {
                text: titleText,
                font: { size: 16 }
            },
            xaxis: { 
                title: {
                    text: data.x_label || getTimeScaleLabel(data.aggregation),
                    font: { size: 14 }
                },
                showgrid: true, 
                zeroline: false 
            },
            yaxis: { 
                title: {
                    text: 'Aggregated Generation (MW)',
                    font: { size: 14 }
                },
                showgrid: true, 
                zeroline: false 
            },
            hovermode: 'closest',
            showlegend: true,
            legend: { x: 1, xanchor: 'right', y: 1 },
            barmode: chartType === 'bar' ? 'group' : undefined
        };
        
        // Add annotation showing technology breakdown if multiple technologies
        if (data.technology_breakdown && data.technology_breakdown.length > 1) {
            const breakdownText = data.technology_breakdown
                .map(tech => `${tech.name}: ${tech.facility_count} facilities`)
                .join('<br>');
            
            layout.annotations = [{
                text: breakdownText,
                xref: 'paper',
                yref: 'paper',
                x: 0.02,
                y: 0.98,
                xanchor: 'left',
                yanchor: 'top',
                showarrow: false,
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: 'rgba(0, 0, 0, 0.2)',
                borderwidth: 1,
                borderpad: 4,
                font: { size: 10 }
            }];
        }
        
        Plotly.newPlot(chartDiv, [trace], layout, getPlotConfig());
    }

    function plotTechnologyComparisonData(data, chartType) {
        const tech1Names = data.technology1.names.join(' + ');
        const tech2Names = data.technology2.names.join(' + ');
        
        const traces = createTraces(
            [data.periods, data.periods, data.periods],
            [data.technology1_quantity, data.technology2_quantity, data.technology1_quantity.map((v, i) => v + data.technology2_quantity[i])],
            [`Group 1: ${tech1Names} (${data.technology1.facility_count} facilities)`, 
            `Group 2: ${tech2Names} (${data.technology2.facility_count} facilities)`, 
            'Combined Total'],
            ['rgb(55, 128, 191)', 'rgb(255, 127, 14)', 'rgb(44, 160, 44)'],
            chartType,
            [false, false, true]
        );
        
        const layout = {
            title: {
                text: `Technology Comparison: ${tech1Names} vs ${tech2Names} (${data.year})`,
                font: { size: 16 }
            },
            xaxis: { 
                title: {
                    text: data.x_label || getTimeScaleLabel(data.aggregation),
                    font: { size: 14 }
                },
                showgrid: true, 
                zeroline: false 
            },
            yaxis: { 
                title: {
                    text: 'Aggregated Generation (MWh)',
                    font: { size: 14 }
                },
                showgrid: true, 
                zeroline: false 
            },
            hovermode: 'x unified',
            showlegend: true,
            legend: { x: 0, xanchor: 'left', y: 1 },
            barmode: chartType === 'bar' ? 'group' : undefined
        };
        
        // Add annotations showing technology breakdowns if multiple technologies in either group
        const annotations = [];
        
        if (data.technology1.breakdown && data.technology1.breakdown.length > 1) {
            const breakdown1Text = 'Group 1:<br>' + data.technology1.breakdown
                .map(tech => `${tech.name}: ${tech.facility_count}`)
                .join('<br>');
            
            annotations.push({
                text: breakdown1Text,
                xref: 'paper',
                yref: 'paper',
                x: 0.02,
                y: 0.02,
                xanchor: 'left',
                yanchor: 'bottom',
                showarrow: false,
                bgcolor: 'rgba(255, 255, 255, 0.9)',
                bordercolor: 'rgb(55, 128, 191)',
                borderwidth: 2,
                borderpad: 6,
                font: { size: 10, color: 'rgb(55, 128, 191)' }
            });
        }
        
        if (data.technology2.breakdown && data.technology2.breakdown.length > 1) {
            const breakdown2Text = 'Group 2:<br>' + data.technology2.breakdown
                .map(tech => `${tech.name}: ${tech.facility_count}`)
                .join('<br>');
            
            annotations.push({
                text: breakdown2Text,
                xref: 'paper',
                yref: 'paper',
                x: 0.98,
                y: 0.02,
                xanchor: 'right',
                yanchor: 'bottom',
                showarrow: false,
                bgcolor: 'rgba(255, 255, 255, 0.9)',
                bordercolor: 'rgb(255, 127, 14)',
                borderwidth: 2,
                borderpad: 6,
                font: { size: 10, color: 'rgb(255, 127, 14)' }
            });
        }
        
        if (annotations.length > 0) {
            layout.annotations = annotations;
        }
        
        Plotly.newPlot(chartDiv, traces, layout, getPlotConfig());
    }

    // Helper function to generate appropriate time scale labels
    function getTimeScaleLabel(aggregation) {
        const labels = {
            'hour': 'Hour of Year',
            'week': 'Week of Year',
            'month': 'Month of Year'
        };
        return labels[aggregation] || 'Time Period';
    }

    function createTraces(xArrays, yArrays, names, colors, chartType, isDashed = []) {
        let traceType = 'scatter';
        let traceMode = 'lines';
        let fillOption = null;
        
        switch(chartType) {
            case 'line': traceType = 'scatter'; traceMode = 'lines'; break;
            case 'scatter': traceType = 'scatter'; traceMode = 'markers'; break;
            case 'bar': traceType = 'bar'; traceMode = null; break;
            case 'area': traceType = 'scatter'; traceMode = 'lines'; fillOption = 'tozeroy'; break;
        }
        
        return xArrays.map((x, idx) => {
            const trace = { x: x, y: yArrays[idx], name: names[idx], type: traceType };
            
            if (traceMode) trace.mode = traceMode;
            
            if (chartType === 'line' || chartType === 'area') {
                trace.line = { color: colors[idx], width: 2 };
                if (isDashed[idx]) trace.line.dash = 'dash';
            }
            
            if (chartType === 'scatter') {
                trace.marker = { color: colors[idx], size: 6 };
                if (isDashed[idx]) trace.marker.symbol = 'diamond';
            }
            
            if (chartType === 'bar') {
                trace.marker = { color: colors[idx] };
            }
            
            if (fillOption) {
                trace.fill = fillOption;
                trace.fillcolor = colors[idx].replace('rgb', 'rgba').replace(')', ', 0.3)');
            }
            
            return trace;
        });
    }
    
    function getPlotConfig() {
        return {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
            displaylogo: false
        };
    }
    
    function displayTechnologyComparisonMetrics(data) {
        const metrics = data.correlation_metrics;
        
        // Display technology group names
        const tech1Names = data.technology1.names.join(' + ');
        const tech2Names = data.technology2.names.join(' + ');
        
        document.getElementById('compFacility1').textContent = `${tech1Names} (${data.technology1.facility_count} facilities)`;
        document.getElementById('compTech1').textContent = 'Aggregated Technologies';
        document.getElementById('compFacility2').textContent = `${tech2Names} (${data.technology2.facility_count} facilities)`;
        document.getElementById('compTech2').textContent = 'Aggregated Technologies';
        document.getElementById('compYear').textContent = data.year;
        document.getElementById('compAggregation').textContent = data.aggregation.charAt(0).toUpperCase() + data.aggregation.slice(1);
        
        const corrBadge = document.getElementById('metricCorrelation');
        corrBadge.textContent = metrics.correlation;
        if (Math.abs(metrics.correlation) < 0.3) {
            corrBadge.className = 'badge bg-success';
        } else if (Math.abs(metrics.correlation) < 0.7) {
            corrBadge.className = 'badge bg-warning';
        } else {
            corrBadge.className = 'badge bg-danger';
        }
        
        const compBadge = document.getElementById('metricComplementarity');
        compBadge.textContent = metrics.complementarity_score;
        if (metrics.complementarity_score > 0.7) {
            compBadge.className = 'badge bg-success';
        } else if (metrics.complementarity_score > 0.4) {
            compBadge.className = 'badge bg-warning';
        } else {
            compBadge.className = 'badge bg-danger';
        }
        
        document.getElementById('metricVariability').textContent = metrics.variability_reduction;
        document.getElementById('metricComplementaryPct').textContent = metrics.complementary_periods_pct;
        document.getElementById('metricInterpretation').textContent = metrics.interpretation;
        
        comparisonMetrics.style.display = 'block';
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
    }

    function hideError() {
        errorMessage.style.display = 'none';
    }

    // Export to Excel functionality
    let currentExportParams = null;
    const exportExcelBtn = document.getElementById('exportExcelBtn');

    function updateExportParams(type, params) {
        currentExportParams = { type, ...params };
        exportExcelBtn.style.display = 'inline-block';
    }

    exportExcelBtn.addEventListener('click', function() {
        if (!currentExportParams) {
            showError('No data to export. Please generate a chart first.');
            return;
        }

        let url = '/export_scada_to_excel/?type=' + currentExportParams.type;
        url += '&year=' + currentExportParams.year;
        url += '&aggregation=' + currentExportParams.aggregation;

        if (currentExportParams.start_hour) {
            url += '&start_hour=' + currentExportParams.start_hour;
        }
        if (currentExportParams.end_hour) {
            url += '&end_hour=' + currentExportParams.end_hour;
        }

        if (currentExportParams.type === 'single') {
            currentExportParams.facility_ids.forEach(id => {
                url += '&facility_id[]=' + id;
            });
        } else if (currentExportParams.type === 'compare') {
            currentExportParams.facility1_ids.forEach(id => {
                url += '&facility1_id[]=' + id;
            });
            currentExportParams.facility2_ids.forEach(id => {
                url += '&facility2_id[]=' + id;
            });
        } else if (currentExportParams.type === 'technology') {
            currentExportParams.technology_ids.forEach(id => {
                url += '&technology_id[]=' + id;
            });
        } else if (currentExportParams.type === 'techcompare') {
            currentExportParams.technology1_ids.forEach(id => {
                url += '&technology1_id[]=' + id;
            });
            currentExportParams.technology2_ids.forEach(id => {
                url += '&technology2_id[]=' + id;
            });
        }

        window.location.href = url;
    });

    // Override fetch functions to capture export params
    const originalFetchAndPlotData = fetchAndPlotData;
    fetchAndPlotData = function(facilityIds, year, aggregation, chartType) {
        const startMonth = startMonthSingle.value;
        const endMonth = endMonthSingle.value;
        let startHour = null, endHour = null;
        if (startMonth && endMonth) {
            const hourRange = getHourRangeFromMonths(parseInt(startMonth), parseInt(endMonth));
            startHour = hourRange.start;
            endHour = hourRange.end;
        }
        updateExportParams('single', {
            facility_ids: facilityIds,
            year: year,
            aggregation: aggregation,
            start_hour: startHour,
            end_hour: endHour
        });
        return originalFetchAndPlotData(facilityIds, year, aggregation, chartType);
    };

    const originalFetchAndPlotComparison = fetchAndPlotComparison;
    fetchAndPlotComparison = function(facility1Ids, facility2Ids, year, aggregation, chartType) {
        const startMonth = startMonthCompare.value;
        const endMonth = endMonthCompare.value;
        let startHour = null, endHour = null;
        if (startMonth && endMonth) {
            const hourRange = getHourRangeFromMonths(parseInt(startMonth), parseInt(endMonth));
            startHour = hourRange.start;
            endHour = hourRange.end;
        }
        updateExportParams('compare', {
            facility1_ids: facility1Ids,
            facility2_ids: facility2Ids,
            year: year,
            aggregation: aggregation,
            start_hour: startHour,
            end_hour: endHour
        });
        return originalFetchAndPlotComparison(facility1Ids, facility2Ids, year, aggregation, chartType);
    };

    const originalFetchAndPlotTechnology = fetchAndPlotTechnology;
    fetchAndPlotTechnology = function(technologyIds, year, aggregation, chartType) {
        const startMonth = startMonthTech.value;
        const endMonth = endMonthTech.value;
        let startHour = null, endHour = null;
        if (startMonth && endMonth) {
            const hourRange = getHourRangeFromMonths(parseInt(startMonth), parseInt(endMonth));
            startHour = hourRange.start;
            endHour = hourRange.end;
        }
        updateExportParams('technology', {
            technology_ids: technologyIds,
            year: year,
            aggregation: aggregation,
            start_hour: startHour,
            end_hour: endHour
        });
        return originalFetchAndPlotTechnology(technologyIds, year, aggregation, chartType);
    };

    const originalFetchAndPlotTechnologyComparison = fetchAndPlotTechnologyComparison;
    fetchAndPlotTechnologyComparison = function(technology1Ids, technology2Ids, year, aggregation, chartType) {
        const startMonth = startMonthTechComp.value;
        const endMonth = endMonthTechComp.value;
        let startHour = null, endHour = null;
        if (startMonth && endMonth) {
            const hourRange = getHourRangeFromMonths(parseInt(startMonth), parseInt(endMonth));
            startHour = hourRange.start;
            endHour = hourRange.end;
        }
        updateExportParams('techcompare', {
            technology1_ids: technology1Ids,
            technology2_ids: technology2Ids,
            year: year,
            aggregation: aggregation,
            start_hour: startHour,
            end_hour: endHour
        });
        return originalFetchAndPlotTechnologyComparison(technology1Ids, technology2Ids, year, aggregation, chartType);
    };
});
</script>
{% endblock %}