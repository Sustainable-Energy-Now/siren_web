<!-- facility_wind_turbines/edit.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3>Edit Wind Turbine Installation</h3>
      <small class="text-muted">{{ installation.idfacilities.facility_name }} - {{ installation.idwindturbines.turbine_model }}</small>
    </div>
    <a href="{% url 'powermapui:facility_wind_turbines_list' %}" class="btn btn-outline-secondary">Back to List</a>
  </div>

  <p>Update the installation details for this wind turbine deployment. Changes will affect capacity calculations and operational parameters.</p>

  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            
            <!-- Read-only facility and turbine info -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Facility</label>
                <input type="text" class="form-control" readonly 
                       value="{{ installation.idfacilities.facility_name }}">
                <div class="form-text">Zone: {{ installation.idfacilities.idzones.name|default:"Not assigned" }}</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Wind Turbine Model</label>
                <input type="text" class="form-control" readonly 
                       value="{{ installation.idwindturbines.manufacturer|default:'Unknown' }} {{ installation.idwindturbines.turbine_model }}">
                <div class="form-text">
                  {% if installation.idwindturbines.rated_power %}
                    Rated Power: {{ installation.idwindturbines.rated_power|floatformat:0 }} kW
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Editable fields -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="no_turbines" class="form-label">Number of Turbines <span class="text-danger">*</span></label>
                <input type="number" 
                       class="form-control non-negative" 
                       id="no_turbines" 
                       name="no_turbines" 
                       min="1" 
                       value="{{ installation.no_turbines }}"
                       required>
                <div class="form-text">Total number of turbines installed</div>
              </div>
              <div class="col-md-4">
                <label for="tilt" class="form-label">Tilt Angle (degrees)</label>
                <input type="number" 
                       class="form-control" 
                       id="tilt" 
                       name="tilt" 
                       min="-90" 
                       max="90"
                       value="{{ installation.tilt|default:'' }}">
                <div class="form-text">Turbine blade tilt angle</div>
              </div>
              <div class="col-md-4">
                <label for="direction" class="form-label">Primary Direction</label>
                <input type="text" 
                       class="form-control" 
                       id="direction" 
                       name="direction" 
                       value="{{ installation.direction|default:'' }}"
                       maxlength="28">
                <div class="form-text">e.g., North, SW, 225°</div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="installation_date" class="form-label">Installation Date</label>
                <input type="date" 
                       class="form-control" 
                       id="installation_date" 
                       name="installation_date" 
                       value="{{ installation.installation_date|date:'Y-m-d'|default:'' }}">
                <div class="form-text">Date when turbines were installed</div>
              </div>
              <div class="col-md-6 d-flex align-items-center">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                         {% if installation.is_active %}checked{% endif %}>
                  <label class="form-check-label" for="is_active">
                    Installation is Active
                  </label>
                  <div class="form-text">Uncheck to deactivate this installation</div>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <label for="notes" class="form-label">Installation Notes</label>
              <textarea class="form-control" 
                        id="notes" 
                        name="notes" 
                        rows="3">{{ installation.notes|default:'' }}</textarea>
              <div class="form-text">Additional notes about this installation</div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Update Installation</button>
              <a href="{% url 'powermapui:facility_wind_turbines_list' %}" class="btn btn-outline-secondary">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Current Capacity Display -->
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">Current Capacity</h6>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <span>Total Capacity:</span>
            <strong class="text-primary" id="current-capacity">
              {% if installation.total_capacity %}
                {{ installation.total_capacity|floatformat:0 }} kW
              {% else %}
                Not calculated
              {% endif %}
            </strong>
          </div>
          <small class="text-muted">
            {{ installation.no_turbines }} units × 
            {% if installation.idwindturbines.rated_power %}
              {{ installation.idwindturbines.rated_power|floatformat:0 }} kW
            {% else %}
              Unknown power
            {% endif %}
          </small>
        </div>
      </div>

      <!-- Installation History -->
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">Installation History</h6>
        </div>
        <div class="card-body">
          <table class="table table-sm mb-0">
            <tr>
              <td><strong>Created:</strong></td>
              <td>{{ installation.created_at|date:"Y-m-d H:i" }}</td>
            </tr>
            <tr>
              <td><strong>Last Updated:</strong></td>
              <td>{{ installation.updated_at|date:"Y-m-d H:i" }}</td>
            </tr>
            <tr>
              <td><strong>Installation Date:</strong></td>
              <td>{{ installation.installation_date|default:"Not specified" }}</td>
            </tr>
            <tr>
              <td><strong>Status:</strong></td>
              <td>
                {% if installation.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Turbine Specifications -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Turbine Specifications</h6>
        </div>
        <div class="card-body">
          <div class="small">
            <table class="table table-sm mb-0">
              <tr>
                <td><strong>Model:</strong></td>
                <td>{{ installation.idwindturbines.turbine_model }}</td>
              </tr>
              <tr>
                <td><strong>Manufacturer:</strong></td>
                <td>{{ installation.idwindturbines.manufacturer|default:"Unknown" }}</td>
              </tr>
              {% if installation.idwindturbines.rated_power %}
              <tr>
                <td><strong>Rated Power:</strong></td>
                <td>{{ installation.idwindturbines.rated_power|floatformat:0 }} kW</td>
              </tr>
              {% endif %}
              {% if installation.idwindturbines.hub_height %}
              <tr>
                <td><strong>Hub Height:</strong></td>
                <td>{{ installation.idwindturbines.hub_height|floatformat:1 }} m</td>
              </tr>
              {% endif %}
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const noTurbinesInput = document.getElementById('no_turbines');
      const currentCapacitySpan = document.getElementById('current-capacity');
      const ratedPower = {{ installation.idwindturbines.rated_power|default:0 }};

      function updateCapacity() {
        const noTurbines = parseInt(noTurbinesInput.value) || 0;
        if (ratedPower > 0) {
          const totalCapacity = ratedPower * noTurbines;
          currentCapacitySpan.textContent = totalCapacity.toLocaleString() + ' kW';
        }
      }

      noTurbinesInput.addEventListener('input', updateCapacity);
    });
    document.querySelectorAll('.non-negative').forEach(input => {
      input.addEventListener('input', function() {
        if (this.value < 0) {
          this.value = 1;
        }
      });
    });
  </script>
{% endblock %}