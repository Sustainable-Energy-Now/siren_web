<!-- facility_storage/create.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Add Storage Installation</h3>
    <a href="{% url 'powermapui:facility_storage_list' %}" class="btn btn-outline-secondary">Back to List</a>
  </div>

  <p>Create a new storage system installation at a facility. Select the facility and storage technology, then specify the installation capacity.</p>

  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <form method="post" novalidate id="storageForm">
            {% csrf_token %}
            
            <!-- Facility Information -->
            <div class="alert alert-info mb-3">
              <strong>Facility:</strong> {{ facility.facility_name }}
              {% if facility.idzones %}
                <span class="ms-2 text-muted">| Zone: {{ facility.idzones.name }}</span>
              {% endif %}
            </div>

            <!-- Technology Selection -->
            <div class="mb-3">
              <label for="technology" class="form-label">Storage Technology <span class="text-danger">*</span></label>
              <select class="form-select" id="technology" name="technology" required>
                <option value="">Select technology</option>
                {% for tech in technologies %}
                  <option value="{{ tech.pk }}"
                          {% if form_data.technology == tech.pk|stringformat:"s" %}selected{% endif %}
                          data-signature="{{ tech.technology_signature }}">
                    {{ tech.technology_name }}
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">Type of storage system</div>
            </div>

            <div class="mb-3">
              <label for="installation_name" class="form-label">Installation Name</label>
              <input type="text" 
                     class="form-control" 
                     id="installation_name" 
                     name="installation_name" 
                     value="{{ form_data.installation_name|default:'' }}"
                     placeholder="e.g., Main Battery Bank">
              <div class="form-text">Optional name to identify this installation (leave blank if facility has only one)</div>
            </div>

            <hr class="my-4">

            <!-- Capacity Specifications -->
            <h5 class="mb-3">Capacity Specifications</h5>
            <p class="text-muted small">Provide at least one capacity value. Duration will be calculated if power and energy are provided.</p>

            <div class="row mb-3">
              <div class="col-md-4">
                <label for="power_capacity" class="form-label">Power Capacity (MW)</label>
                <input type="number" 
                       class="form-control non-negative" 
                       id="power_capacity" 
                       name="power_capacity" 
                       step="0.01" 
                       min="0"
                       value="{{ form_data.power_capacity|default:'' }}">
                <div class="form-text">Max charge/discharge rate</div>
              </div>
              <div class="col-md-4">
                <label for="energy_capacity" class="form-label">Energy Capacity (MWh)</label>
                <input type="number" 
                       class="form-control non-negative" 
                       id="energy_capacity" 
                       name="energy_capacity" 
                       step="0.01" 
                       min="0"
                       value="{{ form_data.energy_capacity|default:'' }}">
                <div class="form-text">Total energy storage</div>
              </div>
              <div class="col-md-4">
                <label for="duration" class="form-label">Duration (hours)</label>
                <input type="number" 
                       class="form-control non-negative" 
                       id="duration" 
                       name="duration" 
                       step="0.1" 
                       min="0"
                       value="{{ form_data.duration|default:'' }}">
                <div class="form-text" id="duration-hint">Discharge duration</div>
              </div>
            </div>

            <hr class="my-4">

            <!-- Installation Details -->
            <h5 class="mb-3">Installation Details</h5>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="installation_date" class="form-label">Installation Date</label>
                <input type="date" 
                       class="form-control" 
                       id="installation_date" 
                       name="installation_date" 
                       value="{{ form_data.installation_date|default:'' }}">
                <div class="form-text">When system was installed</div>
              </div>
              <div class="col-md-6">
                <label for="commissioning_date" class="form-label">Commissioning Date</label>
                <input type="date" 
                       class="form-control" 
                       id="commissioning_date" 
                       name="commissioning_date" 
                       value="{{ form_data.commissioning_date|default:'' }}">
                <div class="form-text">When system began operations</div>
              </div>
            </div>

            <div class="mb-3">
              <label for="initial_state_of_charge" class="form-label">Initial State of Charge</label>
              <input type="number" 
                     class="form-control" 
                     id="initial_state_of_charge" 
                     name="initial_state_of_charge" 
                     step="0.01" 
                     min="0" 
                     max="1"
                     value="{{ form_data.initial_state_of_charge|default:'' }}"
                     placeholder="0.5">
              <div class="form-text">Starting SOC for simulations (0.0 to 1.0). Leave blank to use technology default.</div>
            </div>

            <div class="mb-4">
              <label for="notes" class="form-label">Notes</label>
              <textarea class="form-control" 
                        id="notes" 
                        name="notes" 
                        rows="3">{{ form_data.notes|default:'' }}</textarea>
              <div class="form-text">Additional information about this installation</div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Create Installation</button>
              <a href="{% url 'powermapui:facility_storage_list' %}" class="btn btn-outline-secondary">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Help Card -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Capacity Guidelines</h6>
        </div>
        <div class="card-body">
          <div class="small">
            <p><strong>Power Capacity (MW):</strong> The maximum rate at which the storage can charge or discharge.</p>
            
            <p><strong>Energy Capacity (MWh):</strong> The total amount of energy that can be stored.</p>
            
            <p><strong>Duration:</strong> How long the storage can discharge at rated power. If you provide Power and Energy, Duration will be calculated automatically.</p>
            
            <p class="mb-0"><strong>Formula:</strong><br>
            Duration (h) = Energy (MWh) รท Power (MW)</p>
          </div>
        </div>
      </div>

      <!-- Example Card -->
      <div class="card mt-3">
        <div class="card-header">
          <h6 class="mb-0">Example Installations</h6>
        </div>
        <div class="card-body">
          <div class="small">
            <p><strong>100MW / 400MWh BESS:</strong><br>
            Power: 100 MW<br>
            Energy: 400 MWh<br>
            Duration: 4 hours</p>
            
            <p class="mb-0"><strong>500MW / 4000MWh Pumped Hydro:</strong><br>
            Power: 500 MW<br>
            Energy: 4000 MWh<br>
            Duration: 8 hours</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Auto-calculate duration when power and energy are provided
    const powerInput = document.getElementById('power_capacity');
    const energyInput = document.getElementById('energy_capacity');
    const durationInput = document.getElementById('duration');
    const durationHint = document.getElementById('duration-hint');

    function calculateDuration() {
      const power = parseFloat(powerInput.value);
      const energy = parseFloat(energyInput.value);
      
      if (power > 0 && energy > 0) {
        const calculated = energy / power;
        if (!durationInput.value) {
          durationHint.textContent = `Calculated: ${calculated.toFixed(1)} hours`;
          durationHint.classList.add('text-primary');
        }
      } else {
        durationHint.textContent = 'Discharge duration';
        durationHint.classList.remove('text-primary');
      }
    }

    powerInput.addEventListener('input', calculateDuration);
    energyInput.addEventListener('input', calculateDuration);

    // Prevent negative values
    document.querySelectorAll('.non-negative').forEach(input => {
      input.addEventListener('input', function() {
        if (this.value < 0) {
          this.value = 0;
        }
      });
    });
  </script>
{% endblock %}