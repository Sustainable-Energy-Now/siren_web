<!-- terminals/node_diagram.html -->
{% extends 'powermapui_base.html' %}
{% load static %}
{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3>Node Diagram</h3>
      <small class="text-muted">{{ terminal.terminal_name }}</small>
    </div>
    <div>
      <button class="btn btn-sm btn-secondary" onclick="networkDiagram.resetHighlight()">Reset View</button>
      <button class="btn btn-sm btn-info" onclick="downloadSVG()">Download SVG</button>
      <a href="{% url 'powermapui:terminal_connections' terminal.pk %}" class="btn btn-primary">Manage Connections</a>
      <a href="{% url 'powermapui:terminal_detail' terminal.pk %}" class="btn btn-outline-secondary">Back to Terminal</a>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-9">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Network Visualization</h5>
          <div>
            <button class="btn btn-sm btn-outline-primary" onclick="networkDiagram.simulation.alpha(0.3).restart()">
              <i class="bi bi-arrow-clockwise"></i> Restart Animation
            </button>
          </div>
        </div>
        <div class="card-body p-0">
          <!-- Main visualization container -->
          <div id="network-diagram" style="width: 100%; height: 600px; background-color: #f8f9fa;">
            <div class="d-flex align-items-center justify-content-center h-100" id="loading-indicator">
              <div class="text-center text-muted">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading network diagram...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Legend -->
      <div class="card mt-3">
        <div class="card-header">
          <h6 class="mb-0">Legend & Controls</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
            <h6 class="small fw-bold">Node Types</h6>
            <div class="d-flex align-items-center mb-2">
                <div style="width: 30px; height: 30px; background-color: #0d6efd; border-radius: 50%; border: 2px solid white; margin-right: 10px;"></div>
                <span class="small">Terminal ({{ terminal_count }})</span>
            </div>
            <div class="d-flex align-items-center mb-2">
                <div style="width: 25px; height: 25px; background-color: #198754; border-radius: 50%; border: 2px solid white; margin-right: 10px;"></div>
                <span class="small">Grid Line ({{ gridline_count }})</span>
            </div>
            <div class="d-flex align-items-center mb-2">
                <div style="width: 20px; height: 20px; background-color: #ffc107; border-radius: 50%; border: 2px solid white; margin-right: 10px;"></div>
                <span class="small">Facility ({{ facility_count }})</span>
            </div>
            </div>
            
            <div class="col-md-4">
              <h6 class="small fw-bold">Connection Types</h6>
              <div class="d-flex align-items-center mb-2">
                <div style="width: 40px; height: 3px; background-color: #198754; margin-right: 10px;"></div>
                <span class="small">Outgoing Connection</span>
              </div>
              <div class="d-flex align-items-center mb-2">
                <div style="width: 40px; height: 3px; background-color: #0dcaf0; margin-right: 10px;"></div>
                <span class="small">Incoming Connection</span>
              </div>
              <div class="d-flex align-items-center mb-2">
                <div style="width: 40px; height: 3px; background-color: #999; border-top: 2px dashed #999; margin-right: 10px;"></div>
                <span class="small">Secondary Connection</span>
              </div>
            </div>
            
            <div class="col-md-4">
              <h6 class="small fw-bold">Interactions</h6>
              <ul class="small list-unstyled">
                <li><i class="bi bi-cursor"></i> <strong>Click & Drag:</strong> Move nodes</li>
                <li><i class="bi bi-mouse"></i> <strong>Scroll:</strong> Zoom in/out</li>
                <li><i class="bi bi-hand-index"></i> <strong>Hover:</strong> View details</li>
                <li><i class="bi bi-arrows-move"></i> <strong>Drag Canvas:</strong> Pan view</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-3">
      <!-- Network Statistics -->
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">Network Statistics</h6>
        </div>
        <div class="card-body">
          <div class="mb-3 text-center">
            <h4 class="text-primary">{{ nodes|length }}</h4>
            <small class="text-muted">Total Nodes</small>
          </div>
          <div class="mb-3 text-center">
            <h4 class="text-success">{{ links|length }}</h4>
            <small class="text-muted">Total Connections</small>
          </div>
          <hr>
            <div class="small">
            <strong>Node Breakdown:</strong>
            <ul class="list-unstyled mt-2 mb-0">
                <li>Terminals: <span class="badge bg-primary">{{ terminal_count }}</span></li>
                <li>Grid Lines: <span class="badge bg-success">{{ gridline_count }}</span></li>
                <li>Facilities: <span class="badge bg-warning">{{ facility_count }}</span></li>
            </ul>
            </div>
        </div>
      </div>

      <!-- Node Details -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Selected Node</h6>
        </div>
        <div class="card-body" id="node-details">
          <p class="text-muted text-center small">Click a node to view details</p>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="card mt-3">
        <div class="card-header">
          <h6 class="mb-0">Quick Links</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="{% url 'powermapui:terminal_facilities' terminal.pk %}" class="btn btn-sm btn-outline-info">
              View Facilities List
            </a>
            <a href="{% url 'powermapui:terminal_gridlines' terminal.pk %}" class="btn btn-sm btn-outline-success">
              View Grid Lines List
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data for Node Diagram (JSON) -->
  <script type="application/json" id="network-data">
    {{ network_data_json|safe }}
  </script>

  <!-- Load D3.js from CDN -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Load Node Diagram Class -->
  <script src="{% static 'js/node_diagram.js' %}"></script>

  <!-- Initialize Node Diagram -->
  <script>
    // Global reference to the diagram
    let networkDiagram;

    document.addEventListener('DOMContentLoaded', function() {
      // Parse network data
      const networkData = JSON.parse(document.getElementById('network-data').textContent);
      
      // Hide loading indicator
      const loadingIndicator = document.getElementById('loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
      
      // Initialize the network diagram
      try {
        networkDiagram = new TerminalNetworkDiagram('network-diagram', networkData);
        
        // Add click event to show node details
        addNodeClickHandler();
        
      } catch (error) {
        console.error('Error initializing network diagram:', error);
        document.getElementById('network-diagram').innerHTML = 
          '<div class="alert alert-danger m-3">Error loading network diagram: ' + error.message + '</div>';
      }
    });

    // Add click handler to show node details in sidebar
    function addNodeClickHandler() {
      if (!networkDiagram) return;
      
      networkDiagram.nodesGroup.selectAll('circle').on('click', function(event, d) {
        event.stopPropagation();
        
        // Highlight the clicked node
        networkDiagram.highlightNode(d.id);
        
        // Update details panel
        updateNodeDetails(d);
      });
      
      // Reset on canvas click
      networkDiagram.svg.on('click', function(event) {
        if (event.target === this) {
          networkDiagram.resetHighlight();
          resetNodeDetails();
        }
      });
    }

    // Update the node details panel
    function updateNodeDetails(node) {
      const detailsDiv = document.getElementById('node-details');
      
      let html = '<div class="node-details-content">';
      html += `<h6 class="text-primary">${node.label}</h6>`;
      html += `<p class="small text-muted mb-2">Type: <span class="badge bg-secondary">${node.type}</span></p>`;
      
      if (node.type === 'terminal') {
        html += `<ul class="small list-unstyled mb-0">`;
        html += `<li><strong>Voltage:</strong> ${node.voltage} kV</li>`;
        html += `</ul>`;
        html += `<hr><a href="/terminals/${node.id.split('_')[1]}/" class="btn btn-sm btn-primary w-100">View Terminal</a>`;
      } else if (node.type === 'gridline') {
        html += `<ul class="small list-unstyled mb-0">`;
        html += `<li><strong>Voltage:</strong> ${node.voltage} kV</li>`;
        html += `<li><strong>Capacity:</strong> ${node.capacity} MW</li>`;
        html += `</ul>`;
      } else if (node.type === 'facility') {
        html += `<ul class="small list-unstyled mb-0">`;
        html += `<li><strong>Technology:</strong> ${node.technology}</li>`;
        html += `<li><strong>Capacity:</strong> ${node.capacity ? node.capacity.toFixed(1) : 'N/A'} MW</li>`;
        html += `</ul>`;
        html += `<hr><a href="/facilities/${node.id.split('_')[1]}/" class="btn btn-sm btn-warning w-100">View Facility</a>`;
      }
      
      html += '</div>';
      
      detailsDiv.innerHTML = html;
    }

    // Reset node details panel
    function resetNodeDetails() {
      document.getElementById('node-details').innerHTML = 
        '<p class="text-muted text-center small">Click a node to view details</p>';
    }

    // Download SVG function
    function downloadSVG() {
      if (!networkDiagram) {
        alert('Network diagram not loaded');
        return;
      }
      
      const svgElement = networkDiagram.svg.node();
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svgElement);
      
      const blob = new Blob([svgString], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'node_diagram_{{ terminal.terminal_code }}.svg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      URL.revokeObjectURL(url);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
      if (!networkDiagram) return;
      
      // R key - restart animation
      if (event.key === 'r' || event.key === 'R') {
        networkDiagram.simulation.alpha(0.3).restart();
      }
      
      // Escape key - reset highlight
      if (event.key === 'Escape') {
        networkDiagram.resetHighlight();
        resetNodeDetails();
      }
    });
  </script>
  <style>
    /* Network diagram specific styles */
    #network-diagram {
      border: 1px solid #dee2e6;
      border-radius: 0.25rem;
      overflow: hidden;
    }

    #network-diagram svg {
      display: block;
    }

    /* Node hover effect */
    #network-diagram circle {
      cursor: pointer;
      transition: opacity 0.3s;
    }

    #network-diagram circle:hover {
      opacity: 0.8;
      stroke-width: 3px !important;
    }

    /* Link styles */
    #network-diagram line {
      transition: stroke-opacity 0.3s;
    }

    /* Node details panel */
    .node-details-content {
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Loading spinner */
    #loading-indicator {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
    }

    /* Legend items */
    .legend {
      pointer-events: none;
    }
  </style>
{% endblock %}