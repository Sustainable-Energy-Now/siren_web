<!-- terminals/list.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Terminals</h3>
    <a href="{% url 'powermapui:terminal_create' %}" class="btn btn-primary">Add New Terminal</a>
  </div>

  <p>
    This displays all terminals/substations in the system. Terminals represent connection points in the grid infrastructure 
    where power is transformed, switched, or distributed. Use the search and filters below to find specific terminals.
  </p>

  <!-- Search and Filter Form -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-3">
          <label for="search" class="form-label">Search:</label>
          <input type="text" name="search" id="search" class="form-control" 
                 value="{{ search_query }}" placeholder="Search by name, code, owner">
        </div>
        <div class="col-md-2">
          <label for="terminal_type" class="form-label">Terminal Type:</label>
          <select name="terminal_type" id="terminal_type" class="form-select">
            <option value="">All Types</option>
            {% for type_value, type_label in terminal_types %}
              <option value="{{ type_value }}" 
                      {% if terminal_type_filter == type_value %}selected{% endif %}>
                {{ type_label }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="voltage_class" class="form-label">Voltage Class:</label>
          <select name="voltage_class" id="voltage_class" class="form-select">
            <option value="">All Classes</option>
            {% for class_value, class_label in voltage_classes %}
              <option value="{{ class_value }}" 
                      {% if voltage_class_filter == class_value %}selected{% endif %}>
                {{ class_label }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="active" class="form-label">Status:</label>
          <select name="active" id="active" class="form-select">
            <option value="">All Status</option>
            <option value="true" {% if active_filter == 'true' %}selected{% endif %}>Active</option>
            <option value="false" {% if active_filter == 'false' %}selected{% endif %}>Inactive</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">Filter</button>
          <a href="{% url 'powermapui:terminals_list' %}" class="btn btn-outline-secondary">Clear</a>
        </div>
        <div class="col-md-1 d-flex align-items-end justify-content-end">
          <small class="text-muted">{{ total_count }} terminal{{ total_count|pluralize }}</small>
        </div>
      </form>
    </div>
  </div>

  <!-- Results Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Terminal Name</th>
          <th>Code</th>
          <th>Type</th>
          <th>Primary Voltage</th>
          <th>Transformer Capacity</th>
          <th>Owner</th>
          <th>Location</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for terminal in page_obj %}
          <tr>
            <td>
              <a href="{% url 'powermapui:terminal_detail' terminal.pk %}" class="text-decoration-none">
                {{ terminal.terminal_name }}
              </a>
            </td>
            <td>{{ terminal.terminal_code }}</td>
            <td>{{ terminal.get_terminal_type_display }}</td>
            <td>{{ terminal.primary_voltage_kv }} kV</td>
            <td>
              {% if terminal.transformer_capacity_mva %}
                {{ terminal.transformer_capacity_mva|floatformat:1 }} MVA
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ terminal.owner|default:"-" }}</td>
            <td>
              {% if terminal.latitude and terminal.longitude %}
                {{ terminal.latitude|floatformat:4 }}, {{ terminal.longitude|floatformat:4 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if terminal.active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Inactive</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a href="{% url 'powermapui:terminal_detail' terminal.pk %}" 
                   class="btn btn-outline-primary" title="View Details">
                  View
                </a>
                <a href="{% url 'powermapui:terminal_edit' terminal.pk %}" 
                   class="btn btn-outline-warning" title="Edit">
                  Edit
                </a>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="9" class="text-center text-muted py-4">
              No terminals found.
              {% if search_query or terminal_type_filter or voltage_class_filter or active_filter %}
                <a href="{% url 'powermapui:terminals_list' %}" class="btn btn-link">Clear filters</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
    <nav aria-label="Terminals pagination">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if terminal_type_filter %}&terminal_type={{ terminal_type_filter }}{% endif %}{% if voltage_class_filter %}&voltage_class={{ voltage_class_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}">
              &laquo; First
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if terminal_type_filter %}&terminal_type={{ terminal_type_filter }}{% endif %}{% if voltage_class_filter %}&voltage_class={{ voltage_class_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}">
              Previous
            </a>
          </li>
        {% endif %}

        <li class="page-item active">
          <span class="page-link">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if terminal_type_filter %}&terminal_type={{ terminal_type_filter }}{% endif %}{% if voltage_class_filter %}&voltage_class={{ voltage_class_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}">
              Next
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if terminal_type_filter %}&terminal_type={{ terminal_type_filter }}{% endif %}{% if voltage_class_filter %}&voltage_class={{ voltage_class_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}">
              Last &raquo;
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
{% endblock %}