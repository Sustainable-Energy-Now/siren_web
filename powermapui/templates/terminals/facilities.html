<!-- terminals/facilities.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3>Connected Facilities</h3>
      <small class="text-muted">{{ terminal.terminal_name }}</small>
    </div>
    <div>
      <a href="{% url 'powermapui:terminal_connections' terminal.pk %}" class="btn btn-primary">Manage Connections</a>
      <a href="{% url 'powermapui:terminal_detail' terminal.pk %}" class="btn btn-outline-secondary">Back to Terminal</a>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h4 class="text-primary">{{ total_facilities }}</h4>
          <small class="text-muted">Total Facilities</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h4 class="text-success">{{ total_capacity|floatformat:1 }} MW</h4>
          <small class="text-muted">Total Capacity</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h4 class="text-info">{{ connected_lines_count }}</h4>
          <small class="text-muted">Grid Lines</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h4 class="text-warning">{{ terminal.primary_voltage_kv }} kV</h4>
          <small class="text-muted">Terminal Voltage</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Facilities Table -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Facility Details</h5>
    </div>
    <div class="card-body">
      {% if page_obj %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Facility Name</th>
                <th>Technology</th>
                <th>Zone</th>
                <th>Capacity (MW)</th>
                <th>Direction</th>
                <th>Via Grid Line</th>
                <th>Connection</th>
                <th>Distance (km)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for item in page_obj %}
                <tr>
                  <td>
                    <a href="{% url 'powermapui:facility_detail' item.facility.pk %}" class="text-decoration-none">
                      {{ item.facility.facility_name }}
                    </a>
                  </td>
                  <td>
                    {% if item.facility.idtechnologies %}
                      <span class="badge bg-secondary">{{ item.facility.idtechnologies.technology_name }}</span>
                    {% else %}
                      <span class="badge bg-light text-dark">N/A</span>
                    {% endif %}
                  </td>
                  <td>{{ item.facility.idzones.name|default:"-" }}</td>
                  <td>
                    <strong>{{ item.capacity|floatformat:1 }}</strong>
                    {% if item.connection_capacity %}
                      <br><small class="text-muted">Conn: {{ item.connection_capacity|floatformat:1 }} MW</small>
                    {% endif %}
                  </td>
                  <td>
                    {% if item.direction == "Outgoing" %}
                      <span class="badge bg-success">
                        <i class="bi bi-arrow-right"></i> Outgoing
                      </span>
                    {% elif item.direction == "Incoming" %}
                      <span class="badge bg-info">
                        <i class="bi bi-arrow-left"></i> Incoming
                      </span>
                    {% else %}
                      <span class="badge bg-secondary">Unknown</span>
                    {% endif %}
                  </td>
                  <td>
                    <a href="{% url 'powermapui:gridline_detail' item.grid_line.pk %}" class="text-decoration-none">
                      {{ item.grid_line.line_name }}
                    </a>
                    <br>
                    <small class="text-muted">{{ item.grid_line.voltage_level }} kV</small>
                  </td>
                  <td>
                    <span class="badge {% if item.is_primary %}bg-success{% else %}bg-secondary{% endif %}">
                      {{ item.connection.get_connection_type_display }}
                    </span>
                    {% if item.is_primary %}
                      <br><small class="text-success">Primary</small>
                    {% endif %}
                  </td>
                  <td>{{ item.distance|floatformat:2|default:"-" }}</td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="{% url 'powermapui:facility_detail' item.facility.pk %}" 
                         class="btn btn-outline-primary" 
                         title="View Facility">
                        <i class="bi bi-eye"></i>
                      </a>
                      <a href="{% url 'powermapui:gridline_detail' item.grid_line.pk %}" 
                         class="btn btn-outline-info" 
                         title="View Grid Line">
                        <i class="bi bi-diagram-3"></i>
                      </a>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
          <nav aria-label="Facilities pagination" class="mt-3">
            <ul class="pagination justify-content-center">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1">&laquo; First</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
              {% endif %}

              <li class="page-item active">
                <span class="page-link">
                  Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>
              </li>

              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        {% endif %}
      {% else %}
        <div class="text-center text-muted py-5">
          <i class="bi bi-inbox" style="font-size: 3rem;"></i>
          <h5 class="mt-3">No Facilities Connected</h5>
          <p>This terminal does not have any facilities connected through its grid lines.</p>
          <a href="{% url 'powermapui:terminal_connections' terminal.pk %}" class="btn btn-primary">
            Manage Connections
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Technology Breakdown -->
  {% if page_obj %}
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Connection Type Distribution</h6>
          </div>
          <div class="card-body">
            {% with primary_count=0 secondary_count=0 %}
              {% for item in page_obj.object_list %}
                {% if item.is_primary %}
                  {% with primary_count=primary_count|add:1 %}{% endwith %}
                {% else %}
                  {% with secondary_count=secondary_count|add:1 %}{% endwith %}
                {% endif %}
              {% endfor %}
              <div class="mb-2">
                <div class="d-flex justify-content-between">
                  <span>Primary Connections</span>
                  <span class="text-success fw-bold">{{ page_obj.object_list|length }}</span>
                </div>
              </div>
            {% endwith %}
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Direction Distribution</h6>
          </div>
          <div class="card-body">
            {% with outgoing=0 incoming=0 %}
              {% for item in page_obj.object_list %}
                {% if item.direction == "Outgoing" %}
                  {% with outgoing=outgoing|add:1 %}{% endwith %}
                {% elif item.direction == "Incoming" %}
                  {% with incoming=incoming|add:1 %}{% endwith %}
                {% endif %}
              {% endfor %}
              <div class="mb-2">
                <div class="d-flex justify-content-between">
                  <span><i class="bi bi-arrow-right text-success"></i> Outgoing</span>
                  <span class="fw-bold">{{ outgoing }}</span>
                </div>
              </div>
              <div class="mb-2">
                <div class="d-flex justify-content-between">
                  <span><i class="bi bi-arrow-left text-info"></i> Incoming</span>
                  <span class="fw-bold">{{ incoming }}</span>
                </div>
              </div>
            {% endwith %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}