<!-- storage/list.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Storage Technologies</h3>
    <a href="{% url 'powermapui:storage_create' %}" class="btn btn-primary">Add New Storage Technology</a>
  </div>

  <p>
    This displays all battery and storage technologies in the system. Use the search and filters below to find specific storage types.
    Each storage technology can be configured with capacity, efficiency, and operational characteristics.
  </p>

  <!-- Search and Filter Form -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-5">
          <label for="search" class="form-label">Search:</label>
          <input type="text" name="search" id="search" class="form-control" 
                 value="{{ search_query }}" placeholder="Search by name or signature">
        </div>
        <div class="col-md-4">
          <label for="technology" class="form-label">Technology:</label>
          <select name="technology" id="technology" class="form-select">
            <option value="">All Technologies</option>
            {% for tech_name in technology_names %}
              <option value="{{ tech_name }}" 
                      {% if technology_filter == tech_name %}selected{% endif %}>
                {{ tech_name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">Filter</button>
          <a href="{% url 'powermapui:storage_list' %}" class="btn btn-outline-secondary">Clear</a>
        </div>
      </form>
      <div class="mt-2 text-end">
        <small class="text-muted">{{ total_count }} technolog{{ total_count|pluralize:"y,ies" }}</small>
      </div>
    </div>
  </div>

  <!-- Results Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Technology Name</th>
          <th>Signature</th>
          <th>Power (MW)</th>
          <th>Energy (MWh)</th>
          <th>Duration (hrs)</th>
          <th>RTE (%)</th>
          <th>Cycle Life</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for tech in page_obj %}
          {% with storage_attrs=tech.storageattributes_set.first %}
          <tr>
            <td>
              <a href="{% url 'powermapui:storage_detail' tech.pk %}" class="text-decoration-none">
                <strong>{{ tech.technology_name }}</strong>
              </a>
            </td>
            <td><code>{{ tech.technology_signature }}</code></td>
            <td>
              {% if storage_attrs.power_capacity %}
                {{ storage_attrs.power_capacity|floatformat:1 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if storage_attrs.energy_capacity %}
                {{ storage_attrs.energy_capacity|floatformat:1 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if storage_attrs.duration %}
                {{ storage_attrs.duration|floatformat:1 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if storage_attrs.round_trip_efficiency %}
                {{ storage_attrs.round_trip_efficiency|floatformat:1 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if storage_attrs.cycle_life %}
                {{ storage_attrs.cycle_life|floatformat:0 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a href="{% url 'powermapui:storage_detail' tech.pk %}" 
                   class="btn btn-outline-primary" title="View Details">
                  View
                </a>
                <a href="{% url 'powermapui:storage_edit' tech.pk %}" 
                   class="btn btn-outline-warning" title="Edit">
                  Edit
                </a>
              </div>
            </td>
          </tr>
          {% endwith %}
        {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              No storage technologies found.
              {% if search_query or technology_filter %}
                <a href="{% url 'powermapui:storage_list' %}" class="btn btn-link">Clear filters</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
    <nav aria-label="Storage technologies pagination">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if technology_filter %}&technology={{ technology_filter }}{% endif %}">
              &laquo; First
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if technology_filter %}&technology={{ technology_filter }}{% endif %}">
              Previous
            </a>
          </li>
        {% endif %}

        <li class="page-item active">
          <span class="page-link">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if technology_filter %}&technology={{ technology_filter }}{% endif %}">
              Next
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if technology_filter %}&technology={{ technology_filter }}{% endif %}">
              Last &raquo;
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

  <!-- Storage Type Legend -->
  <div class="card mt-4">
    <div class="card-header">
      <h6 class="mb-0">Storage Type Reference</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <h6><span class="badge bg-primary">Battery</span> Battery Energy Storage System</h6>
          <ul class="small">
            <li>Lithium-ion batteries</li>
            <li>Fast response time</li>
            <li>1-8 hour durations</li>
            <li>High round-trip efficiency (85-90%)</li>
          </ul>
        </div>
        <div class="col-md-4">
          <h6><span class="badge bg-info">PHES</span> Pumped Hydro Storage</h6>
          <ul class="small">
            <li>Large-scale storage</li>
            <li>Long duration (4-24+ hours)</li>
            <li>Lower round-trip efficiency (70-80%)</li>
            <li>Long operational life</li>
          </ul>
        </div>
        <div class="col-md-4">
          <h6><span class="badge bg-success">FLOW</span> Flow Battery</h6>
          <ul class="small">
            <li>Scalable duration</li>
            <li>Decoupled power/energy</li>
            <li>Moderate efficiency (65-75%)</li>
            <li>Long cycle life (10,000+ cycles)</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
{% endblock %}