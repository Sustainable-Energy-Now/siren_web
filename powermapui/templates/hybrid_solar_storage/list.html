<!-- hybrid_solar_storage/list.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Hybrid Solar+Storage Configurations</h3>
  </div>

  <div class="alert alert-info">
    <strong>About Hybrid Systems:</strong> Modern solar farms are increasingly paired with battery storage in hybrid configurations.
    These systems can be DC-coupled (sharing inverters) or AC-coupled (separate inverters), making them semi-dispatchable
    rather than purely variable generation. To create a new hybrid configuration, navigate to the facility detail page and
    click "Add Hybrid System".
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h6 class="card-title">Total Configurations</h6>
          <h3 class="mb-0">{{ total_count }}</h3>
          <small>DC-coupled: {{ dc_coupled_count }} | AC-coupled: {{ ac_coupled_count }}</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-dark">
        <div class="card-body">
          <h6 class="card-title">Combined Solar Capacity</h6>
          <h3 class="mb-0">{{ total_solar_dc|floatformat:1 }} MW</h3>
          <small>DC Nameplate</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h6 class="card-title">Combined Storage Power</h6>
          <h3 class="mb-0">{{ total_storage_power|floatformat:1 }} MW</h3>
          <small>Charge/Discharge Rate</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <h6 class="card-title">Combined Storage Energy</h6>
          <h3 class="mb-0">{{ total_storage_energy|floatformat:1 }} MWh</h3>
          <small>Total Capacity</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter Form -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-3">
          <label for="search" class="form-label">Search:</label>
          <input type="text" name="search" id="search" class="form-control" 
                 value="{{ search_query }}" placeholder="Search configurations">
        </div>
        <div class="col-md-3">
          <label for="facility" class="form-label">Facility:</label>
          <select name="facility" id="facility" class="form-select">
            <option value="">All Facilities</option>
            {% for fac in facilities_list %}
              <option value="{{ fac }}" 
                      {% if facility_filter == fac %}selected{% endif %}>
                {{ fac }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="coupling" class="form-label">Coupling Type:</label>
          <select name="coupling" id="coupling" class="form-select">
            <option value="">All Types</option>
            <option value="dc_coupled" {% if coupling_filter == 'dc_coupled' %}selected{% endif %}>DC-Coupled</option>
            <option value="ac_coupled" {% if coupling_filter == 'ac_coupled' %}selected{% endif %}>AC-Coupled</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="active_only" id="active_only"
                   {% if active_only %}checked{% endif %}>
            <label class="form-check-label" for="active_only">
              Active only
            </label>
          </div>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary me-2">Filter</button>
          <a href="{% url 'powermapui:hybrid_list' %}" class="btn btn-outline-secondary">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Results Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Facility</th>
          <th>Configuration</th>
          <th>Coupling</th>
          <th>Solar (MW DC)</th>
          <th>Storage (MW/MWh)</th>
          <th>Grid POI (MW)</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for hybrid in page_obj %}
          <tr class="{% if not hybrid.is_active %}table-secondary{% endif %}">
            <td>
              <a href="{% url 'powermapui:facility_detail' hybrid.facility.idfacilities %}" class="text-decoration-none">
                {{ hybrid.facility.facility_name }}
              </a>
            </td>
            <td>
              <a href="{% url 'powermapui:hybrid_detail' hybrid.pk %}" class="text-decoration-none">
                {% if hybrid.configuration_name %}
                  {{ hybrid.configuration_name }}
                {% else %}
                  <em class="text-muted">Unnamed</em>
                {% endif %}
              </a>
            </td>
            <td>
              {% if hybrid.is_dc_coupled %}
                <span class="badge bg-primary">DC-Coupled</span>
              {% else %}
                <span class="badge bg-secondary">AC-Coupled</span>
              {% endif %}
            </td>
            <td>
              {{ hybrid.total_solar_capacity_dc|floatformat:1 }}
            </td>
            <td>
              {{ hybrid.total_storage_power|floatformat:1 }} / 
              {{ hybrid.total_storage_energy|floatformat:1 }}
              <br><small class="text-muted">{{ hybrid.storage_duration|floatformat:1 }}h</small>
            </td>
            <td>
              {% if hybrid.grid_connection_capacity %}
                {{ hybrid.grid_connection_capacity|floatformat:1 }}
              {% else %}
                <span class="text-muted">Not specified</span>
              {% endif %}
            </td>
            <td>
              {% if hybrid.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Inactive</span>
              {% endif %}
              {% if hybrid.charge_from_solar_only %}
                <br><small class="text-info">Solar-only charging</small>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a href="{% url 'powermapui:hybrid_detail' hybrid.pk %}" 
                   class="btn btn-outline-primary" title="View Details">
                  View
                </a>
                <a href="{% url 'powermapui:hybrid_edit' hybrid.pk %}" 
                   class="btn btn-outline-warning" title="Edit">
                  Edit
                </a>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              No hybrid configurations found.
              {% if search_query or facility_filter or coupling_filter %}
                <a href="{% url 'powermapui:hybrid_list' %}" class="btn btn-link">Clear filters</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
    <nav aria-label="Hybrid configurations pagination">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if facility_filter %}&facility={{ facility_filter }}{% endif %}{% if coupling_filter %}&coupling={{ coupling_filter }}{% endif %}{% if active_only %}&active_only=on{% endif %}">
              &laquo; First
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if facility_filter %}&facility={{ facility_filter }}{% endif %}{% if coupling_filter %}&coupling={{ coupling_filter }}{% endif %}{% if active_only %}&active_only=on{% endif %}">
              Previous
            </a>
          </li>
        {% endif %}

        <li class="page-item active">
          <span class="page-link">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if facility_filter %}&facility={{ facility_filter }}{% endif %}{% if coupling_filter %}&coupling={{ coupling_filter }}{% endif %}{% if active_only %}&active_only=on{% endif %}">
              Next
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if facility_filter %}&facility={{ facility_filter }}{% endif %}{% if coupling_filter %}&coupling={{ coupling_filter }}{% endif %}{% if active_only %}&active_only=on{% endif %}">
              Last &raquo;
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

  <!-- Additional Actions -->
  <div class="mt-4">
    <a href="{% url 'powermapui:facility_solar_list' %}" class="btn btn-outline-secondary">
      View Solar Installations
    </a>
    <a href="{% url 'powermapui:facility_storage_list' %}" class="btn btn-outline-secondary">
      View Storage Installations
    </a>
  </div>
{% endblock %}
