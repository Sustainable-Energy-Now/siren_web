<!-- hybrid_solar_storage/detail.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3>Hybrid Solar+Storage Configuration</h3>
      <small class="text-muted">
        {{ hybrid.facility.facility_name }}
        {% if hybrid.configuration_name %}
          - {{ hybrid.configuration_name }}
        {% endif %}
      </small>
    </div>
    <div>
      <a href="{% url 'powermapui:hybrid_edit' hybrid.pk %}" class="btn btn-warning">Edit Configuration</a>
      <a href="{% url 'powermapui:hybrid_list' %}" class="btn btn-outline-secondary">Back to List</a>
    </div>
  </div>

  <!-- Status Alert -->
  {% if not hybrid.is_active %}
    <div class="alert alert-warning">
      <strong>Inactive Configuration:</strong> This hybrid configuration is currently deactivated and will not be included in simulations.
    </div>
  {% endif %}

  <!-- Configuration Summary -->
  <div class="alert alert-info">
    <strong>Configuration Summary:</strong> {{ derived_values.configuration_summary }}
    <br>
    <strong>Classification:</strong> <span class="badge bg-success">Semi-Dispatchable</span> 
    (battery enables time-shifting of solar generation)
  </div>

  <div class="row">
    <!-- Configuration Information -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Configuration Information</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="40%">Facility:</th>
              <td>
                <a href="{% url 'powermapui:facility_detail' hybrid.facility.idfacilities %}">
                  {{ hybrid.facility.facility_name }}
                </a>
              </td>
            </tr>
            <tr>
              <th>Configuration Name:</th>
              <td>
                {% if hybrid.configuration_name %}
                  {{ hybrid.configuration_name }}
                {% else %}
                  <em class="text-muted">Unnamed</em>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Coupling Type:</th>
              <td>
                {% if hybrid.is_dc_coupled %}
                  <span class="badge bg-primary">DC-Coupled</span>
                  <small class="text-muted">Shared inverter(s)</small>
                {% else %}
                  <span class="badge bg-secondary">AC-Coupled</span>
                  <small class="text-muted">Separate inverters</small>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Grid Connection:</th>
              <td>
                {% if hybrid.shared_grid_connection %}
                  <span class="badge bg-success">Shared</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Separate</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Status:</th>
              <td>
                {% if hybrid.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Commissioning Date:</th>
              <td>
                {% if hybrid.commissioning_date %}
                  {{ hybrid.commissioning_date|date:"F j, Y" }}
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Created:</th>
              <td>{{ hybrid.created_at|date:"Y-m-d H:i" }}</td>
            </tr>
            <tr>
              <th>Last Updated:</th>
              <td>{{ hybrid.updated_at|date:"Y-m-d H:i" }}</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Capacity Overview -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Capacity Overview</h5>
        </div>
        <div class="card-body">
          <h6>Solar Component</h6>
          <table class="table table-sm">
            <tr>
              <th width="50%">DC Capacity:</th>
              <td><strong>{{ hybrid.total_solar_capacity_dc|floatformat:1 }} MW</strong></td>
            </tr>
            <tr>
              <th>AC Capacity:</th>
              <td><strong>{{ hybrid.total_solar_capacity_ac|floatformat:1 }} MW</strong></td>
            </tr>
          </table>

          <h6 class="mt-3">Storage Component</h6>
          <table class="table table-sm">
            <tr>
              <th width="50%">Power Capacity:</th>
              <td><strong>{{ hybrid.total_storage_power|floatformat:1 }} MW</strong></td>
            </tr>
            <tr>
              <th>Energy Capacity:</th>
              <td><strong>{{ hybrid.total_storage_energy|floatformat:1 }} MWh</strong></td>
            </tr>
            <tr>
              <th>Duration:</th>
              <td><strong>{{ hybrid.storage_duration|floatformat:1 }} hours</strong></td>
            </tr>
          </table>

          <h6 class="mt-3">Grid Connection</h6>
          <table class="table table-sm mb-0">
            {% if hybrid.is_dc_coupled and hybrid.shared_inverter_capacity %}
              <tr>
                <th width="50%">Shared Inverter:</th>
                <td><strong>{{ hybrid.shared_inverter_capacity|floatformat:1 }} MW</strong></td>
              </tr>
            {% endif %}
            <tr>
              <th width="50%">POI Capacity:</th>
              <td>
                {% if hybrid.grid_connection_capacity %}
                  <strong>{{ hybrid.grid_connection_capacity|floatformat:1 }} MW</strong>
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Effective AC Capacity:</th>
              <td>
                {% if derived_values.effective_ac_capacity %}
                  <strong>{{ derived_values.effective_ac_capacity|floatformat:1 }} MW</strong>
                {% else %}
                  <span class="text-muted">Not available</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Key Metrics -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Key Metrics</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="50%">Solar-to-Storage Ratio:</th>
              <td>
                {% if derived_values.solar_to_storage_ratio %}
                  <strong>{{ derived_values.solar_to_storage_ratio|floatformat:2 }}</strong>
                  {% if derived_values.solar_to_storage_ratio > 3 %}
                    <small class="text-muted">(Solar-dominant)</small>
                  {% elif derived_values.solar_to_storage_ratio > 1.5 %}
                    <small class="text-success">(Balanced)</small>
                  {% else %}
                    <small class="text-info">(Storage-dominant)</small>
                  {% endif %}
                {% else %}
                  <span class="text-muted">Not available</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Storage-to-Solar Duration:</th>
              <td>
                {% if derived_values.storage_to_solar_duration %}
                  <strong>{{ derived_values.storage_to_solar_duration|floatformat:1 }} hours</strong>
                  <br><small class="text-muted">Can store {{ derived_values.storage_to_solar_duration|floatformat:1 }}h of solar output</small>
                {% else %}
                  <span class="text-muted">Not available</span>
                {% endif %}
              </td>
            </tr>
            {% if derived_values.poi_utilization_solar %}
              <tr>
                <th>POI Utilization (Solar):</th>
                <td>
                  <strong>{{ derived_values.poi_utilization_solar|floatformat:1 }}%</strong>
                  {% if derived_values.poi_utilization_solar > 90 %}
                    <small class="text-warning">(High)</small>
                  {% endif %}
                </td>
              </tr>
            {% endif %}
            {% if derived_values.poi_utilization_combined %}
              <tr>
                <th>POI Utilization (Combined):</th>
                <td>
                  <strong>{{ derived_values.poi_utilization_combined|floatformat:1 }}%</strong>
                  {% if derived_values.poi_utilization_combined > 100 %}
                    <small class="text-danger">(Requires dispatch coordination)</small>
                  {% elif derived_values.poi_utilization_combined > 90 %}
                    <small class="text-warning">(Near capacity)</small>
                  {% else %}
                    <small class="text-success">(Within capacity)</small>
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          </table>

          <div class="alert alert-info mb-0 small">
            <strong>Interpretation:</strong>
            {% if derived_values.solar_to_storage_ratio %}
              This system has {{ derived_values.solar_to_storage_ratio|floatformat:1 }}x more solar capacity than storage power.
              {% if derived_values.storage_to_solar_duration %}
                The battery can store approximately {{ derived_values.storage_to_solar_duration|floatformat:1 }} hours of peak solar output.
              {% endif %}
            {% else %}
              Metrics require both solar and storage capacity data.
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Operational Configuration -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Operational Configuration</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="50%">Dispatch Priority:</th>
              <td>
                <strong>{{ hybrid.get_priority_dispatch_display }}</strong>
                {% if hybrid.priority_dispatch == 'battery_first' %}
                  <br><small class="text-muted">Charge battery first, export excess solar</small>
                {% elif hybrid.priority_dispatch == 'solar_first' %}
                  <br><small class="text-muted">Export solar first, charge from excess</small>
                {% else %}
                  <br><small class="text-muted">Optimize based on market signals</small>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Battery Charging:</th>
              <td>
                {% if hybrid.charge_from_solar_only %}
                  <span class="badge bg-warning text-dark">Solar Only</span>
                  <br><small class="text-muted">Battery charges only from solar (not from grid)</small>
                {% else %}
                  <span class="badge bg-info">Solar + Grid</span>
                  <br><small class="text-muted">Battery can charge from solar or grid</small>
                {% endif %}
              </td>
            </tr>
            {% if hybrid.is_dc_coupled and hybrid.energy_clipping_losses %}
              <tr>
                <th>Energy Clipping Losses:</th>
                <td>
                  <strong>{{ hybrid.energy_clipping_losses|floatformat:1 }}%</strong>
                  <br><small class="text-muted">Due to inverter constraints in DC-coupled system</small>
                </td>
              </tr>
            {% endif %}
          </table>
        </div>
      </div>
    </div>

    <!-- Solar Installation Details -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">Solar Installation</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="40%">Technology:</th>
              <td>{{ hybrid.solar_installation.technology.technology_name }}</td>
            </tr>
            <tr>
              <th>Installation Name:</th>
              <td>
                {% if hybrid.solar_installation.installation_name %}
                  {{ hybrid.solar_installation.installation_name }}
                {% else %}
                  <em class="text-muted">Unnamed</em>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>DC Capacity:</th>
              <td>{{ hybrid.solar_installation.nameplate_capacity|floatformat:1 }} MW</td>
            </tr>
            <tr>
              <th>AC Capacity:</th>
              <td>{{ hybrid.solar_installation.ac_capacity|floatformat:1 }} MW</td>
            </tr>
            {% if hybrid.solar_installation.panel_count %}
              <tr>
                <th>Panel Count:</th>
                <td>{{ hybrid.solar_installation.panel_count|floatformat:0 }}</td>
              </tr>
            {% endif %}
            {% if hybrid.solar_installation.tilt_angle is not None %}
              <tr>
                <th>Tilt Angle:</th>
                <td>{{ hybrid.solar_installation.tilt_angle|floatformat:1 }}°</td>
              </tr>
            {% endif %}
          </table>
          <a href="{% url 'powermapui:facility_solar_detail' hybrid.solar_installation.pk %}" 
             class="btn btn-sm btn-outline-primary">
            View Full Solar Details
          </a>
        </div>
      </div>
    </div>

    <!-- Storage Installation Details -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Storage Installation</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="40%">Technology:</th>
              <td>{{ hybrid.storage_installation.technology.technology_name }}</td>
            </tr>
            <tr>
              <th>Installation Name:</th>
              <td>
                {% if hybrid.storage_installation.installation_name %}
                  {{ hybrid.storage_installation.installation_name }}
                {% else %}
                  <em class="text-muted">Unnamed</em>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Power Capacity:</th>
              <td>{{ hybrid.storage_installation.power_capacity|floatformat:1 }} MW</td>
            </tr>
            <tr>
              <th>Energy Capacity:</th>
              <td>{{ hybrid.storage_installation.energy_capacity|floatformat:1 }} MWh</td>
            </tr>
            <tr>
              <th>Duration:</th>
              <td>{{ hybrid.storage_installation.get_calculated_duration|floatformat:1 }} hours</td>
            </tr>
            {% if hybrid.storage_installation.storage_attrs %}
              <tr>
                <th>Round-Trip Efficiency:</th>
                <td>{{ hybrid.storage_installation.storage_attrs.round_trip_efficiency|floatformat:1 }}%</td>
              </tr>
            {% endif %}
          </table>
          <a href="{% url 'powermapui:facility_storage_detail' hybrid.storage_installation.pk %}" 
             class="btn btn-sm btn-outline-success">
            View Full Storage Details
          </a>
        </div>
      </div>
    </div>

    <!-- System Diagram -->
    <div class="col-lg-12 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">System Diagram</h5>
        </div>
        <div class="card-body">
          {% if hybrid.is_dc_coupled %}
            <!-- DC-Coupled Diagram -->
            <div class="text-center p-4 bg-light rounded">
              <div class="row align-items-center">
                <div class="col-md-3">
                  <div class="border border-warning bg-white p-3 rounded">
                    <i class="fas fa-solar-panel fa-2x text-warning"></i>
                    <h6 class="mt-2">Solar Array</h6>
                    <small>{{ hybrid.total_solar_capacity_dc|floatformat:1 }} MW DC</small>
                  </div>
                </div>
                <div class="col-md-1">
                  <div class="text-center">
                    <span style="font-size: 2em;">─</span>
                    <br><small class="text-muted">DC</small>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="border border-primary bg-white p-3 rounded">
                    <i class="fas fa-microchip fa-2x text-primary"></i>
                    <h6 class="mt-2">Shared Inverter</h6>
                    <small>{{ hybrid.shared_inverter_capacity|default:hybrid.total_solar_capacity_ac|floatformat:1 }} MW AC</small>
                  </div>
                  <div class="mt-2">
                    <small class="text-muted">↑ DC from battery</small>
                  </div>
                </div>
                <div class="col-md-1">
                  <div class="text-center">
                    <span style="font-size: 2em;">─</span>
                    <br><small class="text-muted">AC</small>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="border border-info bg-white p-3 rounded">
                    <i class="fas fa-plug fa-2x text-info"></i>
                    <h6 class="mt-2">Grid POI</h6>
                    <small>{{ hybrid.grid_connection_capacity|default:"N/A"|floatformat:1 }} MW</small>
                  </div>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-3 offset-md-3">
                  <div class="border border-success bg-white p-3 rounded">
                    <i class="fas fa-battery-full fa-2x text-success"></i>
                    <h6 class="mt-2">Battery</h6>
                    <small>{{ hybrid.total_storage_power|floatformat:1 }} MW / {{ hybrid.total_storage_energy|floatformat:1 }} MWh</small>
                  </div>
                </div>
              </div>
              <div class="mt-3 text-muted small">
                <strong>DC-Coupled Configuration:</strong> Solar and battery share inverter(s). Higher efficiency.
              </div>
            </div>
          {% else %}
            <!-- AC-Coupled Diagram -->
            <div class="text-center p-4 bg-light rounded">
              <div class="row align-items-center">
                <div class="col-md-2">
                  <div class="border border-warning bg-white p-3 rounded">
                    <i class="fas fa-solar-panel fa-2x text-warning"></i>
                    <h6 class="mt-2">Solar</h6>
                    <small>{{ hybrid.total_solar_capacity_dc|floatformat:1 }} MW DC</small>
                  </div>
                </div>
                <div class="col-md-1 text-center">→</div>
                <div class="col-md-2">
                  <div class="border border-primary bg-white p-3 rounded">
                    <h6>Solar Inverter</h6>
                    <small>{{ hybrid.total_solar_capacity_ac|floatformat:1 }} MW</small>
                  </div>
                </div>
                <div class="col-md-1 text-center">→</div>
                <div class="col-md-2">
                  <div class="border border-info bg-white p-3 rounded">
                    <i class="fas fa-plug fa-2x text-info"></i>
                    <h6 class="mt-2">Grid POI</h6>
                    <small>{{ hybrid.grid_connection_capacity|default:"N/A"|floatformat:1 }} MW</small>
                  </div>
                </div>
              </div>
              <div class="row mt-3 align-items-center">
                <div class="col-md-2">
                  <div class="border border-success bg-white p-3 rounded">
                    <i class="fas fa-battery-full fa-2x text-success"></i>
                    <h6 class="mt-2">Battery</h6>
                    <small>{{ hybrid.total_storage_power|floatformat:1 }} MW</small>
                  </div>
                </div>
                <div class="col-md-1 text-center">→</div>
                <div class="col-md-2">
                  <div class="border border-primary bg-white p-3 rounded">
                    <h6>Battery Inverter</h6>
                    <small>{{ hybrid.total_storage_power|floatformat:1 }} MW</small>
                  </div>
                </div>
                <div class="col-md-1 text-center">→</div>
                <div class="col-md-2">
                  <div style="height: 2px; background: #6c757d;"></div>
                  <small class="text-muted">↑ To POI</small>
                </div>
              </div>
              <div class="mt-3 text-muted small">
                <strong>AC-Coupled Configuration:</strong> Separate inverters for solar and battery. More flexible.
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Section -->
  {% if hybrid.notes %}
    <div class="row">
      <div class="col-12 mb-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Notes</h5>
          </div>
          <div class="card-body">
            <p class="mb-0">{{ hybrid.notes }}</p>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Action Buttons -->
  <div class="d-flex gap-2 mt-4">
    <a href="{% url 'powermapui:hybrid_edit' hybrid.pk %}" class="btn btn-warning">
      Edit Configuration
    </a>
    <a href="{% url 'powermapui:facility_detail' hybrid.facility.idfacilities %}" class="btn btn-outline-primary">
      View Facility
    </a>
    <a href="{% url 'powermapui:hybrid_list' %}" class="btn btn-outline-secondary">
      Back to List
    </a>
    <form method="post" action="{% url 'powermapui:hybrid_delete' hybrid.pk %}" 
          style="display: inline;" 
          onsubmit="return confirm('Are you sure you want to delete this hybrid configuration? The solar and storage installations will remain but will no longer be linked.');">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">Delete Configuration</button>
    </form>
  </div>
{% endblock %}