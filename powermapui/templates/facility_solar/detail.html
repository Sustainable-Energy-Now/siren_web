<!-- facility_solar/detail.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3>Solar Installation Details</h3>
      <small class="text-muted">
        {{ installation.facility.facility_name }} - {{ installation.technology.technology_name }}
        {% if installation.installation_name %}
          ({{ installation.installation_name }})
        {% endif %}
      </small>
    </div>
    <div>
      <a href="{% url 'powermapui:facilities_list' %}?installation_type=solar" class="btn btn-outline-secondary">Back to List</a>
    </div>
  </div>

  <!-- Status Alert -->
  {% if not installation.is_active %}
    <div class="alert alert-warning">
      <strong>Inactive Installation:</strong> This solar installation is currently deactivated and will not be included in simulations.
    </div>
  {% endif %}

  <div class="row">
    <!-- Installation Information -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Installation Information</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="40%">Facility:</th>
              <td>
                <a href="{% url 'powermapui:facility_detail' installation.facility.idfacilities %}">
                  {{ installation.facility.facility_name }}
                </a>
              </td>
            </tr>
            <tr>
              <th>Solar Technology:</th>
              <td>{{ installation.technology.technology_name }}</td>
            </tr>
            <tr>
              <th>Installation Name:</th>
              <td>
                {% if installation.installation_name %}
                  {{ installation.installation_name }}
                {% else %}
                  <em class="text-muted">Not specified</em>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Status:</th>
              <td>
                {% if installation.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Installation Date:</th>
              <td>
                {% if installation.installation_date %}
                  {{ installation.installation_date|date:"F j, Y" }}
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Commissioning Date:</th>
              <td>
                {% if installation.commissioning_date %}
                  {{ installation.commissioning_date|date:"F j, Y" }}
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Created:</th>
              <td>{{ installation.created_at|date:"Y-m-d H:i" }}</td>
            </tr>
            <tr>
              <th>Last Updated:</th>
              <td>{{ installation.updated_at|date:"Y-m-d H:i" }}</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Capacity Specifications -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">Capacity Specifications</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="40%">DC Nameplate Capacity:</th>
              <td>
                {% if installation.nameplate_capacity %}
                  <strong>{{ installation.nameplate_capacity|floatformat:2 }} MW</strong>
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>AC Capacity:</th>
              <td>
                {% if installation.ac_capacity %}
                  <strong>{{ installation.ac_capacity|floatformat:2 }} MW</strong>
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>DC/AC Ratio:</th>
              <td>
                {% if derived_values.calculated_dc_ac_ratio %}
                  <strong>{{ derived_values.calculated_dc_ac_ratio|floatformat:2 }}</strong>
                  {% if derived_values.calculated_dc_ac_ratio > 1.3 %}
                    <small class="text-warning">(High ratio)</small>
                  {% elif derived_values.calculated_dc_ac_ratio < 1.0 %}
                    <small class="text-info">(Low ratio)</small>
                  {% else %}
                    <small class="text-success">(Typical)</small>
                  {% endif %}
                {% else %}
                  <span class="text-muted">Not available</span>
                {% endif %}
              </td>
            </tr>
          </table>

          <div class="alert alert-info mb-0">
            <small>
              <strong>Capacity Summary:</strong> {{ installation.capacity_summary }}
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel Array Specifications -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Panel Array Specifications</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="40%">Number of Panels:</th>
              <td>
                {% if installation.panel_count %}
                  {{ installation.panel_count|floatformat:0 }}
                {% elif derived_values.calculated_panel_count %}
                  <span class="text-info">~{{ derived_values.calculated_panel_count|floatformat:0 }}</span>
                  <small class="text-muted">(calculated)</small>
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Panel Wattage:</th>
              <td>
                {% if installation.panel_wattage %}
                  {{ installation.panel_wattage|floatformat:0 }} W
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Array Area:</th>
              <td>
                {% if installation.array_area %}
                  {{ installation.array_area|floatformat:0 }} m²
                {% elif derived_values.calculated_array_area %}
                  <span class="text-info">~{{ derived_values.calculated_array_area|floatformat:0 }} m²</span>
                  <small class="text-muted">(estimated)</small>
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Tilt Angle:</th>
              <td>
                {% if installation.tilt_angle is not None %}
                  {{ installation.tilt_angle|floatformat:1 }}°
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Azimuth Angle:</th>
              <td>
                {% if installation.azimuth_angle is not None %}
                  {{ installation.azimuth_angle|floatformat:1 }}°
                  {% if installation.azimuth_angle == 0 %}
                    <small class="text-muted">(North)</small>
                  {% elif installation.azimuth_angle == 90 %}
                    <small class="text-muted">(East)</small>
                  {% elif installation.azimuth_angle == 180 %}
                    <small class="text-muted">(South)</small>
                  {% elif installation.azimuth_angle == 270 %}
                    <small class="text-muted">(West)</small>
                  {% endif %}
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Inverter Specifications -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Inverter Specifications</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th width="40%">Number of Inverters:</th>
              <td>
                {% if installation.inverter_count %}
                  {{ installation.inverter_count }}
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Capacity per Inverter:</th>
              <td>
                {% if installation.inverter_capacity_each %}
                  {{ installation.inverter_capacity_each|floatformat:1 }} kW
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Total Inverter Capacity:</th>
              <td>
                {% if derived_values.total_inverter_capacity %}
                  <strong>{{ derived_values.total_inverter_capacity|floatformat:2 }} MW</strong>
                  {% if installation.ac_capacity %}
                    {% if derived_values.total_inverter_capacity == installation.ac_capacity %}
                      <small class="text-success">(Matches AC capacity)</small>
                    {% else %}
                      <small class="text-warning">(Differs from AC capacity)</small>
                    {% endif %}
                  {% endif %}
                {% else %}
                  <span class="text-muted">Not available</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Technology Characteristics -->
    <div class="col-lg-12 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Technology Characteristics</h5>
        </div>
        <div class="card-body">
          {% if solar_attrs %}
            <div class="row">
              <div class="col-md-4">
                <h6>Panel Specifications</h6>
                <table class="table table-sm">
                  <tr>
                    <th width="60%">Panel Technology:</th>
                    <td>
                      {% if solar_attrs.panel_technology %}
                        {{ solar_attrs.get_panel_technology_display }}
                      {% else %}
                        <span class="text-muted">Not specified</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Module Efficiency:</th>
                    <td>
                      {% if solar_attrs.module_efficiency %}
                        {{ solar_attrs.module_efficiency|floatformat:1 }}%
                      {% else %}
                        <span class="text-muted">Not specified</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Temperature Coefficient:</th>
                    <td>
                      {% if solar_attrs.temperature_coefficient %}
                        {{ solar_attrs.temperature_coefficient|floatformat:2 }}%/°C
                      {% else %}
                        <span class="text-muted">Not specified</span>
                      {% endif %}
                    </td>
                  </tr>
                </table>
              </div>

              <div class="col-md-4">
                <h6>System Performance</h6>
                <table class="table table-sm">
                  <tr>
                    <th width="60%">Performance Ratio:</th>
                    <td>
                      {% if solar_attrs.performance_ratio %}
                        {{ solar_attrs.performance_ratio|floatformat:1 }}%
                      {% else %}
                        <span class="text-muted">Not specified</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Inverter Efficiency:</th>
                    <td>
                      {% if solar_attrs.inverter_efficiency %}
                        {{ solar_attrs.inverter_efficiency|floatformat:1 }}%
                      {% else %}
                        <span class="text-muted">Not specified</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>System Loss Factor:</th>
                    <td>
                      {% if solar_attrs.system_loss_factor %}
                        {{ solar_attrs.system_loss_factor|floatformat:1 }}%
                      {% else %}
                        <span class="text-muted">Not specified</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>DC/AC Ratio (typical):</th>
                    <td>
                      {% if solar_attrs.dc_ac_ratio %}
                        {{ solar_attrs.dc_ac_ratio|floatformat:2 }}
                      {% else %}
                        <span class="text-muted">Not specified</span>
                      {% endif %}
                    </td>
                  </tr>
                </table>
              </div>

              <div class="col-md-4">
                <h6>Degradation & Tracking</h6>
                <table class="table table-sm">
                  <tr>
                    <th width="60%">Tracking Type:</th>
                    <td>
                      {% if solar_attrs.tracking_type %}
                        {{ solar_attrs.get_tracking_type_display }}
                      {% else %}
                        <span class="text-muted">Fixed Tilt</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Degradation Rate:</th>
                    <td>
                      {% if solar_attrs.degradation_rate %}
                        {{ solar_attrs.degradation_rate|floatformat:2 }}%/year
                      {% else %}
                        <span class="text-muted">Not specified</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <th>Warranty Period:</th>
                    <td>
                      {% if solar_attrs.warranty_years %}
                        {{ solar_attrs.warranty_years }} years
                      {% else %}
                        <span class="text-muted">Not specified</span>
                      {% endif %}
                    </td>
                  </tr>
                </table>
              </div>
            </div>
          {% else %}
            <p class="text-muted">No technology characteristics defined.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Section -->
  {% if installation.notes %}
    <div class="row">
      <div class="col-12 mb-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Notes</h5>
          </div>
          <div class="card-body">
            <p class="mb-0">{{ installation.notes }}</p>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Action Buttons -->
  <div class="d-flex gap-2 mt-4">
    <a href="{% url 'powermapui:facility_solar_edit' installation.pk %}" class="btn btn-warning">
      Edit Installation
    </a>
    <a href="{% url 'powermapui:facilities_list' %}?installation_type=solar" class="btn btn-outline-secondary">
      Back to List
    </a>
    <form method="post" action="{% url 'powermapui:facility_solar_delete' installation.pk %}" 
          style="display: inline;" 
          onsubmit="return confirm('Are you sure you want to delete this solar installation?');">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">Delete Installation</button>
    </form>
  </div>
{% endblock %}
