<!-- powermapui/templates/network_overview.html -->
{% extends 'powermapui_base.html' %}
{% load static %}
{% block powermapui_content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3>Infrastructure Dependency Network</h3>
    <small class="text-muted">Full network topology with pipeline status and bottleneck detection</small>
  </div>
  <div>
    <button class="btn btn-sm btn-secondary" onclick="networkDiagram && networkDiagram.resetHighlight()">Reset View</button>
    <button class="btn btn-sm btn-info" onclick="downloadSVG()">Download SVG</button>
    <a href="{% url 'powermapui:pipeline_map' %}" class="btn btn-sm btn-outline-primary">Pipeline Map</a>
    <a href="{% url 'powermapui:map' %}" class="btn btn-sm btn-outline-secondary">Grid Map</a>
  </div>
</div>

<!-- Scenario Selector -->
<div class="mb-3">
  <form method="post" class="d-flex align-items-end gap-2">
    {% csrf_token %}
    {{ demand_weather_scenario.demand_year.label_tag }}
    {{ demand_weather_scenario.demand_year }}
    {{ demand_weather_scenario.scenario.label_tag }}
    {{ demand_weather_scenario.scenario }}
    <button name="apply_settings" type="submit" class="btn btn-primary btn-sm">Apply</button>
  </form>
</div>

{% if success_message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ success_message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
  <div class="col-lg-9">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Network Visualization</h5>
      </div>
      <div class="card-body p-0">
        <div id="network-diagram" style="width:100%; height:700px; background-color:#f8f9fa;">
          <div class="d-flex align-items-center justify-content-center h-100" id="loading-indicator">
            <div class="text-center text-muted">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3">Loading network diagram...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="card mt-3">
      <div class="card-header"><h6 class="mb-0">Legend</h6></div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <h6 class="small fw-bold">Facility Status (Color)</h6>
            <div class="d-flex align-items-center mb-1">
              <div style="width:14px;height:14px;background:#9e9e9e;border-radius:50%;margin-right:8px;"></div>
              <span class="small">Proposed</span>
            </div>
            <div class="d-flex align-items-center mb-1">
              <div style="width:14px;height:14px;background:#2196f3;border-radius:50%;margin-right:8px;"></div>
              <span class="small">Planned</span>
            </div>
            <div class="d-flex align-items-center mb-1">
              <div style="width:14px;height:14px;background:#ff9800;border-radius:50%;margin-right:8px;"></div>
              <span class="small">Under Construction</span>
            </div>
            <div class="d-flex align-items-center mb-1">
              <div style="width:14px;height:14px;background:#4caf50;border-radius:50%;margin-right:8px;"></div>
              <span class="small">Commissioned</span>
            </div>
            <div class="d-flex align-items-center mb-1">
              <div style="width:14px;height:14px;background:#f44336;border-radius:50%;margin-right:8px;"></div>
              <span class="small">Decommissioned</span>
            </div>
            <hr class="my-2">
            <small class="text-muted">Opacity = commissioning probability</small><br>
            <small class="text-muted">Size = capacity (MW)</small>
          </div>
          <div class="col-md-4">
            <h6 class="small fw-bold">Terminals</h6>
            <div class="d-flex align-items-center mb-1">
              <div style="width:20px;height:20px;background:#495057;border-radius:50%;border:2px solid #fff;margin-right:8px;"></div>
              <span class="small">Normal Terminal</span>
            </div>
            <div class="d-flex align-items-center mb-1">
              <div style="width:20px;height:20px;background:#495057;border-radius:50%;border:4px solid #f44336;margin-right:8px;"></div>
              <span class="small">Bottleneck (overloaded)</span>
            </div>
            <hr class="my-2">
            <small class="text-muted">Terminal size = transformer capacity (MVA)</small>
          </div>
          <div class="col-md-4">
            <h6 class="small fw-bold">Grid Lines</h6>
            <div class="d-flex align-items-center mb-2">
              <svg width="40" height="10"><line x1="0" y1="5" x2="40" y2="5" stroke="#198754" stroke-width="4"/></svg>
              <span class="small ms-2">Transmission</span>
            </div>
            <div class="d-flex align-items-center mb-2">
              <svg width="40" height="10"><line x1="0" y1="5" x2="40" y2="5" stroke="#17a2b8" stroke-width="2.5"/></svg>
              <span class="small ms-2">Sub-transmission</span>
            </div>
            <div class="d-flex align-items-center mb-2">
              <svg width="40" height="10"><line x1="0" y1="5" x2="40" y2="5" stroke="#6c757d" stroke-width="1.5"/></svg>
              <span class="small ms-2">Distribution</span>
            </div>
            <hr class="my-2">
            <h6 class="small fw-bold">Interactions</h6>
            <ul class="small list-unstyled mb-0" style="line-height:1.8;">
              <li>Drag nodes to reposition</li>
              <li>Scroll to zoom</li>
              <li>Click node for details</li>
              <li>Escape to reset</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3">
    <!-- Network Statistics -->
    <div class="card mb-3">
      <div class="card-header"><h6 class="mb-0">Network Statistics</h6></div>
      <div class="card-body">
        <div class="row text-center mb-2">
          <div class="col-6">
            <h4 class="text-primary mb-0">{{ terminal_count }}</h4>
            <small class="text-muted">Terminals</small>
          </div>
          <div class="col-6">
            <h4 class="text-warning mb-0">{{ facility_count }}</h4>
            <small class="text-muted">Facilities</small>
          </div>
        </div>
        <div class="row text-center mb-2">
          <div class="col-6">
            <h4 class="text-success mb-0">{{ link_count }}</h4>
            <small class="text-muted">Connections</small>
          </div>
          <div class="col-6">
            <h4 class="mb-0 {% if bottleneck_count > 0 %}text-danger{% else %}text-muted{% endif %}">{{ bottleneck_count }}</h4>
            <small class="text-muted">Bottlenecks</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Summary -->
    <div class="card mb-3">
      <div class="card-header"><h6 class="mb-0">Pipeline Summary</h6></div>
      <div class="card-body p-2">
        <table class="table table-sm table-borderless mb-0" id="status-summary-table">
          <thead><tr><th>Status</th><th class="text-end">Count</th><th class="text-end">MW</th></tr></thead>
          <tbody id="status-summary-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Bottleneck Warnings -->
    {% if bottlenecks %}
    <div class="card mb-3 border-danger">
      <div class="card-header bg-danger text-white"><h6 class="mb-0">Bottleneck Warnings</h6></div>
      <div class="card-body p-2">
        {% for b in bottlenecks %}
        <div class="small mb-2 p-2 bg-light rounded">
          <strong>{{ b.terminal_name }}</strong><br>
          Transformer: {{ b.transformer_capacity_mva }} MVA<br>
          Connected: {{ b.connected_capacity_mw|floatformat:0 }} MW<br>
          <span class="text-danger">Overload: +{{ b.overload_mw|floatformat:0 }} MW</span>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Status Filter -->
    <div class="card mb-3">
      <div class="card-header"><h6 class="mb-0">Filter by Status</h6></div>
      <div class="card-body">
        <div class="form-check">
          <input class="form-check-input network-status-filter" type="checkbox" value="proposed" id="net-filter-proposed" checked>
          <label class="form-check-label small" for="net-filter-proposed">
            <span style="color:#9e9e9e;">&#9679;</span> Proposed
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input network-status-filter" type="checkbox" value="planned" id="net-filter-planned" checked>
          <label class="form-check-label small" for="net-filter-planned">
            <span style="color:#2196f3;">&#9679;</span> Planned
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input network-status-filter" type="checkbox" value="under_construction" id="net-filter-under_construction" checked>
          <label class="form-check-label small" for="net-filter-under_construction">
            <span style="color:#ff9800;">&#9679;</span> Under Construction
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input network-status-filter" type="checkbox" value="commissioned" id="net-filter-commissioned" checked>
          <label class="form-check-label small" for="net-filter-commissioned">
            <span style="color:#4caf50;">&#9679;</span> Commissioned
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input network-status-filter" type="checkbox" value="decommissioned" id="net-filter-decommissioned" checked>
          <label class="form-check-label small" for="net-filter-decommissioned">
            <span style="color:#f44336;">&#9679;</span> Decommissioned
          </label>
        </div>
      </div>
    </div>

    <!-- Selected Node Details -->
    <div class="card">
      <div class="card-header"><h6 class="mb-0">Selected Node</h6></div>
      <div class="card-body" id="node-details">
        <p class="text-muted text-center small">Click a node to view details</p>
      </div>
    </div>
  </div>
</div>

<!-- Data -->
<script type="application/json" id="network-data">{{ network_data_json|safe }}</script>
<script type="application/json" id="status-summary-data">{{ status_summary_json|safe }}</script>

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Network Overview Class -->
<script src="{% static 'js/network_overview.js' %}"></script>

<script>
let networkDiagram;

const statusLabels = {
    proposed: 'Proposed',
    planned: 'Planned',
    under_construction: 'Under Construction',
    commissioned: 'Commissioned',
    decommissioned: 'Decommissioned'
};

const statusColors = {
    proposed: '#9e9e9e',
    planned: '#2196f3',
    under_construction: '#ff9800',
    commissioned: '#4caf50',
    decommissioned: '#f44336'
};

document.addEventListener('DOMContentLoaded', function() {
    // Parse data
    let networkData;
    try {
        networkData = JSON.parse(document.getElementById('network-data').textContent);
    } catch (error) {
        hideLoading();
        document.getElementById('network-diagram').innerHTML =
            '<div class="alert alert-danger m-3">Error parsing network data: ' + error.message + '</div>';
        return;
    }

    // Populate status summary table
    try {
        const statusSummary = JSON.parse(document.getElementById('status-summary-data').textContent);
        const tbody = document.getElementById('status-summary-tbody');
        Object.keys(statusLabels).forEach(function(status) {
            if (statusSummary[status]) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td><span style="color:' + statusColors[status] + ';">&#9679;</span> ' + statusLabels[status] + '</td>' +
                    '<td class="text-end">' + statusSummary[status].count + '</td>' +
                    '<td class="text-end">' + statusSummary[status].total_mw.toFixed(0) + '</td>';
                tbody.appendChild(tr);
            }
        });
    } catch(e) {}

    // Initialize diagram
    try {
        networkDiagram = new InfrastructureNetworkDiagram('network-diagram', networkData);
        hideLoading();
        addNodeClickHandler();
    } catch (error) {
        console.error('Error initializing network diagram:', error);
        hideLoading();
        document.getElementById('network-diagram').innerHTML =
            '<div class="alert alert-danger m-3">Error loading: ' + error.message + '</div>';
    }

    // Wire up status filters
    document.querySelectorAll('.network-status-filter').forEach(function(cb) {
        cb.addEventListener('change', function() {
            if (!networkDiagram) return;
            const activeStatuses = Array.from(document.querySelectorAll('.network-status-filter:checked')).map(function(c) { return c.value; });
            networkDiagram.filterByStatus(activeStatuses);
        });
    });
});

function hideLoading() {
    const el = document.getElementById('loading-indicator');
    if (el) el.remove();
}

function addNodeClickHandler() {
    if (!networkDiagram) return;

    networkDiagram.nodesGroup.selectAll('circle').on('click', function(event, d) {
        event.stopPropagation();
        networkDiagram.highlightNode(d.id);
        updateNodeDetails(d);
    });

    networkDiagram.svg.on('click', function(event) {
        if (event.target === event.currentTarget) {
            networkDiagram.resetHighlight();
            resetNodeDetails();
        }
    });
}

function updateNodeDetails(node) {
    const div = document.getElementById('node-details');
    let html = '<div class="node-details-content">';
    html += '<h6 class="text-primary">' + node.label + '</h6>';
    html += '<span class="badge bg-secondary">' + node.type + '</span>';

    if (node.type === 'terminal') {
        html += '<ul class="small list-unstyled mt-2 mb-0">';
        html += '<li><strong>Voltage:</strong> ' + node.voltage + ' kV</li>';
        html += '<li><strong>Transformer:</strong> ' + node.transformer_capacity + ' MVA</li>';
        html += '<li><strong>Connected:</strong> ' + node.total_connected_capacity.toFixed(0) + ' MW</li>';
        html += '<li><strong>Utilization:</strong> ' + (node.utilization_percent || 0).toFixed(1) + '%</li>';
        if (node.is_bottleneck) {
            html += '<li class="text-danger fw-bold mt-1">BOTTLENECK - Overloaded</li>';
        }
        html += '</ul>';
        const terminalPk = node.id.split('_')[1];
        html += '<hr><a href="/terminals/' + terminalPk + '/" class="btn btn-sm btn-primary w-100">View Terminal</a>';
    } else if (node.type === 'facility') {
        const color = statusColors[node.status] || '#9e9e9e';
        html += ' <span class="badge" style="background:' + color + ';">' + (statusLabels[node.status] || node.status) + '</span>';
        html += '<ul class="small list-unstyled mt-2 mb-0">';
        html += '<li><strong>Technology:</strong> ' + node.technology + '</li>';
        html += '<li><strong>Capacity:</strong> ' + node.capacity.toFixed(1) + ' MW</li>';
        html += '<li><strong>Probability:</strong> ' + (node.commissioning_probability * 100).toFixed(0) + '%</li>';
        if (node.retirement_year) html += '<li><strong>Retirement:</strong> ' + node.retirement_year + '</li>';
        html += '</ul>';
        const facilityPk = node.id.split('_')[1];
        html += '<hr><a href="/facilities/' + facilityPk + '/" class="btn btn-sm btn-warning w-100">View Facility</a>';
    }

    html += '</div>';
    div.innerHTML = html;
}

function resetNodeDetails() {
    document.getElementById('node-details').innerHTML =
        '<p class="text-muted text-center small">Click a node to view details</p>';
}

function downloadSVG() {
    if (!networkDiagram) { alert('Diagram not loaded'); return; }
    const svgEl = networkDiagram.svg.node();
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svgEl);
    const blob = new Blob([svgString], {type: 'image/svg+xml'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'infrastructure_network.svg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

document.addEventListener('keydown', function(event) {
    if (!networkDiagram) return;
    if (event.key === 'Escape') {
        networkDiagram.resetHighlight();
        resetNodeDetails();
    }
});
</script>

<style>
#network-diagram {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    overflow: hidden;
}
#network-diagram svg { display: block; }
#network-diagram circle {
    cursor: pointer;
    transition: opacity 0.3s;
}
#network-diagram circle:hover {
    stroke-width: 4px !important;
}
#network-diagram line {
    transition: stroke-opacity 0.3s;
}
.node-details-content {
    animation: fadeIn 0.3s;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
.node-label {
    user-select: none;
    text-shadow: -1px -1px 0 white, 1px -1px 0 white, -1px 1px 0 white, 1px 1px 0 white;
}
</style>
{% endblock %}
