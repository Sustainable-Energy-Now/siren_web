<!-- facilities/create.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Add New Facility</h3>
    <a href="{% url 'powermapui:facilities_list' %}" class="btn btn-outline-secondary">Back to List</a>
  </div>

  <p>Enter the details for a new facility. Facilities represent the infrastructure that comprises the grid. All fields except Facility Name are optional.</p>

  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            
            <div class="mb-3">
              <label for="facility_name" class="form-label">Facility Name <span class="text-danger">*</span></label>
              <input type="text" 
                     class="form-control" 
                     id="facility_name" 
                     name="facility_name" 
                     value="{{ form_data.facility_name|default:'' }}"
                     required>
              <div class="form-text">Unique identifier for this facility</div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="technology" class="form-label">Technology</label>
                <select class="form-select" id="technology" name="technology">
                  <option value="">Select technology</option>
                  {% for tech in technologies %}
                    <option value="{{ tech.idtechnologies }}" 
                            {% if form_data.technology == tech.idtechnologies|stringformat:"s" %}selected{% endif %}>
                      {{ tech.technology_name }}
                    </option>
                  {% endfor %}
                </select>
                <div class="form-text">Type of generation or infrastructure</div>
              </div>
              <div class="col-md-6">
                <label for="zone" class="form-label">Zone</label>
                <select class="form-select" id="zone" name="zone">
                  <option value="">Select zone</option>
                  {% for zone in zones %}
                    <option value="{{ zone.idzones }}" 
                            {% if form_data.zone == zone.idzones|stringformat:"s" %}selected{% endif %}>
                      {{ zone.name }}
                    </option>
                  {% endfor %}
                </select>
                <div class="form-text">Geographic or administrative zone</div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="capacity" class="form-label">Capacity</label>
                <input type="number" 
                       class="form-control non-negative"  
                       id="capacity" 
                       name="capacity" 
                       step="0.01" 
                       min="0"
                       value="{{ form_data.capacity|default:'' }}">
                <div class="form-text">Rated capacity of the facility</div>
              </div>
              <div class="col-md-6">
                <label for="capacity_factor" class="form-label">Capacity Factor</label>
                <input type="number" 
                       class="form-control non-negative"  
                       id="capacity_factor" 
                       name="capacity_factor" 
                       step="0.001" 
                       min="0" 
                       max="1"
                       value="{{ form_data.capacity_factor|default:'' }}">
                <div class="form-text">Ratio of actual to potential output (0-1)</div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="emission_intensity" class="form-label">Emission Intensity</label>
                <input type="number"
                       class="form-control non-negative"
                       id="emission_intensity"
                       name="emission_intensity"
                       step="0.001"
                       min="0"
                       value="{{ form_data.emission_intensity|default:'' }}">
                <div class="form-text">CO₂ equivalent emissions per unit of energy (t CO₂-e/MWh)</div>
              </div>
            </div>

            <hr class="my-4">
            <h5 class="mb-3">Lifecycle Status</h5>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                <select class="form-select" id="status" name="status" required>
                  <option value="proposed" {% if form_data.status == 'proposed' %}selected{% endif %}>Proposed</option>
                  <option value="planned" {% if form_data.status == 'planned' %}selected{% endif %}>Planned</option>
                  <option value="under_construction" {% if form_data.status == 'under_construction' %}selected{% endif %}>Under Construction</option>
                  <option value="commissioned" {% if form_data.status == 'commissioned' or not form_data.status %}selected{% endif %}>Commissioned</option>
                  <option value="decommissioned" {% if form_data.status == 'decommissioned' %}selected{% endif %}>Decommissioned</option>
                </select>
                <div class="form-text">Current lifecycle stage of the facility</div>
              </div>
              <div class="col-md-6">
                <label for="commissioning_probability" class="form-label">Commissioning Probability</label>
                <input type="number"
                       class="form-control"
                       id="commissioning_probability"
                       name="commissioning_probability"
                       step="0.01"
                       min="0"
                       max="1"
                       value="{{ form_data.commissioning_probability|default:'' }}">
                <div class="form-text">Likelihood of commissioning (0-1), for proposed/planned facilities</div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="commissioning_date" class="form-label">Commissioning Date</label>
                <input type="date"
                       class="form-control"
                       id="commissioning_date"
                       name="commissioning_date"
                       value="{{ form_data.commissioning_date|default:'' }}">
                <div class="form-text">Actual or expected date when facility becomes operational</div>
              </div>
              <div class="col-md-6">
                <label for="decommissioning_date" class="form-label">Decommissioning Date</label>
                <input type="date"
                       class="form-control"
                       id="decommissioning_date"
                       name="decommissioning_date"
                       value="{{ form_data.decommissioning_date|default:'' }}">
                <div class="form-text">Actual or expected date when facility will be retired</div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-6">
                <label for="latitude" class="form-label">Latitude</label>
                <input type="number" 
                       class="form-control" 
                       id="latitude" 
                       name="latitude" 
                       step="0.000001" 
                       min="-90" 
                       max="90"
                       value="{{ form_data.latitude|default:'' }}">
                <div class="form-text">Decimal degrees (-90 to 90)</div>
              </div>
              <div class="col-md-6">
                <label for="longitude" class="form-label">Longitude</label>
                <input type="number" 
                       class="form-control non-negative"  
                       id="longitude" 
                       name="longitude" 
                       step="0.000001" 
                       min="-180" 
                       max="180"
                       value="{{ form_data.longitude|default:'' }}">
                <div class="form-text">Decimal degrees (-180 to 180)</div>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label">Scenarios</label>
              <div class="form-text mb-2">Select the scenarios this facility belongs to</div>
              <div class="row">
                {% for scenario in scenarios %}
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" 
                             type="checkbox" 
                             name="scenarios" 
                             value="{{ scenario.idscenarios }}" 
                             id="scenario_{{ scenario.idscenarios }}">
                      <label class="form-check-label" for="scenario_{{ scenario.idscenarios }}">
                        {{ scenario.title }}
                      </label>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Create Facility</button>
              <a href="{% url 'powermapui:facilities_list' %}" class="btn btn-outline-secondary">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Help Card -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Field Guidelines</h6>
        </div>
        <div class="card-body">
          <div class="small">
            <p><strong>Facility Name:</strong> Use a descriptive, unique name that identifies the facility clearly.</p>
            
            <p><strong>Technology:</strong> Select the primary technology type for this facility. For hybrid facilities, create separate installations for each technology.</p>
            
            <p><strong>Capacity Factor:</strong> Typical values range from 0.15-0.25 for solar, 0.25-0.45 for wind, and 0.50-0.90 for baseload generation.</p>
            
            <p><strong>Coordinates:</strong> Use decimal degrees format. Ensure accuracy for mapping and spatial analysis.</p>
          </div>
        </div>
      </div>

      <!-- Examples Card -->
      <div class="card mt-3">
        <div class="card-header">
          <h6 class="mb-0">Example Facilities</h6>
        </div>
        <div class="card-body">
          <div class="small">
            <ul class="list-unstyled">
              <li class="mb-2"><strong>Wind Farm:</strong> Capacity: 150 MW, CF: 0.35</li>
              <li class="mb-2"><strong>Solar Plant:</strong> Capacity: 100 MW, CF: 0.22</li>
              <li class="mb-2"><strong>Gas Turbine:</strong> Capacity: 500 MW, CF: 0.60</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.querySelectorAll('.non-negative').forEach(input => {
      input.addEventListener('input', function() {
        if (this.value < 0) {
          this.value = 0;
        }
      });
    });
  </script>
{% endblock %}