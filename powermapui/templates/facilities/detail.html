<!-- facilities/detail.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3>{{ facility.facility_name }}</h3>
    </div>
    <div>
      <a href="{% url 'powermapui:facilities_list' %}" class="btn btn-outline-secondary">Back to List</a>
    </div>
  </div>

  <div class="row">
    <!-- Basic Information -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Facility Information</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-sm">
                <tr>
                  <td><strong>Facility Name:</strong></td>
                  <td>{{ facility.facility_name }}</td>
                </tr>
                <tr>
                  <td><strong>Technologies:</strong></td>
                  <td>
                    {% if facility.technologies.exists %}
                      {% for tech in facility.technologies %}
                        <span class="badge bg-secondary me-1">{{ tech.technology_name }}</span>
                      {% endfor %}
                    {% else %}
                      <span class="text-muted">No technology installations</span>
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td><strong>Zone:</strong></td>
                  <td>{{ facility.idzones.name|default:"Not specified" }}</td>
                </tr>
                <tr>
                  <td><strong>Capacity:</strong></td>
                  <td>
                    {% if facility.capacity %}
                      {{ facility.capacity|floatformat:2 }}
                    {% else %}
                      Not specified
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td><strong>Capacity Factor:</strong></td>
                  <td>
                    {% if facility.capacityfactor %}
                      {{ facility.capacityfactor|floatformat:3 }}
                    {% else %}
                      Not specified
                    {% endif %}
                  </td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-sm">
                <tr>
                  <td><strong>Emission Intensity:</strong></td>
                  <td>
                    {% if facility.emission_intensity %}
                      {{ facility.emission_intensity|floatformat:3 }}
                    {% else %}
                      Not specified
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td><strong>Latitude:</strong></td>
                  <td>
                    {% if facility.latitude %}
                      {{ facility.latitude|floatformat:6 }}
                    {% else %}
                      Not specified
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td><strong>Longitude:</strong></td>
                  <td>
                    {% if facility.longitude %}
                      {{ facility.longitude|floatformat:6 }}
                    {% else %}
                      Not specified
                    {% endif %}
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Scenarios -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Associated Scenarios</h5>
        </div>
        <div class="card-body">
          {% if facility_scenarios %}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Scenario</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  {% for fs in facility_scenarios %}
                    <tr>
                      <td>{{ fs.idscenarios.title }}</td>
                      <td>{{ fs.idscenarios.description|default:"-"|truncatechars:100 }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center text-muted py-3">
              <p>This facility is not associated with any scenarios.</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Wind Installations -->
      {% if wind_installations %}
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Wind Installations</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Installation Name</th>
                    <th>Technology</th>
                    <th>Turbine Model</th>
                    <th>Units</th>
                    <th>Total Capacity</th>
                    <th>Commissioned</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for inst in wind_installations %}
                    <tr>
                      <td>{{ inst.installation_name|default:"Unnamed" }}</td>
                      <td><span class="badge bg-info">{{ inst.idtechnologies.technology_name }}</span></td>
                      <td>{{ inst.idwindturbines.turbine_model }}</td>
                      <td>{{ inst.no_turbines }}</td>
                      <td>{{ inst.total_capacity|floatformat:2 }} MW</td>
                      <td>{{ inst.commissioning_date|default:"-" }}</td>
                      <td>
                        <a href="{% url 'powermapui:facility_wind_turbine_edit' inst.pk %}" class="btn btn-sm btn-outline-warning">Edit</a>
                        <button class="btn btn-sm btn-outline-danger delete-installation-btn" data-type="wind" data-id="{{ inst.pk }}" data-name="{{ inst.installation_name|default:'Unnamed' }}">Delete</button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Solar Installations -->
      {% if solar_installations %}
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Solar Installations</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Installation Name</th>
                    <th>Technology</th>
                    <th>DC Capacity</th>
                    <th>AC Capacity</th>
                    <th>Commissioned</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for inst in solar_installations %}
                    <tr>
                      <td>{{ inst.installation_name|default:"Unnamed" }}</td>
                      <td><span class="badge bg-warning text-dark">{{ inst.idtechnologies.technology_name }}</span></td>
                      <td>{{ inst.nameplate_capacity|floatformat:2 }} MW</td>
                      <td>{{ inst.ac_capacity|floatformat:2|default:"-" }} MW</td>
                      <td>{{ inst.commissioning_date|default:"-" }}</td>
                      <td>
                        <a href="{% url 'powermapui:facility_solar_edit' inst.pk %}" class="btn btn-sm btn-outline-warning">Edit</a>
                        <button class="btn btn-sm btn-outline-danger delete-installation-btn" data-type="solar" data-id="{{ inst.pk }}" data-name="{{ inst.installation_name|default:'Unnamed' }}">Delete</button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Storage Installations -->
      {% if storage_installations %}
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Storage Installations</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Installation Name</th>
                    <th>Technology</th>
                    <th>Power</th>
                    <th>Energy</th>
                    <th>Duration</th>
                    <th>Commissioned</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for inst in storage_installations %}
                    <tr>
                      <td>{{ inst.installation_name|default:"Unnamed" }}</td>
                      <td><span class="badge bg-success">{{ inst.idtechnologies.technology_name }}</span></td>
                      <td>{{ inst.power_capacity|floatformat:2|default:"-" }} MW</td>
                      <td>{{ inst.energy_capacity|floatformat:2|default:"-" }} MWh</td>
                      <td>{{ inst.get_calculated_duration|floatformat:1|default:"-" }} hrs</td>
                      <td>{{ inst.commissioning_date|default:"-" }}</td>
                      <td>
                        <a href="{% url 'powermapui:facility_storage_edit' inst.pk %}" class="btn btn-sm btn-outline-warning">Edit</a>
                        <button class="btn btn-sm btn-outline-danger delete-installation-btn" data-type="storage" data-id="{{ inst.pk }}" data-name="{{ inst.installation_name|default:'Unnamed' }}">Delete</button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}

    </div>

    <!-- Quick Actions Sidebar -->
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0">Quick Actions</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="{% url 'powermapui:facility_edit' facility.pk %}" class="btn btn-warning btn-sm">
              Edit Facility
            </a>
            <a href="{% url 'powermapui:facility_wind_turbine_create' facility.pk %}" class="btn btn-outline-primary btn-sm">
              Add Wind Installation
            </a>
            <a href="{% url 'powermapui:facility_solar_create_for_facility' facility.pk %}" class="btn btn-outline-primary btn-sm">
              Add Solar Installation
            </a>
            <a href="{% url 'powermapui:facility_storage_create_for_facility' facility.pk %}" class="btn btn-outline-primary btn-sm">
              Add Storage Installation
            </a>
            <button class="btn btn-danger btn-sm" onclick="confirmDelete()">
              Delete Facility
            </button>
          </div>
        </div>
      </div>

      <!-- Location Map Card -->
      {% if facility.latitude and facility.longitude %}
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="mb-0">Location</h6>
          </div>
          <div class="card-body">
            <div class="text-center">
              <p class="mb-2"><strong>Coordinates:</strong></p>
              <p class="mb-1">{{ facility.latitude|floatformat:6 }}, {{ facility.longitude|floatformat:6 }}</p>
              <small class="text-muted">Lat, Lng</small>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Statistics Card -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Statistics</h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-12 mb-3">
              <h4 class="text-primary">{{ facility_scenarios.count }}</h4>
              <small class="text-muted">Scenario{{ facility_scenarios.count|pluralize }}</small>
            </div>
          </div>
          {% if facility.total_capacity %}
            <hr>
            <div class="text-center">
              <h4 class="text-success">{{ facility.total_capacity|floatformat:2 }} MW</h4>
              <small class="text-muted">Total Capacity</small>
            </div>
          {% endif %}
          {% if wind_installations %}
            <hr>
            <div class="text-center">
              <h5 class="text-info">{{ wind_installations.count }}</h5>
              <small class="text-muted">Wind Installation{{ wind_installations.count|pluralize }}</small>
            </div>
          {% endif %}
          {% if solar_installations %}
            <hr>
            <div class="text-center">
              <h5 class="text-warning">{{ solar_installations.count }}</h5>
              <small class="text-muted">Solar Installation{{ solar_installations.count|pluralize }}</small>
            </div>
          {% endif %}
          {% if storage_installations %}
            <hr>
            <div class="text-center">
              <h5 class="text-success">{{ storage_installations.count }}</h5>
              <small class="text-muted">Storage Installation{{ storage_installations.count|pluralize }}</small>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Facility Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete the facility "{{ facility.facility_name }}"?</p>
          <div class="alert alert-warning">
            <strong>Warning:</strong> This action cannot be undone. All associated scenario relationships will be removed.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form method="post" action="{% url 'powermapui:facility_delete' facility.pk %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">
              Delete Facility
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Installation Confirmation Modal -->
  <div class="modal fade" id="deleteInstallationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete Installation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete the installation "<span id="installationNameText"></span>"?</p>
          <div class="alert alert-warning">
            <strong>Warning:</strong> This action cannot be undone.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form method="post" id="deleteInstallationForm" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">
              Delete Installation
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    function confirmDelete() {
      var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
      deleteModal.show();
    }

    // Handle installation delete button clicks
    document.addEventListener('DOMContentLoaded', function() {
      const deleteButtons = document.querySelectorAll('.delete-installation-btn');
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteInstallationModal'));
      const deleteForm = document.getElementById('deleteInstallationForm');
      const installationNameText = document.getElementById('installationNameText');

      deleteButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          const type = this.dataset.type;
          const id = this.dataset.id;
          const name = this.dataset.name;

          // Set the installation name in the modal
          installationNameText.textContent = name;

          // Set the form action based on type
          let deleteUrl = '';
          switch(type) {
            case 'wind':
              deleteUrl = "{% url 'powermapui:facility_wind_turbine_delete' 0 %}".replace('0', id);
              break;
            case 'solar':
              deleteUrl = "{% url 'powermapui:facility_solar_delete' 0 %}".replace('0', id);
              break;
            case 'storage':
              deleteUrl = "{% url 'powermapui:facility_storage_delete' 0 %}".replace('0', id);
              break;
          }

          deleteForm.action = deleteUrl;
          deleteModal.show();
        });
      });
    });
  </script>
{% endblock %}