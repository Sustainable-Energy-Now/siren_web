<!-- facilities/list.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Facilities</h3>
    <a href="{% url 'powermapui:facility_create' %}" class="btn btn-primary">Add New Facility</a>
  </div>

  <p>
    This displays all facilities in the system. Facilities represent infrastructure that comprises the grid.
    Use the search and filters below to find specific facilities. Where more than one technology is used at the 
    same location (hybrid facility), they are handled as separate facilities for each technology.
  </p>

  <!-- Search and Filter Form -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-3">
          <label for="search" class="form-label">Search:</label>
          <input type="text" name="search" id="search" class="form-control" 
                 value="{{ search_query }}" placeholder="Search by name, technology, or zone">
        </div>
        <div class="col-md-2">
          <label for="scenario" class="form-label">Scenario:</label>
          <select name="scenario" id="scenario" class="form-select">
            <option value="">All Scenarios</option>
            {% for scenario in scenarios %}
              <option value="{{ scenario.idscenarios }}" 
                      {% if scenario_filter == scenario.idscenarios|stringformat:"s" %}selected{% endif %}>
                {{ scenario.title }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="technology" class="form-label">Technology:</label>
          <select name="technology" id="technology" class="form-select">
            <option value="">All Technologies</option>
            {% for tech in technologies %}
              <option value="{{ tech }}" 
                      {% if technology_filter == tech %}selected{% endif %}>
                {{ tech }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="zone" class="form-label">Zone:</label>
          <select name="zone" id="zone" class="form-select">
            <option value="">All Zones</option>
            {% for zone in zones %}
              <option value="{{ zone }}" 
                      {% if zone_filter == zone %}selected{% endif %}>
                {{ zone }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">Filter</button>
          <a href="{% url 'powermapui:facilities_list' %}" class="btn btn-outline-secondary">Clear</a>
        </div>
        <div class="col-md-1 d-flex align-items-end justify-content-end">
          <small class="text-muted">{{ total_count }} facilit{{ total_count|pluralize:"y,ies" }}</small>
        </div>
      </form>
    </div>
  </div>

  <!-- Results Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Facility Name</th>
          <th>Technology</th>
          <th>Zone</th>
          <th>Capacity</th>
          <th>Capacity Factor</th>
          <th>Generation</th>
          <th>Transmitted</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for facility in page_obj %}
          <tr>
            <td>
              <a href="{% url 'powermapui:facility_detail' facility.pk %}" class="text-decoration-none">
                {{ facility.facility_name }}
              </a>
            </td>
            <td>{{ facility.idtechnologies.technology_name|default:"-" }}</td>
            <td>{{ facility.idzones.name|default:"-" }}</td>
            <td>
              {% if facility.capacity %}
                {{ facility.capacity|floatformat:2 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if facility.capacityfactor %}
                {{ facility.capacityfactor|floatformat:3 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if facility.generation %}
                {{ facility.generation|floatformat:2 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if facility.transmitted %}
                {{ facility.transmitted|floatformat:2 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if facility.latitude %}
                {{ facility.latitude|floatformat:6 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if facility.longitude %}
                {{ facility.longitude|floatformat:6 }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a href="{% url 'powermapui:facility_detail' facility.pk %}" 
                   class="btn btn-outline-primary" title="View Details">
                  View
                </a>
                <a href="{% url 'powermapui:facility_edit' facility.pk %}" 
                   class="btn btn-outline-warning" title="Edit">
                  Edit
                </a>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="10" class="text-center text-muted py-4">
              No facilities found.
              {% if search_query or scenario_filter or technology_filter or zone_filter %}
                <a href="{% url 'powermapui:facilities_list' %}" class="btn btn-link">Clear filters</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
    <nav aria-label="Facilities pagination">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if scenario_filter %}&scenario={{ scenario_filter }}{% endif %}{% if technology_filter %}&technology={{ technology_filter }}{% endif %}{% if zone_filter %}&zone={{ zone_filter }}{% endif %}">
              &laquo; First
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if scenario_filter %}&scenario={{ scenario_filter }}{% endif %}{% if technology_filter %}&technology={{ technology_filter }}{% endif %}{% if zone_filter %}&zone={{ zone_filter }}{% endif %}">
              Previous
            </a>
          </li>
        {% endif %}

        <li class="page-item active">
          <span class="page-link">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if scenario_filter %}&scenario={{ scenario_filter }}{% endif %}{% if technology_filter %}&technology={{ technology_filter }}{% endif %}{% if zone_filter %}&zone={{ zone_filter }}{% endif %}">
              Next
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if scenario_filter %}&scenario={{ scenario_filter }}{% endif %}{% if technology_filter %}&technology={{ technology_filter }}{% endif %}{% if zone_filter %}&zone={{ zone_filter }}{% endif %}">
              Last &raquo;
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
{% endblock %}