<!-- facilities/edit.html -->
{% extends 'powermapui_base.html' %}

{% block powermapui_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3>Edit Facility</h3>
      <small class="text-muted">{{ facility.facility_name }}</small>
    </div>
    <div>
      <a href="{% url 'powermapui:facility_detail' facility.pk %}" class="btn btn-outline-secondary">Back to Details</a>
    </div>
  </div>

  <p>Update the details for this facility. Changes will be reflected across all associated scenarios.</p>

  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            
            <div class="mb-3">
              <label for="facility_name" class="form-label">Facility Name <span class="text-danger">*</span></label>
              <input type="text" 
                     class="form-control" 
                     id="facility_name" 
                     name="facility_name" 
                     value="{{ form_data.facility_name|default:facility.facility_name }}"
                     required>
              <div class="form-text">Unique identifier for this facility</div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="technology" class="form-label">Technology</label>
                <select class="form-select" id="technology" name="technology">
                  <option value="">Select technology</option>
                  {% for tech in technologies %}
                    <option value="{{ tech.idtechnologies }}" 
                            {% if form_data.technology|default:facility.idtechnologies.idtechnologies == tech.idtechnologies %}selected{% endif %}>
                      {{ tech.technology_name }}
                    </option>
                  {% endfor %}
                </select>
                <div class="form-text">Type of generation or infrastructure</div>
              </div>
              <div class="col-md-6">
                <label for="zone" class="form-label">Zone</label>
                <select class="form-select" id="zone" name="zone">
                  <option value="">Select zone</option>
                  {% for zone in zones %}
                    <option value="{{ zone.idzones }}" 
                            {% if form_data.zone|default:facility.idzones.idzones == zone.idzones %}selected{% endif %}>
                      {{ zone.name }}
                    </option>
                  {% endfor %}
                </select>
                <div class="form-text">Geographic or administrative zone</div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="capacity" class="form-label">Capacity</label>
                <input type="number" 
                       class="form-control non-negative"  
                       id="capacity" 
                       name="capacity" 
                       step="0.01" 
                       min="0"
                       value="{{ form_data.capacity|default:facility.capacity|default:'' }}">
                <div class="form-text">Rated capacity of the facility</div>
              </div>
              <div class="col-md-6">
                <label for="capacity_factor" class="form-label">Capacity Factor</label>
                <input type="number" 
                       class="form-control non-negative"  
                       id="capacity_factor" 
                       name="capacity_factor" 
                       step="0.001" 
                       min="0" 
                       max="1"
                       value="{{ form_data.capacity_factor|default:facility.capacityfactor|default:'' }}">
                <div class="form-text">Ratio of actual to potential output (0-1)</div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="emission_intensity" class="form-label">Emission Intensity</label>
                <input type="number" 
                       class="form-control non-negative"  
                       id="emission_intensity" 
                       name="emission_intensity" 
                       step="0.001" 
                       min="0"
                       value="{{ form_data.emission_intensity|default:facility.emission_intensity|default:'' }}">
                <div class="form-text">CO₂ emissions per unit of energy (t CO₂-e/MWh)</div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-6">
                <label for="latitude" class="form-label">Latitude</label>
                <input type="number" 
                       class="form-control" 
                       id="latitude" 
                       name="latitude" 
                       step="0.000001" 
                       min="-90" 
                       max="90"
                       value="{{ form_data.latitude|default:facility.latitude|default:'' }}">
                <div class="form-text">Decimal degrees (-90 to 90)</div>
              </div>
              <div class="col-md-6">
                <label for="longitude" class="form-label">Longitude</label>
                <input type="number" 
                       class="form-control non-negative"  
                       id="longitude" 
                       name="longitude" 
                       step="0.000001" 
                       min="-180" 
                       max="180"
                       value="{{ form_data.longitude|default:facility.longitude|default:'' }}">
                <div class="form-text">Decimal degrees (-180 to 180)</div>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label">Scenarios</label>
              <div class="form-text mb-2">Select the scenarios this facility belongs to</div>
              <div class="row">
                {% for scenario in scenarios %}
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" 
                             type="checkbox" 
                             name="scenarios" 
                             value="{{ scenario.idscenarios }}" 
                             id="scenario_{{ scenario.idscenarios }}"
                             {% if scenario.idscenarios in current_scenario_ids %}checked{% endif %}>
                      <label class="form-check-label" for="scenario_{{ scenario.idscenarios }}">
                        {{ scenario.title }}
                      </label>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Update Facility</button>
              <a href="{% url 'powermapui:facility_detail' facility.pk %}" class="btn btn-outline-secondary">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Record Information -->
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0">Record Information</h6>
        </div>
        <div class="card-body">
          <table class="table table-sm mb-0">
            <tr>
              <td><strong>Facility ID:</strong></td>
              <td>{{ facility.idfacilities }}</td>
            </tr>
            <tr>
              <td><strong>Current Technology:</strong></td>
              <td>{{ facility.idtechnologies.technology_name|default:"Not set" }}</td>
            </tr>
            <tr>
              <td><strong>Current Zone:</strong></td>
              <td>{{ facility.idzones.name|default:"Not set" }}</td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Help Card -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Update Guidelines</h6>
        </div>
        <div class="card-body">
          <div class="small">
            <p><strong>Impact of Changes:</strong> Updates to this facility will be reflected across all associated scenarios.</p>
            
            <p><strong>Technology Changes:</strong> If changing technology type significantly (e.g., from solar to wind), consider creating a new facility instead.</p>
            
            <p><strong>Scenario Associations:</strong> Unchecking a scenario will remove this facility from that scenario's analysis.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.querySelectorAll('.non-negative').forEach(input => {
      input.addEventListener('input', function() {
        if (this.value < 0) {
          this.value = 0;
        }
      });
    });
  </script>
{% endblock %}