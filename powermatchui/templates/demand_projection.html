{% extends 'powermatchui_base.html' %}
{% load static %}

{% block powermatchui_content %}
<div class="container-fluid mt-4">
    <h2>Electricity Demand Projection</h2>
    
    <!-- Control Panel -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form id="demandProjectionForm" class="row g-3">
                        <div class="col-md-2">
                            <label for="baseYearSelect" class="form-label">Base Year:</label>
                            <select class="form-select" id="baseYearSelect" name="base_year" required>
                                {% for year in available_years %}
                                <option value="{{ year }}" {% if forloop.last %}selected{% endif %}>
                                    {{ year }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="endYearSelect" class="form-label">Project To Year:</label>
                            <select class="form-select" id="endYearSelect" name="end_year" required>
                                {% for year in projection_years %}
                                <option value="{{ year }}" {% if year == 2040 %}selected{% endif %}>
                                    {{ year }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="viewModeSelect" class="form-label">View Mode:</label>
                            <select class="form-select" id="viewModeSelect" name="view_mode">
                                <option value="single" selected>Single Projection</option>
                                <option value="comparison">Compare Scenarios</option>
                                <option value="breakdown">Operational vs Underlying</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3" id="scenarioSelectDiv">
                            <label for="scenarioSelect" class="form-label">Scenario:</label>
                            <select class="form-select" id="scenarioSelect" name="scenario">
                                {% for scenario in db_scenarios %}
                                    {% if scenario.has_factors %}
                                    <option value="db_{{ scenario.id }}"
                                            data-scenario-id="{{ scenario.id }}"
                                            data-has-factors="true"
                                            data-factor-count="{{ scenario.factor_count }}">
                                        {{ scenario.title }} ({{ scenario.factor_count }} factors)
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-graph-up"></i> Generate Projection
                            </button>
                        </div>
                    </form>

                    <!-- Update Target Scenario Button -->
                    <div class="row mt-3" id="updateTargetScenarioDiv">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-warning" id="updateTargetScenarioBtn">
                                <i class="bi bi-database-fill-up"></i> Update TargetScenario with Projection
                            </button>
                            <small class="text-muted ms-2">Updates the TargetScenario table with demand values from the generated projection</small>
                        </div>
                    </div>
                    
                    <!-- Multi-scenario selection (hidden by default) -->
                    <div class="row mt-3" id="multiScenarioDiv" style="display: none;">
                        <div class="col-md-12">
                            <label class="form-label">Select Scenarios to Compare:</label>
                            <div class="btn-group-vertical w-100" role="group">
                                {% for scenario in db_scenarios %}
                                    {% if scenario.has_factors %}
                                    <div class="form-check">
                                        <input class="form-check-input scenario-checkbox" type="checkbox"
                                               value="{{ scenario.id }}"
                                               data-scenario-id="{{ scenario.id }}"
                                               id="compare_scenario_{{ scenario.id }}">
                                        <label class="form-check-label" for="compare_scenario_{{ scenario.id }}">
                                            {{ scenario.title }} ({{ scenario.factor_count }} factors)
                                        </label>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Display -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Demand Projection Results</h5>
                </div>
                <div class="card-body">
                    <!-- Loading Indicator -->
                    <div id="loadingIndicator" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Calculating projections...</p>
                    </div>
                    
                    <!-- Error Message -->
                    <div id="errorMessage" class="alert alert-danger" style="display: none;">
                    </div>
                    
                    <!-- Plot -->
                    <div id="demandPlot" style="width: 100%; height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Summary Statistics -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Projection Summary</h5>
                </div>
                <div class="card-body">
                    <div id="summaryStats" class="row">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-subtitle mb-2 text-muted">Base Year Demand</h6>
                                    <h4 id="baseYearDemand" class="card-title text-primary">-</h4>
                                    <small>GWh/year</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-subtitle mb-2 text-muted">End Year Demand</h6>
                                    <h4 id="endYearDemand" class="card-title text-success">-</h4>
                                    <small>GWh/year</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Growth</h6>
                                    <h4 id="totalGrowth" class="card-title text-info">-</h4>
                                    <small>% increase</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-subtitle mb-2 text-muted">Avg. Annual Growth</h6>
                                    <h4 id="avgGrowth" class="card-title text-warning">-</h4>
                                    <small>% per year</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3" id="configSummary">
                        <div class="col-md-12">
                            <h6>Configuration Used:</h6>
                            <p id="configDetails" class="text-muted small">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Update Target Scenario Confirmation -->
<div class="modal fade" id="updateTargetScenarioModal" tabindex="-1" aria-labelledby="updateTargetScenarioModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="updateTargetScenarioModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Update TargetScenario - Confirmation Required
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This action will update or create TargetScenario records in the database.
                </div>

                <p><strong>Projection Details:</strong></p>
                <ul>
                    <li>Base Year: <span id="modalBaseYear"></span></li>
                    <li>End Year: <span id="modalEndYear"></span></li>
                    <li>Scenario: <span id="modalScenario"></span></li>
                    <li>Years to Update: <span id="modalYearRange"></span></li>
                </ul>

                <div class="mb-3">
                    <label for="targetScenarioNameInput" class="form-label">
                        <strong>Target Scenario Name:</strong>
                    </label>
                    <input
                        type="text"
                        class="form-control"
                        id="targetScenarioNameInput"
                        placeholder="e.g., Base Case 2024"
                        required>
                    <small class="form-text text-muted">
                        Enter the scenario_name for the TargetScenario records. Existing records with this name will be updated.
                    </small>
                </div>

                <p class="text-danger">
                    <strong>Note:</strong> This will overwrite any existing TargetScenario records with the same scenario_name and year.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmUpdateBtn">
                    <i class="bi bi-check-circle"></i> Confirm Update
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('demandProjectionForm');
    const viewModeSelect = document.getElementById('viewModeSelect');
    const scenarioSelectDiv = document.getElementById('scenarioSelectDiv');
    const multiScenarioDiv = document.getElementById('multiScenarioDiv');
    const demandPlot = document.getElementById('demandPlot');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    
    // Handle view mode changes
    viewModeSelect.addEventListener('change', function() {
        const scenarioSelect = document.getElementById('scenarioSelect');
        const selectedOption = scenarioSelect.options[scenarioSelect.selectedIndex];
        const hasFactors = selectedOption.dataset.hasFactors === 'true';

        if (this.value === 'comparison') {
            scenarioSelectDiv.style.display = 'none';
            multiScenarioDiv.style.display = 'block';
        } else {
            scenarioSelectDiv.style.display = 'block';
            multiScenarioDiv.style.display = 'none';

            // Show warning if breakdown mode selected but scenario has no factors
            if (this.value === 'breakdown' && !hasFactors) {
                showError('Selected scenario does not have factor-based configuration. ' +
                         'Please select a factor-based scenario or configure factors first.');
            } else {
                hideError();
            }
        }
    });
    
    // Form submission handler
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const baseYear = parseInt(document.getElementById('baseYearSelect').value);
        const endYear = parseInt(document.getElementById('endYearSelect').value);
        const viewMode = viewModeSelect.value;
        
        if (viewMode === 'comparison') {
            // Multi-scenario comparison
            const selectedScenarios = Array.from(
                document.querySelectorAll('.scenario-checkbox:checked')
            ).map(cb => parseInt(cb.value));

            if (selectedScenarios.length === 0) {
                showError('Please select at least one scenario to compare');
                return;
            }

            compareScenarios(baseYear, endYear, selectedScenarios);
        } else {
            // Single projection
            const scenario = document.getElementById('scenarioSelect').value;

            calculateProjection(baseYear, endYear, scenario, viewMode);
        }
    });
    
    function calculateProjection(baseYear, endYear, scenario, viewMode) {
        showLoading();
        hideError();

        // Check if this is a factor-based scenario
        const scenarioSelect = document.getElementById('scenarioSelect');
        const selectedOption = scenarioSelect.options[scenarioSelect.selectedIndex];
        const scenarioId = selectedOption.dataset.scenarioId;
        const hasFactors = selectedOption.dataset.hasFactors === 'true';

        const requestData = {
            base_year: baseYear,
            end_year: endYear,
            scenario_id: parseInt(scenarioId)
        };

        fetch('{% url "powermatchui:calculate_demand_projection" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.error) {
                showError(data.error);
            } else {
                // Check if this is a factor-based projection
                if (data.projection_type === 'factor_based' && viewMode === 'breakdown') {
                    plotFactorBreakdown(data);
                } else {
                    plotProjection(data, viewMode);
                }
                updateSummaryStats(data);
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error calculating projection: ' + error.message);
        });
    }
    
    function compareScenarios(baseYear, endYear, scenarioIds) {
        showLoading();
        hideError();

        const requestData = {
            base_year: baseYear,
            end_year: endYear,
            scenario_ids: scenarioIds
        };
        
        fetch('{% url "powermatchui:compare_scenarios" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.error) {
                showError(data.error);
            } else {
                plotScenarioComparison(data);
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error comparing scenarios: ' + error.message);
        });
    }
    
    function plotProjection(data, viewMode) {
        const traces = [];
        
        if (viewMode === 'breakdown') {
            // Show operational, underlying, and total as separate traces
            traces.push({
                x: data.years,
                y: data.operational_total_gwh,
                name: 'Operational Demand',
                type: 'scatter',
                mode: 'lines',
                line: { color: 'rgb(55, 128, 191)', width: 2 },
                stackgroup: 'one'
            });
            
            traces.push({
                x: data.years,
                y: data.underlying_total_gwh,
                name: 'Underlying Demand',
                type: 'scatter',
                mode: 'lines',
                line: { color: 'rgb(50, 171, 96)', width: 2 },
                stackgroup: 'one'
            });
        } else {
            // Show total only
            traces.push({
                x: data.years,
                y: data.total_gwh,
                name: 'Total Demand',
                type: 'scatter',
                mode: 'lines',
                line: { color: 'rgb(219, 64, 82)', width: 3 }
            });
        }
        
        const layout = {
            title: 'Electricity Demand Projection',
            xaxis: {
                title: 'Year',
                showgrid: true
            },
            yaxis: {
                title: 'Annual Demand (GWh)',
                showgrid: true
            },
            hovermode: 'x unified',
            showlegend: true,
            legend: {
                x: 0.02,
                y: 0.98,
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: '#666',
                borderwidth: 1
            }
        };
        
        Plotly.newPlot(demandPlot, traces, layout, getPlotConfig());
    }

    function plotFactorBreakdown(data) {
        // Create stacked area chart showing individual factor contributions
        const traces = [];
        const colors = [
            'rgb(55, 128, 191)',   // Blue - EV
            'rgb(50, 171, 96)',    // Green - Industrial
            'rgb(219, 64, 82)',    // Red - Hydrogen
            'rgb(255, 127, 14)',   // Orange - Data Centers
            'rgb(148, 103, 189)',  // Purple - HVAC
            'rgb(140, 86, 75)',    // Brown
            'rgb(227, 119, 194)',  // Pink
            'rgb(127, 127, 127)'   // Gray
        ];

        let colorIdx = 0;

        // Add traces for operational factors
        if (data.factor_breakdown_operational_gwh) {
            for (const [factorName, factorValues] of Object.entries(data.factor_breakdown_operational_gwh)) {
                traces.push({
                    x: data.years,
                    y: factorValues,
                    name: factorName + ' (Op)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { width: 0 },
                    fillcolor: colors[colorIdx % colors.length],
                    fill: 'tonexty',
                    stackgroup: 'operational',
                    hovertemplate: '<b>%{fullData.name}</b><br>' +
                                   'Year: %{x}<br>' +
                                   'Demand: %{y:.0f} GWh<br>' +
                                   '<extra></extra>'
                });
                colorIdx++;
            }
        }

        // Add traces for underlying factors
        if (data.factor_breakdown_underlying_gwh) {
            for (const [factorName, factorValues] of Object.entries(data.factor_breakdown_underlying_gwh)) {
                traces.push({
                    x: data.years,
                    y: factorValues,
                    name: factorName + ' (Und)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { width: 0 },
                    fillcolor: colors[colorIdx % colors.length],
                    fill: 'tonexty',
                    stackgroup: 'underlying',
                    hovertemplate: '<b>%{fullData.name}</b><br>' +
                                   'Year: %{x}<br>' +
                                   'Demand: %{y:.0f} GWh<br>' +
                                   '<extra></extra>'
                });
                colorIdx++;
            }
        }

        const layout = {
            title: 'Factor-Based Demand Projection Breakdown',
            xaxis: {
                title: 'Year',
                showgrid: true
            },
            yaxis: {
                title: 'Annual Demand (GWh)',
                showgrid: true
            },
            hovermode: 'x unified',
            showlegend: true,
            legend: {
                x: 1.02,
                y: 1,
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: '#666',
                borderwidth: 1,
                orientation: 'v'
            },
            margin: {
                r: 200  // Extra space for legend
            }
        };

        Plotly.newPlot(demandPlot, traces, layout, getPlotConfig());
    }

    function plotScenarioComparison(data) {
        const traces = [];
        const colors = [
            'rgb(55, 128, 191)', 
            'rgb(50, 171, 96)', 
            'rgb(219, 64, 82)',
            'rgb(255, 127, 14)',
            'rgb(148, 103, 189)'
        ];
        
        let colorIdx = 0;
        for (const [scenarioName, scenarioData] of Object.entries(data.scenarios)) {
            traces.push({
                x: data.years,
                y: scenarioData.total_gwh,
                name: scenarioName,
                type: 'scatter',
                mode: 'lines',
                line: { 
                    color: colors[colorIdx % colors.length], 
                    width: 2 
                }
            });
            colorIdx++;
        }
        
        const layout = {
            title: 'Demand Projection Scenario Comparison',
            xaxis: {
                title: 'Year',
                showgrid: true
            },
            yaxis: {
                title: 'Annual Demand (GWh)',
                showgrid: true
            },
            hovermode: 'x unified',
            showlegend: true,
            legend: {
                x: 0.02,
                y: 0.98,
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: '#666',
                borderwidth: 1
            }
        };
        
        Plotly.newPlot(demandPlot, traces, layout, getPlotConfig());
        
        // Update summary for first scenario
        const firstScenario = Object.values(data.scenarios)[0];
        updateSummaryStats({
            years: data.years,
            total_gwh: firstScenario.total_gwh,
            config: {}
        });
    }
    
    function updateSummaryStats(data) {
        const baseYearIdx = 0;
        const endYearIdx = data.years.length - 1;

        const baseDemand = data.total_gwh[baseYearIdx];
        const endDemand = data.total_gwh[endYearIdx];
        const totalGrowth = ((endDemand - baseDemand) / baseDemand * 100);
        const numYears = data.years[endYearIdx] - data.years[baseYearIdx];
        const avgGrowth = Math.pow(endDemand / baseDemand, 1 / numYears) - 1;

        document.getElementById('baseYearDemand').textContent =
            baseDemand.toFixed(0);
        document.getElementById('endYearDemand').textContent =
            endDemand.toFixed(0);
        document.getElementById('totalGrowth').textContent =
            totalGrowth.toFixed(1) + '%';
        document.getElementById('avgGrowth').textContent =
            (avgGrowth * 100).toFixed(2) + '%';

        // Update config details
        if (data.projection_type === 'factor_based') {
            // Show factor-based summary
            let factorSummary = '<strong>Factor-Based Projection</strong><br>';

            if (data.factor_breakdown_operational_gwh) {
                factorSummary += '<br><em>Operational Factors:</em> ';
                const opFactors = Object.keys(data.factor_breakdown_operational_gwh);
                factorSummary += opFactors.join(', ');
            }

            if (data.factor_breakdown_underlying_gwh) {
                factorSummary += '<br><em>Underlying Factors:</em> ';
                const undFactors = Object.keys(data.factor_breakdown_underlying_gwh);
                factorSummary += undFactors.join(', ');
            }

            document.getElementById('configDetails').innerHTML = factorSummary;
        } else if (data.config) {
            // Show legacy config summary
            const configText = `
                Operational Growth: ${(data.config.operational_growth_rate * 100).toFixed(1)}%
                (${data.config.operational_growth_type}),
                Underlying Growth: ${(data.config.underlying_growth_rate * 100).toFixed(1)}%
                (${data.config.underlying_growth_type})
            `;
            document.getElementById('configDetails').textContent = configText;
        }
    }
    
    function getPlotConfig() {
        return {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
            displaylogo: false
        };
    }
    
    function showLoading() {
        loadingIndicator.style.display = 'block';
        demandPlot.style.display = 'none';
    }
    
    function hideLoading() {
        loadingIndicator.style.display = 'none';
        demandPlot.style.display = 'block';
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
    }
    
    function hideError() {
        errorMessage.style.display = 'none';
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ========================================================================
    // UPDATE TARGET SCENARIO FUNCTIONALITY
    // ========================================================================

    const updateTargetScenarioBtn = document.getElementById('updateTargetScenarioBtn');
    const updateTargetScenarioModal = new bootstrap.Modal(document.getElementById('updateTargetScenarioModal'));
    const confirmUpdateBtn = document.getElementById('confirmUpdateBtn');
    let currentProjectionData = null;

    // Initially hide the update button until a projection is generated
    if (updateTargetScenarioBtn) {
        updateTargetScenarioBtn.style.display = 'none';
    }

    // Show update button after successful projection generation
    function enableUpdateTargetScenario(data) {
        currentProjectionData = data;
        if (updateTargetScenarioBtn && data.projection_type === 'factor_based') {
            updateTargetScenarioBtn.style.display = 'inline-block';
        }
    }

    // Handle update button click - show modal with warning
    if (updateTargetScenarioBtn) {
        updateTargetScenarioBtn.addEventListener('click', function() {
            if (!currentProjectionData) {
                showError('Please generate a projection first');
                return;
            }

            const baseYear = parseInt(document.getElementById('baseYearSelect').value);
            const endYear = parseInt(document.getElementById('endYearSelect').value);
            const scenarioSelect = document.getElementById('scenarioSelect');
            const selectedOption = scenarioSelect.options[scenarioSelect.selectedIndex];
            const scenarioTitle = selectedOption.textContent;

            // Populate modal with projection details
            document.getElementById('modalBaseYear').textContent = baseYear;
            document.getElementById('modalEndYear').textContent = endYear;
            document.getElementById('modalScenario').textContent = scenarioTitle;
            document.getElementById('modalYearRange').textContent = `${baseYear} - ${endYear} (${endYear - baseYear + 1} years)`;

            // Pre-populate the target scenario name with the scenario title
            document.getElementById('targetScenarioNameInput').value = scenarioTitle;

            // Show the modal
            updateTargetScenarioModal.show();
        });
    }

    // Handle confirm update button in modal
    if (confirmUpdateBtn) {
        confirmUpdateBtn.addEventListener('click', function() {
            const targetScenarioName = document.getElementById('targetScenarioNameInput').value.trim();

            if (!targetScenarioName) {
                alert('Please enter a Target Scenario Name');
                return;
            }

            if (!currentProjectionData) {
                alert('No projection data available');
                updateTargetScenarioModal.hide();
                return;
            }

            // Disable button during update
            confirmUpdateBtn.disabled = true;
            confirmUpdateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';

            const baseYear = parseInt(document.getElementById('baseYearSelect').value);
            const endYear = parseInt(document.getElementById('endYearSelect').value);
            const scenarioSelect = document.getElementById('scenarioSelect');
            const selectedOption = scenarioSelect.options[scenarioSelect.selectedIndex];
            const scenarioId = parseInt(selectedOption.dataset.scenarioId);

            const requestData = {
                base_year: baseYear,
                end_year: endYear,
                scenario_id: scenarioId,
                target_scenario_name: targetScenarioName
            };

            fetch('{% url "powermatchui:update_target_scenario_with_projection" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                confirmUpdateBtn.disabled = false;
                confirmUpdateBtn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Update';

                if (data.error) {
                    alert('Error: ' + data.error);
                } else if (data.success) {
                    // Show success message
                    const message = `Successfully updated TargetScenario!\n\n` +
                                  `Scenario Name: ${data.scenario_name}\n` +
                                  `Total Years: ${data.total_years}\n` +
                                  `Created: ${data.years_created.length} records\n` +
                                  `Updated: ${data.years_updated.length} records\n` +
                                  `Year Range: ${data.year_range[0]} - ${data.year_range[1]}`;
                    alert(message);

                    // Hide modal
                    updateTargetScenarioModal.hide();

                    // Show success indicator on button
                    updateTargetScenarioBtn.classList.remove('btn-warning');
                    updateTargetScenarioBtn.classList.add('btn-success');
                    setTimeout(() => {
                        updateTargetScenarioBtn.classList.remove('btn-success');
                        updateTargetScenarioBtn.classList.add('btn-warning');
                    }, 3000);
                }
            })
            .catch(error => {
                confirmUpdateBtn.disabled = false;
                confirmUpdateBtn.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Update';
                alert('Error updating TargetScenario: ' + error.message);
            });
        });
    }

    // Modify the existing plotProjection and plotFactorBreakdown functions
    // to enable the update button after successful projection
    const originalPlotProjection = plotProjection;
    plotProjection = function(data, viewMode) {
        originalPlotProjection(data, viewMode);
        enableUpdateTargetScenario(data);
    };

    const originalPlotFactorBreakdown = plotFactorBreakdown;
    plotFactorBreakdown = function(data) {
        originalPlotFactorBreakdown(data);
        enableUpdateTargetScenario(data);
    };
});
</script>

<style>
.form-range {
    cursor: pointer;
}

.form-check {
    padding: 0.5rem 0;
}

#summaryStats .card {
    transition: transform 0.2s;
}

#summaryStats .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

{% endblock %}