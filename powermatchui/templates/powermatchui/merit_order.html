{% extends 'base.html' %}

{% block title %}Home | My Website{% endblock %}

{% block content %}
<form method="post">
    {% csrf_token %}
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Merit Order</div>
                    <div class="card-body">
                        <ul id="merit-order-list" class="list-group">
                            {% for id, values in merit_order.items %}
                                {% with name=values.0 emissions=values.1 %}
                                    <li class="list-group-item" id="{{ id }}" draggable="true" data-emissions="{{ emissions }}">{{ name }}</li>
                                    <input type="hidden" name="merit_order[]" value="{{ id }}">
                                {% endwith %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Excluded Resources</div>
                    <div class="card-body">
                        <ul id="excluded-resources-list" class="list-group">
                            {% for id, values in excluded_resources.items %}
                                {% with name=values.0 emissions=values.1 %}
                                    <li class="list-group-item" id="{{ id }}" draggable="true" data-emissions="{{ emissions }}">{{ name }}</li>
                                    <input type="hidden" name="merit_order[]" value="{{ id }}">
                                {% endwith %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button type="submit" class="btn btn-primary mt-3">Save Merit Order</button>
</form>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>

<script>
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.addEventListener('dragstart', event => {
            event.dataTransfer.setData('text/plain', item.id);
        });
        document.querySelectorAll('.list-group-item').forEach(item => {
            let emissions = item.getAttribute('data-emissions');
            let hexColor = emissions;  // Keep the color code as a string
            item.style.setProperty('--bs-list-group-bg', hexColor);
        });
    });

    $(function() {
        // Make the containers sortable
        $('.list-group').sortable({
            connectWith: '.list-group', // Allow sorting between containers
            tolerance: 'pointer', // Use pointer for more precise sorting
            helper: 'clone', // Use a clone as the dragging helper
            start: function(event, ui) {
                // Add a class to the dragged item for styling
                ui.item.addClass('dragging');
            },
            stop: function(event, ui) {
                // Remove the dragging class when dragging stops
                ui.item.removeClass('dragging');
            },
            receive: function(event, ui) {
                // Handle the dropped item
                var droppedItem = ui.item;
                var targetList = droppedItem.parent();
                var targetId = targetList.attr('id');
                var itemId = droppedItem.attr('id');

                // Update any associated hidden input fields
                var inputField = $('input[name="' + targetId + '"][value="' + itemId + '"]');
                if (inputField.length === 0) {
                    // Create a new hidden input field if it doesn't exist
                    $('<input>').attr({
                        type: 'hidden',
                        name: targetId,
                        value: itemId
                    }).appendTo('form');
                }
            }
        });

        // Prevent the default drag and drop behavior for the entire document
        $(document).on('dragover', function(event) {
            event.preventDefault();
        });

        $(document).on('drop', function(event) {
            event.preventDefault();
        });
    });
</script>
{% endblock %}
