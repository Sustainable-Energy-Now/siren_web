{% extends 'powermatchui_base.html' %}
{% load static %}
{% block powermatchui_content %}
<!-- template.html -->
{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}
<div class="container-fluid p-4">
    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
        {% csrf_token %}
        <input type="hidden" name="action" id="action" value="save">
        <!-- File inputs section -->
        <div class="row mb-3">
            <div class="col-md-8">
                <!-- Constraints File Row -->
                <div class="row mb-2">
                    <div class="col-md-2">
                        <label for="{{ form.constraints_file.id_for_label }}" class="form-label">{{ form.constraints_file.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.constraints_file }}
                    </div>
                </div>

                <!-- Constraints Sheet Row -->
                <div class="row mb-2">
                    <div class="col-md-2">
                        <label for="{{ form.constraints_sheet.id_for_label }}" class="form-label">{{ form.constraints_sheet.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.constraints_sheet }}
                    </div>
                    <div class="col-md-2">
                        <span class="form-text">Constraints</span>
                    </div>
                </div>

                <!-- Generators File Row -->
                <div class="row mb-2">
                    <div class="col-md-2">
                        <label for="{{ form.generators_file.id_for_label }}" class="form-label">{{ form.generators_file.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.generators_file }}
                    </div>
                </div>

                <!-- Generators Sheet Row -->
                <div class="row mb-2">
                    <div class="col-md-2">
                        <label for="{{ form.generators_sheet.id_for_label }}" class="form-label">{{ form.generators_sheet.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.generators_sheet }}
                    </div>
                    <div class="col-md-2">
                        <span class="form-text">Generators</span>
                    </div>
                </div>

                <!-- Optimisation File Row -->
                <div class="row mb-2">
                    <div class="col-md-2">
                        <label for="{{ form.optimisation_file.id_for_label }}" class="form-label">{{ form.optimisation_file.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.optimisation_file }}
                    </div>
                </div>

                <!-- Optimisation Sheet Row -->
                <div class="row mb-2">
                    <div class="col-md-2">
                        <label for="{{ form.optimisation_sheet.id_for_label }}" class="form-label">{{ form.optimisation_sheet.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.optimisation_sheet }}
                    </div>
                    <div class="col-md-2">
                        <span class="form-text">Optimisation</span>
                    </div>
                </div>

                <!-- Data File Row -->
                <div class="row mb-2">
                    <div class="col-md-2">
                        <label for="{{ form.data_file.id_for_label }}" class="form-label">{{ form.data_file.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.data_file }}
                    </div>
                </div>
                <!-- Load Year Row -->
                <div class="row mb-2">
                    <div class="col-md-2">
                        <label for="{{ form.load_year.id_for_label }}" class="form-label">{{ form.load_year.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.load_year }}
                        <div class="form-text">{{ form.load_year.help_text }}</div>
                    </div>
                </div>

                <!-- Results File Row -->
                <div class="row mb-2">
                    <div class="col-md-2">
                        <label for="{{ form.results_file.id_for_label }}" class="form-label">{{ form.results_file.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.results_file }}
                    </div>
                </div>

                <!-- Batch File Row -->
                <div class="row mb-2">
                    <div class="col-md-2">
                        <label for="{{ form.batch_file.id_for_label }}" class="form-label">{{ form.batch_file.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.batch_file }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings section -->
        <div class="row mb-3">
            <div class="col-md-6">
                <!-- Replace Last Checkbox -->
                <div class="row mb-2">
                    <div class="col-md-8">
                        <div class="form-check">
                            {{ form.replace_last }}
                            <label class="form-check-label" for="{{ form.replace_last.id_for_label }}">
                                {{ form.replace_last.label }}
                            </label>
                            <div class="form-text">{{ form.replace_last.help_text }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            {{ form.prefix_facility }}
                            <label class="form-check-label" for="{{ form.prefix_facility.id_for_label }}">
                                {{ form.prefix_facility.label }}
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Discount Rate Row -->
                <div class="row mb-2">
                    <div class="col-md-4">
                        <label for="{{ form.discount_rate.id_for_label }}" class="form-label">{{ form.discount_rate.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.discount_rate }}
                        <div class="form-text">{{ form.discount_rate.help_text }}</div>
                    </div>
                </div>

                <!-- Carbon Price Row -->
                <div class="row mb-2">
                    <div class="col-md-4">
                        <label for="{{ form.carbon_price.id_for_label }}" class="form-label">{{ form.carbon_price.label }}</label>
                    </div>
                    <div class="col-md-8">
                        {{ form.carbon_price }}
                        <div class="form-text">{{ form.carbon_price.help_text }}</div>
                    </div>
                </div>
            </div>
        </div>
<!-- Replace the existing generator columns section in your template with this -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="form-check mb-2">
            {{ form.adjust_generators }}
            <label class="form-check-label" for="{{ form.adjust_generators.id_for_label }}">
                {{ form.adjust_generators.label }}
            </label>
            <div class="form-text">{{ form.adjust_generators.help_text }}</div>
        </div>
        
        <input type="hidden" name="generator_columns" id="generator-columns">
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Base Load Generators</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-group" id="left-generators">
                            <!-- Will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Renewable Generators</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-group" id="right-generators">
                            <!-- Will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- In your template, before the closing </div> of the generator columns section -->
        <script>
            // Add this before the DOMContentLoaded event handler
            const initialGeneratorColumns = {{ form.initial_generator_columns|safe|default:'{"leftColumn":[],"rightColumn":[]}' }};
        </script>
    </div>

        <!-- Button row -->
        <div class="row">
            <div class="col-md-12">
                <div class="btn-group" role="group">
                    <button type="submit" class="btn btn-secondary" onclick="document.getElementById('action').value='Save'">Save</button>
                    <button type="submit" class="btn btn-secondary" onclick="document.getElementById('action').value='Summary'">Summary</button>
                    <button type="submit" class="btn btn-secondary" onclick="document.getElementById('action').value='Detail'">Detail</button>
                    <button type="submit" class="btn btn-secondary" onclick="document.getElementById('action').value='Batch'">Batch</button>
                    <button type="submit" class="btn btn-secondary" onclick="document.getElementById('action').value='Transition'">Transition</button>
                    <button type="submit" class="btn btn-secondary" onclick="document.getElementById('action').value='Optimise'">Optimise</button>
                    <button type="submit" class="btn btn-secondary" onclick="document.getElementById('action').value='Help'">Help</button>
                </div>
            </div>
        </div>
    </form>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.querySelector('input[type="file"]');
        const serverFileSelects = document.querySelectorAll('.server-file-select');
        // Initialize the sortable lists
        const leftList = document.getElementById('left-generators');
        const rightList = document.getElementById('right-generators');
        const hiddenInput = document.getElementById('generator-columns');
        // Function to create list item
        function createListItem(generator) {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';
            li.style.cursor = 'grab';
            li.textContent = generator;
            return li;
        }

        // Populate left column
        initialGeneratorColumns.leftColumn.forEach(generator => {
            leftList.appendChild(createListItem(generator));
        });

        // Populate right column
        initialGeneratorColumns.rightColumn.forEach(generator => {
            rightList.appendChild(createListItem(generator));
        });
        // Create sortable instance for left column
        new Sortable(leftList, {
            group: 'generators', // Both lists belong to same group
            animation: 150,
            ghostClass: 'bg-light',
            onEnd: updateGeneratorColumns
        });

        // Create sortable instance for right column
        new Sortable(rightList, {
            group: 'generators',
            animation: 150,
            ghostClass: 'bg-light',
            onEnd: updateGeneratorColumns
        });

    // Function to update hidden input with current column states
    function updateGeneratorColumns() {
        const leftGenerators = Array.from(leftList.children).map(item => item.textContent.trim());
        const rightGenerators = Array.from(rightList.children).map(item => item.textContent.trim());
        
        const generatorData = {
            leftColumn: leftGenerators,
            rightColumn: rightGenerators
        };

        hiddenInput.value = JSON.stringify(generatorData);
    }
    // Initial update of hidden input
    updateGeneratorColumns();
        
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                if (!this.files.length) return;
                
                const formData = new FormData();
                formData.append('file', this.files[0]);
                
                fetch('/upload-file/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update all select fields with new file list
                        const options = data.files.map(file => 
                            `<option value="${file}">${file}</option>`
                        );
                        
                        serverFileSelects.forEach(select => {
                            const currentValue = select.value;
                            select.innerHTML = '<option value="">-- Select a file --</option>' + options.join('');
                            // Preserve current selection if it still exists
                            if (data.files.includes(currentValue)) {
                                select.value = currentValue;
                            }
                        });
                        
                        // Clear file input
                        fileInput.value = '';
                        
                        // Show success message
                        alert('File uploaded successfully');
                    } else {
                        alert(data.error || 'Upload failed');
                    }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    alert('Upload failed');
                });
            });
        }
        
        // Helper function to get CSRF token
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
    });
</script>
{% endblock %}
