<!-- templates/edit_help.html -->
{% extends 'base.html' %}

{% block title %}Edit Help Template - Siren-Web{% endblock %}

{% block extra_css %}
<style>
    .template-editor {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 14px;
        line-height: 1.4;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .markdown-preview {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        background-color: #f8f9fa;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .variable-help {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin: 15px 0;
    }
    
    .variable-tag {
        background-color: #e1f5fe;
        color: #0277bd;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9em;
    }

    /* Search functionality styles */
    .search-container {
        position: relative;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .search-input-group {
        display: flex;
        gap: 5px;
        align-items: center;
    }

    .search-input {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        font-size: 14px;
    }

    .search-controls {
        display: flex;
        gap: 5px;
    }

    .search-btn {
        padding: 6px 12px;
        border: 1px solid #ced4da;
        background: #fff;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
    }

    .search-btn:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }

    .search-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .search-info {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
    }

    .search-highlight {
        background-color: #fff3cd !important;
        border: 1px solid #ffeaa7;
    }

    .search-current-highlight {
        background-color: #f093fb !important;
        color: white !important;
    }

    /* Keyboard shortcut info */
    .keyboard-shortcuts {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 12px;
        color: #6c757d;
    }

    .shortcut-key {
        background: #e9ecef;
        padding: 1px 4px;
        border-radius: 2px;
        font-family: monospace;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Edit Siren-Web Help Template</h2>
        </div>
    </div>
    
    <form method="post" class="row">
        {% csrf_token %}
        
        <!-- Editor Column -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Template Editor</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                onclick="insertAtCursor('## ')">Add Heading</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                onclick="insertAtCursor('| Column 1 | Column 2 |\n|----------|----------|\n| Data 1   | Data 2   |')">Add Table</button>
                    </div>
                </div>
                
                <!-- Search Container -->
                <div class="search-container">
                    <div class="search-input-group">
                        <input type="text" id="searchInput" class="search-input" placeholder="Find in document..." />
                        <div class="search-controls">
                            <button type="button" class="search-btn" id="findPrevBtn" title="Previous (Shift+F3)">‚Üë</button>
                            <button type="button" class="search-btn" id="findNextBtn" title="Next (F3)">‚Üì</button>
                            <button type="button" class="search-btn" id="replaceBtn" title="Replace">Replace</button>
                            <button type="button" class="search-btn" id="clearSearchBtn" title="Clear (Esc)">‚úï</button>
                        </div>
                    </div>
                    <div class="search-info" id="searchInfo"></div>
                    
                    <!-- Replace functionality (initially hidden) -->
                    <div id="replaceContainer" style="display: none; margin-top: 10px;">
                        <div class="search-input-group">
                            <input type="text" id="replaceInput" class="search-input" placeholder="Replace with..." />
                            <div class="search-controls">
                                <button type="button" class="search-btn" id="replaceOneBtn">Replace</button>
                                <button type="button" class="search-btn" id="replaceAllBtn">Replace All</button>
                                <button type="button" class="search-btn" id="cancelReplaceBtn">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Keyboard shortcuts info -->
                <div class="keyboard-shortcuts">
                    <strong>Keyboard Shortcuts:</strong> 
                    <span class="shortcut-key">Ctrl+F</span> Find ‚Ä¢ 
                    <span class="shortcut-key">F3</span> Next ‚Ä¢ 
                    <span class="shortcut-key">Shift+F3</span> Previous ‚Ä¢ 
                    <span class="shortcut-key">Ctrl+H</span> Replace ‚Ä¢ 
                    <span class="shortcut-key">Esc</span> Close search
                </div>
                
                <div class="card-body p-0">
                    <textarea name="template_content" id="templateEditor" class="form-control template-editor" 
                              rows="25" required>{{ template_content }}</textarea>
                </div>
                <div class="card-footer">
                    <button type="submit" name="action" value="save" class="btn btn-primary">
                        üíæ Save Template
                    </button>
                    <button type="submit" name="action" value="generate" class="btn btn-success">
                        üîÑ Save & Generate Help
                    </button>
                    <a href="{% url 'display_help_html' %}" class="btn btn-outline-secondary">
                        üìñ View Current Help
                    </a>
                </div>
            </div>
        </div>

        <!-- Sidebar Column -->
        <div class="col-lg-4">
            <!-- Markdown Reference -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">üìù Markdown Quick Reference</h6>
                </div>
                <div class="card-body small">
                    <p><strong>Headers:</strong></p>
                    <code># H1<br>## H2<br>### H3</code>
                    
                    <p class="mt-2"><strong>Emphasis:</strong></p>
                    <code>**bold**<br>*italic*</code>
                    
                    <p class="mt-2"><strong>Lists:</strong></p>
                    <code>- Item 1<br>- Item 2</code>
                    
                    <p class="mt-2"><strong>Links:</strong></p>
                    <code>[text](url)</code>
                    
                    <p class="mt-2"><strong>Tables:</strong></p>
                    <code>| Col1 | Col2 |<br>|------|------|<br>| Data | Data |</code>
                    
                    <p class="mt-2"><strong>Blockquotes:</strong></p>
                    <code>> Important note</code>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Editor functionality
    function insertAtCursor(text) {
        const textarea = document.querySelector('textarea[name="template_content"]');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const currentValue = textarea.value;
        
        textarea.value = currentValue.substring(0, start) + text + currentValue.substring(end);
        textarea.focus();
        textarea.setSelectionRange(start + text.length, start + text.length);
    }

    // Search and Replace Functionality
    class MarkdownSearch {
        constructor() {
            this.textarea = document.getElementById('templateEditor');
            this.searchInput = document.getElementById('searchInput');
            this.replaceInput = document.getElementById('replaceInput');
            this.searchInfo = document.getElementById('searchInfo');
            this.replaceContainer = document.getElementById('replaceContainer');
            
            this.matches = [];
            this.currentMatchIndex = -1;
            this.originalContent = '';
            
            this.initializeEventListeners();
        }

        initializeEventListeners() {
            // Search input events
            this.searchInput.addEventListener('input', () => this.performSearch());
            this.searchInput.addEventListener('keydown', (e) => this.handleSearchKeydown(e));
            
            // Button events
            document.getElementById('findNextBtn').addEventListener('click', () => this.findNext());
            document.getElementById('findPrevBtn').addEventListener('click', () => this.findPrevious());
            document.getElementById('clearSearchBtn').addEventListener('click', () => this.clearSearch());
            document.getElementById('replaceBtn').addEventListener('click', () => this.toggleReplace());
            
            // Replace events
            document.getElementById('replaceOneBtn').addEventListener('click', () => this.replaceOne());
            document.getElementById('replaceAllBtn').addEventListener('click', () => this.replaceAll());
            document.getElementById('cancelReplaceBtn').addEventListener('click', () => this.toggleReplace());
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => this.handleGlobalKeydown(e));
            
            // Store original content
            this.originalContent = this.textarea.value;
        }

        handleGlobalKeydown(e) {
            // Ctrl+F or Cmd+F - Open search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                this.focusSearch();
            }
            
            // Ctrl+H or Cmd+H - Open replace
            if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                e.preventDefault();
                this.showReplace();
                this.focusSearch();
            }
            
            // F3 - Find next
            if (e.key === 'F3' && !e.shiftKey) {
                e.preventDefault();
                this.findNext();
            }
            
            // Shift+F3 - Find previous
            if (e.key === 'F3' && e.shiftKey) {
                e.preventDefault();
                this.findPrevious();
            }
            
            // Escape - Clear search
            if (e.key === 'Escape') {
                this.clearSearch();
            }
        }

        handleSearchKeydown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (e.shiftKey) {
                    this.findPrevious();
                } else {
                    this.findNext();
                }
            }
        }

        focusSearch() {
            this.searchInput.focus();
            this.searchInput.select();
        }

        performSearch() {
            const searchTerm = this.searchInput.value.trim();
            
            if (!searchTerm) {
                this.clearMatches();
                return;
            }

            const wasSearchFocused = document.activeElement === this.searchInput;

            this.findMatches(searchTerm);
            this.updateSearchInfo();
            
            if (this.matches.length > 0) {
                this.currentMatchIndex = 0;
                this.highlightCurrentMatch();
            }

            // Keep focus in search field during typing
            if (wasSearchFocused) {
                this.searchInput.focus();
            }
        }

        findMatches(searchTerm) {
            this.matches = [];
            const content = this.textarea.value;
            const regex = new RegExp(this.escapeRegExp(searchTerm), 'gi');
            let match;

            while ((match = regex.exec(content)) !== null) {
                this.matches.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    text: match[0]
                });
            }
        }

        escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        updateSearchInfo() {
            if (this.matches.length === 0) {
                this.searchInfo.textContent = this.searchInput.value ? 'No matches found' : '';
                this.updateButtonStates(false);
            } else {
                this.searchInfo.textContent = `${this.currentMatchIndex + 1} of ${this.matches.length} matches`;
                this.updateButtonStates(true);
            }
        }

        updateButtonStates(hasMatches) {
            document.getElementById('findNextBtn').disabled = !hasMatches;
            document.getElementById('findPrevBtn').disabled = !hasMatches;
            document.getElementById('replaceBtn').disabled = !hasMatches;
        }

        highlightCurrentMatch() {
            if (this.matches.length === 0 || this.currentMatchIndex < 0) return;

            const match = this.matches[this.currentMatchIndex];
            
            // Store current focus element
            const activeElement = document.activeElement;
            
            // Set selection to highlight the match
            this.textarea.setSelectionRange(match.start, match.end);
            
            // Scroll to the match
            this.scrollToMatch(match);
            
            // Restore focus to the original element (keep cursor in search field)
            if (activeElement && activeElement !== this.textarea) {
                activeElement.focus();
            }
            
            this.updateSearchInfo();
        }

        scrollToMatch(match) {
            // Calculate line number of the match
            const contentBeforeMatch = this.textarea.value.substring(0, match.start);
            const lineNumber = (contentBeforeMatch.match(/\n/g) || []).length;
            
            // Calculate scroll position
            const lineHeight = parseInt(getComputedStyle(this.textarea).lineHeight) || 20;
            const scrollTop = lineNumber * lineHeight - (this.textarea.clientHeight / 2);
            
            // Scroll to position
            this.textarea.scrollTop = Math.max(0, scrollTop);
        }

        findNext() {
            if (this.matches.length === 0) return;
            
            const wasSearchFocused = document.activeElement === this.searchInput;
            
            this.currentMatchIndex = (this.currentMatchIndex + 1) % this.matches.length;
            this.highlightCurrentMatch();
            
            // Keep focus in search field if it was focused
            if (wasSearchFocused) {
                this.searchInput.focus();
            }
        }

        findPrevious() {
            if (this.matches.length === 0) return;
            
            const wasSearchFocused = document.activeElement === this.searchInput;
            
            this.currentMatchIndex = this.currentMatchIndex <= 0 
                ? this.matches.length - 1 
                : this.currentMatchIndex - 1;
            this.highlightCurrentMatch();
            
            // Keep focus in search field if it was focused
            if (wasSearchFocused) {
                this.searchInput.focus();
            }
        }

        toggleReplace() {
            const isVisible = this.replaceContainer.style.display !== 'none';
            this.replaceContainer.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                this.replaceInput.focus();
            }
        }

        showReplace() {
            this.replaceContainer.style.display = 'block';
        }

        replaceOne() {
            if (this.matches.length === 0 || this.currentMatchIndex < 0) return;
            
            const match = this.matches[this.currentMatchIndex];
            const replaceText = this.replaceInput.value;
            
            // Replace the text
            const content = this.textarea.value;
            const newContent = content.substring(0, match.start) + 
                               replaceText + 
                               content.substring(match.end);
            
            this.textarea.value = newContent;
            
            // Update cursor position
            const newCursorPos = match.start + replaceText.length;
            this.textarea.setSelectionRange(newCursorPos, newCursorPos);
            
            // Refresh search
            this.performSearch();
        }

        replaceAll() {
            if (this.matches.length === 0) return;
            
            const searchTerm = this.searchInput.value;
            const replaceText = this.replaceInput.value;
            
            if (!searchTerm) return;
            
            const regex = new RegExp(this.escapeRegExp(searchTerm), 'gi');
            const newContent = this.textarea.value.replace(regex, replaceText);
            
            this.textarea.value = newContent;
            
            // Show replacement count
            const replacementCount = this.matches.length;
            this.searchInfo.textContent = `Replaced ${replacementCount} occurrence${replacementCount !== 1 ? 's' : ''}`;
            
            // Clear matches
            this.clearMatches();
        }

        clearSearch() {
            this.searchInput.value = '';
            this.replaceInput.value = '';
            this.replaceContainer.style.display = 'none';
            this.clearMatches();
            this.textarea.focus();
        }

        clearMatches() {
            this.matches = [];
            this.currentMatchIndex = -1;
            this.searchInfo.textContent = '';
            this.updateButtonStates(false);
        }
    }

    // Auto-save functionality
    let autoSaveTimeout;
    const textarea = document.querySelector('textarea[name="template_content"]');
    
    textarea.addEventListener('input', function() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            // Save to localStorage as backup
            localStorage.setItem('sirenweb_help_template_backup', this.value);
        }, 5000); // Auto-save after 5 seconds of inactivity
    });
    
    // Restore from localStorage if available
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize search functionality
        new MarkdownSearch();
        
        // Auto-save restoration
        const backup = localStorage.getItem('sirenweb_help_template_backup');
        if (backup && backup !== textarea.value) {
            if (confirm('A newer version of your template was found in local storage. Would you like to restore it?')) {
                textarea.value = backup;
            }
        }
    });
</script>
{% endblock %}