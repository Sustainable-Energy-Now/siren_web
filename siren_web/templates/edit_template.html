<!-- templates/edit_template.html -->
{% extends 'base.html' %}

{% block title %}Edit Help Template - Siren-Web{% endblock %}

{% block extra_css %}
<style>
    .template-editor {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 14px;
        line-height: 1.4;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .markdown-preview {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        background-color: #f8f9fa;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .variable-help {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin: 15px 0;
    }
    
    .variable-tag {
        background-color: #e1f5fe;
        color: #0277bd;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Edit Siren-Web Help Template</h2>
            
            <!-- Template file info -->
            <div class="alert alert-info">
                <h5>üìù Template File Information</h5>
                <p><strong>File Path:</strong> <code>{{ template_path }}</code></p>
                <p class="mb-0">
                    This Markdown template is used to generate the Siren-Web help documentation. 
                    You can use Jinja2 variables and standard Markdown formatting.
                </p>
            </div>
        </div>
    </div>
    
    <form method="post" class="row">
        {% csrf_token %}
        
        <!-- Editor Column -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Template Editor</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                onclick="insertAtCursor('## ')">Add Heading</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                onclick="insertAtCursor('| Column 1 | Column 2 |\n|----------|----------|\n| Data 1   | Data 2   |')">Add Table</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <textarea name="template_content" class="form-control template-editor" 
                              rows="25" required>{{ template_content }}</textarea>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary">
                        üíæ Save Template
                    </button>
                    <a href="{% url 'generate_help_html' %}" class="btn btn-success">
                        üîÑ Save & Generate Help
                    </a>
                    <a href="{% url 'display_help_html' %}" class="btn btn-outline-secondary">
                        üìñ View Current Help
                    </a>
                </div>
            </div>
        </div>

            <!-- Markdown Reference -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">üìù Markdown Quick Reference</h6>
                </div>
                <div class="card-body small">
                    <p><strong>Headers:</strong></p>
                    <code># H1<br>## H2<br>### H3</code>
                    
                    <p class="mt-2"><strong>Emphasis:</strong></p>
                    <code>**bold**<br>*italic*</code>
                    
                    <p class="mt-2"><strong>Lists:</strong></p>
                    <code>- Item 1<br>- Item 2</code>
                    
                    <p class="mt-2"><strong>Links:</strong></p>
                    <code>[text](url)</code>
                    
                    <p class="mt-2"><strong>Tables:</strong></p>
                    <code>| Col1 | Col2 |<br>|------|------|<br>| Data | Data |</code>
                    
                    <p class="mt-2"><strong>Blockquotes:</strong></p>
                    <code>> Important note</code>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function insertAtCursor(text) {
        const textarea = document.querySelector('textarea[name="template_content"]');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const currentValue = textarea.value;
        
        textarea.value = currentValue.substring(0, start) + text + currentValue.substring(end);
        textarea.focus();
        textarea.setSelectionRange(start + text.length, start + text.length);
    }
    
    // Auto-save functionality
    let autoSaveTimeout;
    const textarea = document.querySelector('textarea[name="template_content"]');
    
    textarea.addEventListener('input', function() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            // Save to localStorage as backup
            localStorage.setItem('sirenweb_help_template_backup', this.value);
            console.log('Template auto-saved to local storage');
        }, 5000); // Auto-save after 5 seconds of inactivity
    });
    
    // Restore from localStorage if available
    document.addEventListener('DOMContentLoaded', function() {
        const backup = localStorage.getItem('sirenweb_help_template_backup');
        if (backup && backup !== textarea.value) {
            if (confirm('A newer version of your template was found in local storage. Would you like to restore it?')) {
                textarea.value = backup;
            }
        }
    });
    
    // Line numbers (optional enhancement)
    function addLineNumbers() {
        const textarea = document.querySelector('.template-editor');
        const lineNumbers = document.createElement('div');
        lineNumbers.className = 'line-numbers';
        
        // This is a simplified version - you might want to use a proper code editor library
        // like CodeMirror or Monaco Editor for full functionality
    }
</script>
{% endblock %}